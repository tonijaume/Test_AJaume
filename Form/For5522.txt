OBJECT Form 5522 Order Planning
{
  OBJECT-PROPERTIES
  {
    Date=14/08/09;
    Time=12:00:00;
    Version List=NAVW16.00.01;
  }
  PROPERTIES
  {
    Width=16500;
    Height=9900;
    CaptionML=[ENU=Order Planning;
               ESP=Planificaci¢n de pedidos];
    InsertAllowed=No;
    TableBoxID=1;
    SourceTable=Table246;
    SourceTableTemporary=Yes;
    OnOpenForm=BEGIN
                 IF NOT MfgUserTempl.GET(USERID) THEN BEGIN
                   MfgUserTempl.INIT;
                   MfgUserTempl."User ID" := USERID;
                   MfgUserTempl."Make Orders" := MfgUserTempl."Make Orders"::"the Active Order";
                   MfgUserTempl."Create Purchase Order" := MfgUserTempl."Create Purchase Order"::"Make Purch. Orders";
                   MfgUserTempl."Create Production Order" := MfgUserTempl."Create Production Order"::"Firm Planned";
                   MfgUserTempl."Create Transfer Order" := MfgUserTempl."Create Transfer Order"::"Make Trans. Orders";
                   MfgUserTempl.INSERT;
                 END;

                 IF ISSERVICETIER THEN
                   ExpandAll
                 ELSE
                   InitTempTable;
                 SetRecFilters;

                 CurrForm.UPDATE(FALSE);
               END;

    OnAfterGetRecord=BEGIN
                       SetExpansionStatus;
                     END;

    OnAfterGetCurrRecord=BEGIN
                           IF ReqLine.GET("Worksheet Template Name","Journal Batch Name","Line No.") THEN BEGIN
                             Rec := ReqLine;
                             MODIFY
                           END ELSE
                             IF GET("Worksheet Template Name","Journal Batch Name","Line No.") THEN
                               DELETE;

                           UpdateSupplyFrom;
                         END;

    OnModifyRecord=VAR
                     ReqLine@1000 : Record 246;
                   BEGIN
                     ReqLine.GET("Worksheet Template Name","Journal Batch Name","Line No.");
                     ReqLine.TRANSFERFIELDS(Rec,FALSE);
                     ReqLine.MODIFY(TRUE);
                   END;

    OnDeleteRecord=VAR
                     xReqLine@1000 : Record 246;
                   BEGIN
                     xReqLine := Rec;
                     WHILE (NEXT <> 0) AND (Level > xReqLine.Level) DO
                       DELETE(TRUE);
                     Rec := xReqLine;
                     xReqLine.DELETE(TRUE);
                     DELETE;
                     EXIT(FALSE);
                   END;

  }
  CONTROLS
  {
    { 78  ;TabControl   ;220  ;220  ;16060;1430 ;HorzGlue=Both }
    { 80  ;TextBox      ;3850 ;990  ;2750 ;440  ;Name=DemandOrderFilterCtrl;
                                                 ParentControl=78;
                                                 InPage=0;
                                                 CaptionML=[ENU=Show Demand as;
                                                            ESP=Mostrar demanda como];
                                                 OptionCaptionML=[ENU=All Demand,Production Demand,Sales Demand;
                                                                  ESP=Toda la demanda,Demanda de producci¢n,Demanda de venta];
                                                 SourceExpr=DemandOrderFilter;
                                                 OnAfterValidate=BEGIN
                                                                   CurrForm.SAVERECORD;
                                                                   SetRecFilters;
                                                                 END;
                                                                  }
    { 79  ;Label        ;440  ;990  ;3300 ;440  ;ParentControl=80 }
    { 44  ;CommandButton;14080;9130 ;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 PushAction=FormHelp }
    { 39  ;MenuButton   ;9240 ;9130 ;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 CaptionML=[ENU=F&unctions;
                                                            ESP=Acci&ones];
                                                 Menu=MENUITEMS
                                                 {
                                                   { ID=37;
                                                     CaptionML=[ENU=&Calculate Plan;
                                                                ESP=&Calcular plan];
                                                     OnPush=BEGIN
                                                              CalcPlan;
                                                            END;
                                                             }
                                                   { ID=48;
                                                     MenuItemType=Separator }
                                                   { ID=66;
                                                     CaptionML=[ENU=&Reserve;
                                                                ESP=&Reservar];
                                                     OnPush=BEGIN
                                                              CurrForm.SAVERECORD;
                                                              ShowReservation;
                                                            END;
                                                             }
                                                   { ID=67;
                                                     CaptionML=[ENU=Order &Tracking;
                                                                ESP=&Seg. pedido];
                                                     OnPush=VAR
                                                              TrackingForm@1001 : Form 99000822;
                                                            BEGIN
                                                              TrackingForm.SetReqLine(Rec);
                                                              TrackingForm.RUNMODAL;
                                                            END;
                                                             }
                                                   { ID=45;
                                                     CaptionML=[ENU=Production Sc&hedule;
                                                                ESP=Previsi¢n de p&roducci¢n];
                                                     OnPush=VAR
                                                              ProdOrder@1002 : Record 5405;
                                                              ProdSchedMgt@1000 : Codeunit 5500;
                                                            BEGIN
                                                              IF "Demand Type" = DATABASE::"Prod. Order Component" THEN
                                                                ProdOrder.GET("Demand Subtype","Demand Order No.");
                                                              ProdSchedMgt.ScheduleOrder(ProdOrder,TRUE);
                                                            END;
                                                             }
                                                   { ID=77;
                                                     Ellipsis=Yes;
                                                     CaptionML=[ENU=Refresh &Planning Line;
                                                                ESP=&Actualizar l¡nea plan.];
                                                     OnPush=VAR
                                                              ReqLine2@1000 : Record 246;
                                                            BEGIN
                                                              ReqLine2.SETRANGE("Worksheet Template Name","Worksheet Template Name");
                                                              ReqLine2.SETRANGE("Journal Batch Name","Journal Batch Name");
                                                              ReqLine2.SETRANGE("Line No.","Line No.");

                                                              REPORT.RUNMODAL(REPORT::"Refresh Planning Demand",TRUE,FALSE,ReqLine2);
                                                            END;
                                                             }
                                                   { ID=76;
                                                     MenuItemType=Separator }
                                                   { ID=92;
                                                     ShortCutKey=May£s+Ctrl+A;
                                                     CaptionML=[ENU=Exp&and/Collapse;
                                                                ESP=E&xpandir/Contraer];
                                                     OnPush=BEGIN
                                                              ToggleExpandCollapse;
                                                            END;
                                                             }
                                                   { ID=94;
                                                     CaptionML=[ENU=E&xpand All;
                                                                ESP=E&xpandir todo];
                                                     OnPush=BEGIN
                                                              ExpandAll;
                                                            END;
                                                             }
                                                   { ID=93;
                                                     CaptionML=[ENU=C&ollapse All;
                                                                ESP=C&ontraer todo];
                                                     OnPush=BEGIN
                                                              InitTempTable;
                                                            END;
                                                             }
                                                   { ID=36;
                                                     MenuItemType=Separator }
                                                 }
                                                  }
    { 55  ;CommandButton;11660;9130 ;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 Ellipsis=Yes;
                                                 CaptionML=[ENU=Make &Orders;
                                                            ESP=&Crear pedidos compra];
                                                 OnPush=VAR
                                                          MakeSupplyOrders@1001 : Codeunit 5521;
                                                        BEGIN
                                                          MakeSupplyOrders.SetManufUserTemplate(MfgUserTempl);
                                                          MakeSupplyOrders.RUN(Rec);

                                                          RefreshTempTable;
                                                          SetRecFilters;
                                                          CurrForm.UPDATE(FALSE);
                                                        END;
                                                         }
    { 99  ;MenuButton   ;4400 ;9130 ;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 CaptionML=[ENU=&Line;
                                                            ESP=&L¡nea];
                                                 Menu=MENUITEMS
                                                 {
                                                   { ID=18;
                                                     CaptionML=[ENU=Show Document;
                                                                ESP=Mostrar documento];
                                                     OnPush=BEGIN
                                                              ShowDemandOrder;
                                                            END;
                                                             }
                                                   { ID=63;
                                                     MenuItemType=Separator }
                                                   { ID=42;
                                                     PushAction=RunObject;
                                                     CaptionML=[ENU=Components;
                                                                ESP=Componentes];
                                                     RunObject=Form 99000862;
                                                     RunFormLinkType=OnUpdate;
                                                     RunFormLink=Worksheet Template Name=FIELD(Worksheet Template Name),
                                                                 Worksheet Batch Name=FIELD(Journal Batch Name),
                                                                 Worksheet Line No.=FIELD(Line No.) }
                                                   { ID=47;
                                                     PushAction=RunObject;
                                                     CaptionML=[ENU=Ro&uting;
                                                                ESP=R&uta];
                                                     RunObject=Form 99000863;
                                                     RunFormLinkType=OnUpdate;
                                                     RunFormLink=Worksheet Template Name=FIELD(Worksheet Template Name),
                                                                 Worksheet Batch Name=FIELD(Journal Batch Name),
                                                                 Worksheet Line No.=FIELD(Line No.) }
                                                   { ID=101;
                                                     PushAction=RunObject;
                                                     ShortCutKey=May£s+Ctrl+D;
                                                     CaptionML=[ENU=Dimensions;
                                                                ESP=Dimensiones];
                                                     RunObject=Form 545;
                                                     RunFormLinkType=OnUpdate;
                                                     RunFormLink=Table ID=CONST(246),
                                                                 Journal Template Name=FIELD(Worksheet Template Name),
                                                                 Journal Batch Name=FIELD(Journal Batch Name),
                                                                 Journal Line No.=FIELD(Line No.) }
                                                 }
                                                  }
    { 100 ;MenuButton   ;6820 ;9130 ;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 CaptionML=[ENU=&Item;
                                                            ESP=&Producto];
                                                 Menu=MENUITEMS
                                                 {
                                                   { ID=19;
                                                     ShortCutKey=May£s+F5;
                                                     CaptionML=[ENU=Card;
                                                                ESP=Ficha];
                                                     OnPush=VAR
                                                              Item@1000 : Record 27;
                                                            BEGIN
                                                              TESTFIELD(Type,Type::Item);
                                                              TESTFIELD("No.");
                                                              Item."No." := "No.";
                                                              FORM.RUNMODAL(FORM::"Item Card",Item);
                                                            END;
                                                             }
                                                   { ID=105;
                                                     CaptionML=[ENU=&Item Availability by;
                                                                ESP=&Disponibilidad prod. por] }
                                                   { ID=106;
                                                     MenuLevel=1;
                                                     CaptionML=[ENU=Period;
                                                                ESP=Periodo];
                                                     OnPush=BEGIN
                                                              ItemAvailability(0);
                                                            END;
                                                             }
                                                   { ID=107;
                                                     MenuLevel=1;
                                                     CaptionML=[ENU=Variant;
                                                                ESP=Variante];
                                                     OnPush=BEGIN
                                                              ItemAvailability(1);
                                                            END;
                                                             }
                                                   { ID=108;
                                                     MenuLevel=1;
                                                     CaptionML=[ENU=Location;
                                                                ESP=Almacn];
                                                     OnPush=BEGIN
                                                              ItemAvailability(2);
                                                            END;
                                                             }
                                                 }
                                                  }
    { 38  ;Frame        ;220  ;7480 ;16060;1430 ;HorzGlue=Both;
                                                 VertGlue=Bottom;
                                                 ShowCaption=No }
    { 58  ;TextBox      ;3960 ;8250 ;1650 ;440  ;Editable=No;
                                                 ParentControl=38;
                                                 InFrame=Yes;
                                                 Lookup=No;
                                                 DrillDown=No;
                                                 DropDown=No;
                                                 CaptionML=[ENU=Substitutes Exist;
                                                            ESP=Existe sustitutivo];
                                                 SourceExpr=CalcSubstitionAvailable;
                                                 OnAssistEdit=VAR
                                                                ReqLine2@1001 : Record 246;
                                                                xReqLine@1002 : Record 246;
                                                                ReqLine3@1003 : Record 246;
                                                              BEGIN
                                                                ReqLine3 := Rec;
                                                                OrderPlanningMgt.InsertAltSupplySubstitution(ReqLine3);
                                                                Rec := ReqLine3;
                                                                MODIFY;

                                                                IF OrderPlanningMgt.DeleteLine THEN BEGIN
                                                                  xReqLine := Rec;
                                                                  ReqLine2.SETCURRENTKEY("User ID","Demand Type","Demand Subtype","Demand Order No.");
                                                                  ReqLine2.SETRANGE("User ID",USERID);
                                                                  ReqLine2.SETRANGE("Demand Type","Demand Type");
                                                                  ReqLine2.SETRANGE("Demand Subtype","Demand Subtype");
                                                                  ReqLine2.SETRANGE("Demand Order No.","Demand Order No.");
                                                                  ReqLine2.SETRANGE(Level,Level,Level + 1);
                                                                  ReqLine2.SETFILTER("Line No.",'<>%1',"Line No.");
                                                                  IF NOT ReqLine2.FIND('-') THEN BEGIN // No other children
                                                                    ReqLine2.SETRANGE("Line No.");
                                                                    ReqLine2.SETRANGE(Level,0);
                                                                    IF ReqLine2.FIND('-') THEN BEGIN // Find and delete parent
                                                                      Rec := ReqLine2;
                                                                      DELETE;
                                                                    END;
                                                                  END;

                                                                  Rec := xReqLine;
                                                                  DELETE;
                                                                  CurrForm.UPDATE(FALSE);
                                                                END ELSE
                                                                  CurrForm.UPDATE(TRUE);
                                                              END;
                                                               }
    { 59  ;Label        ;3960 ;7700 ;3080 ;440  ;ParentControl=58;
                                                 LeaderDots=No }
    { 60  ;TextBox      ;440  ;8250 ;1650 ;440  ;Editable=No;
                                                 ParentControl=38;
                                                 InFrame=Yes;
                                                 DecimalPlaces=0:5;
                                                 SourceExpr=CalcQtyOnOtherLocations;
                                                 OnAssistEdit=BEGIN
                                                                OrderPlanningMgt.InsertAltSupplyLocation(Rec);
                                                              END;
                                                               }
    { 68  ;TextBox      ;7260 ;8250 ;1650 ;440  ;Editable=No;
                                                 ParentControl=38;
                                                 InFrame=Yes;
                                                 Lookup=No;
                                                 DrillDown=No;
                                                 DropDown=No;
                                                 CaptionML=[ENU=Quantity Available;
                                                            ESP=Cantidad disponible];
                                                 DecimalPlaces=0:5;
                                                 SourceExpr=CalcQtyATP }
    { 69  ;Label        ;7260 ;7700 ;3080 ;440  ;ParentControl=68;
                                                 LeaderDots=No }
    { 70  ;TextBox      ;10560;8250 ;1650 ;440  ;Editable=No;
                                                 ParentControl=38;
                                                 InFrame=Yes;
                                                 Lookup=No;
                                                 DrillDown=No;
                                                 DropDown=No;
                                                 CaptionML=[ENU=Earliest Date Available;
                                                            ESP=Primera fecha posible];
                                                 SourceExpr=CalcEarliestShptDateAvailable }
    { 71  ;Label        ;10560;7700 ;3080 ;440  ;ParentControl=70;
                                                 LeaderDots=No }
    { 61  ;Label        ;440  ;7700 ;3300 ;440  ;ParentControl=38;
                                                 LeaderDots=No;
                                                 CaptionML=[ENU=Available for Transfer;
                                                            ESP=Disponible para transfer.] }
    { 1   ;TableBox     ;220  ;1760 ;16060;5500 ;HorzGlue=Both;
                                                 VertGlue=Both }
    { 89  ;PictureBox   ;0    ;1320 ;550  ;3740 ;ParentControl=1;
                                                 InColumn=Yes;
                                                 BitmapList=47,46;
                                                 CaptionML=[ENU=Expand;
                                                            ESP=Expandir];
                                                 SourceExpr=ActualExpansionStatus;
                                                 OnPush=BEGIN
                                                          ToggleExpandCollapse;
                                                        END;
                                                         }
    { 90  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=89;
                                                 InColumnHeading=Yes }
    { 14  ;TextBox      ;0    ;0    ;1700 ;0    ;ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Demand Date" }
    { 15  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=14;
                                                 InColumnHeading=Yes }
    { 72  ;TextBox      ;6138 ;2200 ;550  ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 DropDown=No;
                                                 SourceExpr=Status;
                                                 OnFormat=VAR
                                                            SalesHeader@1003 : Record 36;
                                                            ProdOrder@1002 : Record 5405;
                                                          BEGIN
                                                            IF "Demand Line No." = 0 THEN
                                                              CASE "Demand Type" OF
                                                                DATABASE::"Prod. Order Component":
                                                                  BEGIN
                                                                    ProdOrder.Status := Status;
                                                                    Text := FORMAT(ProdOrder.Status);
                                                                  END;
                                                                DATABASE::"Sales Line":
                                                                  BEGIN
                                                                    SalesHeader.Status := Status;
                                                                    Text := FORMAT(SalesHeader.Status);
                                                                  END;
                                                              END
                                                            ELSE
                                                              Text := '';
                                                          END;
                                                           }
    { 73  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=72;
                                                 InColumnHeading=Yes }
    { 43  ;TextBox      ;0    ;880  ;2200 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 HorzAlign=Left;
                                                 Lookup=No;
                                                 SourceExpr="Demand Type";
                                                 OnFormat=BEGIN
                                                            IF "Demand Line No." = 0 THEN
                                                              CASE "Demand Type" OF
                                                                DATABASE::"Sales Line":
                                                                  Text := Text001;
                                                                DATABASE::"Prod. Order Component":
                                                                  Text := Text002;
                                                              END
                                                            ELSE
                                                              Text := '';

                                                            IF (Level = 0) OR (ActualExpansionStatus < 2) THEN
                                                              CurrForm."Demand Type".UPDATEFONTBOLD := TRUE;
                                                          END;
                                                           }
    { 56  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=43;
                                                 InColumnHeading=Yes }
    { 46  ;TextBox      ;2090 ;2640 ;556  ;440  ;Visible=No;
                                                 Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 DropDown=No;
                                                 SourceExpr="Demand Subtype";
                                                 OnFormat=VAR
                                                            SalesHeader@1001 : Record 36;
                                                            ProdOrder@1000 : Record 5405;
                                                          BEGIN
                                                            IF "Demand Type" = DATABASE::"Prod. Order Component" THEN BEGIN
                                                              ProdOrder.Status := "Demand Subtype";
                                                              Text := FORMAT(ProdOrder.Status);
                                                            END;
                                                            IF "Demand Type" = DATABASE::"Sales Line" THEN BEGIN
                                                              SalesHeader."Document Type" := "Demand Subtype";
                                                              Text := FORMAT(SalesHeader."Document Type");
                                                            END;
                                                          END;
                                                           }
    { 65  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=46;
                                                 InColumnHeading=Yes }
    { 57  ;TextBox      ;1700 ;880  ;1650 ;440  ;ParentControl=1;
                                                 InColumn=Yes;
                                                 CaptionML=[ENU=Order No.;
                                                            ESP=N§ pedido];
                                                 SourceExpr="Demand Order No.";
                                                 OnFormat=BEGIN
                                                            IF "Demand Line No." <> 0 THEN
                                                              Text := '';

                                                            SetExpansionStatus;
                                                            IF (Level = 0) OR (ActualExpansionStatus < 2) THEN
                                                              CurrForm."Demand Order No.".UPDATEFONTBOLD := TRUE;
                                                          END;
                                                           }
    { 86  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=57;
                                                 InColumnHeading=Yes }
    { 87  ;TextBox      ;3400 ;880  ;1700 ;440  ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Demand Line No." }
    { 88  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=87;
                                                 InColumnHeading=Yes }
    { 4   ;TextBox      ;0    ;0    ;1650 ;0    ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 CaptionML=[ENU=Item No.;
                                                            ESP=N§ producto];
                                                 SourceExpr="No." }
    { 5   ;Label        ;0    ;0    ;0    ;0    ;ParentControl=4;
                                                 InColumnHeading=Yes }
    { 8   ;TextBox      ;0    ;0    ;1650 ;0    ;Visible=No;
                                                 Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Variant Code" }
    { 9   ;Label        ;0    ;0    ;0    ;0    ;ParentControl=8;
                                                 InColumnHeading=Yes }
    { 16  ;TextBox      ;10028;1210 ;1650 ;440  ;Visible=No;
                                                 Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Location Code" }
    { 17  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=16;
                                                 InColumnHeading=Yes }
    { 6   ;TextBox      ;0    ;0    ;4400 ;0    ;HorzGlue=Both;
                                                 Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr=Description;
                                                 OnFormat=BEGIN
                                                            IF Level > 0 THEN
                                                              CurrForm.Description.UPDATEINDENT := (Level + "Planning Level") * 220;

                                                            IF (Level = 0) OR (ActualExpansionStatus < 2) THEN
                                                              CurrForm.Description.UPDATEFONTBOLD := TRUE;
                                                          END;
                                                           }
    { 7   ;Label        ;0    ;0    ;0    ;0    ;ParentControl=6;
                                                 InColumnHeading=Yes }
    { 10  ;TextBox      ;0    ;0    ;1650 ;0    ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Demand Quantity";
                                                 OnFormat=BEGIN
                                                            IF Level = 0 THEN
                                                              Text := '';
                                                          END;
                                                           }
    { 11  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=10;
                                                 InColumnHeading=Yes }
    { 95  ;TextBox      ;20585;1980 ;1650 ;440  ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Demand Qty. Available";
                                                 OnFormat=BEGIN
                                                            IF Level = 0 THEN
                                                              Text := '';
                                                          END;
                                                           }
    { 96  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=95;
                                                 InColumnHeading=Yes }
    { 2   ;TextBox      ;15002;2640 ;1650 ;440  ;Visible=Yes;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Needed Quantity" }
    { 3   ;Label        ;0    ;0    ;0    ;0    ;ParentControl=2;
                                                 InColumnHeading=Yes }
    { 24  ;TextBox      ;21299;2640 ;550  ;440  ;ParentControl=1;
                                                 InColumn=Yes;
                                                 OptionString=Purchase,Prod. Order,Transfer;
                                                 SourceExpr="Replenishment System";
                                                 OnFormat=BEGIN
                                                            IF "Replenishment System" = "Replenishment System"::" " THEN
                                                              Text := '';
                                                          END;

                                                 OnAfterValidate=BEGIN
                                                                   UpdateSupplyFrom;
                                                                 END;
                                                                  }
    { 25  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=24;
                                                 InColumnHeading=Yes }
    { 26  ;TextBox      ;0    ;0    ;1650 ;0    ;ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Supply From" }
    { 27  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=26;
                                                 InColumnHeading=Yes }
    { 62  ;CheckBox     ;26141;2420 ;550  ;440  ;ParentControl=1;
                                                 InColumn=Yes;
                                                 ShowCaption=No;
                                                 SourceExpr=Reserve }
    { 64  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=62;
                                                 InColumnHeading=Yes }
    { 28  ;TextBox      ;0    ;0    ;1650 ;0    ;ParentControl=1;
                                                 InColumn=Yes;
                                                 CaptionML=[ENU=Qty. to Order;
                                                            ESP=Cantidad que se pedir ];
                                                 SourceExpr=Quantity;
                                                 OnFormat=BEGIN
                                                            IF Level = 0 THEN
                                                              Text := '';
                                                          END;
                                                           }
    { 29  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=28;
                                                 InColumnHeading=Yes }
    { 12  ;TextBox      ;0    ;0    ;1650 ;0    ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Unit of Measure Code" }
    { 13  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=12;
                                                 InColumnHeading=Yes }
    { 32  ;TextBox      ;0    ;0    ;1700 ;0    ;ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Order Date" }
    { 33  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=32;
                                                 InColumnHeading=Yes }
    { 74  ;TextBox      ;30374;3520 ;1700 ;440  ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Starting Date" }
    { 75  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=74;
                                                 InColumnHeading=Yes }
    { 30  ;TextBox      ;0    ;0    ;1700 ;0    ;ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Due Date" }
    { 31  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=30;
                                                 InColumnHeading=Yes }
    { 34  ;TextBox      ;0    ;0    ;2196 ;0    ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Unit Cost" }
    { 35  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=34;
                                                 InColumnHeading=Yes }
    { 53  ;TextBox      ;32808;1650 ;2200 ;440  ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Direct Unit Cost" }
    { 54  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=53;
                                                 InColumnHeading=Yes }
    { 51  ;TextBox      ;32756;1650 ;1700 ;440  ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Currency Code" }
    { 52  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=51;
                                                 InColumnHeading=Yes }
    { 49  ;TextBox      ;32941;3410 ;1650 ;440  ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Purchasing Code" }
    { 50  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=49;
                                                 InColumnHeading=Yes }
    { 20  ;TextBox      ;0    ;0    ;1650 ;0    ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Shortcut Dimension 1 Code" }
    { 21  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=20;
                                                 InColumnHeading=Yes }
    { 22  ;TextBox      ;0    ;0    ;1650 ;0    ;Visible=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Shortcut Dimension 2 Code" }
    { 23  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=22;
                                                 InColumnHeading=Yes }
  }
  CODE
  {
    VAR
      ReqLine@1001 : Record 246;
      SalesHeader@1000 : Record 36;
      ProdOrder@1006 : Record 5405;
      MfgUserTempl@1015 : Record 5525;
      OrderPlanningMgt@1002 : Codeunit 5522;
      ActualExpansionStatus@1005 : 'Has Children,Expanded,No Children';
      DemandOrderFilter@1007 : 'All Demands,Production Demand,Sales Demand';
      Text000@1003 : TextConst 'ENU=All items in %1 %2 %3 are available and no planning line is created for it.;ESP=Todos los elementos de %3 %1 %2 est n disponibles y no se han creado l¡neas de planificaci¢n para ellos.';
      Text001@1008 : TextConst 'ENU=Sales;ESP=Ventas';
      Text002@1009 : TextConst 'ENU=Production;ESP=Producci¢n';

    PROCEDURE SetSalesOrder@2(SalesHeader2@1001 : Record 36);
    BEGIN
      SalesHeader := SalesHeader2;
      DemandOrderFilter := DemandOrderFilter::"Sales Demand";
      CurrForm.DemandOrderFilterCtrl.ENABLED := FALSE;
    END;

    PROCEDURE SetProdOrder@3(ProdOrder2@1000 : Record 5405);
    BEGIN
      ProdOrder := ProdOrder2;
      DemandOrderFilter := DemandOrderFilter::"Production Demand";
      CurrForm.DemandOrderFilterCtrl.ENABLED := FALSE;
    END;

    PROCEDURE SetExpansionStatus@16();
    BEGIN
      IF IsExpanded(Rec) THEN
        ActualExpansionStatus := ActualExpansionStatus::Expanded
      ELSE
        IF HasChildren(Rec) THEN
          ActualExpansionStatus := ActualExpansionStatus::"Has Children"
        ELSE
          ActualExpansionStatus := ActualExpansionStatus::"No Children";
    END;

    PROCEDURE InitTempTable@1();
    BEGIN
      ReqLine.RESET;
      ReqLine.COPYFILTERS(Rec);
      ReqLine.SETRANGE("Worksheet Template Name",'');
      DELETEALL;
      IF ReqLine.FINDSET THEN
        REPEAT
          IF ReqLine.Level = 0 THEN BEGIN
            Rec := ReqLine;
            INSERT;
          END;
        UNTIL ReqLine.NEXT = 0;
    END;

    LOCAL PROCEDURE ExpandAll@12();
    VAR
      ReqLine@1000 : Record 246;
    BEGIN
      ReqLine.RESET;
      ReqLine.COPYFILTERS(Rec);
      DELETEALL;

      IF ReqLine.FINDSET THEN
        REPEAT
          Rec := ReqLine;
          INSERT;
        UNTIL ReqLine.NEXT = 0;
    END;

    LOCAL PROCEDURE IsExpanded@20(ActualReqLine@1000 : Record 246) : Boolean;
    VAR
      xReqLine@1001 : Record 246;
      Found@1002 : Boolean;
    BEGIN
      xReqLine := Rec;
      Rec := ActualReqLine;
      Found := (NEXT <> 0);
      IF Found THEN
        Found := (Level > ActualReqLine.Level);
      Rec := xReqLine;
      EXIT(Found);
    END;

    LOCAL PROCEDURE HasChildren@18(ActualReqLine@1000 : Record 246) : Boolean;
    BEGIN
      ReqLine.RESET;
      ReqLine.COPYFILTERS(Rec);
      ReqLine := ActualReqLine;
      IF ReqLine.NEXT = 0 THEN
        EXIT(FALSE);

      EXIT(ReqLine.Level > ActualReqLine.Level);
    END;

    PROCEDURE RefreshTempTable@14();
    VAR
      TempReqLine2@1001 : Record 246;
      ReqLine@1000 : Record 246;
    BEGIN
      TempReqLine2.COPY(Rec);

      RESET;
      IF FIND('-') THEN
        REPEAT
          ReqLine := Rec;
          IF NOT ReqLine.FIND OR
             ((Level = 0) AND ((ReqLine.NEXT = 0) OR (ReqLine.Level = 0)))
          THEN BEGIN
            IF Level = 0 THEN BEGIN
              ReqLine := Rec;
              ReqLine.FIND;
              ReqLine.DELETE(TRUE);
            END;
            DELETE
          END;
        UNTIL NEXT = 0;

      COPY(TempReqLine2);
    END;

    LOCAL PROCEDURE ToggleExpandCollapse@4();
    VAR
      ReqLine@1000 : Record 246;
      xReqLine@1001 : Record 246;
    BEGIN
      xReqLine := Rec;
      IF ActualExpansionStatus = 0 THEN BEGIN // Has children, but not expanded
        ReqLine.SETRANGE("Worksheet Template Name",'');
        ReqLine.SETFILTER("Line No.",'<>%1',"Line No.");
        ReqLine.SETRANGE(Level,Level,Level + 1);
        ReqLine := Rec;
        IF ReqLine.NEXT <> 0 THEN
          REPEAT
            IF ReqLine.Level > xReqLine.Level THEN BEGIN
              Rec := ReqLine;
              IF INSERT THEN;
            END;
          UNTIL (ReqLine.NEXT = 0) OR (ReqLine.Level = xReqLine.Level);
      END ELSE
        IF ActualExpansionStatus = 1 THEN BEGIN // Has children and is already expanded
          WHILE (NEXT <> 0) AND (Level > xReqLine.Level) DO
            DELETE;
        END;
      Rec := xReqLine;
      CurrForm.UPDATE(FALSE);
    END;

    PROCEDURE SetRecFilters@5();
    BEGIN
      RESET;
      FILTERGROUP(2);
      SETRANGE("User ID",USERID);
      SETRANGE("Worksheet Template Name",'');

      CASE DemandOrderFilter OF
        DemandOrderFilter::"All Demands":
          BEGIN
            SETRANGE("Demand Type");
            SETCURRENTKEY("User ID","Worksheet Template Name","Journal Batch Name","Line No.");
          END;
        DemandOrderFilter::"Sales Demand":
          BEGIN
            SETRANGE("Demand Type",DATABASE::"Sales Line");
            SETCURRENTKEY("User ID","Demand Type","Worksheet Template Name","Journal Batch Name","Line No.");
          END;
        DemandOrderFilter::"Production Demand":
          BEGIN
            SETRANGE("Demand Type",DATABASE::"Prod. Order Component");
            SETCURRENTKEY("User ID","Demand Type","Worksheet Template Name","Journal Batch Name","Line No.");
          END;
      END;
      FILTERGROUP(0);

      CurrForm.UPDATE(FALSE);
    END;

    PROCEDURE ExpandOrderToPlan@10();
    VAR
      ReqLine@1000 : Record 246;
    BEGIN
      IF (SalesHeader."No." <> '') OR (ProdOrder."No." <> '') THEN BEGIN
        ReqLine.SETCURRENTKEY("User ID","Demand Type","Demand Subtype","Demand Order No.");
        ReqLine.SETRANGE("User ID",USERID);
        CASE TRUE OF
          SalesHeader."No." <> '':
            BEGIN
              ReqLine.SETRANGE("Demand Type",DATABASE::"Sales Line");
              ReqLine.SETRANGE("Demand Subtype",SalesHeader."Document Type");
              ReqLine.SETRANGE("Demand Order No.",SalesHeader."No.");
            END;
          ProdOrder."No." <> '':
            BEGIN
              ReqLine.SETRANGE("Demand Type",DATABASE::"Prod. Order Component");
              ReqLine.SETRANGE("Demand Subtype",ProdOrder.Status);
              ReqLine.SETRANGE("Demand Order No.",ProdOrder."No.");
            END;
        END;

        IF ReqLine.FIND('-') THEN BEGIN
          Rec := ReqLine;
          FIND;
          ActualExpansionStatus := 0;
          ToggleExpandCollapse;
        END ELSE BEGIN
          IF SalesHeader."No." <> '' THEN
            MESSAGE(
              Text000,
              Text001,
              SalesHeader."Document Type",
              SalesHeader."No.");
          IF ProdOrder."No." <> '' THEN
            MESSAGE(
              Text000,
              ProdOrder.Status,
              ProdOrder.TABLECAPTION,
              ProdOrder."No.");
        END;
      END;
    END;

    PROCEDURE ShowDemandOrder@15();
    VAR
      SalesHeader@1001 : Record 36;
      ProdOrder@1000 : Record 5405;
    BEGIN
      CASE "Demand Type" OF
        DATABASE::"Sales Line":
          BEGIN
            SalesHeader.GET("Demand Subtype","Demand Order No.");
            CASE SalesHeader."Document Type" OF
              SalesHeader."Document Type"::Order:
                FORM.RUN(FORM::"Sales Order",SalesHeader);
              SalesHeader."Document Type"::"Return Order":
                FORM.RUN(FORM::"Sales Return Order",SalesHeader);
            END;
          END;
        DATABASE::"Prod. Order Component":
          BEGIN
            ProdOrder.GET("Demand Subtype","Demand Order No.");
            CASE ProdOrder.Status OF
              ProdOrder.Status::Planned:
                FORM.RUN(FORM::"Planned Production Order",ProdOrder);
              ProdOrder.Status::"Firm Planned":
                FORM.RUN(FORM::"Firm Planned Prod. Order",ProdOrder);
              ProdOrder.Status::Released:
                FORM.RUN(FORM::"Released Production Order",ProdOrder);
            END;
          END;
      END;
    END;

    PROCEDURE CalcQtyOnOtherLocations@6() : Decimal;
    VAR
      QtyOnOtherLocation@1000 : Decimal;
    BEGIN
      QtyOnOtherLocation := OrderPlanningMgt.AvailQtyOnOtherLocations(Rec); // Base Unit
      IF "Qty. per Unit of Measure" = 0 THEN
        "Qty. per Unit of Measure" := 1;
      QtyOnOtherLocation := ROUND(QtyOnOtherLocation / "Qty. per Unit of Measure",0.00001);

      EXIT(QtyOnOtherLocation);
    END;

    PROCEDURE CalcQtyOnBlanketOrders@7() : Decimal;
    BEGIN
    END;

    PROCEDURE CalcQtyATP@8() : Decimal;
    VAR
      QtyATP@1000 : Decimal;
    BEGIN
      QtyATP := OrderPlanningMgt.CalcATPQty("No.","Variant Code","Location Code","Demand Date"); // Base Unit
      IF "Qty. per Unit of Measure" = 0 THEN
        "Qty. per Unit of Measure" := 1;
      QtyATP := ROUND(QtyATP / "Qty. per Unit of Measure",0.00001);

      EXIT(QtyATP);
    END;

    PROCEDURE CalcEarliestShptDateAvailable@9() : Date;
    VAR
      Item@1000 : Record 27;
    BEGIN
      IF "No." <> '' THEN BEGIN
        Item.GET("No.");
        IF Item."Order Tracking Policy" = Item."Order Tracking Policy"::"Tracking & Action Msg." THEN
          EXIT;
      END;
      EXIT(OrderPlanningMgt.CalcATPEarliestDate("No.","Variant Code","Location Code","Demand Date","Quantity (Base)"));
    END;

    PROCEDURE CalcSubstitionAvailable@11() : Boolean;
    BEGIN
      EXIT(OrderPlanningMgt.SubstitutionPossible(Rec));
    END;

    PROCEDURE CalcPlan@13();
    VAR
      ReqLine@1001 : Record 246;
    BEGIN
      RESET;
      DELETEALL;

      CLEAR(OrderPlanningMgt);
      CASE DemandOrderFilter OF
        DemandOrderFilter::"Sales Demand":
          OrderPlanningMgt.SetSalesOrder(SalesHeader);
        DemandOrderFilter::"Production Demand":
          OrderPlanningMgt.SetProdOrder(ProdOrder);
      END;
      OrderPlanningMgt.GetOrdersToPlan(ReqLine);

      IF ISSERVICETIER THEN
        ExpandAll
      ELSE BEGIN
        InitTempTable;
        ExpandOrderToPlan;
      END;
      SetRecFilters;

      CurrForm.UPDATE(FALSE);
    END;

    PROCEDURE UpdateSupplyFrom@17();
    BEGIN
      CurrForm."Supply From".EDITABLE("Replenishment System" <> "Replenishment System"::"Prod. Order");
    END;

    BEGIN
    END.
  }
}

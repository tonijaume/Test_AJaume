OBJECT Form 7035359 Autofacturacion ingresos
{
  OBJECT-PROPERTIES
  {
    Date=05/10/10;
    Time=10:40:33;
    Version List=TRANSFER;
  }
  PROPERTIES
  {
    Width=20240;
    Height=8580;
    CaptionML=ESP=Autofacturacion ingresos;
    InsertAllowed=No;
    TableBoxID=1;
    SourceTable=Table7010365;
    SourceTableView=SORTING(Confirmado,Cliente operativo,Touroperador,Bono);
    OnInit=BEGIN
             wColorMarcado   := 10485760;
             wColorFacturado := 8421376;
           END;

    OnOpenForm=BEGIN

                 Inicializa;

                 // Rellena los campos filtrados

                 wTTOO          := GETFILTER(Touroperador);
                 wTipoVehiculo  := GETFILTER("Tipo Vehiculo");
                 SETFILTER("Filtro Fecha",GETFILTER("Fecha Facturacion"));
                 IF GETFILTER("Pax Transportados")<>'' THEN BEGIN
                   wRangoPaxes[1]:= GETRANGEMIN("Pax Transportados");
                   wRangoPaxes[2]:= GETRANGEMAX("Pax Transportados");
                 END;
                 //IF NOT EVALUATE("Filtro Fecha" , GETFILTER("Fecha Facturacion")) THEN
                   //"Filtro Fecha" := 0D;
               END;

  }
  CONTROLS
  {
    { 1   ;TableBox     ;220  ;2090 ;19800;5500 ;HorzGlue=Both;
                                                 VertGlue=Both;
                                                 HeadingHeight=880 }
    { 18  ;TextBox      ;1032 ;2420 ;2153 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="N§ Parte";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."N§ Parte".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."N§ Parte".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 19  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=18;
                                                 InColumnHeading=Yes }
    { 1100244000;TextBox;13732;2420 ;2750 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr=Referencia;
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm.Referencia.UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm.Referencia.UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 1100244001;Label  ;0    ;0    ;0    ;0    ;ParentControl=1100244000;
                                                 InColumnHeading=Yes }
    { 1100244004;TextBox;4419 ;2750 ;2310 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Vuelos partes";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Vuelos partes".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Vuelos partes".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 1100244005;Label  ;0    ;0    ;0    ;0    ;ParentControl=1100244004;
                                                 InColumnHeading=Yes }
    { 31  ;TextBox      ;0    ;330  ;2033 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Fecha Facturacion";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Fecha Facturacion".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Fecha Facturacion".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 32  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=31;
                                                 InColumnHeading=Yes }
    { 51  ;TextBox      ;7065 ;2310 ;2530 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="N§ Factura";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."N§ Factura".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."N§ Factura".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 52  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=51;
                                                 InColumnHeading=Yes }
    { 6   ;TextBox      ;1429 ;2200 ;1650 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Tipo Vehiculo";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Tipo Vehiculo".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Tipo Vehiculo".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 7   ;Label        ;0    ;0    ;0    ;0    ;ParentControl=6;
                                                 InColumnHeading=Yes }
    { 2   ;TextBox      ;0    ;0    ;1876 ;0    ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr=Touroperador;
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm.Touroperador.UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm.Touroperador.UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 3   ;Label        ;0    ;0    ;0    ;0    ;ParentControl=2;
                                                 InColumnHeading=Yes }
    { 22  ;TextBox      ;0    ;0    ;1594 ;0    ;Name=IngresosDL1;
                                                 Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 CaptionML=ESP=Ingresos (DL);
                                                 SourceExpr=TotalIngresoDL;
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm.IngresosDL1.UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm.IngresosDL1.UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 23  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=22;
                                                 InColumnHeading=Yes }
    { 1100244002;TextBox;13415;2530 ;1536 ;440  ;Name=IngresoBruto1;
                                                 Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 CaptionML=ESP=Ingresos Brutos;
                                                 SourceExpr=TotalIngresoBruto;
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm.IngresoBruto1.UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm.IngresoBruto1.UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 1100244003;Label  ;0    ;0    ;0    ;0    ;ParentControl=1100244002;
                                                 InColumnHeading=Yes }
    { 1100244006;TextBox;17992;2640 ;1981 ;440  ;ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Importe Touroperador";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Importe Touroperador".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Importe Touroperador".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 1100244007;Label  ;0    ;0    ;0    ;0    ;ParentControl=1100244006;
                                                 InColumnHeading=Yes }
    { 14  ;TextBox      ;20320;2200 ;1105 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Adultos transportados";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Adultos transportados".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Adultos transportados".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 15  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=14;
                                                 InColumnHeading=Yes }
    { 26  ;TextBox      ;22520;2200 ;1111 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Ni¤os transportados";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Ni¤os transportados".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Ni¤os transportados".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 27  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=26;
                                                 InColumnHeading=Yes }
    { 4   ;TextBox      ;0    ;0    ;1540 ;0    ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Precio manual venta DL";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Precio manual venta DL".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Precio manual venta DL".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 5   ;Label        ;0    ;0    ;0    ;0    ;ParentControl=4;
                                                 InColumnHeading=Yes }
    { 34  ;TextBox      ;24448;2310 ;770  ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Pax Transportados";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Pax Transportados".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Pax Transportados".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 35  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=34;
                                                 InColumnHeading=Yes }
    { 37  ;TextBox      ;14923;2310 ;2457 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr=Bono;
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm.Bono.UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm.Bono.UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 38  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=37;
                                                 InColumnHeading=Yes }
    { 12  ;TextBox      ;0    ;0    ;1770 ;0    ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="Codigo Servicio";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Codigo Servicio".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Codigo Servicio".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 13  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=12;
                                                 InColumnHeading=Yes }
    { 16  ;TextBox      ;0    ;0    ;1650 ;0    ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="N§ Contrato venta";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."N§ Contrato venta".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."N§ Contrato venta".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 17  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=16;
                                                 InColumnHeading=Yes }
    { 24  ;TextBox      ;0    ;0    ;2200 ;0    ;Visible=No;
                                                 Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 CaptionML=ESP=Costes (DL);
                                                 SourceExpr="Coste C/I DL";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."Coste C/I DL".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."Coste C/I DL".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 25  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=24;
                                                 InColumnHeading=Yes }
    { 20  ;TextBox      ;0    ;0    ;1650 ;0    ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr=Marca;
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm.Marca.UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm.Marca.UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 21  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=20;
                                                 InColumnHeading=Yes }
    { 61  ;TextBox      ;23998;2750 ;2200 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InColumn=Yes;
                                                 SourceExpr="N§ Prefactura";
                                                 OnFormat=BEGIN
                                                            IF Marca = USERID THEN
                                                              CurrForm."N§ Prefactura".UPDATEFORECOLOR := wColorMarcado;

                                                            IF cFunAutoFac.parte_facturado(Rec) THEN
                                                              CurrForm."N§ Prefactura".UPDATEFORECOLOR := wColorFacturado;
                                                          END;
                                                           }
    { 62  ;Label        ;0    ;0    ;0    ;0    ;ParentControl=61;
                                                 InColumnHeading=Yes }
    { 28  ;CommandButton;10120;7810 ;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 Default=Yes;
                                                 PushAction=LookupOK;
                                                 InvalidActionAppearance=Hide }
    { 29  ;CommandButton;12540;7810 ;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 Cancel=Yes;
                                                 PushAction=LookupCancel;
                                                 InvalidActionAppearance=Hide }
    { 30  ;CommandButton;17820;7810 ;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 PushAction=FormHelp }
    { 33  ;TabControl   ;220  ;220  ;19800;1760 ;HorzGlue=Both;
                                                 PageNamesML=ESP=Filtros }
    { 39  ;TextBox      ;4180 ;1320 ;2530 ;440  ;ParentControl=33;
                                                 InPage=0;
                                                 AutoEnter=Yes;
                                                 DrillDown=No;
                                                 ClearOnLookup=No;
                                                 SourceExpr=wTipoVehiculo;
                                                 TableRelation="Tipo Vehiculo".Codigo;
                                                 OnValidate=BEGIN

                                                              IF wTipoVehiculo <> '' THEN
                                                                SETRANGE("Tipo Vehiculo", wTipoVehiculo)
                                                              ELSE
                                                                SETRANGE("Tipo Vehiculo");
                                                            END;

                                                 OnAfterValidate=BEGIN
                                                                   CurrForm.UPDATE;
                                                                 END;
                                                                  }
    { 40  ;Label        ;4180 ;880  ;2530 ;440  ;ParentControl=39;
                                                 HorzAlign=Center;
                                                 LeaderDots=No;
                                                 CaptionML=ESP=Tipo de Vehiculo }
    { 43  ;TextBox      ;7040 ;1320 ;2640 ;440  ;ParentControl=33;
                                                 InPage=0;
                                                 AutoEnter=Yes;
                                                 DrillDown=No;
                                                 ClearOnLookup=No;
                                                 SourceExpr=wTTOO;
                                                 TableRelation=TTOO.Codigo;
                                                 OnValidate=BEGIN
                                                              IF wTTOO <> '' THEN
                                                                SETRANGE(Touroperador, wTTOO)
                                                              ELSE
                                                                SETRANGE(Touroperador);
                                                            END;

                                                 OnAfterValidate=BEGIN
                                                                   CurrForm.UPDATE;
                                                                 END;
                                                                  }
    { 44  ;Label        ;7040 ;880  ;2640 ;440  ;ParentControl=43;
                                                 HorzAlign=Center;
                                                 LeaderDots=No;
                                                 CaptionML=ESP=Touroperador }
    { 8   ;Label        ;440  ;880  ;3520 ;440  ;ParentControl=33;
                                                 InPage=0;
                                                 HorzAlign=Center;
                                                 LeaderDots=No;
                                                 CaptionML=ESP=Filtro Fecha }
    { 9   ;Label        ;10010;880  ;2420 ;440  ;ParentControl=33;
                                                 InPage=0;
                                                 HorzAlign=Center;
                                                 LeaderDots=No;
                                                 CaptionML=ESP=Rango de Paxes }
    { 10  ;TextBox      ;10010;1320 ;990  ;440  ;ParentControl=33;
                                                 InPage=0;
                                                 DecimalPlaces=0:0;
                                                 SourceExpr=wRangoPaxes[1];
                                                 OnValidate=BEGIN
                                                              FiltraRangos;
                                                            END;

                                                 OnAfterValidate=BEGIN
                                                                   CurrForm.UPDATE;
                                                                 END;
                                                                  }
    { 11  ;TextBox      ;11440;1320 ;990  ;440  ;ParentControl=33;
                                                 InPage=0;
                                                 DecimalPlaces=0:0;
                                                 SourceExpr=wRangoPaxes[2];
                                                 OnValidate=BEGIN
                                                              FiltraRangos;
                                                            END;

                                                 OnAfterValidate=BEGIN
                                                                   CurrForm.UPDATE;
                                                                 END;
                                                                  }
    { 41  ;Label        ;11000;1320 ;440  ;440  ;ParentControl=33;
                                                 InPage=0;
                                                 HorzAlign=Center;
                                                 LeaderDots=No;
                                                 CaptionML=ESP=.. }
    { 45  ;TextBox      ;440  ;1320 ;3520 ;440  ;ParentControl=33;
                                                 InPage=0;
                                                 SourceExpr="Filtro Fecha";
                                                 OnValidate=BEGIN
                                                              Cambiafecha;
                                                            END;

                                                 OnAfterValidate=BEGIN
                                                                   CurrForm.UPDATE;
                                                                 END;
                                                                  }
    { 36  ;MenuButton   ;14960;7810 ;2640 ;550  ;Name=boton1;
                                                 HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 CaptionML=ESP=&TTOO x Parte;
                                                 Menu=MENUITEMS
                                                 {
                                                   { ID=49;
                                                     PushAction=RunObject;
                                                     ShortCutKey=May£s+F5;
                                                     CaptionML=ESP=Ficha Parte;
                                                     RunObject=Form 7010400;
                                                     RunFormLink=N§ Parte=FIELD(N§ Parte) }
                                                   { ID=1103350002;
                                                     ShortCutKey=Ctrl+Z;
                                                     CaptionML=ESP=Ver PDF;
                                                     OnPush=VAR
                                                              lrParte@1103350000 : Record 7010360;
                                                            BEGIN
                                                              CLEAR(lrParte);
                                                              IF lrParte.GET("N§ Parte") THEN
                                                                lrParte.VerPDF;
                                                            END;
                                                             }
                                                   { ID=63;
                                                     MenuItemType=Separator;
                                                     CaptionML=ESP="" }
                                                   { ID=53;
                                                     ShortCutKey=Ctrl+F1;
                                                     CaptionML=ESP=Marcar;
                                                     OnPush=VAR
                                                              lwVentana@1100244001 : Dialog;
                                                              lrTTOOxParte@1100244002 : Record 7010365;
                                                            BEGIN
                                                              lwVentana.OPEN(Text000);
                                                              lwVentana.INPUT(1, NFact);
                                                              lwVentana.CLOSE;

                                                              NFact := UPPERCASE(NFact);

                                                              lrTTOOxParte.RESET;
                                                              CurrForm.SETSELECTIONFILTER(lrTTOOxParte);
                                                              IF lrTTOOxParte.FINDSET THEN BEGIN
                                                              // Comprueba que las l¡neas no esten facturadas
                                                                REPEAT
                                                                  IF cFunAutoFac.parte_facturado(lrTTOOxParte) THEN
                                                                    ERROR(Text00001, lrTTOOxParte."N§ Parte");
                                                                UNTIL lrTTOOxParte.NEXT=0;
                                                                //lrTTOOxParte.TESTFIELD("N§.Factura",'');
                                                                lrTTOOxParte.MODIFYALL("N§ Factura", NFact);
                                                                IF NFact <> '' THEN
                                                                  lrTTOOxParte.MODIFYALL(Marca       , USERID);
                                                              END;
                                                            END;
                                                             }
                                                   { ID=58;
                                                     CaptionML=ESP=Desmarcar;
                                                     OnPush=VAR
                                                              lrTTOOxParte@1100244001 : Record 7010365;
                                                            BEGIN


                                                              lrTTOOxParte.RESET;
                                                              CurrForm.SETSELECTIONFILTER(lrTTOOxParte);
                                                              IF lrTTOOxParte.FINDFIRST THEN BEGIN
                                                                //lrTTOOxParte.MODIFYALL("N§ Factura", '');
                                                                lrTTOOxParte.MODIFYALL(Marca, '');
                                                              END;
                                                            END;
                                                             }
                                                   { ID=57;
                                                     Name=Desmarcar1;
                                                     CaptionML=ESP=Filtrar &Marcadas;
                                                     OnPush=BEGIN
                                                              IF GETFILTER(Marca) = '' THEN BEGIN
                                                                SETRANGE(Marca, USERID);
                                                                CurrForm.SoloMarca1.VISIBLE(TRUE);
                                                              END
                                                              ELSE
                                                              BEGIN
                                                                SETRANGE(Marca);
                                                                CurrForm.SoloMarca1.VISIBLE(FALSE);
                                                              END;
                                                            END;
                                                             }
                                                   { ID=1103350001;
                                                     ShortCutKey=Ctrl+T;
                                                     CaptionML=ESP=Totalizar Importes;
                                                     OnPush=VAR
                                                              lrToPar@1103350000 : Record 7010365;
                                                              lrPI@1103350001 : Record 7035392;
                                                              lwTotal@1103350002 : Decimal;
                                                              lwCont@1103350004 : Integer;
                                                              lwT@1103350005 : Integer;
                                                            BEGIN
                                                              // Calculamos las linea marcadas con la factura

                                                              CLEAR(lwTotal);
                                                              IF "N§ Factura" ='' THEN
                                                                ERROR(Text0001);

                                                              lrToPar.RESET;
                                                              lrToPar.SETCURRENTKEY(Confirmado,
                                                                                    "Cliente operativo",
                                                                                    Touroperador,
                                                                                    "N§ Factura");
                                                              lrToPar.SETRANGE(Confirmado  , TRUE);
                                                              lrToPar.SETRANGE("Cliente operativo"     , "Cliente operativo");
                                                              lrToPar.SETRANGE("N§ Factura", "N§ Factura");
                                                              IF lrToPar.FINDSET THEN BEGIN
                                                                lwT := lrToPar.COUNT;
                                                                CLEAR(lwCont);
                                                                wVentana.OPEN('@1@@@@@@@@@@');
                                                                REPEAT
                                                                  lrPI.RESET;
                                                                  lrPI.SETCURRENTKEY("Cliente Operativo",Touroperador,Fecha,Facturable,"N§ Prefactura");
                                                                  lrPI.SETRANGE ("Cliente Operativo"        , lrToPar."Cliente operativo");
                                                                  lrPI.SETRANGE ("N§ Prefactura", '');
                                                                  lrPI.SETRANGE (Facturable     , TRUE);
                                                                  lrPI.SETRANGE ("N§ Parte"     , lrToPar."N§ Parte");
                                                                  IF lrPI.FINDSET THEN BEGIN
                                                                    REPEAT
                                                                      lwTotal += lrPI."Importe con impuesto";
                                                                    UNTIL lrPI.NEXT=0;
                                                                  END;
                                                                  lwCont+=1;
                                                                  wVentana.UPDATE(1,ROUND(lwCont/lwT*10000,1));
                                                                UNTIL lrToPar.NEXT=0;
                                                                wVentana.CLOSE;
                                                              END;

                                                              MESSAGE(Text0002,"N§ Factura", lwTotal);
                                                            END;
                                                             }
                                                   { ID=65;
                                                     MenuItemType=Separator;
                                                     CaptionML=ESP="" }
                                                   { ID=46;
                                                     ShortCutKey=F9;
                                                     CaptionML=ESP=Calcular Parte;
                                                     OnPush=VAR
                                                              lrTTOOxParte@1100244001 : Record 7010365;
                                                              lcFun@1100244002 : Codeunit 7010318;
                                                              lrParte@1100244003 : Record 7010360;
                                                              lwNoParte@1100244004 : Code[10];
                                                            BEGIN
                                                              // Calcula los servicios seleccionados
                                                              lrTTOOxParte.COPY(Rec);
                                                              lrTTOOxParte.SETRANGE(Marca, USERID);
                                                              IF lrTTOOxParte.FINDSET THEN BEGIN
                                                                REPEAT
                                                                  IF lwNoParte <> lrTTOOxParte."N§ Parte" THEN BEGIN
                                                                    lrParte.GET(lrTTOOxParte."N§ Parte");
                                                                    //BRM 25/05/04 A¤adimos ultimo parametro para incluir tratamiento grupos
                                                                    lcFun.desconfirmar_partes(lrParte,FALSE,'',3);
                                                                    lcFun.confirmar_partes(lrParte, FALSE,'',3);
                                                                  END;
                                                                  lwNoParte := lrTTOOxParte."N§ Parte";
                                                                UNTIL lrTTOOxParte.NEXT=0;
                                                              END
                                                              ELSE BEGIN
                                                                lrParte.GET(lrTTOOxParte."N§ Parte");
                                                                //BRM 25/05/04 A¤adimos ultimo parametro para incluir tratamiento grupos
                                                                lcFun.desconfirmar_partes(lrParte,FALSE,'',3);
                                                                lcFun.confirmar_partes(lrParte, FALSE,'',3);
                                                              END;
                                                            END;
                                                             }
                                                   { ID=55;
                                                     CaptionML=ESP=Indicar precio manual;
                                                     OnPush=BEGIN
                                                              CambiaPrecioManual;
                                                            END;
                                                             }
                                                   { ID=1103350000;
                                                     CaptionML=ESP=Desconfirmar partes;
                                                     OnPush=BEGIN
                                                              cFunAboFac.DesconfirmarServiciosAutofactu(Rec);
                                                            END;
                                                             }
                                                   { ID=66;
                                                     MenuItemType=Separator;
                                                     CaptionML=ESP="" }
                                                   { ID=59;
                                                     ShortCutKey=Ctrl+P;
                                                     CaptionML=ESP=Prefacturar;
                                                     OnPush=VAR
                                                              lcFunAutofac@1100244001 : Codeunit 7035325;
                                                            BEGIN
                                                              lcFunAutofac.prefactura_autofactura(Rec);
                                                            END;
                                                             }
                                                   { ID=42;
                                                     CaptionML=ESP=Reimprimir prefactura;
                                                     OnPush=VAR
                                                              lrPref@1103355001 : Record 7010415;
                                                            BEGIN
                                                              IF "N§ Prefactura" = '' THEN
                                                                EXIT;

                                                              IF lrPref.GET("N§ Prefactura") THEN
                                                                cFactCli.ImprimirRegistroPrefactura(lrPref);
                                                            END;
                                                             }
                                                   { ID=48;
                                                     CaptionML=ESP=Deshacer prefactura;
                                                     OnPush=VAR
                                                              lcFunPar@1100244001 : Codeunit 7010318;
                                                            BEGIN
                                                              IF "N§ Prefactura" = '' THEN
                                                                EXIT;

                                                              lcFunPar.deshacer_prefactura("N§ Prefactura");
                                                            END;
                                                             }
                                                   { ID=47;
                                                     MenuItemType=Separator;
                                                     CaptionML=ESP="" }
                                                   { ID=56;
                                                     ShortCutKey=F11;
                                                     CaptionML=ESP=Facturar;
                                                     OnPush=VAR
                                                              lcFunAutofac@1100244001 : Codeunit 7035325;
                                                            BEGIN
                                                              // Crea una factura con las l¡neas marcadas con Marca=USERID
                                                              //
                                                              lcFunAutofac.crear_autofactura(Rec);
                                                            END;
                                                             }
                                                 }
                                                  }
    { 54  ;TextBox      ;220  ;7810 ;5610 ;440  ;VertGlue=Bottom;
                                                 Editable=No;
                                                 SourceExpr=rTemp.nom_cliente }
    { 60  ;Label        ;6050 ;7810 ;2200 ;440  ;Name=SoloMarca1;
                                                 HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 Visible=No;
                                                 HorzAlign=Center;
                                                 ForeColor=255;
                                                 LeaderDots=No;
                                                 CaptionML=ESP=Solo Marcados }
  }
  CODE
  {
    VAR
      Text000@1100244014 : TextConst 'ESP=N§ de Factura #1#########';
      Text001@1100244015 : TextConst 'ESP=Indique precio manual: #1###########';
      wTipoVehiculo@1100244000 : Code[10];
      wTTOO@1100244001 : Code[10];
      wRangoPaxes@1100244002 : ARRAY [2] OF Decimal;
      NFact@1100244003 : Code[10];
      texto_registro@1100244004 : TextConst 'ESP=Servicios del dia %1 al dia %2';
      err1@1100244005 : TextConst 'ESP=No se ha encontrado nada que facturar';
      ErrNoConf@1100244006 : TextConst 'ESP=El parte %1 No est  confirmado';
      rTemp@1100244007 : Record 7010420;
      tParametros@1100244008 : Record 7010311;
      err002@1100244009 : TextConst 'ESP=Se ha borrado el contrato de venta %1-%2.';
      cFunAutoFac@1100244010 : Codeunit 7035325;
      Text00001@1100244011 : TextConst 'ESP=El parte %1 ya esta facturado.';
      cFunAboFac@1103350000 : Codeunit 7010322;
      cFactCli@1103355000 : Codeunit 7010406;
      wColorMarcado@1100244012 : Integer;
      wColorFacturado@1100244013 : Integer;
      Text0001@1103350001 : TextConst 'ESP=Debe de indicar un n£mero de factura';
      wVentana@1103350002 : Dialog;
      Text0002@1103350003 : TextConst 'ESP="Total Fact %1 = %2"';

    PROCEDURE Cambiafecha@1();
    VAR
      lwFecha@1100244000 : Text[100];
    BEGIN
      // Cambiafecha
      lwFecha := GETFILTER("Filtro Fecha");
      IF lwFecha <> '' THEN
        SETFILTER("Fecha Facturacion", lwFecha)
      ELSE
        SETRANGE("Fecha Facturacion");
    END;

    PROCEDURE primeraFecha@2();
    BEGIN
      // SI NO HAY FECHA SE LE ASIGNA UNA

      IF "Filtro Fecha" = 0D THEN BEGIN
        IF "Fecha Facturacion"<>0D THEN
          SETRANGE("Filtro Fecha", "Fecha Facturacion")
        ELSE
          SETRANGE("Filtro Fecha", TODAY);
      END;
    END;

    PROCEDURE Inicializa@3();
    VAR
      lfCondTemp@1100244000 : Form 7035360;
    BEGIN
      // Inicializa
      // Cuadro de dialogo para el filtrado previo de las condiciones

      // AJF 07/01/09
      // Evito borrar el registro, ya que ahora tiene datos permanentes.
      IF rTemp.GET(USERID) THEN
        rTemp.LimpiaRegistro
      ELSE BEGIN
        rTemp.INIT;
        rTemp.Usuario := USERID;
        rTemp.INSERT;
      END;

      COMMIT;
      rTemp.SETRECFILTER;

      IF FORM.RUNMODAL(7035360, rTemp)<> ACTION::OK THEN BEGIN
        CurrForm.CLOSE;
        EXIT;
      END;
      rTemp.GET(USERID);

      //IF rTemp.FIND('-') THEN BEGIN

        RESET;
        SETCURRENTKEY(Confirmado,
                      "Cliente operativo",
                      Touroperador,
                      Bono);

        FILTERGROUP(2);
        IF rTemp.Cliente <> '' THEN
          SETRANGE("Cliente operativo" , rTemp.Cliente);
        SETRANGE(Confirmado, TRUE);
        FILTERGROUP(0);
        IF rTemp.Touroperador <> '' THEN
          SETRANGE(Touroperador , rTemp.Touroperador);
        IF rTemp.Garaje <>'' THEN
          SETRANGE(Garaje , rTemp.Garaje);
        IF rTemp."Tipos servicio" <> '' THEN
          SETFILTER("Tipo Servicio",rTemp."Tipos servicio");
        IF rTemp."Codigos Servicio" <>'' THEN
          SETFILTER("Codigo Servicio",rTemp."Codigos Servicio");
        IF rTemp."Tipos Vehiculo" <> '' THEN
          SETFILTER("Tipo Vehiculo",rTemp."Tipos Vehiculo");
        IF  (rTemp."Fecha desde" <>0D) OR (rTemp."Fecha hasta"<>0D) THEN BEGIN
          IF rTemp."Fecha desde" = rTemp."Fecha hasta" THEN
            SETRANGE ("Fecha Facturacion", rTemp."Fecha desde")
          ELSE BEGIN
            IF rTemp."Fecha desde" <> 0D THEN BEGIN
              IF rTemp."Fecha hasta" <> 0D THEN
                SETRANGE("Fecha Facturacion", rTemp."Fecha desde", rTemp."Fecha hasta")
              ELSE
                SETFILTER("Fecha Facturacion", '%1..', rTemp."Fecha desde");
            END
            ELSE BEGIN
              IF rTemp."Fecha hasta" <> 0D THEN
                SETFILTER("Fecha Facturacion", '..%1', rTemp."Fecha hasta");
            END;
          END;
        END;
        IF (rTemp."Rango Desde" <>0) OR (rTemp."Rango Hasta"<>0) THEN
          SETFILTER ("Pax Transportados",'%1..%2', rTemp."Rango Desde", rTemp."Rango Hasta");
      //END;
    END;

    PROCEDURE FiltraRangos@7();
    BEGIN
      // FiltraRangos()
      // Filtra por rangos de paxes

      IF (wRangoPaxes[1]<> 0) OR (wRangoPaxes[2]<> 0) THEN BEGIN
        IF wRangoPaxes[2]= 0 THEN
          SETFILTER("Pax Transportados",'%1..',wRangoPaxes[1])
        ELSE
          SETFILTER("Pax Transportados",'%1..%2',wRangoPaxes[1],wRangoPaxes[2])
      END ELSE
        SETRANGE("Pax Transportados");
    END;

    BEGIN
    END.
  }
}

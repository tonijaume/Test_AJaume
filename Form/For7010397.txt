OBJECT Form 7010397 Ficha Servicio
{
  OBJECT-PROPERTIES
  {
    Date=29/06/15;
    Time=10:35:46;
    Modified=Yes;
    Version List=TRANSFER;
  }
  PROPERTIES
  {
    Width=18810;
    Height=14080;
    CaptionML=ESP=Ficha Servicio;
    SourceTable=Table7010358;
    SaveTableView=No;
    UpdateOnActivate=Yes;
    PopulateAllFields=Yes;
    OnOpenForm=BEGIN
                 FiltrarGarajeUsuario;
               END;

  }
  CONTROLS
  {
    { 1   ;TabControl   ;220  ;220  ;18370;6490 ;HorzGlue=Both;
                                                 VertGlue=Top;
                                                 PageNamesML=ESP=General,Vehiculo }
    { 2   ;TextBox      ;3850 ;990  ;2750 ;440  ;ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr="N§ Servicio" }
    { 3   ;Label        ;440  ;990  ;3300 ;440  ;ParentControl=2 }
    { 4   ;TextBox      ;3850 ;1650 ;2750 ;440  ;ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=Garaje;
                                                 OnValidate=VAR
                                                              cFunBas@1100244001 : Codeunit 7010310;
                                                            BEGIN
                                                            END;
                                                             }
    { 5   ;Label        ;440  ;1650 ;3300 ;440  ;ParentControl=4 }
    { 6   ;TextBox      ;3850 ;2200 ;1650 ;440  ;ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=Fecha }
    { 7   ;Label        ;440  ;2200 ;3300 ;440  ;ParentControl=6 }
    { 8   ;TextBox      ;3850 ;2750 ;2750 ;440  ;ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=Cliente }
    { 9   ;Label        ;440  ;2750 ;3300 ;440  ;ParentControl=8 }
    { 10  ;TextBox      ;3850 ;3850 ;2750 ;440  ;ParentControl=1;
                                                 InPage=0;
                                                 NextControl=1100253001;
                                                 SourceExpr="Codigo Servicio" }
    { 11  ;Label        ;440  ;3850 ;3300 ;440  ;ParentControl=10 }
    { 12  ;TextBox      ;3850 ;4400 ;2750 ;440  ;Focusable=No;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr="Tipo Servicio" }
    { 13  ;Label        ;440  ;4400 ;3300 ;440  ;ParentControl=12 }
    { 15  ;TextBox      ;6710 ;3850 ;4730 ;440  ;Focusable=No;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=nom_codigo_servicio }
    { 16  ;TextBox      ;6710 ;2750 ;4730 ;440  ;Focusable=No;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=nom_cliente }
    { 17  ;TextBox      ;6710 ;1650 ;4730 ;440  ;Focusable=No;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=nom_garaje }
    { 21  ;TextBox      ;14080;1430 ;2200 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 HorzAlign=Center;
                                                 FontBold=Yes;
                                                 SourceExpr="Adultos Servicio" }
    { 22  ;Label        ;14080;990  ;2200 ;440  ;HorzGlue=Right;
                                                 ParentControl=21;
                                                 HorzAlign=Center;
                                                 Border=Yes;
                                                 BorderStyle=BumpDown;
                                                 BorderWidth=3pt;
                                                 LeaderDots=No }
    { 23  ;TextBox      ;16390;1430 ;1980 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 HorzAlign=Center;
                                                 FontBold=Yes;
                                                 SourceExpr="Ni¤os Servicio" }
    { 24  ;Label        ;16390;990  ;1980 ;440  ;HorzGlue=Right;
                                                 ParentControl=23;
                                                 HorzAlign=Center;
                                                 Border=Yes;
                                                 BorderStyle=BumpDown;
                                                 BorderWidth=3pt;
                                                 LeaderDots=No }
    { 1100244000;TextBox;14410;2200 ;3960 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=Referencia }
    { 1100244001;Label  ;11660;2200 ;2640 ;440  ;HorzGlue=Right;
                                                 ParentControl=1100244000 }
    { 1100244002;TextBox;14410;2750 ;3520 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=Letreros }
    { 1100244003;Label  ;11660;2750 ;2640 ;440  ;HorzGlue=Right;
                                                 ParentControl=1100244002 }
    { 1100244004;TextBox;14410;3850 ;2640 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 NextControl=1100244011;
                                                 SourceExpr="Origen/Destino" }
    { 1100244005;Label  ;11660;3850 ;2640 ;440  ;HorzGlue=Right;
                                                 ParentControl=1100244004 }
    { 1100244007;TextBox;3850 ;3300 ;2750 ;440  ;ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=Touroperador }
    { 1100244008;Label  ;440  ;3300 ;3300 ;440  ;ParentControl=1100244007 }
    { 1100244009;TextBox;14410;4400 ;3960 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 NextControl=18;
                                                 SourceExpr=Presentacion }
    { 1100244010;Label  ;11660;4400 ;2640 ;440  ;HorzGlue=Right;
                                                 ParentControl=1100244009 }
    { 1100244011;TextBox;14410;5500 ;1100 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 NextControl=1100244019;
                                                 SourceExpr="Hora inicio";
                                                 Format=<Hours24,2>:<Minutes,2> }
    { 1100244012;TextBox;14410;3300 ;3960 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=Guia }
    { 1100244013;Label  ;11660;3300 ;2640 ;440  ;HorzGlue=Right;
                                                 ParentControl=1100244012 }
    { 1100244016;TextBox;3850 ;5500 ;2750 ;440  ;Editable=No;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=Usuario }
    { 1100244017;Label  ;440  ;5500 ;3300 ;440  ;ParentControl=1100244016 }
    { 1100244019;TextBox;15950;5500 ;1100 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 NextControl=1100244009;
                                                 SourceExpr="Hora Final";
                                                 Format=<Hours24,2>:<Minutes,2> }
    { 1100244020;Label  ;11660;5500 ;2640 ;440  ;HorzGlue=Right;
                                                 ParentControl=1100244019;
                                                 CaptionML=ESP=Horario servicio }
    { 1100244018;CommandButton;5600;2200;550;440;Name=Boton1;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 CaptionML=ESP=...;
                                                 OnPush=VAR
                                                          lrRangoPl@1100244000 : Record 7010430;
                                                        BEGIN
                                                          CLEAR(fCalendar);
                                                          fCalendar.RUNMODAL;

                                                          wFecha := fCalendar.GetChosenDate;
                                                          IF wFecha <> 0D THEN BEGIN
                                                            VALIDATE(Fecha, wFecha);
                                                            MODIFY;
                                                          END;
                                                          CurrForm.UPDATECONTROLS;
                                                        END;
                                                         }
    { 1100244021;Label  ;15510;5500 ;440  ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 HorzAlign=Center;
                                                 LeaderDots=No;
                                                 CaptionML=ESP=- }
    { 1100244022;TextBox;14410;6050 ;2640 ;440  ;HorzGlue=Right;
                                                 Visible=Yes;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr="Cod Grupo";
                                                 TableRelation=Grupos."Codigo Grupo" WHERE (Cliente=FIELD(Cliente),
                                                                                            TTOO=FIELD(Touroperador),
                                                                                            Confirmado=CONST(Yes),
                                                                                            Facturado=CONST(No));
                                                 LookupFormID=Lista Grupos }
    { 1100244023;Label  ;11660;6050 ;2640 ;440  ;HorzGlue=Right;
                                                 ParentControl=1100244022 }
    { 1100253000;CheckBox;18040;2750;440  ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 ShowCaption=No;
                                                 ToolTipML=ESP=Imprimir Letreros;
                                                 SourceExpr="Imprimir Letreros" }
    { 1100253001;TextBox;3850 ;4950 ;5500 ;440  ;ParentControl=1;
                                                 InPage=0;
                                                 NextControl=1100253003;
                                                 SourceExpr=Vuelos }
    { 1100253002;Label  ;440  ;4950 ;3300 ;440  ;ParentControl=1100253001 }
    { 1100253003;TextBox;9570 ;4950 ;1700 ;440  ;ParentControl=1;
                                                 InPage=0;
                                                 NextControl=1100244000;
                                                 SourceExpr="Hora Vuelo";
                                                 Format=<Hours24,2>:<Minutes,2> }
    { 1100253004;Label  ;9570 ;4400 ;1760 ;440  ;ParentControl=1100253003;
                                                 HorzAlign=Center;
                                                 FontBold=Yes;
                                                 LeaderDots=No }
    { 1103355004;CheckBox;10890;5500;440  ;440  ;ParentControl=1;
                                                 InPage=0;
                                                 ShowCaption=No;
                                                 SourceExpr=Privado }
    { 1103355005;Label  ;6820 ;5500 ;3960 ;440  ;ParentControl=1103355004 }
    { 1103355006;TextBox;14410;4950 ;3960 ;440  ;HorzGlue=Right;
                                                 ParentControl=1;
                                                 InPage=0;
                                                 SourceExpr=Finalizacion }
    { 1103355007;Label  ;11660;4950 ;2640 ;440  ;HorzGlue=Right;
                                                 ParentControl=1103355006 }
    { 1103355000;CheckBox;3850;990  ;440  ;440  ;ParentControl=1;
                                                 InPage=1;
                                                 ShowCaption=No;
                                                 SourceExpr="Vehiculo Escolar" }
    { 1103355001;Label  ;440  ;990  ;3300 ;440  ;ParentControl=1103355000 }
    { 1103355002;CheckBox;3850;1540 ;440  ;440  ;ParentControl=1;
                                                 InPage=1;
                                                 ShowCaption=No;
                                                 SourceExpr="Vehiculo Minusvalidos" }
    { 1103355003;Label  ;440  ;1540 ;3300 ;440  ;ParentControl=1103355002 }
    { 1103355008;CheckBox;3850;2090 ;440  ;440  ;ParentControl=1;
                                                 InPage=1;
                                                 ShowCaption=No;
                                                 SourceExpr="Vehiculo especial" }
    { 1103355009;Label  ;440  ;2090 ;3300 ;440  ;ParentControl=1103355008 }
    { 14  ;CommandButton;16390;13310;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 PushAction=FormHelp }
    { 18  ;SubForm      ;220  ;6930 ;18370;6160 ;Name=SubHotSer;
                                                 HorzGlue=Both;
                                                 VertGlue=Both;
                                                 Border=No;
                                                 SubFormID=Form7010398;
                                                 SubFormView=SORTING(N§ Servicio);
                                                 SubFormLink=N§ Servicio=FIELD(N§ Servicio) }
    { 19  ;MenuButton   ;13970;13310;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 CaptionML=ESP=&Servicios;
                                                 Menu=MENUITEMS
                                                 {
                                                   { ID=20;
                                                     Visible=No;
                                                     PushAction=LookupTable;
                                                     ShortCutKey=F5;
                                                     CaptionML=ESP=Lista }
                                                   { ID=29;
                                                     PushAction=RunObject;
                                                     CaptionML=[ENU=Change log;
                                                                ESP=Log de cambios];
                                                     RunObject=Form 7010403;
                                                     RunFormView=SORTING(Tipo Fichero);
                                                     RunFormLink=Tipo Fichero=CONST(Servicio),
                                                                 N§=FIELD(N§ Servicio) }
                                                   { ID=40;
                                                     MenuItemType=Separator;
                                                     CaptionML=ESP="" }
                                                   { ID=36;
                                                     ShortCutKey=Ctrl+O;
                                                     CaptionML=ESP=T&otalizar por Letras;
                                                     OnPush=VAR
                                                              rSP@1100244001 : Record 7010359;
                                                              rT@1100244002 : Record 7010367;
                                                              vTotAD@1100244003 : Decimal;
                                                              vTotNI@1100244004 : Decimal;
                                                            BEGIN
                                                              rT.RESET;
                                                              rT.SETCURRENTKEY(Usuario,Orden,"Hora Vuelo",Vuelo,Letra);
                                                              rT.SETRANGE(Usuario,USERID);
                                                              rT.DELETEALL;

                                                              vTotAD := 0;
                                                              vTotNI := 0;

                                                              rSP.RESET;
                                                              rSP.SETCURRENTKEY("N§ Servicio");
                                                              rSP.SETRANGE("N§ Servicio","N§ Servicio");
                                                              IF rSP.FINDSET THEN REPEAT
                                                                rT.SETRANGE("Hora Vuelo",rSP."Hora Vuelo");
                                                                rT.SETRANGE(Vuelo,rSP.Vuelo);
                                                                rT.SETRANGE(Letra,rSP.Letra);
                                                                IF NOT rT.FINDFIRST THEN BEGIN
                                                                  rT.INIT;
                                                                  rT."Hora Vuelo" := rSP."Hora Vuelo";
                                                                  rT.Vuelo        := rSP.Vuelo;
                                                                  rT.Letra        := rSP.Letra;
                                                                  rT.Orden        := 1;
                                                                  rT.INSERT(TRUE);
                                                                END;

                                                                vTotAD += rSP."Adultos transportados";
                                                                vTotNI += rSP."Ni¤os transportados";

                                                                rT."Adultos Transportados" += rSP."Adultos transportados";
                                                                rT."Ni¤os Transportados"   += rSP."Ni¤os transportados";
                                                                rT.Transportados           := rT."Adultos Transportados" + rT."Ni¤os Transportados";
                                                                rT.MODIFY;

                                                              UNTIL rSP.NEXT=0;

                                                              rT.SETRANGE("Hora Vuelo");
                                                              rT.SETRANGE(Vuelo);
                                                              rT.SETRANGE(Letra);

                                                              //Grabamos el registro de TOTAL.
                                                              rT.INIT;
                                                              rT."Hora Vuelo" := 0T;
                                                              rT.Vuelo        := '';
                                                              rT.Letra        := Text000;
                                                              rT.Orden        := 2;
                                                              rT."Adultos Transportados" := vTotAD;
                                                              rT."Ni¤os Transportados"   := vTotNI;
                                                              rT.Transportados           := rT."Adultos Transportados" + rT."Ni¤os Transportados";
                                                              rT.INSERT(TRUE);

                                                              FORM.RUN(7010416,rT);
                                                            END;
                                                             }
                                                   { ID=1100244006;
                                                     ShortCutKey=Ctrl+R;
                                                     CaptionML=ESP=Crea servicio copiado;
                                                     OnPush=VAR
                                                              lrSer@1100244000 : Record 7010358;
                                                            BEGIN
                                                              // Primero comprobamos que los datos principales estan rellenados

                                                              IF (Garaje = '') OR (Fecha = 0D) OR (Cliente = '') OR ("Codigo Servicio" = '') THEN
                                                                ERROR(Text001);

                                                              rPar.FINDFIRST;

                                                              CASE rPar."Empresa Real" OF
                                                                rPar."Empresa Real"::TRN, rPar."Empresa Real"::CNT:
                                                                BEGIN
                                                                  rSerPar.RESET;
                                                                  rSerPar.SETRANGE("N§ Servicio", "N§ Servicio");
                                                                  rSerPar.SETRANGE("N§ Parte"   , '');
                                                                  IF rSerPar.FINDFIRST THEN
                                                                    ERROR(Text002);
                                                                END;
                                                              END;

                                                              lrSer := Rec;
                                                              lrSer."N§ Servicio" := '';
                                                              lrSer.INSERT(TRUE);

                                                              lrSer.Fecha            := Fecha;
                                                              lrSer.MODIFY;

                                                              Rec := lrSer;
                                                              CurrForm.UPDATECONTROLS;
                                                            END;
                                                             }
                                                 }
                                                  }
    { 25  ;MenuButton   ;11550;13310;2200 ;550  ;HorzGlue=Right;
                                                 VertGlue=Bottom;
                                                 CaptionML=ESP=&Lineas;
                                                 Menu=MENUITEMS
                                                 {
                                                   { ID=30;
                                                     CaptionML=ESP=Historia;
                                                     OnPush=VAR
                                                              rSerPar@1100244001 : Record 7010359;
                                                              rHist@1100244002 : Record 7010361;
                                                              fTabHisSerPar@1100244003 : Form 7010403;
                                                            BEGIN
                                                              rSerPar.RESET; rSerPar.INIT;
                                                              CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);
                                                              rHist.RESET; rHist.INIT;
                                                              rHist.SETRANGE("Tipo Fichero", rHist."Tipo Fichero"::Linea);
                                                              rHist.SETRANGE("N§"          , rSerPar."N§ Servicio");
                                                              rHist.SETRANGE("N§ Linea"    , rSerPar."N§ Linea");
                                                              CLEAR(fTabHisSerPar);
                                                              fTabHisSerPar.SETTABLEVIEW(rHist);
                                                              fTabHisSerPar.RUNMODAL;
                                                            END;
                                                             }
                                                   { ID=33;
                                                     ShortCutKey=Ctrl+S;
                                                     CaptionML=ESP=Suplementos;
                                                     OnPush=VAR
                                                              rSerPar@1100244001 : Record 7010359;
                                                              rSuplLin@1100244002 : Record 7010363;
                                                              fTabSupl@1100244003 : Form 7010408;
                                                            BEGIN
                                                              rSerPar.RESET; rSerPar.INIT;
                                                              CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);
                                                              CLEAR(fTabSupl);

                                                              // No mostramos nada si a£n no se ha creado la linea
                                                              IF rSerPar."N§ Linea"=0 THEN
                                                                EXIT;

                                                              rSuplLin.RESET; rSuplLin.INIT;
                                                              rSuplLin.FILTERGROUP(2);
                                                              rSuplLin.SETRANGE("N§ Servicio", rSerPar."N§ Servicio");
                                                              rSuplLin.SETRANGE("N§ Linea"   , rSerPar."N§ Linea");
                                                              rSuplLin.SETRANGE("N§ Parte"   , rSerPar."N§ Parte");
                                                              rSuplLin.FILTERGROUP(0);

                                                              fTabSupl.SETTABLEVIEW(rSuplLin);
                                                              fTabSupl.RUNMODAL;
                                                            END;
                                                             }
                                                   { ID=34;
                                                     ShortCutKey=Ctrl+T;
                                                     CaptionML=ESP=Parte asociado;
                                                     OnPush=VAR
                                                              rSerPar@1100244001 : Record 7010359;
                                                              rParte@1100244002 : Record 7010360;
                                                              fFicPar@1100244003 : Form 7010400;
                                                            BEGIN
                                                              rSerPar.RESET; rSerPar.INIT;
                                                              CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);
                                                              IF rSerPar."N§ Parte" = '' THEN
                                                                EXIT;
                                                              rParte.RESET; rParte.INIT;
                                                              rParte.GET(rSerPar."N§ Parte");
                                                              rParte.SETRECFILTER;

                                                              CLEAR(fFicPar);
                                                              fFicPar.SETTABLEVIEW(rParte);
                                                              fFicPar.RUNMODAL;
                                                            END;
                                                             }
                                                   { ID=41;
                                                     MenuItemType=Separator;
                                                     CaptionML=ESP="" }
                                                   { ID=26;
                                                     ShortCutKey=F11;
                                                     CaptionML=ESP=Crear Parte;
                                                     OnPush=VAR
                                                              rSerPar@1100244001 : Record 7010359;
                                                              rSerPar2@1100244002 : Record 7010359;
                                                              rParte@1100244003 : Record 7010360;
                                                              rCond@1100244004 : Record 7010420;
                                                              rTipoSer@1100244005 : Record 7010319;
                                                              fFicNuePar@1100244006 : Form 7035261;
                                                              vVehiculo@1100244007 : Code[10];
                                                            BEGIN
                                                              rPar.FINDFIRST;

                                                              IF ("Codigo Servicio" = '')  OR (Touroperador = '') THEN BEGIN
                                                                CurrForm.Garaje.ACTIVATE;
                                                                ERROR(err6);
                                                              END;

                                                              // Comprobamos que exista alguna linea marcada y que aun no este dentro de ningun parte, sino, entendemos que se van a
                                                              // meter todas las lineas sin parte en el parte que estamos creando

                                                              rSerPar.RESET; rSerPar.INIT;
                                                              CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);
                                                              rSerPar.MARKEDONLY(TRUE);
                                                              rSerPar.SETRANGE("N§ Parte", '');
                                                              IF NOT rSerPar.FINDFIRST THEN BEGIN
                                                                rSerPar.SETRANGE("N§ Servicio", "N§ Servicio");
                                                                rSerPar.MARKEDONLY(FALSE);
                                                                IF NOT rSerPar.FINDFIRST THEN
                                                                  ERROR(err1);
                                                              END;

                                                              // Comprobar que no hay campos importantes sin rellenar en las lineas

                                                              IF rSerPar.FINDSET THEN BEGIN
                                                                REPEAT
                                                                  ComprobarCamposEnBlanco(rSerPar);
                                                                UNTIL rSerPar.NEXT=0;
                                                                rSerPar.FINDFIRST;
                                                              END;

                                                              // Vamos a utilizar el fichero de condiciones temporales para pedir al usuario si desea dar un
                                                              // numero determinado al parte o acepta el n§ dado por el sistema.

                                                              CLEAR(fFicNuePar);

                                                              // AJF 07/01/09
                                                              // Evito borrar el registro, ya que ahora tiene datos permanentes.
                                                              IF rCond.GET(USERID) THEN
                                                                rCond.LimpiaRegistro
                                                              ELSE BEGIN
                                                                rCond.INIT;
                                                                rCond.Usuario := USERID;
                                                                rCond.INSERT;
                                                              END;

                                                              rCond.Guia    := Guia;
                                                              rCond.MODIFY;
                                                              COMMIT;
                                                              rCond.FILTERGROUP(2);
                                                              rCond.SETRANGE(Usuario, USERID);
                                                              fFicNuePar.SETRECORD(rCond);
                                                              fFicNuePar.SETTABLEVIEW(rCond);
                                                              IF fFicNuePar.RUNMODAL <> ACTION::OK THEN
                                                                EXIT;

                                                              rCond.GET(USERID);

                                                              // Crear el registro de parte a partir de la informacion de la ficha de servicio

                                                              // BRM 04/06/04 Insertamos parte nuevo por cada linea que tenga vehiculo distinto

                                                              IF rSerPar.FINDSET THEN BEGIN
                                                                wPrimerParteCreado := TRUE;
                                                                vVehiculo          := rSerPar.Vehiculo;
                                                                REPEAT

                                                                  IF (vVehiculo <> rSerPar.Vehiculo) THEN BEGIN
                                                                    rSerPar2.COPY(rSerPar);
                                                                    rSerPar2.SETRANGE(Vehiculo, vVehiculo);
                                                                    CrearParte(rSerPar2, rCond, rParte);
                                                                    vVehiculo := rSerPar.Vehiculo;
                                                                  END;

                                                                UNTIL rSerPar.NEXT=0;

                                                                vVehiculo := rSerPar.Vehiculo;
                                                                rSerPar2.COPY(rSerPar);
                                                                rSerPar2.SETRANGE(Vehiculo, vVehiculo);
                                                                CrearParte(rSerPar2, rCond, rParte);
                                                                CurrForm.UPDATE;
                                                              END;
                                                            END;
                                                             }
                                                   { ID=27;
                                                     ShortCutKey=Ctrl+P;
                                                     CaptionML=ESP=A¤adir a Parte;
                                                     OnPush=VAR
                                                              rParte@1100244001 : Record 7010360;
                                                              rSerPar@1100244002 : Record 7010359;
                                                              fTabPar@1100244003 : Form 7010401;
                                                              w_Sin_Marcas@1100244004 : Boolean;
                                                              rrSerPar@1100244005 : Record 7010359;
                                                            BEGIN

                                                              rSerPar.RESET; rSerPar.INIT;
                                                              CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);
                                                              rSerPar.MARKEDONLY(TRUE);

                                                              // JPT - Mira si hay alguna linea marcada, y si alguna de ellas ya tienen parte asignado  ----
                                                              // ----  tambien se comprueba si alguno de los campos importantes esta en blanco          ----

                                                              IF rSerPar.FINDSET THEN BEGIN
                                                                w_Sin_Marcas:=FALSE;
                                                                REPEAT
                                                                  IF rSerPar."N§ Parte" <> '' THEN
                                                                    ERROR(err4);
                                                                  ComprobarCamposEnBlanco(rSerPar);
                                                                UNTIL rSerPar.NEXT=0;
                                                              END
                                                              ELSE BEGIN
                                                                w_Sin_Marcas := TRUE;
                                                                rSerPar.RESET;
                                                                CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);
                                                                IF rSerPar."N§ Parte" <> '' THEN
                                                                  ERROR(err2);
                                                                ComprobarCamposEnBlanco(rSerPar);
                                                              END;

                                                              CLEAR(rParte);
                                                              rParte.SETCURRENTKEY(Confirmado,
                                                                                   Fecha);
                                                              rParte.FILTERGROUP(2);
                                                              rParte.SETRANGE(Confirmado       , FALSE);
                                                              rParte.SETRANGE(Fecha            , Fecha);
                                                              rParte.SETRANGE(Cliente          , Cliente);
                                                              rParte.SETRANGE("Codigo Servicio", "Codigo Servicio");
                                                              rParte.SETRANGE("Tipo Servicio"  , "Tipo Servicio");
                                                              rParte.FILTERGROUP(0);
                                                              CLEAR(fTabPar);
                                                              fTabPar.SETTABLEVIEW(rParte);
                                                              fTabPar.LOOKUPMODE := TRUE;
                                                              fTabPar.EDITABLE := FALSE;
                                                              IF fTabPar.RUNMODAL = ACTION::LookupOK THEN BEGIN
                                                                fTabPar.GETRECORD(rParte);


                                                              IF w_Sin_Marcas THEN BEGIN
                                                                rSerPar.es_a¤adir(TRUE);
                                                                rSerPar.VALIDATE("N§ Parte", rParte."N§ Parte");
                                                                rSerPar.MODIFY(TRUE);
                                                              END
                                                              ELSE
                                                                IF rSerPar.FINDSET(TRUE) THEN
                                                                  BEGIN
                                                                    rrSerPar.COPY(rSerPar);
                                                                    REPEAT
                                                                      rSerPar.es_a¤adir(TRUE);
                                                                      rSerPar.VALIDATE("N§ Parte", rParte."N§ Parte");
                                                                      rSerPar.MODIFY(TRUE);
                                                                    UNTIL rSerPar.NEXT=0;
                                                                    rSerPar.MARKEDONLY(FALSE);

                                                                    // JPT - Ahora desmarcar  las l¡neas marcadas

                                                                    REPEAT
                                                                      IF rSerPar.GET(rrSerPar."N§ Servicio", rrSerPar."N§ Linea") THEN
                                                                        rSerPar.MARK(FALSE);
                                                                    UNTIL rrSerPar.NEXT=0;
                                                                END;

                                                                // ----  Refrescar el registro de partes para tomar las modificaciones de paxes  ----

                                                                rParte.GET(rParte."N§ Parte");
                                                                rParte.ProratearViajes; // AJF 04/11/10
                                                                CurrForm.SubHotSer.FORM.modifica_registro(rSerPar);
                                                              END;
                                                              // ----  Actualiza la hora del 1er vuelo  ----

                                                              rSerPar.Actualiza_Hora1erVuelo_Partes(rParte."N§ Parte",'',0);

                                                              // ----  AJS 15.10.2001  Mantenimiento del campo Zona Parte a partir de los puntos de  ----
                                                              // ----  recogida, se pone la zona fisica mas alejada                                  ----

                                                              rSerPar.ultima_zona_fisica(rParte, FALSE, FALSE);
                                                            END;
                                                             }
                                                   { ID=28;
                                                     ShortCutKey=Ctrl+F11;
                                                     CaptionML=ESP=Desasignar linea;
                                                     OnPush=VAR
                                                              rSerPar@1100244001 : Record 7010359;
                                                              rParte@1100244002 : Record 7010360;
                                                              lrPar@1000000001 : Record 7010311;
                                                            BEGIN
                                                              //CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);
                                                              CurrForm.SubHotSer.FORM.GETRECORD(rSerPar);

                                                              rSerPar.MiraSiEsUltimaLineaParte;
                                                              IF NOT CONFIRM(conf1) THEN
                                                                EXIT;

                                                              rParte.RESET; rParte.INIT;
                                                              rParte.GET(rSerPar."N§ Parte");
                                                              IF rParte.Confirmado THEN
                                                                ERROR(err3);

                                                              rParte.GET(rSerPar."N§ Parte");
                                                              rSerPar.es_baja(TRUE);
                                                              rSerPar.mantener_touroperador_parte(rParte); // Desasigna el TTOO

                                                              // AJF 17/03/08
                                                              // Para las l¡neas de shuttle el vuelo debe permanecer en la l¡nea.
                                                              lrPar.FINDFIRST;
                                                              IF (rSerPar."Origen creacion" <> rSerPar."Origen creacion"::Shuttle) OR
                                                                 (lrPar."Empresa Real" = lrPar."Empresa Real"::IBZ) THEN
                                                              BEGIN
                                                                rSerPar.TraspasaVuelo;

                                                                rSerPar.VALIDATE("N§ Parte", '');
                                                                rSerPar.MODIFY(TRUE);
                                                                CurrForm.SubHotSer.FORM.modifica_registro(rSerPar);

                                                              END
                                                              ELSE BEGIN

                                                                cuFShuttle.TraspasarLinea(rSerPar, 0, '',Text50000);

                                                              END;
                                                              // ----   Actualizar el campo touroperadores a partir de las lineas que quedan  ----

                                                              // ----  AJS 22.01.2002  ----
                                                              // ----  Refrescar el registro de parte para coger las modificaciones en paxes  ----

                                                              saca_paxes_desasigna(rParte."N§ Parte", rSerPar);
                                                              rParte.GET(rParte."N§ Parte");

                                                              // AJF 17/03/08
                                                              // TrapasarLinea crea una linea nueva sin asignar a ning£n parte, as¡ que tenemos
                                                              // que borrar la l¡nea antigua.
                                                              IF (rSerPar."Origen creacion" = rSerPar."Origen creacion"::Shuttle) AND
                                                                 (lrPar."Empresa Real" <> lrPar."Empresa Real"::IBZ) THEN
                                                                rSerPar.DELETE;

                                                              // ----  Actualiza la hora del 1er vuelo  ----

                                                              rSerPar.Actualiza_Hora1erVuelo_Partes(rParte."N§ Parte",'',0);

                                                              // ----  AJS 15.10.2001  Mantenimiento del campo Zona Parte a partir de los puntos de  ----
                                                              // ----  recogida, se pone la zona fisica mas alejada                                  ----

                                                              rSerPar.ultima_zona_fisica(rParte, TRUE, FALSE);
                                                            END;
                                                             }
                                                   { ID=1103350002;
                                                     MenuItemType=Separator }
                                                   { ID=1103350000;
                                                     CaptionML=ESP=Impresion Parte;
                                                     OnPush=VAR
                                                              lrParte@1103350003 : Record 7010360;
                                                              lrSerPar@1103350005 : Record 7010359;
                                                              lrSerPar2@1103350006 : Record 7010359;
                                                              lrInf@1103350002 : Record 2000000001;
                                                              lrPar@1103350001 : Record 7010311;
                                                              vIdInforme@1103350000 : Integer;
                                                              lwPartes@1103350007 : Text[250];
                                                              lwNoPartes@1103350008 : Integer;
                                                              lwOp@1103350009 : Integer;
                                                            BEGIN
                                                              CLEAR(lrSerPar);

                                                              CLEAR(lwNoPartes);
                                                              CurrForm.SubHotSer.FORM.GETRECORD(lrSerPar);
                                                              lrSerPar2.COPY(lrSerPar);
                                                              lrSerPar2.SETRANGE("N§ Servicio","N§ Servicio");
                                                              lrSerPar2.SETFILTER("N§ Parte"  ,'<>%1','');
                                                              // Concatenamos todos los partes en una cadena
                                                              IF lrSerPar2.FINDSET THEN BEGIN
                                                                CLEAR(lwPartes);
                                                                REPEAT
                                                                  IF STRPOS(lwPartes,lrSerPar2."N§ Parte") = 0 THEN BEGIN // Si no existe en la cadena
                                                                    IF lwPartes <>'' THEN
                                                                      lwPartes := lwPartes + '|';
                                                                    lwPartes := lwPartes + lrSerPar2."N§ Parte";
                                                                    lwNoPartes +=1;
                                                                  END;
                                                                UNTIL lrSerPar2.NEXT=0;
                                                              END;

                                                              IF lwNoPartes=0 THEN
                                                                ERROR(Text006);

                                                              lwOp:=2;
                                                              // Pedimos si quiere imprimir todos los partes del servicio o solo el seleccionado
                                                              IF lwNoPartes > 1 THEN
                                                                lwOp:= STRMENU(Text007,1);

                                                              IF lwOp=0 THEN
                                                                EXIT;

                                                              lrParte.RESET;
                                                              lrParte.SETRANGE(Fecha     , Fecha);
                                                              CASE lwOp OF
                                                                1: lrParte.SETFILTER("N§ Parte", lwPartes);
                                                                2: lrParte.SETRANGE("N§ Parte" , lrSerPar."N§ Parte");
                                                              END;

                                                              vIdInforme := 7000198;

                                                              lrPar.FINDFIRST;
                                                              IF lrInf.GET(lrInf.Type::Report, '', lrPar."Informe partes trabajo") THEN
                                                                vIdInforme := lrInf.ID;

                                                              REPORT.RUN(vIdInforme, TRUE, TRUE, lrParte);
                                                            END;
                                                             }
                                                   { ID=37;
                                                     ShortCutKey=Ctrl+W;
                                                     CaptionML=ESP=Impresi¢n Codigo Barras;
                                                     OnPush=VAR
                                                              lrParte@1103350000 : Record 7010360;
                                                            BEGIN
                                                              CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);
                                                              IF rSerPar."N§ Parte" = '' THEN
                                                                ERROR(Text005);

                                                              CLEAR(lrParte);
                                                              lrParte.GET(rSerPar."N§ Parte");
                                                              lrParte.SETRECFILTER;
                                                              REPORT.RUNMODAL(7010412,FALSE,FALSE,lrParte);
                                                            END;
                                                             }
                                                 }
                                                  }
    { 1100244014;CommandButton;220;13310;550;550;VertGlue=Bottom;
                                                 ShowCaption=No;
                                                 BitmapPos=Center;
                                                 Bitmap=15;
                                                 OnPush=BEGIN
                                                          CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);

                                                          rSerPar2.COPY(rSerPar);
                                                          IF rSerPar2.NEXT(-1) = 0 THEN
                                                            ERROR(Text003);


                                                          rSerPar3.COPY(rSerPar2);
                                                          IF rSerPar3.NEXT(-1) = 0 THEN
                                                            wNumLinea := ROUND( (rSerPar2."N§ Linea" + 0) / 2, 1)
                                                          ELSE
                                                            wNumLinea := ROUND( (rSerPar2."N§ Linea" + rSerPar3."N§ Linea") / 2, 1);

                                                          WHILE rSerPar2.GET(rSerPar."N§ Servicio", wNumLinea) DO
                                                            wNumLinea := ROUND((rSerPar2."N§ Linea" + wNumLinea) / 2, 1); ;

                                                          rSerPar2 := rSerPar;
                                                          rSerPar2."N§ Linea" := wNumLinea;
                                                          rSerPar2.INSERT;

                                                          // Hay que tratar los suplementos que tambien se mueven de linea

                                                          rSupl.RESET;
                                                          rSupl.SETRANGE("N§ Servicio", rSerPar."N§ Servicio");
                                                          rSupl.SETRANGE("N§ Linea"   , rSerPar."N§ Linea");
                                                          IF rSupl.FINDSET(TRUE) THEN BEGIN
                                                            REPEAT
                                                              rSupl2 := rSupl;
                                                              rSupl2."N§ Linea" := wNumLinea;
                                                              rSupl2.INSERT;

                                                              rSupl3 := rSupl;
                                                              rSupl3.DELETE;
                                                            UNTIL rSupl.NEXT = 0;
                                                          END;

                                                          rSerPar.DELETE;

                                                          CurrForm.SubHotSer.FORM.registro_actual(rSerPar2);
                                                        END;
                                                         }
    { 1100244015;CommandButton;880;13310;550;550;VertGlue=Bottom;
                                                 ShowCaption=No;
                                                 BitmapPos=Center;
                                                 Bitmap=16;
                                                 OnPush=BEGIN
                                                          CurrForm.SubHotSer.FORM.pasa_registro(rSerPar);

                                                          rSerPar2.COPY(rSerPar);
                                                          IF rSerPar2.NEXT = 0 THEN
                                                            ERROR(Text004);

                                                          rSerPar3.COPY(rSerPar2);

                                                          IF rSerPar3.NEXT = 0 THEN
                                                            wNumLinea := ROUND( (rSerPar2."N§ Linea" + 9999999) / 2, 1)
                                                          ELSE
                                                            wNumLinea := ROUND( (rSerPar2."N§ Linea" + rSerPar3."N§ Linea") / 2, 1);

                                                          WHILE rSerPar2.GET(rSerPar."N§ Servicio", wNumLinea) DO
                                                            wNumLinea := ROUND((rSerPar2."N§ Linea" + wNumLinea) / 2, 1); ;

                                                          rSerPar2 := rSerPar;
                                                          rSerPar2."N§ Linea" := wNumLinea;
                                                          rSerPar2.INSERT;

                                                          // Hay que tratar los suplementos que tambien se mueven de linea

                                                          rSupl.RESET;
                                                          rSupl.SETRANGE("N§ Servicio", rSerPar."N§ Servicio");
                                                          rSupl.SETRANGE("N§ Linea"   , rSerPar."N§ Linea");
                                                          IF rSupl.FINDSET(TRUE) THEN BEGIN
                                                            REPEAT
                                                              rSupl2 := rSupl;
                                                              rSupl2."N§ Linea" := wNumLinea;
                                                              rSupl2.INSERT;

                                                              rSupl3 := rSupl;
                                                              rSupl3.DELETE;
                                                            UNTIL rSupl.NEXT = 0;
                                                          END;

                                                          rSerPar.DELETE;

                                                          CurrForm.SubHotSer.FORM.registro_actual(rSerPar2);
                                                        END;
                                                         }
  }
  CODE
  {
    VAR
      Text50000@1103355001 : TextConst 'ESP=SHU_DES';
      Text000@1100244010 : TextConst 'ESP=TOTAL';
      err1@1100244000 : TextConst 'ESP=No hay lineas pendientes asignar a un parte de trabajo.';
      err2@1100244001 : TextConst 'ESP=Esta linea ya esta asignada a un parte.';
      err3@1100244002 : TextConst 'ESP=No se puede modificar un parte confirmado.';
      err4@1100244003 : TextConst 'ESP=Hay lineas marcadas que ya se han asignado a alg£n parte';
      conf1@1100244004 : TextConst 'ESP=Seguro de que desea deasignar este punto de recogida del parte';
      err5@1100244005 : TextConst 'ESP=No se puede dejar el campo %1 en blanco';
      err5a@1100244006 : TextConst 'ESP=Punto recogida';
      err5b@1100244007 : TextConst 'ESP=Touroperador';
      err5c@1100244008 : TextConst 'ESP=Adultos transportados o Ni¤os transportados';
      err6@1100244009 : TextConst 'ESP="No se puede dejar el ''Codigo Servicio'' sin rellenar "';
      Text001@1100244011 : TextConst 'ESP=Para realizar una copia el original debe tener los datos principales rellenados';
      rSerPar@1100244012 : Record 7010359;
      Text002@1100244013 : TextConst 'ESP=Hay que asignar todas las lineas de recogida a un parte de trabajo antes de abandonar el servicio.';
      rSerPar2@1100244015 : Record 7010359;
      rSerPar3@1100244019 : Record 7010359;
      rSupl@1100244020 : Record 7010363;
      rSupl2@1100244021 : Record 7010363;
      rSupl3@1100244022 : Record 7010363;
      rPar@1100244014 : Record 7010311;
      Text003@1100244016 : TextConst 'ESP=Este hotel ya es el primer hotel del servicio.';
      Text004@1100244018 : TextConst 'ESP=Este hotel ya es el ultimo hotel del servicio.';
      rGrupos@1103350001 : Record 7010373;
      fCalendar@1100244026 : Form 7035306;
      fGrupos@1100244029 : Form 7010452;
      Text005@1103350004 : TextConst 'ESP=Esta linea No est  asignada a ning£n parte.';
      Text006@1103350005 : TextConst 'ESP=No se encontr¢ ning£n pate que imprimir';
      Text007@1103350006 : TextConst 'ESP=Imprimir Todos,Imprimir Actual';
      err7@1100244030 : TextConst 'ESP=No se pueden crear partes asociados al Grupo %1 definido en el servicio %2.';
      wNumLinea@1103350000 : Integer;
      wFecha@1103350002 : Date;
      wPrimerParteCreado@1103350003 : Boolean;
      wHoraTemp@1103350007 : Time;
      cuFShuttle@1103355000 : Codeunit 7010412;

    PROCEDURE ComprobarCamposEnBlanco@1(VAR prSerPar@1100244000 : Record 7010359);
    VAR
      lwFaltaRellenar@1100244001 : Integer;
    BEGIN
      // ComprobarCamposEnBlanco
      // Comprobar que no hay campos importantes sin rellenar en la linea ACTUAL

      lwFaltaRellenar:=0;

      IF prSerPar."Punto recogida" = '' THEN
        lwFaltaRellenar:=1;
      IF prSerPar.Touroperador     = '' THEN
        lwFaltaRellenar:=2;
      IF (prSerPar."Adultos transportados"=0) AND (prSerPar."Ni¤os transportados"=0) THEN
        lwFaltaRellenar:=3;

      IF lwFaltaRellenar>0 THEN BEGIN
         CASE lwFaltaRellenar OF
          1:ERROR(err5,err5a);
          2:ERROR(err5,err5b);
          3:ERROR(err5,err5c);
        END;
      END;
    END;

    PROCEDURE saca_paxes_desasigna@4(w_numpar@1100244000 : Code[10];prSerPar@1100244001 : Record 7010359);
    VAR
      lrParte@1100244002 : Record 7010360;
    BEGIN
      // saca_paxes_desasigna

      IF lrParte.GET(w_numpar) THEN BEGIN

        // ----  Si se trata de una desasignacion hay que tratarlo como una baja  ----

        lrParte.CALCFIELDS("Adultos transportados", "Ni¤os transportados");
        lrParte."Adultos trans. soporte" := lrParte."Adultos transportados";
        lrParte."Ni¤os trans. soporte"   := lrParte."Ni¤os transportados";
        lrParte.MODIFY;
      END;
    END;

    BEGIN
    {
      $001 AJS 29062015 Desactivo la propiedad SaveTableView para evitar problemas con filtros
    }
    END.
  }
}

OBJECT Codeunit 7009754 Macros Atennea Incoming
{
  OBJECT-PROPERTIES
  {
    Date=21/05/15;
    Time=18:21:31;
    Modified=Yes;
    Version List=AIC2009,COM;
  }
  PROPERTIES
  {
    OnRun=VAR
            resultado@1103355000 : Decimal;
          BEGIN
            FusionaContratosGuiaVenta;
          END;

  }
  CODE
  {
    VAR
      wDialog@1100253001 : Dialog;
      Text002@1100253002 : TextConst 'ENU=Deleting table #1########################### \ #2#############################################################;ESP=Borrando historico #1########################### \ #2#############################################################';
      Text052@1100253032 : TextConst 'ESP=Va a iniciar los ficheros de la empresa';
      Text053@1100253031 : TextConst 'ESP=EXCI';
      Text054@1100253030 : TextConst 'ESP=Ingreso excursiones';
      Text055@1100253029 : TextConst 'ESP=EXGV';
      Text056@1100253028 : TextConst 'ESP=Coste Guia Venta';
      Text057@1100253027 : TextConst 'ESP=EXTO';
      Text058@1100253026 : TextConst 'ESP=Coste TourOperador';
      Text059@1100253025 : TextConst 'ESP=EXCC';
      Text060@1100253024 : TextConst 'ESP=Coste Proveedor excursion';
      Text061@1100253023 : TextConst 'ESP=EXAC';
      Text062@1100253022 : TextConst 'ESP=Coste Transportista excursion';
      Text063@1100253021 : TextConst 'ESP=EXGO';
      Text064@1100253020 : TextConst 'ESP=Coste Guia Oficial';
      Text065@1100253019 : TextConst 'ESP=TRNC';
      Text066@1100253018 : TextConst 'ESP=Coste Transfers';
      Text067@1100253017 : TextConst 'ESP=TRNI';
      Text068@1100253016 : TextConst 'ESP=Ingreso Transfers';
      Text069@1100253015 : TextConst 'ESP=T';
      Text070@1100253014 : TextConst 'ESP=Transportista';
      Text071@1100253013 : TextConst 'ESP=E';
      Text072@1100253012 : TextConst 'ESP=Proveedor excursiones';
      Text073@1100253011 : TextConst 'ESP=GO';
      Text074@1100253010 : TextConst 'ESP=Guia Oficial';
      Text075@1100253009 : TextConst 'ESP=GV';
      Text076@1100253008 : TextConst 'ESP=Guia Venta';
      Text077@1100253007 : TextConst 'ESP=H';
      Text078@1100253006 : TextConst 'ESP=Hotel';
      Text079@1100253005 : TextConst 'ESP=TO';
      Text080@1100253004 : TextConst 'ESP=TourOperador';
      Text103@1100253003 : TextConst 'ESP=IA';
      Text104@1100253000 : TextConst 'ESP=Incoming Agency';
      Text105@1100253033 : TextConst 'ESP=HANDFEEVEN';
      Text106@1100253034 : TextConst 'ESP=Handling fee';
      Text107@1100253035 : TextConst 'ESP=REPSERVICE';
      Text108@1100253036 : TextConst 'ESP=Customer service';
      Text109@1100217000 : TextConst 'ESP=Se van a borrar los registros del interfase de reservas con mas de 12 meses de antiguedad';
      Text110@1100217001 : TextConst 'ESP=Cambiar el touroperador de reserva\Touroperador actual #1######## Bono #2########\Nuevo Touroperador  #3######## Bono #4########';
      Text111@1100217002 : TextConst 'ESP=Confirma que desea cambiar el Touroperador actual #1######## Bono #2######## por el Nuevo Touroperador  #3######## Bono #4########';
      Text112@1100217003 : TextConst 'ESP=Eliminar un Bono en Hotel Payment\Delegacion   #1######## \Touroperador #2######## \Bono       #3######## \Reserva    #4##### \Secuencia    #5####';
      Text113@1100217004 : TextConst 'ESP=No se puede eliminar el bono %1 reserva %4 secuencia %5 de la delegacion %2 y touroperador %3, porque ya ha sido validado.';
      Text114@1100217005 : TextConst 'ESP=No se ha encontrado ningun bono con la informacion suministrada';
      rParPer@1100217006 : Record 7009701;
      Text115@1000000000 : TextConst 'ENU=HOTEL STAY;ESP=ESTANCIA EN HOTEL';
      Text116@1000000001 : TextConst 'ENU=AIRPORT TRANSFER;ESP=TRANSFER AEROPUERTO';

    PROCEDURE BorrarHistoricosOld@1100253000();
    VAR
      lrCompany@1100253012 : Record 2000000006;
      lrHistRsv@1100253000 : Record 7009751;
      lrHistRsv2@1100253014 : Record 7009751;
      lrHistCont@1100253001 : Record 7009764;
      lrHistCont2@1100253015 : Record 7009764;
      lrHistPrec@1100253002 : Record 7009765;
      lrHistPrec2@1100253016 : Record 7009765;
      lrHistPreTra@1100253003 : Record 7009803;
      lrHistPreTra2@1100253017 : Record 7009803;
      lrHistPreTrans@1100253004 : Record 7010155;
      lrHistPreTrans2@1100253018 : Record 7010155;
      lrHistPreExc@1100253005 : Record 7010156;
      lrHistPreExc2@1100253019 : Record 7010156;
      lrHistPreGV@1100253006 : Record 7010157;
      lrHistPreGV2@1100253020 : Record 7010157;
      lrHistPreTO@1100253007 : Record 7010158;
      lrHistPreTO2@1100253021 : Record 7010158;
      lrHistPreGO@1100253008 : Record 7010159;
      lrHistPreGO2@1100253022 : Record 7010159;
      lrHistTarVta@1100253009 : Record 7010160;
      lrHistTarVta2@1100253023 : Record 7010160;
      lrHistTarCir@1100253010 : Record 7010208;
      lrHistTarCir2@1100253024 : Record 7010208;
      lrHistPreCir@1100253011 : Record 7010209;
      lrHistPreCir2@1100253025 : Record 7010209;
      lrHistExc@1100217000 : Record 7010255;
      lrHistExc2@1100217001 : Record 7010255;
      lwFechaLimite@1100253013 : Date;
    BEGIN
      // BorrarHistoricosOld

      lwFechaLimite := CALCDATE('<-3Y>', TODAY);

      lrCompany.RESET;
      lrCompany.FINDSET;
      REPEAT
        //. Historico de reservas
        lrHistRsv.CHANGECOMPANY(lrCompany.Name);
        lrHistRsv2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistRsv.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistRsv.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistRsv.GETPOSITION);

            IF lrHistRsv.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistRsv2 := lrHistRsv;
              lrHistRsv2.DELETE;
            END;
          UNTIL lrHistRsv.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico Excursiones
        lrHistExc.CHANGECOMPANY(lrCompany.Name);
        lrHistExc2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistExc.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistExc.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistExc.GETPOSITION);

            IF DT2DATE(lrHistExc."Fecha/Hora cambio") <= lwFechaLimite THEN
            BEGIN
              lrHistExc2 := lrHistExc;
              lrHistExc2.DELETE;
            END;
          UNTIL lrHistExc.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de contratos de hotel/transfer
        lrHistCont.CHANGECOMPANY(lrCompany.Name);
        lrHistCont2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistCont.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistCont.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistCont.GETPOSITION);

            IF lrHistCont.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistCont2 := lrHistCont;
              lrHistCont2.DELETE;
            END;
          UNTIL lrHistCont.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de precios de hotel
        lrHistPrec.CHANGECOMPANY(lrCompany.Name);
        lrHistPrec2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistPrec.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistPrec.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistPrec.GETPOSITION);

            IF lrHistPrec.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistPrec2 := lrHistPrec;
              lrHistPrec2.DELETE;
            END;
          UNTIL lrHistPrec.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de precios de transfer
        lrHistPreTra.CHANGECOMPANY(lrCompany.Name);
        lrHistPreTra2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistPreTra.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistPreTra.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistPreTra.GETPOSITION);

            IF lrHistPreTra.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistPreTra2 := lrHistPreTra;
              lrHistPreTra2.DELETE;
            END;
          UNTIL lrHistPreTra.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de precios de transportista excursiones
        lrHistPreTrans.CHANGECOMPANY(lrCompany.Name);
        lrHistPreTrans2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistPreTrans.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistPreTrans.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistPreTrans.GETPOSITION);

            IF lrHistPreTrans.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistPreTrans2 := lrHistPreTrans;
              lrHistPreTrans2.DELETE;
            END;
          UNTIL lrHistPreTrans.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de precios de proveedor servicios de excursiones
        lrHistPreExc.CHANGECOMPANY(lrCompany.Name);
        lrHistPreExc2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistPreExc.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistPreExc.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistPreExc.GETPOSITION);

            IF lrHistPreExc.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistPreExc2 := lrHistPreExc;
              lrHistPreExc2.DELETE;
            END;
          UNTIL lrHistPreExc.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de precios de comision Guia Venta
        lrHistPreGV.CHANGECOMPANY(lrCompany.Name);
        lrHistPreGV2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistPreGV.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistPreGV.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistPreGV.GETPOSITION);

            IF lrHistPreGV.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistPreGV2 := lrHistPreGV;
              lrHistPreGV2.DELETE;
            END;
          UNTIL lrHistPreGV.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de precios de comision touroperador
        lrHistPreTO.CHANGECOMPANY(lrCompany.Name);
        lrHistPreTO2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistPreTO.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistPreTO.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistPreTO.GETPOSITION);

            IF lrHistPreTO.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistPreTO2 := lrHistPreTO;
              lrHistPreTO2.DELETE;
            END;
          UNTIL lrHistPreTO.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de precios de Guia oficial excursiones
        lrHistPreGO.CHANGECOMPANY(lrCompany.Name);
        lrHistPreGO2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistPreGO.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistPreGO.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistPreGO.GETPOSITION);

            IF lrHistPreGO.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistPreGO2 := lrHistPreGO;
              lrHistPreGO2.DELETE;
            END;
          UNTIL lrHistPreGO.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de tarifas de venta excursiones
        lrHistTarVta.CHANGECOMPANY(lrCompany.Name);
        lrHistTarVta2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistTarVta.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistTarVta.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistTarVta.GETPOSITION);

            IF lrHistTarVta.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistTarVta2 := lrHistTarVta;
              lrHistTarVta2.DELETE;
            END;
          UNTIL lrHistTarVta.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de tarifas de circuitos
        lrHistTarCir.CHANGECOMPANY(lrCompany.Name);
        lrHistTarCir2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistTarCir.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistTarCir.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistTarCir.GETPOSITION);

            IF lrHistTarCir.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistTarCir2 := lrHistTarCir;
              lrHistTarCir2.DELETE;
            END;
          UNTIL lrHistTarCir.NEXT = 0;
          wDialog.CLOSE;
        END;

        //. Historico de precios de circuitos
        lrHistPreCir.CHANGECOMPANY(lrCompany.Name);
        lrHistPreCir2.CHANGECOMPANY(lrCompany.Name);
        IF lrHistPreCir.FINDSET THEN
        BEGIN
          wDialog.OPEN(Text002);
          wDialog.UPDATE(1, lrHistPreCir.TABLECAPTION);
          REPEAT
            wDialog.UPDATE(2, lrHistPreCir.GETPOSITION);

            IF lrHistPreCir.Fecha <= lwFechaLimite THEN
            BEGIN
              lrHistPreCir2 := lrHistPreCir;
              lrHistPreCir2.DELETE;
            END;
          UNTIL lrHistPreCir.NEXT = 0;
          wDialog.CLOSE;
        END;
      UNTIL lrCompany.NEXT = 0;
    END;

    PROCEDURE Iniciar_empresa@17();
    VAR
      rPar@1103355000 : Record 7009700;
      rParPer@1103355001 : Record 7009701;
      lrMacro@1100217000 : Record 7009767;
      lrProd@1000000000 : Record 7009710;
      lwTipo@1103355002 : 'Coste,Ingreso';
    BEGIN
      // iniciar_empresa

      IF NOT CONFIRM(Text052) THEN
        EXIT;

      IF NOT rPar.FINDFIRST THEN
      BEGIN
        CLEAR(rPar);
        rPar."Empresa Delegacion"    := TRUE;
        rPar."Empresa Hotel Payment" := TRUE;
        rPar.INSERT;
      END;

      CLEAR(rParPer);
      IF NOT rParPer.FINDFIRST THEN
        rParPer.INSERT;

      // CONCEPTOS C/I
      InsertaConCI(Text105, Text106, lwTipo::Ingreso, 0);
      InsertaConCI(Text107, Text108, lwTipo::Ingreso, 0);
      InsertaConCI(Text065, Text066, lwTipo::Coste, 1);
      InsertaConCI(Text067, Text068, lwTipo::Ingreso, 1);
      InsertaConCI(Text053, Text054, lwTipo::Ingreso, 2);
      InsertaConCI(Text059, Text060, lwTipo::Coste, 2);
      InsertaConCI(Text061, Text062, lwTipo::Coste, 2);
      InsertaConCI(Text063, Text064, lwTipo::Coste, 2);

      // TIPOS DE PROVEEDOR
      InsertaTipoProv(Text069, Text070);
      InsertaTipoProv(Text071, Text072);
      InsertaTipoProv(Text073, Text074);
      InsertaTipoProv(Text075, Text076);
      InsertaTipoProv(Text077, Text078);
      InsertaTipoProv(Text079, Text080);
      InsertaTipoProv(Text103, Text104);

      //. Crear el producto hotel
      lrProd.RESET;
      lrProd.SETRANGE("Tipo Producto", lrProd."Tipo Producto"::Hotel);
      IF NOT lrProd.FINDFIRST THEN
      BEGIN
        lrProd.INIT;
        lrProd.Codigo          := 'HOTEL';
        lrProd.Descripcion     := Text115;
        lrProd."Tipo Producto" := lrProd."Tipo Producto"::Hotel;
        lrProd.INSERT;
      END;

      //. Crear el producto transfer
      lrProd.RESET;
      lrProd.SETRANGE("Tipo Producto", lrProd."Tipo Producto"::Transfer);
      IF NOT lrProd.FINDFIRST THEN
      BEGIN
        lrProd.INIT;
        lrProd.Codigo          := 'TRANSFER';
        lrProd.Descripcion     := Text116;
        lrProd."Tipo Producto" := lrProd."Tipo Producto"::Transfer;
        lrProd.INSERT;
      END;

      //. Marcamos todas las macros automaticas antiguas para que no se ejecuten en esta nueva empresa

      lrMacro.RESET;
      lrMacro.SETRANGE (Automatica      , TRUE);
      lrMacro.SETRANGE (Ejecutada       , FALSE);
      lrMacro.SETFILTER("Fecha creacion", '<%1', CURRENTDATETIME);
      IF lrMacro.FINDSET(TRUE) THEN
      BEGIN
        lrMacro.MODIFYALL(Finalizada, TRUE);
        lrMacro.MODIFYALL(Ejecutada , TRUE);
      END;
    END;

    PROCEDURE InsertaConCI@1103355006(pwCod@1103355001 : Code[10];pwDesc@1103355000 : Text[30];pwTipo@1103355003 : 'Coste,Ingreso';pwModulo@1100253000 : Integer);
    VAR
      lrCI@1103355002 : Record 7009716;
      lwEnc@1103355004 : Boolean;
    BEGIN
      // InsertaConCI

      CLEAR(lrCI);
      lwEnc := lrCI.GET(pwCod);
      lrCI.Concepto        := pwCod;
      lrCI.Descripcion     := pwDesc;
      lrCI."Coste/Ingreso" := pwTipo;
      lrCI.Modulo          := pwModulo;
      IF lwEnc THEN
        lrCI.MODIFY
      ELSE
        lrCI.INSERT;
    END;

    PROCEDURE InsertaTipoProv@1103355001(pwCod@1103355001 : Code[10];pwDesc@1103355002 : Text[30]);
    VAR
      lrTipoPro@1103355000 : Record 7009714;
      lwEnc@1103355003 : Boolean;
    BEGIN
      // InsertaTipoProv

      CLEAR(lrTipoPro);
      lwEnc := lrTipoPro.GET(pwCod);
      lrTipoPro."Tipo proveedor" := pwCod;
      lrTipoPro.Descripcion      := pwDesc;
      IF lwEnc THEN
        lrTipoPro.MODIFY
      ELSE
        lrTipoPro.INSERT;
    END;

    PROCEDURE RellenaBonoFacturado@1100253001();
    VAR
      lrBono@1100253000 : Record 7010013;
      Text001@1100253001 : TextConst 'ESP=Rellenando Bono Facturado';
      lwCont@1100253002 : Integer;
      lwTotal@1100253003 : Integer;
    BEGIN
      // RellenaBonoFacturado

      CLEAR(wDialog);
      wDialog.OPEN(Text001 + '\Actualizando Historicos\Espere por favor');

      CLEAR(lrBono);
      lrBono.SETCURRENTKEY(Delegacion,"Fecha llegada");
      lrBono.SETFILTER("Fecha llegada", '<%1', 010112D);
      lrBono.MODIFYALL(Facturado, TRUE);
      wDialog.CLOSE;

      wDialog.OPEN(Text001 + '\@1@@@@@@@@@@@@@');
      lrBono.SETFILTER("Fecha llegada", '>=%1', 010112D);
      IF lrBono.FINDSET THEN BEGIN
        lwTotal := lrBono.COUNT;
        CLEAR(lwCont);
        REPEAT
          lrBono.Facturado := lrBono.CompruebaBonoFact;
          lrBono.MODIFY;
          lwCont +=1;
          IF lwCont MOD 10 =0 THEN
            wDialog.UPDATE(1, ROUND(lwCont/lwTotal*10000,1));
        UNTIL lrBono.NEXT=0;
      END;
      wDialog.CLOSE;
    END;

    PROCEDURE CrearLineasFacturaInc@1100253002();
    VAR
      lrLinV@1100253000 : Record 37;
      lrLinHF@1100253001 : Record 113;
      lrLinHA@1100253002 : Record 115;
      lwTotal@1100253003 : Integer;
      lwCount@1100253004 : Integer;
    BEGIN
      // CrearLineasFacturaInc

      wDialog.OPEN('Creando Lineas Handling Fee\#1#####################\@2@@@@@@@@@@@');

      CLEAR(lrLinV);
      IF lrLinV.FINDSET THEN BEGIN
        wDialog.UPDATE(1, lrLinV.TABLECAPTION);
        lwTotal := lrLinV.COUNT;
        CLEAR(lwCount);
        REPEAT
          _CreaLinaFactInc(lrLinV."Document Type", lrLinV."Document No.", lrLinV."Line No.",
                           lrLinV.Description, lrLinV."Description 2");
          lwCount +=1;
          IF lwCount MOD 10 =0 THEN
            wDialog.UPDATE(2, ROUND(lwCount/lwTotal*10000,1));
        UNTIL lrLinV.NEXT=0;
      END;

      CLEAR(lrLinHF);
      IF lrLinHF.FINDSET THEN BEGIN
        wDialog.UPDATE(1, lrLinHF.TABLECAPTION);
        lwTotal := lrLinHF.COUNT;
        CLEAR(lwCount);
        REPEAT
          _CreaLinaFactInc(2, lrLinHF."Document No.", lrLinHF."Line No.",
                           lrLinHF.Description, lrLinHF."Description 2");
          lwCount +=1;
          IF lwCount MOD 10 =0 THEN
            wDialog.UPDATE(2, ROUND(lwCount/lwTotal*10000,1));
        UNTIL lrLinHF.NEXT=0;
      END;

      CLEAR(lrLinHA);
      IF lrLinHA.FINDSET THEN BEGIN
        wDialog.UPDATE(1, lrLinHA.TABLECAPTION);
        lwTotal := lrLinHA.COUNT;
        CLEAR(lwCount);
        REPEAT
          _CreaLinaFactInc(3, lrLinHA."Document No.", lrLinHA."Line No.",
                           lrLinHA.Description, lrLinHA."Description 2");
          lwCount +=1;
          IF lwCount MOD 10 =0 THEN
            wDialog.UPDATE(2, ROUND(lwCount/lwTotal*10000,1));
        UNTIL lrLinHA.NEXT=0;
      END;
    END;

    LOCAL PROCEDURE _CreaLinaFactInc@1100253003(pwTipoDoc@1100253003 : Integer;pwNoDoc@1100253004 : Code[20];pwNoLin@1100253005 : Integer;pwText@1100253000 : Text[50];pwText2@1100253001 : Text[50]);
    VAR
      lrLin@1100253002 : Record 7009909;
      lwTxt@1100253006 : Text[30];
      lwOK@1100253007 : Boolean;
      LTxt0001@1100253008 : TextConst 'ESP=HANDFEEVEN';
    BEGIN
      // _CreaLinaFactInc

      IF COPYSTR(pwText,1,4) = 'HFEE' THEN BEGIN
        CLEAR(lrLin);
        IF lrLin.GET(pwTipoDoc, pwNoDoc, pwNoLin) THEN
          EXIT;

        lrLin."Tipo documento" := pwTipoDoc;
        lrLin."N§ documento"   := pwNoDoc;
        lrLin."Line No."       := pwNoLin;
        lrLin.Subconcepto      := _GetCmp(pwText, 5,10);
        lrLin.Bono             := _GetCmp(pwText,15,10);
        lrLin.Hotel            := _GetCmp(pwText,25,20);
        lwTxt:= _GetCmp(pwText,45,3);
        lwOK := EVALUATE(lrLin.Adultos, lwTxt);
        lwTxt:= _GetCmp(pwText,48,3);
        lwOK := EVALUATE(lrLin.Ni¤os, lwTxt);
        lwTxt:= _GetCmp(pwText2,21,10);
        lwOK := EVALUATE(lrLin.Precio, lwTxt);
        lrLin.Concepto         := LTxt0001;
        lrLin.INSERT;
      END;
    END;

    LOCAL PROCEDURE _GetCmp@1100253060(pwText@1100253000 : Text[100];pwDsd@1100253001 : Integer;pwHst@1100253002 : Integer) : Text[50];
    VAR
      lwText@1100253003 : Text[50];
    BEGIN
      // _GetCmp

      lwText := COPYSTR(pwText,pwDsd,pwHst);
      lwText := DELCHR(lwText, '<>');
      EXIT(lwText);
    END;

    PROCEDURE RellenarDetalleEcoExc@1100253004();
    VAR
      lrDetEco@1100253000 : Record 7010245;
      lrRsvExc@1100253001 : Record 7010162;
    BEGIN
      // RellenarDetalleEcoExc

      lrRsvExc.RESET;
      lrRsvExc.SETCURRENTKEY("Fecha Excursion");
      lrRsvExc.SETRANGE (Anulada          , FALSE);
      lrRsvExc.SETFILTER("Fecha Excursion", '>=%1', 010108D);
      IF lrRsvExc.FINDSET THEN
      BEGIN
        REPEAT
          IF NOT lrDetEco.GET(lrRsvExc.Delegacion, lrRsvExc."N§ Reserva") THEN
          BEGIN
            lrDetEco.Delegacion                  := lrRsvExc.Delegacion;
            lrDetEco."Num. Reserva"              := lrRsvExc."N§ Reserva";
            lrDetEco."Cod. Divisa"               := lrRsvExc.Divisa;
            lrDetEco."Precio adulto"             := lrRsvExc."Precio Adulto";
            lrDetEco."Precio ni¤o"               := lrRsvExc."Precio Ni¤o";
            lrDetEco."Ingreso reserva"           := lrRsvExc."Ingreso reserva";
            lrDetEco."Ingreso base"              := lrRsvExc."Ingreso reserva";
            lrDetEco."Ingreso adultos"           := lrRsvExc."Ingreso Adulto";
            lrDetEco."Ingreso adultos base"      := lrRsvExc."Ingreso Adulto";
            lrDetEco."Ingreso ni¤os"             := lrRsvExc."Ingreso Ni¤o";
            lrDetEco."Ingreso ni¤os base"        := lrRsvExc."Ingreso Ni¤o";
            lrDetEco."Ingreso comisionable"      := lrRsvExc."Ingreso comisionable";
            lrDetEco."Base comisionable"         := lrRsvExc."Ingreso comisionable";
            lrDetEco."Ingreso reserva neto"      := lrRsvExc."Ingreso reserva neto";
            lrDetEco."Ingreso comisionable neto" := lrRsvExc."Ingreso comisionable neto";
            lrDetEco."Ingreso adultos neto"      := lrRsvExc."Ingreso adulto neto";
            lrDetEco."Ingreso ni¤os neto"        := lrRsvExc."Ingreso ni¤o neto";
            lrDetEco.INSERT;
          END;
        UNTIL lrRsvExc.NEXT = 0;
      END;
    END;

    PROCEDURE RellenarOrdenDependiente@1100217000();
    VAR
      lrPrecioCompra@1100217000 : Record 7009789;
      lrPrecioCompra2@1100217002 : Record 7009789;
      lrPrecioVenta@1100217001 : Record 7009790;
      lrPrecioVenta2@1100217003 : Record 7009790;
    BEGIN
      // RellenarOrdenDependiente

      lrPrecioCompra.RESET;
      lrPrecioCompra.SETFILTER("Codigo precio", '%1|%2', lrPrecioCompra."Codigo precio"::"Precio base",
                                                         lrPrecioCompra."Codigo precio"::"Precio ruta");
      lrPrecioCompra.SETRANGE ("Tipo aplicacion"  , lrPrecioCompra."Tipo aplicacion"::Pax);
      lrPrecioCompra.SETRANGE ("Tipo elemento", '');
      IF lrPrecioCompra.FINDSET THEN
      BEGIN
        REPEAT
          lrPrecioCompra2.RESET;
          lrPrecioCompra2.SETRANGE (Delegacion     , lrPrecioCompra.Delegacion);
          lrPrecioCompra2.SETRANGE ("N§ Contrato"  , lrPrecioCompra."N§ Contrato");
          lrPrecioCompra2.SETRANGE ("Codigo precio", lrPrecioCompra."Codigo precio");
          lrPrecioCompra2.SETRANGE ("Fecha desde"  , lrPrecioCompra."Fecha desde");
          lrPrecioCompra2.SETRANGE ("Fecha hasta"  , lrPrecioCompra."Fecha hasta");
          lrPrecioCompra2.SETRANGE (Destino         , lrPrecioCompra.Destino);
          lrPrecioCompra2.SETRANGE ("Tipo vehiculo", lrPrecioCompra."Tipo vehiculo");
          lrPrecioCompra2.SETRANGE ("Rango desde"  , lrPrecioCompra."Rango desde");
          lrPrecioCompra2.SETRANGE ("Rango hasta"  , lrPrecioCompra."Rango hasta");
          lrPrecioCompra2.SETRANGE ("old_Zona 1"       , lrPrecioCompra."old_Zona 1");
          lrPrecioCompra2.SETRANGE ("old_Zona 2"       , lrPrecioCompra."old_Zona 2");
          lrPrecioCompra2.SETFILTER("Tipo elemento", '<>%1', '');
          IF lrPrecioCompra2.FINDSET(TRUE) THEN
            lrPrecioCompra2.MODIFYALL("old_Orden dependiente", lrPrecioCompra."Orden precio");
        UNTIL lrPrecioCompra.NEXT = 0;
      END;

      lrPrecioVenta.RESET;
      lrPrecioVenta.SETFILTER("Codigo precio", '%1|%2', lrPrecioVenta."Codigo precio"::"Precio Base",
                                                        lrPrecioVenta."Codigo precio"::"Precio ruta");
      lrPrecioVenta.SETRANGE ("Tipo Aplicacion"  , lrPrecioVenta."Tipo Aplicacion"::Pax);
      lrPrecioVenta.SETRANGE ("Tipo elemento", '');
      IF lrPrecioVenta.FINDSET THEN
      BEGIN
        REPEAT
          lrPrecioVenta2.RESET;
          lrPrecioVenta2.SETRANGE (Delegacion     , lrPrecioVenta.Delegacion);
          lrPrecioVenta2.SETRANGE ("N§ Contrato"  , lrPrecioVenta."N§ Contrato");
          lrPrecioVenta2.SETRANGE ("Codigo precio", lrPrecioVenta."Codigo precio");
          lrPrecioVenta2.SETRANGE ("Fecha desde"  , lrPrecioVenta."Fecha desde");
          lrPrecioVenta2.SETRANGE ("Fecha hasta"  , lrPrecioVenta."Fecha hasta");
          lrPrecioVenta2.SETRANGE (Destino         , lrPrecioVenta.Destino);
          lrPrecioVenta2.SETRANGE ("Tipo vehiculo", lrPrecioVenta."Tipo vehiculo");
          lrPrecioVenta2.SETRANGE ("Rango desde"  , lrPrecioVenta."Rango desde");
          lrPrecioVenta2.SETRANGE ("Rango hasta"  , lrPrecioVenta."Rango hasta");
          lrPrecioVenta2.SETRANGE ("old_Zona 1"       , lrPrecioVenta."old_Zona 1");
          lrPrecioVenta2.SETRANGE ("old_Zona 2"       , lrPrecioVenta."old_Zona 2");
          lrPrecioVenta2.SETRANGE ("Tipo Traslado", lrPrecioVenta."Tipo Traslado");
          lrPrecioVenta2.SETFILTER("Tipo elemento", '<>%1', '');
          IF lrPrecioVenta2.FINDSET(TRUE) THEN
            lrPrecioVenta2.MODIFYALL("old_Orden dependiente", lrPrecioVenta."Orden precio");
        UNTIL lrPrecioVenta.NEXT = 0;
      END;
    END;

    PROCEDURE DepurarInterfaseReservas@1103355000();
    VAR
      lwFecha@1103355000 : Date;
      lwVentana@1103355008 : Dialog;
      lwActual@1103355009 : Integer;
      lwTotal@1103355010 : Integer;
      lrHist@1103355001 : Record 7010082;
      lrHist2@1000000000 : Record 7010082;
      lrCab@1103355002 : Record 7010076;
      lrPax@1103355003 : Record 7010079;
      lrVuel@1103355004 : Record 7010077;
      lrHot@1103355005 : Record 7010078;
      lrServ@1103355006 : Record 7010080;
      lrError@1103355007 : Record 7010083;
      lrFichero@1100217000 : Record 7009899;
      lrFichero2@1000000001 : Record 7009899;
    BEGIN
      // DepurarInterfaseReservas

      // Esta rutina borra los registros del interfase de reservas con mas de 12 meses
      // de antiguedad

      IF NOT CONFIRM(Text109) THEN
        EXIT;

      lwFecha := DMY2DATE(1, DATE2DMY(TODAY, 2), DATE2DMY(TODAY, 3));

      // Borramos los ficheros importados con mas de un a¤o de antiguedad

      lwFecha := CALCDATE('-1A', lwFecha);

      // Filtramos el registro de historico de importaciones y para cada fichero borramos
      // toda su informacion

      lrHist.SETFILTER("Fecha importacion", '<%1', lwFecha);
      IF lrHist.FINDSET(TRUE, FALSE) THEN BEGIN
        lwVentana.OPEN(Text002);
        lwTotal  := lrHist.COUNT;
        lwActual := 0;
        REPEAT

          // Actualizar la barra de progreso

          lwActual += 1;
          lwVentana.UPDATE(1, ROUND(lwActual / lwTotal * 10000, 1));

          // Borramos los registros de cabecera

          lrCab.SETRANGE(Fichero, lrHist."N§ Fichero");
          IF lrCab.FINDFIRST THEN
          BEGIN
            lrCab.DELETEALL;

            // Borramos los registros de hotel

            lrHot.SETRANGE(Fichero, lrHist."N§ Fichero");
            IF lrHot.FINDFIRST THEN
              lrHot.DELETEALL;

            // Borramos los registros de vuelos

            lrVuel.SETRANGE(Fichero, lrHist."N§ Fichero");
            IF lrVuel.FINDFIRST THEN
              lrVuel.DELETEALL;

            // Borramos los registros de paxes

            lrPax.SETRANGE(Fichero, lrHist."N§ Fichero");
            IF lrPax.FINDFIRST THEN
              lrPax.DELETEALL;

            // Borramos los registros de servicios

            lrServ.SETRANGE(Fichero, lrHist."N§ Fichero");
            IF lrServ.FINDFIRST THEN
              lrServ.DELETEALL;

            // Borramos los registros de errores

            lrError.SETRANGE("ID Fichero", lrHist."N§ Fichero");
            IF lrError.FINDFIRST THEN
              lrError.DELETEALL;

            lrHist2 := lrHist;
            lrHist2.DELETE;
          END;
        UNTIL lrHist.NEXT = 0;
        lwVentana.CLOSE;
      END;

      //. Ampliamos para borrar tambien los registros de WS
      //+$002 <
      lrFichero.SETFILTER("Fecha importacion", '<%1', lwFecha);
      IF lrFichero.FINDSET(TRUE, FALSE) THEN
      BEGIN
        lwVentana.OPEN(Text002);
        lwTotal  := lrFichero.COUNT;
        lwActual := 0;
        REPEAT

          // Actualizar la barra de progreso

          lwActual += 1;
          lwVentana.UPDATE(1, ROUND(lwActual / lwTotal * 10000, 1));

          // Borramos los registros de cabecera

          lrCab.SETRANGE(Fichero, lrFichero."N§ Fichero");
          IF lrCab.FINDFIRST THEN
          BEGIN
            lrCab.DELETEALL;

            // Borramos los registros de hotel

            lrHot.SETRANGE(Fichero, lrFichero."N§ Fichero");
            IF lrHot.FINDFIRST THEN
              lrHot.DELETEALL;

            // Borramos los registros de vuelos

            lrVuel.SETRANGE(Fichero, lrFichero."N§ Fichero");
            IF lrVuel.FINDFIRST THEN
              lrVuel.DELETEALL;

            // Borramos los registros de paxes

            lrPax.SETRANGE(Fichero, lrFichero."N§ Fichero");
            IF lrPax.FINDFIRST THEN
              lrPax.DELETEALL;

            // Borramos los registros de servicios

            lrServ.SETRANGE(Fichero, lrFichero."N§ Fichero");
            IF lrServ.FINDFIRST THEN
              lrServ.DELETEALL;

            // Borramos los registros de errores

            lrError.SETRANGE("ID Fichero", lrFichero."N§ Fichero");
            IF lrError.FINDFIRST THEN
              lrError.DELETEALL;

            lrFichero2 := lrFichero;
            lrFichero2.DELETE;
          END;
        UNTIL lrFichero.NEXT = 0;
        lwVentana.CLOSE;
      END;
      //+$002 >
    END;

    PROCEDURE CambiaTouroperadorReserva@1100217001();
    VAR
      wTouroperadorOLD@1103355002 : Code[10];
      wBonoOLD@1103355001 : Code[10];
      wTouroperadorNEW@1103355000 : Code[10];
      wBonoNEW@1103355006 : Code[10];
      Ventana@1103355003 : Dialog;
    BEGIN
      // CambiaTouroperadorReserva

      Ventana.OPEN(Text110);
      Ventana.INPUT(1, wTouroperadorOLD);
      Ventana.INPUT(2, wBonoOLD);
      Ventana.INPUT(3, wTouroperadorNEW);
      Ventana.INPUT(4, wBonoNEW);
      Ventana.CLOSE;

      IF (wTouroperadorOLD = '') OR (wBonoOLD = '') OR (wTouroperadorNEW = '') OR (wBonoNEW = '') OR
         ((wTouroperadorOLD = wTouroperadorNEW) AND (wBonoOLD = wBonoNEW)) THEN
        EXIT;

      IF NOT CONFIRM(Text111, FALSE, wTouroperadorOLD, wBonoOLD, wTouroperadorNEW, wBonoNEW) THEN
        EXIT;

      _CambiaTouroperadorCabecera(wTouroperadorOLD, wBonoOLD, wTouroperadorNEW, wBonoNEW);

      MESSAGE('Proceso finalizado.');
    END;

    LOCAL PROCEDURE _CambiaTouroperadorCabecera@1103355005(pwTouroperadorOLD@1103355003 : Code[10];pwBonoOLD@1103355002 : Code[10];pwTouroperadorNEW@1103355001 : Code[10];pwBonoNEW@1103355000 : Code[10]);
    VAR
      rCab@1103355005 : Record 7009741;
      rCab2@1103355004 : Record 7009741;
    BEGIN
      // _CambiaTouroperadorCabecera

      rCab.RESET;
      rCab.SETCURRENTKEY("TourOperador Venta",
                         Bono);
      rCab.SETRANGE("TourOperador Venta", pwTouroperadorOLD);
      rCab.SETRANGE(Bono                , pwBonoOLD);
      IF rCab.FINDSET(TRUE) THEN BEGIN
        REPEAT
          _CambiaTouroperadorPeriodo(rCab, pwTouroperadorNEW, pwBonoNEW);

          rCab2 := rCab;
          rCab2.Bono                 := pwBonoNEW;
          rCab2."TourOperador Venta" := pwTouroperadorNEW;
          rCab2.MODIFY;
        UNTIL rCab.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE _CambiaTouroperadorPeriodo@1103355003(prCab@1103355010 : Record 7009741;pwTouroperadorNEW@1103355000 : Code[10];pwBonoNEW@1103355001 : Code[10]);
    VAR
      rPer@1103355009 : Record 7009742;
      rRsv@1103355008 : Record 7009743;
      rRsvTra@1103355003 : Record 7009744;
    BEGIN
      // _CambiaTouroperadorPeriodo

      rPer.RESET;
      rPer.SETRANGE(Delegacion  , prCab.Delegacion);
      rPer.SETRANGE("N§ Interno", prCab."N§ Interno");
      IF rPer.FINDSET(TRUE) THEN BEGIN
        rRsv.SETCURRENTKEY(Delegacion,
                           "N§ Interno",
                           "N§ Periodo");

        rRsvTra.SETCURRENTKEY(Delegacion,
                              "N§ Interno",
                              "N§ Periodo");
        REPEAT
          rRsv.SETRANGE(Delegacion  , rPer.Delegacion);
          rRsv.SETRANGE("N§ Interno", rPer."N§ Interno");
          rRsv.SETRANGE("N§ Periodo", rPer."N§ Periodo");
          IF rRsv.FINDSET(TRUE) THEN BEGIN
            REPEAT
              _CambiaTouroperadorBonos(rRsv, pwTouroperadorNEW, pwBonoNEW);

              rRsv."TourOperador Venta" := pwTouroperadorNEW;
              rRsv.Bono                 := pwBonoNEW;
              rRsv.MODIFY;
            UNTIL rRsv.NEXT = 0;
          END;

          rRsvTra.SETRANGE(Delegacion  , rPer.Delegacion);
          rRsvTra.SETRANGE("N§ Interno", rPer."N§ Interno");
          rRsvTra.SETRANGE("N§ Periodo", rPer."N§ Periodo");
          IF rRsvTra.FINDSET(TRUE) THEN BEGIN
            REPEAT
              rRsvTra.TourOperador := pwTouroperadorNEW;
              rRsvTra.Bono         := pwBonoNEW;
              rRsvTra.MODIFY;
            UNTIL rRsvTra.NEXT = 0;
          END;

          rPer."TourOperador Venta" := pwTouroperadorNEW;
          rPer.Bono         := pwBonoNEW;
          rPer.MODIFY;
        UNTIL rPer.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE _CambiaTouroperadorBonos@1103355008(prRsv@1103355000 : Record 7009743;pwTouroperadorNEW@1103355001 : Code[10];pwBonoNEW@1103355012 : Code[10]);
    VAR
      rBono@1103355005 : Record 7010013;
      rBono2@1103355006 : Record 7010013;
      rBono3@1103355009 : Record 7010013;
      rCIBono@1103355004 : Record 7010018;
      rCIBono2@1103355007 : Record 7010018;
      rCIBono3@1103355010 : Record 7010018;
      rCIBonoCnp@1103355003 : Record 7010019;
      rCIBonoCnp2@1103355008 : Record 7010019;
      rCIBonoCnp3@1103355011 : Record 7010019;
      rResum@1103355002 : Record 7009771;
    BEGIN
      // _CambiaTouroperadorBonos

      rBono.RESET;
      rBono.SETRANGE(Delegacion  , prRsv.Delegacion);
      rBono.SETRANGE(TourOperador, prRsv."TourOperador Venta");
      rBono.SETRANGE(Bono        , prRsv.Bono);
      rBono.SETRANGE("N§ Reserva", prRsv."N§ Reserva");
      IF rBono.FINDSET(TRUE) THEN BEGIN
        REPEAT
          rCIBono.SETRANGE(Delegacion    , rBono.Delegacion);
          rCIBono.SETRANGE(TourOperador  , rBono.TourOperador);
          rCIBono.SETRANGE(Bono          , rBono.Bono);
          rCIBono.SETRANGE("N§ Reserva"  , rBono."N§ Reserva");
          rCIBono.SETRANGE("N§ Secuencia", rBono."N§ Secuencia");
          IF rCIBono.FINDSET(TRUE) THEN BEGIN
            REPEAT
              rCIBono2 := rCIBono;
              rCIBono2.TourOperador := pwTouroperadorNEW;
              rCIBono2.Bono         := pwBonoNEW;
              rCIBono2.Replicado    := FALSE;
              rCIBono2.INSERT;

              rCIBono3 := rCIBono;
              rCIBono3.DELETE;
            UNTIL rCIBono.NEXT = 0;
          END;

          rCIBonoCnp.SETRANGE(Delegacion    , rBono.Delegacion);
          rCIBonoCnp.SETRANGE(TourOperador  , rBono.TourOperador);
          rCIBonoCnp.SETRANGE(Bono          , rBono.Bono);
          rCIBonoCnp.SETRANGE("N§ Reserva"  , rBono."N§ Reserva");
          rCIBonoCnp.SETRANGE("N§ Secuencia", rBono."N§ Secuencia");
          IF rCIBonoCnp.FINDSET(TRUE) THEN BEGIN
            REPEAT
              rCIBonoCnp2 := rCIBonoCnp;
              rCIBonoCnp2.TourOperador := pwTouroperadorNEW;
              rCIBonoCnp2.Bono         := pwBonoNEW;
              rCIBonoCnp2.Replicado    := FALSE;
              rCIBonoCnp2.INSERT;

              rCIBonoCnp3 := rCIBonoCnp;
              rCIBonoCnp3.DELETE;
            UNTIL rCIBonoCnp.NEXT = 0;
          END;

          rBono2 := rBono;
          rBono2.TourOperador := pwTouroperadorNEW;
          rBono2.Bono         := pwBonoNEW;
          rBono2.INSERT;

          rBono3 := rBono;
          rBono3.DELETE;
        UNTIL rBono.NEXT = 0;
      END;

      rResum.SETRANGE(Delegacion  , prRsv.Delegacion);
      rResum.SETRANGE("N§ Reserva", prRsv."N§ Reserva");
      IF rResum.FINDSET(TRUE) THEN BEGIN
        REPEAT
          rResum."TourOperador Venta" := pwTouroperadorNEW;
          rResum.Bono                 := pwBonoNEW;
          rResum.Replicado            := FALSE;
          rResum.MODIFY;
        UNTIL rResum.NEXT = 0;
      END
    END;

    PROCEDURE BorrarBonoHotelPayment@1103355002();
    VAR
      rBono@1100217000 : Record 7010013;
      rCIBono@1100217001 : Record 7010018;
      rCIBonoCnp@1100217002 : Record 7010019;
      rCIBonoDia@1100217003 : Record 7010020;
      rResumenReserva@1100217004 : Record 7009771;
      rConc@1100217005 : Record 7010070;
      rBono2@1100217006 : Record 7010013;
      wVentana@1103355004 : Dialog;
      wBono@1103355003 : Code[10];
      wTouroperador@1103355002 : Code[10];
      wDelegacion@1103355001 : Code[10];
      wReserva@1103355000 : Integer;
      wSecuencia@1103355005 : Code[10];
    BEGIN
      // BorrarBonoHotelPayment

      wVentana.OPEN(Text112);
      wVentana.INPUT(1, wDelegacion);
      wVentana.INPUT(2, wTouroperador);
      wVentana.INPUT(3, wBono);
      wVentana.INPUT(4, wReserva);
      wVentana.INPUT(5, wSecuencia);
      wVentana.CLOSE;

      rBono.RESET;

      IF wDelegacion <> '' THEN
        rBono.SETRANGE(Delegacion, wDelegacion);

      IF wTouroperador <> '' THEN
        rBono.SETRANGE(TourOperador, wTouroperador);

      IF wBono <> '' THEN
        rBono.SETRANGE(Bono, wBono);

      IF wReserva <> 0 THEN
        rBono.SETRANGE("N§ Reserva", wReserva);

      IF wSecuencia <> '' THEN
        rBono.SETRANGE("N§ Secuencia", wSecuencia);

      IF rBono.FINDFIRST THEN BEGIN
        REPEAT
          rBono.CALCFIELDS("Importe ya validado");
          IF rBono."Importe ya validado" <> 0 THEN
            ERROR(Text113, wBono, wDelegacion, wTouroperador, wReserva, wSecuencia);

          rCIBono.SETRANGE(Delegacion    , rBono.Delegacion);
          rCIBono.SETRANGE(TourOperador  , rBono.TourOperador);
          rCIBono.SETRANGE(Bono          , rBono.Bono);
          rCIBono.SETRANGE("N§ Reserva"  , rBono."N§ Reserva");
          rCIBono.SETRANGE("N§ Secuencia", rBono."N§ Secuencia");
          IF rCIBono.FINDFIRST THEN
            rCIBono.DELETEALL;

          rCIBonoCnp.SETRANGE(Delegacion    , rBono.Delegacion);
          rCIBonoCnp.SETRANGE(TourOperador  , rBono.TourOperador);
          rCIBonoCnp.SETRANGE(Bono          , rBono.Bono);
          rCIBonoCnp.SETRANGE("N§ Reserva"  , rBono."N§ Reserva");
          rCIBonoCnp.SETRANGE("N§ Secuencia", rBono."N§ Secuencia");
          IF rCIBonoCnp.FINDFIRST THEN
            rCIBonoCnp.DELETEALL;

          rCIBonoDia.SETRANGE(Delegacion    , rBono.Delegacion);
          rCIBonoDia.SETRANGE(TourOperador  , rBono.TourOperador);
          rCIBonoDia.SETRANGE(Bono          , rBono.Bono);
          rCIBonoDia.SETRANGE("N§ Reserva"  , rBono."N§ Reserva");
          rCIBonoDia.SETRANGE("N§ Secuencia", rBono."N§ Secuencia");
          IF rCIBonoDia.FINDFIRST THEN
            rCIBonoDia.DELETEALL;

          rResumenReserva.SETCURRENTKEY(Delegacion,
                                        "TourOperador Venta",
                                        Bono);
          rResumenReserva.SETRANGE(Delegacion          , rBono.Delegacion);
          rResumenReserva.SETRANGE("TourOperador Venta", rBono.TourOperador);
          rResumenReserva.SETRANGE(Bono                , rBono.Bono);
          IF rResumenReserva.FINDFIRST THEN
            rResumenReserva.DELETEALL;

          rConc.SETRANGE(Delegacion    , rBono.Delegacion);
          rConc.SETRANGE(TourOperador  , rBono.TourOperador);
          rConc.SETRANGE(Bono          , rBono.Bono);
          rConc.SETRANGE("N§ Reserva"  , rBono."N§ Reserva");
          rConc.SETRANGE("N§ Secuencia", rBono."N§ Secuencia");
          IF rConc.FINDSET(TRUE) THEN
            rConc.DELETEALL;

          rBono2 := rBono;
          rBono2.DELETE;
        UNTIL rBono.NEXT = 0;
      END
      ELSE
        ERROR(Text114);
    END;

    PROCEDURE RellenaNuevoCampo_LinCobroExc@1100217002();
    VAR
      lrCobro@1100217000 : Record 7010240;
      lrResv@1100217003 : Record 7010162;
      lwTotal@1100217001 : Integer;
      lwCont@1100217002 : Integer;
    BEGIN
      // RellenaNuevoCampo_LinCobroExc
      // JPT 06/09/12 CNT 12002 Permitir mas de un cobro por reserva de excursi¢n
      // Rellenamos el nuevo campo "Importe Divisa Reserva"

      CLEAR(lrCobro);
      IF lrCobro.FINDSET THEN BEGIN
        wDialog.OPEN('@1@@@@@@@@@@@@@');
        lwTotal := lrCobro.COUNT;
        CLEAR(lwCont);
        REPEAT
          IF lrCobro."Fecha cambio cobro" = 0D THEN BEGIN
            IF lrResv.GET(lrCobro.Delegacion, lrCobro."Num Reserva") THEN
              lrCobro."Fecha cambio cobro" := lrResv."Fecha cambio";
          END;
          IF lrCobro."Fecha cambio cobro" <> 0D THEN BEGIN
            lrCobro.CALCFIELDS("Cod. Divisa Reserva");
            lrCobro."Importe Divisa Reserva" := lrCobro.CambioDivisa(lrCobro."Cod. Divisa",
                                                                     lrCobro."Cod. Divisa Reserva", lrCobro.Importe);
            lrCobro.MODIFY;
          END;
          lwCont +=1;
          IF (lwCont MOD 100 = 0) THEN
            wDialog.UPDATE(1, ROUND(lwCont/lwTotal*10000,1));
        UNTIL lrCobro.NEXT=0;
        wDialog.CLOSE;
      END;
    END;

    PROCEDURE RellenarContratosCNT@1100217003();
    VAR
      lrCont@1100217000 : Record 7009723;
      lrHab@1100217001 : Record 7009731;
      lrHabTMP@1100217004 : TEMPORARY Record 7009731;
      lrPre@1100217002 : Record 7009738;
      lrCupo@1100217003 : Record 7009739;
    BEGIN
      // RellenarContratosCNT

      lrCont.RESET;
      lrCont.SETRANGE(Confirmado, TRUE);
      IF lrCont.FINDSET THEN
      BEGIN
        REPEAT
          lrHabTMP.RESET;
          lrHabTMP.DELETEALL;

          //. Construir un temporal de habitacion para evitar repeticiones de habitacion cupo
          lrHab.SETRANGE(Delegacion     , lrCont.Delegacion);
          lrHab.SETRANGE("N§ Contrato"  , lrCont."N§ Contrato compra");
          lrHab.SETRANGE("Tipo contrato", lrHab."Tipo contrato"::Compra);
          IF lrHab.FINDSET THEN
          BEGIN
            REPEAT
              lrHabTMP.SETRANGE(Delegacion       , lrHab.Delegacion);
              lrHabTMP.SETRANGE("N§ Contrato"    , lrHab."N§ Contrato");
              lrHabTMP.SETRANGE("Tipo contrato"  , lrHab."Tipo contrato");
              lrHabTMP.SETRANGE("Habitacion cupo", lrHab."Habitacion cupo");
              IF NOT lrHabTMP.FINDFIRST THEN
              BEGIN
                lrHabTMP.Delegacion        := lrHab.Delegacion;
                lrHabTMP."N§ Contrato"     := lrHab."N§ Contrato";
                lrHabTMP."Tipo contrato"   := lrHab."Tipo contrato";
                lrHabTMP."Habitacion cupo" := lrHab."Habitacion cupo";
                lrHabTMP.INSERT;
              END;
            UNTIL lrHab.NEXT = 0;
          END;

          lrHabTMP.RESET;
          IF lrHabTMP.FINDSET THEN
          BEGIN
            REPEAT
              CLEAR(lrPre);
              lrPre.VALIDATE(Delegacion     , lrCont.Delegacion);
              lrPre.VALIDATE("N§ Contrato"  , lrCont."N§ Contrato compra");
              lrPre.VALIDATE("Codigo Precio", lrPre."Codigo Precio"::Habitacion);
              lrPre.VALIDATE(Codigo         , lrHabTMP."Habitacion cupo");
              lrPre.VALIDATE("Fecha desde"  , lrCont."Fecha inicio contrato");
              lrPre.VALIDATE("Fecha hasta"  , lrCont."Fecha final contrato");
              lrPre.INSERT(TRUE);

              CLEAR(lrCupo);
              lrCupo.VALIDATE(Delegacion          , lrCont.Delegacion);
              lrCupo.VALIDATE("N§ Contrato compra", lrCont."N§ Contrato compra");
              lrCupo.VALIDATE("Habitacion cupo"   , lrHabTMP."Habitacion cupo");
              lrCupo.VALIDATE("Fecha desde"       , lrCont."Fecha inicio contrato");
              lrCupo.VALIDATE("Fecha hasta"       , lrCont."Fecha final contrato");
              lrCupo.INSERT(TRUE);
            UNTIL lrHabTMP.NEXT = 0;
          END;

          CLEAR(lrPre);
          lrPre.VALIDATE(Delegacion     , lrCont.Delegacion);
          lrPre.VALIDATE("N§ Contrato"  , lrCont."N§ Contrato compra");
          lrPre.VALIDATE("Codigo Precio", lrPre."Codigo Precio"::Regimen);
          lrPre.VALIDATE(Codigo         , 'AI');
          lrPre.VALIDATE("Fecha desde"  , lrCont."Fecha inicio contrato");
          lrPre.VALIDATE("Fecha hasta"  , lrCont."Fecha final contrato");
          lrPre.INSERT(TRUE);

          CLEAR(lrPre);
          lrPre.VALIDATE(Delegacion     , lrCont.Delegacion);
          lrPre.VALIDATE("N§ Contrato"  , lrCont."N§ Contrato compra");
          lrPre.VALIDATE("Codigo Precio", lrPre."Codigo Precio"::Regimen);
          lrPre.VALIDATE(Codigo         , 'EP');
          lrPre.VALIDATE("Fecha desde"  , lrCont."Fecha inicio contrato");
          lrPre.VALIDATE("Fecha hasta"  , lrCont."Fecha final contrato");
          lrPre.INSERT(TRUE);
        UNTIL lrCont.NEXT = 0;
      END;
    END;

    PROCEDURE RellenarGuiaVentaContrato@1100217004();
    VAR
      lrCont@1100217000 : Record 7010142;
    BEGIN
      // RellenarGuiaVentaContrato

      lrCont.RESET;
      lrCont.SETRANGE("Tipo Contrato", lrCont."Tipo Contrato"::"Guia Venta");
      IF lrCont.FINDSET THEN
      BEGIN
        REPEAT
          lrCont."Guia Venta" := lrCont.Proveedor;
          lrCont.MODIFY;
        UNTIL lrCont.NEXT = 0;
      END;
    END;

    PROCEDURE VaciarParametros_OLD@1100217005();
    VAR
      lrPar@1100217000 : Record 7009700;
      lrCompany@1100217001 : Record 2000000006;
    BEGIN
      // VaciarParametros_OLD

      lrCompany.FINDSET;
      REPEAT
        lrPar.CHANGECOMPANY(lrCompany.Name);
        IF lrPar.FINDFIRST THEN
        BEGIN
          lrPar."O_TourOperador BLANK"           := '';
          lrPar."O_Libro diario general"         := '';
          lrPar."OLD_Contador Grupos"            := 0;
          lrPar."OLD_Ultimo Debit/Credit"        := 0;
          lrPar."OLD_Fecha contratos desde"      := 0D;
          lrPar."OLD_Fecha contratos hasta"      := 0D;
          lrPar."OLD_Ultimo factura venta fisic" := '';
          lrPar."O_Liquidacion por caja"         := FALSE;
          lrPar."O_Serie documentos liquidacion" := '';
          lrPar."O_Banco Caja"                   := '';
          lrPar."OLD_Contador Bono impresion"    := '';
          lrPar.MODIFY;
        END;
      UNTIL lrCompany.NEXT = 0;
    END;

    PROCEDURE VaciarObsolServicioExcursion@1100217007();
    VAR
      lrCompany@1100217000 : Record 2000000006;
      lrSer@1100217001 : Record 7010163;
    BEGIN
      lrCompany.FINDSET;
      REPEAT
        lrSer.CHANGECOMPANY(lrCompany.Name);
        IF lrSer.FINDSET(TRUE) THEN
        BEGIN
          lrSer.MODIFYALL("O_N§ Pax Liquidar GO", 0);
          lrSer.MODIFYALL("O_N§ Pax Liquidar Transportist", 0);
        END;
      UNTIL lrCompany.NEXT = 0;
    END;

    PROCEDURE Vaciar_OldReservaExcursion@1100217006();
    VAR
      lrCompany@1100217001 : Record 2000000006;
      lrRsv@1100217000 : Record 7010162;
    BEGIN
      // Vaciar_OldReservaExcursion

      lrCompany.FINDSET;
      REPEAT
        lrRsv.CHANGECOMPANY(lrCompany.Name);
        IF lrRsv.FINDSET(TRUE) THEN
        BEGIN
          //lrRsv.MODIFYALL("O_Argumento TourOperador"      , '');
          //lrRsv.MODIFYALL(O_ImporteMargen                 , 0);
          //lrRsv.MODIFYALL(O_MargenComisionable            , 0);
          lrRsv.MODIFYALL("o_Liquidado TO"                , FALSE);
          lrRsv.MODIFYALL("o_N§ liquidacion TO"           , 0);
          lrRsv.MODIFYALL("o_Previo Liquidar"             , FALSE);
          lrRsv.MODIFYALL("o_Marca C/I"                   , '');
          lrRsv.MODIFYALL("o_Semana Excursion"            , 0);
          //lrRsv.MODIFYALL("o_recio descuento TO reembolso" , 0);
          //lrRsv.MODIFYALL("o_N§ liquidacion TO anul/reem" , 0);
          //lrRsv.MODIFYALL("o_Importe liquidado TO"        , 0);
          //lrRsv.MODIFYALL("o_Precio comision GV reembolso", 0);
          //lrRsv.MODIFYALL("o_Fecha Liquidacion TO"        , 0D);
          //lrRsv.MODIFYALL("o_cha Liquidacion anul/reem TO", 0D);
          //lrRsv.MODIFYALL("o_Semana Liquidacion GV"       , 0);
          //lrRsv.MODIFYALL("o_mana Liquidacion anul/ree GV", 0);
          //lrRsv.MODIFYALL("o_Semana Liquidacion TO"       , 0);
          //lrRsv.MODIFYALL("o_mana Liquidacion anul/ree TO", 0);
        END;
      UNTIL lrCompany.NEXT = 0;
    END;

    PROCEDURE VaciaFechaCambioCobro@1100217008();
    VAR
      lrCompany@1100217000 : Record 2000000006;
      lrCobro@1100217001 : Record 7010240;
    BEGIN
      // VaciaFechaCambioCobro

      lrCompany.RESET;
      IF lrCompany.FINDSET THEN
      BEGIN
        REPEAT
          lrCobro.CHANGECOMPANY(lrCompany.Name);
          IF lrCobro.FINDSET THEN
          BEGIN
            lrCobro.MODIFYALL("O_Fecha Cambio", 0D);
          END;
        UNTIL lrCompany.NEXT = 0;
      END;
    END;

    PROCEDURE VaciarCamposLiquidaciones@1100217009();
    VAR
      lrCompany@1100217001 : Record 2000000006;
      lrLiquidaciones@1100217000 : Record 7010178;
    BEGIN
      // VaciarCamposLiquidaciones

      lrCompany.RESET;
      IF lrCompany.FINDSET THEN
      BEGIN
        REPEAT
          lrLiquidaciones.CHANGECOMPANY(lrCompany.Name);
          IF lrLiquidaciones.FINDSET(TRUE) THEN
          BEGIN
            lrLiquidaciones.MODIFYALL(O_Tipo, '');
            lrLiquidaciones.MODIFYALL(O_Codigo, '');
          END;
        UNTIL lrCompany.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaPreDtoTTOODet@1100217010();
    VAR
      lrCompany@1100217000 : Record 2000000006;
      lrRsv@1100217001 : Record 7010162;
      lrDetEco@1100217002 : Record 7010245;
    BEGIN
      // RellenaPreDtoTTOODet

      lrCompany.RESET;
      IF lrCompany.FINDSET THEN
      BEGIN
        REPEAT
          lrRsv.CHANGECOMPANY(lrCompany.Name);
          IF lrRsv.FINDSET(TRUE) THEN
          BEGIN
            REPEAT
              IF lrDetEco.GET(lrRsv.Delegacion, lrRsv."N§ Reserva") THEN
              BEGIN
                lrDetEco."Precio Descuento Touroperador" := lrRsv."Precio Descuento Touroperador";
                lrDetEco.MODIFY;
              END;
            UNTIL lrRsv.NEXT = 0;
          END;
        UNTIL lrCompany.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaIDTarifaExc@1100217011();
    VAR
      lrCompany@1100217000 : Record 2000000006;
      lrTar@1100217001 : Record 7010147;
      lrPre@1100217003 : Record 7010148;
      lrZon@1100217004 : Record 7010149;
      lrHisTarifa@1100217006 : Record 7009764;
      lrHistPrecio@1100217005 : Record 7010160;
      lwID@1100217002 : Integer;
    BEGIN
      // RellenaIDTarifaExc

      lrCompany.RESET;
      IF lrCompany.FINDSET THEN
      BEGIN
        REPEAT
          lrTar.CHANGECOMPANY(lrCompany.Name);
          IF lrTar.FINDSET(TRUE) THEN
          BEGIN
            lwID := 0;
            REPEAT
              lwID += 1;
              lrTar."ID Tarifa" := lwID;
              lrTar.MODIFY;

              lrPre.CHANGECOMPANY(lrCompany.Name);
              lrPre.SETRANGE(Delegacion        , lrTar.Delegacion);
              lrPre.SETRANGE(Excursion         , lrTar.Excursion);
              lrPre.SETRANGE("Temporada Tarifa", lrTar.Temporada);
              IF lrPre.FINDSET(TRUE) THEN
                lrPre.MODIFYALL("ID Tarifa", lrTar."ID Tarifa");

              lrZon.CHANGECOMPANY(lrCompany.Name);
              lrZon.SETRANGE(Excursion        , lrTar.Excursion);
              lrZon.SETRANGE("Codigo Contrato", lrTar.Temporada);
              lrZon.SETRANGE("Tipo Contrato"  , lrZon."Tipo Contrato"::Venta);
              IF lrZon.FINDSET(TRUE) THEN
                lrZon.MODIFYALL("ID Tarifa", lrTar."ID Tarifa");

              lrHisTarifa.CHANGECOMPANY(lrCompany.Name);
              lrHisTarifa.SETRANGE(Delegacion   , lrTar.Excursion);
              lrHisTarifa.SETRANGE("N§ Contrato", lrTar.Temporada);
              lrHisTarifa.SETRANGE(Tipo         , lrHisTarifa.Tipo::"Excursion Venta");
              IF lrHisTarifa.FINDSET(TRUE) THEN
                lrHisTarifa.MODIFYALL("No Linea", lrTar."ID Tarifa");

              lrHistPrecio.CHANGECOMPANY(lrCompany.Name);
              lrHistPrecio.SETRANGE(Producto       , lrTar.Excursion);
              lrHistPrecio.SETRANGE(Temporada      , lrTar.Temporada);
              lrHistPrecio.SETRANGE(Tipo           , lrHistPrecio.Tipo::Venta);
              IF lrHistPrecio.FINDSET(TRUE) THEN
                lrHistPrecio.MODIFYALL("ID Tarifa", lrTar."ID Tarifa");
            UNTIL lrTar.NEXT = 0;
          END;
        UNTIL lrCompany.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaFechaVentaCobro@1100217012();
    VAR
      lrCompany@1100217002 : Record 2000000006;
      lrCobro@1100217000 : Record 7010240;
      lrRsv@1100217001 : Record 7010162;
    BEGIN
      // RellenaFechaVentaCobro

      lrCompany.RESET;
      IF lrCompany.FINDSET THEN
      BEGIN
        REPEAT
          lrCobro.CHANGECOMPANY(lrCompany.Name);
          IF lrCobro.FINDSET THEN
          BEGIN
            REPEAT
              lrRsv.CHANGECOMPANY(lrCompany.Name);
              IF lrRsv.GET(lrCobro.Delegacion, lrCobro."Num Reserva") THEN
              BEGIN
                lrCobro."Fecha venta" := lrRsv."Fecha Venta";
                lrCobro.MODIFY;
              END;
            UNTIL lrCobro.NEXT = 0;
          END;
        UNTIL lrCompany.NEXT = 0;
      END;
    END;

    PROCEDURE VaciarCamposDLExcursiones@1100217013();
    VAR
      lrPreExc@1100217000 : Record 7010151;
      lrPreTra@1100217001 : Record 7010150;
      lrPreGO@1100217002 : Record 7010154;
      lrPreGV@1100217003 : Record 7010152;
      lrPreTO@1100217004 : Record 7010153;
    BEGIN
      // VaciarCamposDLExcursiones

      lrPreExc.RESET;
      IF lrPreExc.FINDSET(TRUE) THEN
      BEGIN
        lrPreExc.MODIFYALL("O_Precio (DL)"       , 0);
        lrPreExc.MODIFYALL("O_Precio Adulto (DL)", 0);
        lrPreExc.MODIFYALL("O_Precio Ni¤o (DL)"  , 0);
      END;

      lrPreTra.RESET;
      IF lrPreTra.FINDSET(TRUE) THEN
        lrPreTra.MODIFYALL("O_Precio (DL)", 0);

      lrPreGO.RESET;
      IF lrPreGO.FINDSET(TRUE) THEN
      BEGIN
        lrPreGO.MODIFYALL("o_Precio (DL)"       , 0);
        lrPreGO.MODIFYALL("o_Precio Adulto (DL)", 0);
        lrPreGO.MODIFYALL("o_Precio Ni¤o (DL)"  , 0);
      END;

      lrPreGV.RESET;
      IF lrPreGV.FINDSET(TRUE) THEN
        lrPreGV.MODIFYALL("o_Precio (DL)", 0);

      lrPreTO.RESET;
      IF lrPreTO.FINDSET(TRUE) THEN
        lrPreTO.MODIFYALL("o_Precio (DL)", 0);
    END;

    PROCEDURE RellenaTipoPagoCobro@1100217014();
    VAR
      lrCobro@1100217000 : Record 7010240;
      lrPayment@1100217001 : Record 289;
    BEGIN
      // RellenaTipoPagoCobro

      lrCobro.RESET;
      IF lrCobro.FINDSET(TRUE) THEN
      BEGIN
        REPEAT
          IF lrPayment.GET(lrCobro."Forma de Pago") THEN
          BEGIN
            lrCobro."Tipo pago" := lrPayment."Tipo pago";
            lrCobro.MODIFY;
          END;
        UNTIL lrCobro.NEXT = 0;
      END;
    END;

    PROCEDURE VaciarMaestrodeClaves@1100217015();
    VAR
      r7010474@1100217000 : Record 7010474;
      r7010473@1100217001 : Record 7010473;
      r7010472@1100217002 : Record 7010472;
      r7010471@1100217003 : Record 7010471;
      r7010470@1100217004 : Record 7010470;
      r7010469@1100217005 : Record 7010469;
      r7010468@1100217006 : Record 7010468;
      r7010467@1100217007 : Record 7010467;
      r7010458@1100217008 : Record 7010458;
      r7010457@1100217009 : Record 7010457;
      r7010456@1100217010 : Record 7010456;
      r7010086@1100217011 : Record 7010086;
      r7009909@1100217012 : Record 7009909;
      r254@1100217013 : Record 254;
      r125@1100217014 : Record 125;
      r124@1100217015 : Record 124;
      r123@1100217016 : Record 123;
      r122@1100217017 : Record 122;
      r115@1100217018 : Record 115;
      r114@1100217019 : Record 114;
      r113@1100217020 : Record 113;
      r112@1100217021 : Record 112;
      r81@1100217022 : Record 81;
      r49@1100217023 : Record 49;
      r39@1100217024 : Record 39;
      r38@1100217025 : Record 38;
      r37@1100217026 : Record 37;
      r36@1100217027 : Record 36;
      r25@1100217028 : Record 25;
      r21@1100217029 : Record 21;
      r17@1100217030 : Record 17;
    BEGIN
      // VaciarMaestrodeClaves

      r7010474.RESET;
      r7010474.MODIFYALL("Tipo de Clave", '');

      r7010473.RESET;
      r7010473.MODIFYALL("Tipo de Clave", '');

      r7010472.RESET;
      r7010472.MODIFYALL("Tipo de Clave", '');

      r7010471.RESET;
      r7010471.MODIFYALL("Tipo de Clave", '');

      r7010470.RESET;
      r7010470.MODIFYALL("Tipo de Clave", '');

      r7010469.RESET;
      r7010469.MODIFYALL("Tipo de Clave", '');

      r7010468.RESET;
      r7010468.MODIFYALL("Tipo de Clave", '');

      r7010467.RESET;
      r7010467.MODIFYALL("Tipo de Clave", '');

      r7010458.RESET;
      r7010458.MODIFYALL("Tipo de clave", '');

      r7010457.RESET;
      r7010457.MODIFYALL("Tipo de Clave", '');

      r7010456.RESET;
      r7010456.MODIFYALL("Tipo de clave", '');

      r7010086.RESET;
      r7010086.DELETEALL;

      r7009909.RESET;
      r7009909.MODIFYALL("Tipo de Clave", '');

      r254.RESET;
      r254.MODIFYALL("Tipo de clave", '');

      r125.RESET;
      r125.MODIFYALL("Tipo de Clave", '');

      r124.RESET;
      r124.MODIFYALL("Tipo de Clave", '');

      r123.RESET;
      r123.MODIFYALL("Tipo de Clave", '');

      r122.RESET;
      r122.MODIFYALL("Tipo de Clave", '');

      r115.RESET;
      r115.MODIFYALL("Tipo de Clave", '');

      r114.RESET;
      r114.MODIFYALL("Tipo de Clave", '');

      r113.RESET;
      r113.MODIFYALL("Tipo de Clave", '');

      r112.RESET;
      r112.MODIFYALL("Tipo de Clave", '');

      r81.RESET;
      r81.MODIFYALL("Tipo de Clave", '');

      r49.RESET;
      r49.MODIFYALL("Tipo de Clave", '');

      r39.RESET;
      r39.MODIFYALL("Tipo de Clave", '');

      r38.RESET;
      r38.MODIFYALL("Tipo de Clave", '');

      r37.RESET;
      r37.MODIFYALL("Tipo de Clave", '');

      r36.RESET;
      r36.MODIFYALL("Tipo de Clave", '');

      r25.RESET;
      r25.MODIFYALL("Tipo de Clave", '');

      r21.RESET;
      r21.MODIFYALL("Tipo de Clave", '');

      r17.RESET;
      r17.MODIFYALL("Tipo de clave", '');
    END;

    PROCEDURE CampoBDContabilidad@1100217016();
    VAR
      lrCompany@1100217000 : Record 2000000006;
      lrPar@1100217001 : Record 7009700;
    BEGIN
      // CampoBDContabilidad

      lrCompany.FINDFIRST;
      REPEAT
        lrPar.CHANGECOMPANY(lrCompany.Name);
        IF lrPar.FINDFIRST THEN
        BEGIN
          lrPar."O_BD Contabilidad" := FALSE;
          lrPar.MODIFY;
        END;
      UNTIL lrCompany.NEXT = 0;
    END;

    PROCEDURE RellenarTransferPrivadoCoste@1100217017();
    VAR
      lrCoste@1100217000 : Record 7009805;
      lrAgrupacion@1100217001 : Record 7009796;
    BEGIN
      // RellenarTransferPrivadoCoste

      lrCoste.RESET;
      lrCoste.SETRANGE(Concepto, 'TRNC');
      IF lrCoste.FINDSET(TRUE) THEN
      BEGIN
        REPEAT
          IF lrAgrupacion.GET(lrCoste.Agrupacion) THEN
          BEGIN
            lrCoste."Transfer Privado" := lrAgrupacion."Transfer Privado";
            lrCoste.MODIFY;
          END;
        UNTIL lrCoste.NEXT = 0;
      END;
    END;

    PROCEDURE VaciarTablasEBB@1100217018();
    VAR
      lr7009836@1100217001 : Record 7009836;
      lr7009837@1100217000 : Record 7009837;
      lr7009838@1100217003 : Record 7009838;
      lr7009839@1100217002 : Record 7009839;
      lr7009880@1100217004 : Record 7009880;
      lr7009890@1100217005 : Record 7009890;
    BEGIN
      // VaciarTablasEBB

      lr7009836.RESET;
      lr7009836.DELETEALL;

      lr7009837.RESET;
      lr7009837.DELETEALL;

      lr7009838.RESET;
      lr7009838.DELETEALL;

      lr7009839.RESET;
      lr7009839.DELETEALL;

      lr7009880.RESET;
      lr7009880.DELETEALL;

      lr7009890.RESET;
      lr7009890.DELETEALL;
    END;

    PROCEDURE EnviarConfirmacionTouroperador@1100217019();
    VAR
      lrCompany@1100217000 : Record 2000000006;
      lrCab@1100217001 : Record 7009741;
    BEGIN
      lrCompany.RESET;
      lrCompany.FINDSET;
      REPEAT
        lrCab.CHANGECOMPANY(lrCompany.Name);
        IF lrCab.FINDSET(TRUE) THEN
          lrCab.MODIFYALL("Confirmacion servicios enviada", TRUE);
      UNTIL lrCompany.NEXT = 0;
    END;

    PROCEDURE NuevoTransferPrivado@1100217020();
    VAR
      lrRsv@1100217001 : Record 7009744;
    BEGIN
      // NuevoTransferPrivado

      IF lrRsv.FINDSET(TRUE) THEN
      BEGIN
        REPEAT
          lrRsv."Transfer Privado Salida" := lrRsv."Transfer Privado Llegada";
          lrRsv.MODIFY;
        UNTIL lrRsv.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaPrecioPersonaTransfer@1100217021();
    VAR
      lrContV@1100217004 : Record 7009788;
      lrPreV@1100217000 : Record 7009790;
      lrPreV2@1100217001 : Record 7009790;
      lrContC@1100217005 : Record 7009787;
      lrPreC@1100217002 : Record 7009789;
      lrPreC2@1100217003 : Record 7009789;
    BEGIN
      // RellenaPrecioPersonaTransfer

      rParPer.FINDFIRST;

      lrContV.RESET;
      lrContV.SETFILTER("Fecha final contrato", '>=%1', 010111D);
      IF lrContV.FINDSET THEN
      BEGIN
        REPEAT
          lrPreV.RESET;
          lrPreV.SETRANGE(Delegacion       , lrContV.Delegacion);
          lrPreV.SETRANGE("N§ Contrato"    , lrContV."N§ Contrato Venta");
          lrPreV.SETRANGE("Codigo precio"  , lrPreV."Codigo precio"::"Precio Base");
          lrPreV.SETRANGE("Tipo Aplicacion", lrPreV."Tipo Aplicacion"::Pax);
          lrPreV.SETRANGE("Tipo elemento"  , '');
          IF lrPreV.FINDSET(TRUE) THEN
          BEGIN
            REPEAT
              //. Buscamos si esta linea tiene precio adulto relacionado
              lrPreV2.COPY(lrPreV);
              lrPreV2.SETRANGE("Tipo elemento"        , rParPer."Codigo Adulto");
              lrPreV2.SETRANGE("old_Orden dependiente", lrPreV."Orden precio");
              IF lrPreV2.FINDFIRST THEN
              BEGIN
                lrPreV."Precio Adulto" := lrPreV2.Precio;
                lrPreV2.DELETE;
              END
              ELSE
                lrPreV."Precio Adulto" := lrPreV.Precio;

              //. Buscamos si esta linea tiene precio ni¤o relacionado
              lrPreV2.COPY(lrPreV);
              lrPreV2.SETRANGE("Tipo elemento"        , rParPer."Codigo Ni¤o");
              lrPreV2.SETRANGE("old_Orden dependiente", lrPreV."Orden precio");
              IF lrPreV2.FINDFIRST THEN
              BEGIN
                lrPreV."Precio Ni¤o" := lrPreV2.Precio;
                lrPreV2.DELETE;
              END
              ELSE
                lrPreV."Precio Ni¤o" := lrPreV.Precio;

              lrPreV.Precio := 0;
              lrPreV.MODIFY;
            UNTIL lrPreV.NEXT = 0;
          END;
        UNTIL lrContV.NEXT = 0;
      END;

      lrContC.RESET;
      lrContC.SETFILTER("Fecha final contrato", '>=%1', 010111D);
      IF lrContC.FINDSET THEN
      BEGIN
        REPEAT
          lrPreC.RESET;
          lrPreC.SETRANGE(Delegacion       , lrContC.Delegacion);
          lrPreC.SETRANGE("N§ Contrato"    , lrContC."N§ Contrato compra");
          lrPreC.SETRANGE("Codigo precio"  , lrPreC."Codigo precio"::"Precio base");
          lrPreC.SETRANGE("Tipo aplicacion", lrPreC."Tipo aplicacion"::Pax);
          lrPreC.SETRANGE("Tipo elemento"  , '');
          IF lrPreC.FINDSET(TRUE) THEN
          BEGIN
            REPEAT
              //. Buscamos si esta linea tiene precio adulto relacionado
              lrPreC2.COPY(lrPreC);
              lrPreC2.SETRANGE("Tipo elemento"        , rParPer."Codigo Adulto");
              lrPreC2.SETRANGE("old_Orden dependiente", lrPreC."Orden precio");
              IF lrPreC2.FINDFIRST THEN
              BEGIN
                lrPreC."Precio Adulto" := lrPreC2.Precio;
                lrPreC2.DELETE;
              END
              ELSE
                lrPreC."Precio Adulto" := lrPreC.Precio;

              //. Buscamos si esta linea tiene precio ni¤o relacionado
              lrPreC2.COPY(lrPreC);
              lrPreC2.SETRANGE("Tipo elemento"        , rParPer."Codigo Ni¤o");
              lrPreC2.SETRANGE("old_Orden dependiente", lrPreC."Orden precio");
              IF lrPreC2.FINDFIRST THEN
              BEGIN
                lrPreC."Precio Ni¤o" := lrPreC2.Precio;
                lrPreC2.DELETE;
              END
              ELSE
                lrPreC."Precio Ni¤o" := lrPreC.Precio;

              lrPreC.Precio := 0;
              lrPreC.MODIFY;
            UNTIL lrPreC.NEXT = 0;
          END;
        UNTIL lrContC.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaOrigenPrecioTransfer@1100217022();
    VAR
      lrTouroperador@1100217004 : Record 7009717;
      lrContV@1100217000 : Record 7009788;
      lrContV2@1100217009 : Record 7009788;
      lrContV3@1100217011 : Record 7009788;
      lrPreV@1100217001 : Record 7009790;
      lrPreV2@1100217012 : Record 7009790;
      lrPreV3@1100217016 : Record 7009790;
      lrTransportista@1100217005 : Record 7009801;
      lrContC@1100217002 : Record 7009787;
      lrContC2@1100217010 : Record 7009787;
      lrContC3@1100217013 : Record 7009787;
      lrPreC@1100217003 : Record 7009789;
      lrPreC2@1100217014 : Record 7009789;
      lrPreC3@1100217015 : Record 7009789;
      lrAeropuerto@1100217007 : Record 7009704;
      lrZonTra@1100217008 : Record 7009791;
      lrIngreso@1100217017 : Record 7009805;
      lrCoste@1100217018 : Record 7009805;
      lwTienePrecios@1100217006 : Boolean;
    BEGIN
      // RellenaOrigenPrecioTransfer

      lrTouroperador.RESET;
      IF lrTouroperador.FINDSET THEN
      BEGIN
        REPEAT
          lrContV.SETCURRENTKEY(TourOperador, "Fecha inicio contrato", "Fecha final contrato");
          lrContV.SETRANGE (TourOperador              , lrTouroperador.TourOperador);
          lrContV.SETFILTER("Fecha final contrato"    , '>=%1', 010111D);
          lrContV.SETFILTER("OLD_Punto Origen/Destino", '<>%1', '');
          lrContV.SETRANGE (Confirmado                , TRUE);
          IF lrContV.FINDFIRST THEN
          BEGIN
            REPEAT
              lwTienePrecios := FALSE;

              lrAeropuerto.GET(lrContV."OLD_Punto Origen/Destino");

              lrZonTra.RESET;
              lrZonTra.SETRANGE(Contrato       , lrContV."N§ Contrato Venta");
              lrZonTra.SETRANGE("Tipo contrato", lrZonTra."Tipo contrato"::Venta);
              lrZonTra.SETRANGE("Zona fisica"  , lrAeropuerto."Zona fisica");
              IF NOT lrZonTra.FINDFIRST THEN
              BEGIN
                lrZonTra.Zona            := lrAeropuerto."Zona fisica";
                lrZonTra.Contrato        := lrContV."N§ Contrato Venta";
                lrZonTra."Tipo contrato" := lrZonTra."Tipo contrato"::Venta;
                lrZonTra."Zona fisica"   := lrAeropuerto."Zona fisica";
                lrZonTra.INSERT;
              END;

              lrPreV.SETRANGE(Delegacion   , lrContV.Delegacion);
              lrPreV.SETRANGE("N§ Contrato", lrContV."N§ Contrato Venta");
              lrPreV.SETRANGE(Activo       , TRUE);
              IF lrPreV.FINDSET THEN
              BEGIN
                lwTienePrecios := TRUE;
                REPEAT
                  lrPreV.Origen := lrZonTra.Zona;
                  lrPreV.MODIFY;
                UNTIL lrPreV.NEXT = 0;
              END;

              IF lwTienePrecios THEN
              BEGIN
                lrContV2.SETCURRENTKEY(TourOperador, "Fecha inicio contrato", "Fecha final contrato");
                lrContV2.SETRANGE (TourOperador              , lrContV.TourOperador);
                lrContV2.SETFILTER("N§ Contrato Venta"       , '<>%1', lrContV."N§ Contrato Venta");
                lrContV2.SETRANGE ("Fecha inicio contrato"   , lrContV."Fecha inicio contrato");
                lrContV2.SETRANGE ("Fecha final contrato"    , lrContV."Fecha final contrato");
                lrContV2.SETFILTER("OLD_Punto Origen/Destino", '<>%1', '');
                lrContV2.SETRANGE (Confirmado                , TRUE);
                IF lrContV2.FINDSET THEN
                BEGIN
                  REPEAT
                    lrAeropuerto.GET(lrContV2."OLD_Punto Origen/Destino");

                    lrZonTra.RESET;
                    lrZonTra.SETRANGE(Contrato       , lrContV2."N§ Contrato Venta");
                    lrZonTra.SETRANGE("Tipo contrato", lrZonTra."Tipo contrato"::Venta);
                    lrZonTra.SETRANGE("Zona fisica"  , lrAeropuerto."Zona fisica");
                    IF NOT lrZonTra.FINDFIRST THEN
                    BEGIN
                      lrZonTra.Zona            := lrAeropuerto."Zona fisica";
                      lrZonTra.Contrato        := lrContV2."N§ Contrato Venta";
                      lrZonTra."Tipo contrato" := lrZonTra."Tipo contrato"::Venta;
                      lrZonTra."Zona fisica"   := lrAeropuerto."Zona fisica";
                      lrZonTra.INSERT;
                    END;

                    lrPreV.SETRANGE(Delegacion   , lrContV2.Delegacion);
                    lrPreV.SETRANGE("N§ Contrato", lrContV2."N§ Contrato Venta");
                    lrPreV.SETRANGE(Activo       , TRUE);
                    IF lrPreV.FINDSET THEN
                    BEGIN
                      REPEAT
                        lrPreV3 := lrPreV;
                        lrPreV3."N§ Contrato"  := lrContV."N§ Contrato Venta";
                        lrPreV3."Orden precio" := 0;
                        lrPreV3.Origen         := lrZonTra.Zona;
                        lrPreV3.INSERT(TRUE);

                        lrPreV2 := lrPreV;
                        lrPreV2.DELETE;
                      UNTIL lrPreV.NEXT = 0;
                    END;

                    //. Modificar el contrato de las lineas de ingreso transfer
                    lrIngreso.RESET;
                    lrIngreso.SETRANGE(Concepto       , 'TRNI');
                    lrIngreso.SETRANGE("Num. Contrato", lrContV2."N§ Contrato Venta");
                    IF lrIngreso.FINDSET(TRUE, TRUE) THEN
                      lrIngreso.MODIFYALL("Num. Contrato", lrContV."N§ Contrato Venta");

                    lrContV3 := lrContV2;
                    lrContV3.DELETE;
                  UNTIL lrContV2.NEXT = 0;
                END;
              END;
            UNTIL lrContV.NEXT = 0;
          END;
        UNTIL lrTouroperador.NEXT = 0;
      END;

      lrTransportista.RESET;
      IF lrTransportista.FINDSET THEN
      BEGIN
        REPEAT
          lrContC.SETCURRENTKEY(Proveedor, "Fecha inicio contrato", "Fecha final contrato");
          lrContC.SETRANGE (Transportista             , lrTransportista.Codigo);
          lrContC.SETFILTER("Fecha final contrato"    , '>=%1', 010111D);
          lrContC.SETFILTER("OLD_Punto Origen/Destino", '<>%1', '');
          lrContC.SETRANGE (Confirmado                , TRUE);
          IF lrContC.FINDFIRST THEN
          BEGIN
            REPEAT
              lwTienePrecios := FALSE;

              lrAeropuerto.GET(lrContC."OLD_Punto Origen/Destino");

              lrZonTra.RESET;
              lrZonTra.SETRANGE(Contrato       , lrContC."N§ Contrato compra");
              lrZonTra.SETRANGE("Tipo contrato", lrZonTra."Tipo contrato"::Compra);
              lrZonTra.SETRANGE("Zona fisica"  , lrAeropuerto."Zona fisica");
              IF NOT lrZonTra.FINDFIRST THEN
              BEGIN
                lrZonTra.Zona            := lrAeropuerto."Zona fisica";
                lrZonTra.Contrato        := lrContC."N§ Contrato compra";
                lrZonTra."Tipo contrato" := lrZonTra."Tipo contrato"::Compra;
                lrZonTra."Zona fisica"   := lrAeropuerto."Zona fisica";
                lrZonTra.INSERT;
              END;

              lrPreC.SETRANGE(Delegacion   , lrContC.Delegacion);
              lrPreC.SETRANGE("N§ Contrato", lrContC."N§ Contrato compra");
              lrPreC.SETRANGE(Activo       , TRUE);
              IF lrPreC.FINDSET THEN
              BEGIN
                lwTienePrecios := TRUE;
                REPEAT
                  lrPreC.Origen        := lrZonTra.Zona;
                  lrPreC.MODIFY;
                UNTIL lrPreC.NEXT = 0;
              END;

              IF lwTienePrecios THEN
              BEGIN
                lrContC2.SETCURRENTKEY(Proveedor, "Fecha inicio contrato", "Fecha final contrato");
                lrContC2.SETRANGE (Transportista             , lrContC.Transportista);
                lrContC2.SETFILTER("N§ Contrato compra"      , '<>%1', lrContC."N§ Contrato compra");
                lrContC2.SETRANGE ("Fecha inicio contrato"   , lrContC."Fecha inicio contrato");
                lrContC2.SETRANGE ("Fecha final contrato"    , lrContC."Fecha final contrato");
                lrContC2.SETFILTER("OLD_Punto Origen/Destino", '<>%1', '');
                lrContC2.SETRANGE (Confirmado                , TRUE);
                IF lrContC2.FINDSET THEN
                BEGIN
                  REPEAT
                    lrAeropuerto.GET(lrContC2."OLD_Punto Origen/Destino");

                    lrZonTra.RESET;
                    lrZonTra.SETRANGE(Contrato       , lrContC2."N§ Contrato compra");
                    lrZonTra.SETRANGE("Tipo contrato", lrZonTra."Tipo contrato"::Compra);
                    lrZonTra.SETRANGE("Zona fisica"  , lrAeropuerto."Zona fisica");
                    IF NOT lrZonTra.FINDFIRST THEN
                    BEGIN
                      lrZonTra.Zona            := lrAeropuerto."Zona fisica";
                      lrZonTra.Contrato        := lrContC2."N§ Contrato compra";
                      lrZonTra."Tipo contrato" := lrZonTra."Tipo contrato"::Compra;
                      lrZonTra."Zona fisica"   := lrAeropuerto."Zona fisica";
                      lrZonTra.INSERT;
                    END;

                    lrPreC.SETRANGE(Delegacion   , lrContC2.Delegacion);
                    lrPreC.SETRANGE("N§ Contrato", lrContC2."N§ Contrato compra");
                    lrPreC.SETRANGE(Activo       , TRUE);
                    IF lrPreC.FINDSET THEN
                    BEGIN
                      REPEAT
                        lrPreC3 := lrPreC;
                        lrPreC3."N§ Contrato"  := lrContC."N§ Contrato compra";
                        lrPreC3."Orden precio" := 0;
                        lrPreC3.Origen         := lrZonTra.Zona;
                        lrPreC3.INSERT(TRUE);

                        lrPreC2 := lrPreC;
                        lrPreC2.DELETE;
                      UNTIL lrPreC.NEXT = 0;
                    END;

                    //. Modificar el contrato de las lineas de ingreso transfer
                    lrCoste.RESET;
                    lrCoste.SETRANGE(Concepto       , 'TRNC');
                    lrCoste.SETRANGE("Num. Contrato", lrContC2."N§ Contrato compra");
                    IF lrCoste.FINDSET(TRUE, TRUE) THEN
                      lrCoste.MODIFYALL("Num. Contrato", lrContC."N§ Contrato compra");

                    lrContC3 := lrContC2;
                    lrContC3.DELETE;
                  UNTIL lrContC2.NEXT = 0;
                END;
              END;

            UNTIL lrContC.NEXT = 0;
          END;
        UNTIL lrTransportista.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaOrigenCITransfer@1100217023();
    VAR
      rCI@1100217000 : Record 7009805;
      lrAeropuerto@1100217001 : Record 7009704;
      lrZonTra@1100217002 : Record 7009791;
    BEGIN
      // RellenaOrigenCITransfer

      rCI.RESET;
      IF rCI.FINDSET THEN
      BEGIN
        REPEAT
          IF rCI.Concepto = 'TRNC' THEN
          BEGIN
            IF lrAeropuerto.GET(rCI."Origen/Destino transfer") THEN
            BEGIN
              lrZonTra.RESET;
              lrZonTra.SETRANGE(Contrato       , rCI."Num. Contrato");
              lrZonTra.SETRANGE("Tipo contrato", lrZonTra."Tipo contrato"::Compra);
              lrZonTra.SETRANGE("Zona fisica"  , lrAeropuerto."Zona fisica");
              IF lrZonTra.FINDFIRST THEN
              BEGIN
                rCI.Origen := lrZonTra.Zona;
                rCI.MODIFY;
              END;
            END;
          END
          ELSE
          BEGIN
            IF lrAeropuerto.GET(rCI."Origen/Destino transfer") THEN
            BEGIN
              lrZonTra.RESET;
              lrZonTra.SETRANGE(Contrato       , rCI."Num. Contrato");
              lrZonTra.SETRANGE("Tipo contrato", lrZonTra."Tipo contrato"::Venta);
              lrZonTra.SETRANGE("Zona fisica"  , lrAeropuerto."Zona fisica");
              IF lrZonTra.FINDFIRST THEN
              BEGIN
                rCI.Origen := lrZonTra.Zona;
                rCI.MODIFY;
              END;
            END;
          END;
        UNTIL rCI.NEXT = 0;
      END;
    END;

    PROCEDURE RellenarTipoCambioTransfer@1000000000();
    VAR
      lrCoste@1100217000 : Record 7009805;
      lrCurrExch@1000000000 : Record 330;
    BEGIN
      // RellenarTipoCambioTransfer

      lrCoste.RESET;
      IF lrCoste.FINDSET(TRUE) THEN
      BEGIN
        REPEAT
          IF lrCoste."Cod. divisa" = '' THEN
          BEGIN
            lrCoste."Tipo cambio FPR" := 1;
          END
          ELSE
          BEGIN
            lrCurrExch.SETRANGE ("Currency Code", lrCoste."Cod. divisa");
            lrCurrExch.SETFILTER("Starting Date", '<=%1', lrCoste.Fecha);
            lrCurrExch.FINDLAST;

            lrCoste."Tipo cambio FPR" := lrCurrExch."Relational Exch. Rate Amount";
          END;

          IF lrCoste."N§ Factura" <> '' THEN
            lrCoste."Tipo cambio validacion" := lrCoste."Tipo cambio FPR";
          lrCoste.MODIFY;
        UNTIL lrCoste.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaTipoServicioTransportis@1000000001();
    VAR
      lrAgr@1000000000 : Record 7009796;
      lrCoste@1000000001 : Record 7009805;
    BEGIN
      // RellenaTipoServicioTransportis

      lrAgr.RESET;
      IF lrAgr.FINDSET THEN
      BEGIN
        lrCoste.RESET;
        REPEAT
          lrCoste.SETRANGE(Agrupacion, lrAgr."N§ Agrupacion");
          lrCoste.SETRANGE(Concepto  , 'TRNC');
          IF lrCoste.FINDSET(TRUE) THEN
            lrCoste.MODIFYALL("Tipo servicio transportista", lrAgr."Tipo servicio transportista");
        UNTIL lrAgr.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaTipoServicioTransfer@1000000002();
    VAR
      lrPer@1000000002 : Record 7009742;
      lrRes@1000000003 : Record 7009744;
      lrTras@1000000004 : Record 7009916;
      lrAgr@1000000000 : Record 7009796;
    BEGIN
      // RellenaTipoServicioTransfer

      lrPer.RESET;
      IF lrPer.FINDFIRST THEN BEGIN
        REPEAT
          IF (lrPer."Transfer Privado" = lrPer."Transfer Privado"::Entrada) OR
             (lrPer."Transfer Privado" = lrPer."Transfer Privado"::Ambos) THEN
          BEGIN
            IF lrPer."Tipo vehiculo solicitado" = '' THEN
              lrPer."Servicio transfer entrada" := lrPer."Servicio transfer entrada"::Privado
            ELSE
              lrPer."Servicio transfer entrada" := lrPer."Servicio transfer entrada"::Deluxe;
          END;

          IF (lrPer."Transfer Privado" = lrPer."Transfer Privado"::Salida) OR
             (lrPer."Transfer Privado" = lrPer."Transfer Privado"::Ambos) THEN
          BEGIN
            IF lrPer."Tipo vehiculo solicitado" = '' THEN
              lrPer."Servicio transfer salida" := lrPer."Servicio transfer salida"::Privado
            ELSE
              lrPer."Servicio transfer salida" := lrPer."Servicio transfer salida"::Deluxe;
          END;
          lrPer.MODIFY;
        UNTIL lrPer.NEXT = 0;
      END;

      lrRes.RESET;
      IF lrRes.FINDFIRST THEN BEGIN
        REPEAT
          IF lrRes."Transfer Privado Llegada" THEN
          BEGIN
            IF lrRes."Tipo vehiculo solicitado" = '' THEN
              lrRes."Servicio transfer entrada" := lrRes."Servicio transfer entrada"::Privado
            ELSE
              lrRes."Servicio transfer entrada" := lrRes."Servicio transfer entrada"::Deluxe;
          END;
          IF lrRes."Transfer Privado Salida" THEN
          BEGIN
            IF lrRes."Tipo vehiculo solicitado" = '' THEN
              lrRes."Servicio transfer salida" := lrRes."Servicio transfer salida"::Privado
            ELSE
              lrRes."Servicio transfer salida" := lrRes."Servicio transfer salida"::Deluxe;
          END;
        UNTIL lrRes.NEXT = 0;
      END;

      lrTras.RESET;
      IF lrTras.FINDFIRST THEN BEGIN
        REPEAT
          IF lrTras."Servicio privado" THEN BEGIN
            lrTras."Tipo Servicio" := lrTras."Tipo Servicio"::Privado;
            lrTras.MODIFY;
          END;
        UNTIL lrTras.NEXT = 0;
      END;

      lrAgr.RESET;
      IF lrAgr.FINDSET THEN
      BEGIN
        REPEAT
          IF lrAgr."Transfer Privado" THEN
          BEGIN
            lrAgr."Tipo Servicio venta" := lrAgr."Tipo Servicio venta"::Privado;
            lrAgr.MODIFY;
          END;
        UNTIL lrAgr.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaDatetimeAcumulado@1000000003();
    VAR
      rAcum@1000000000 : Record 7009795;
      rAcum2@1000000001 : Record 7009795;
    BEGIN
      rAcum.RESET;
      IF rAcum.FINDSET(TRUE) THEN
      BEGIN
        REPEAT
          IF rAcum."Tipo Transfer" = rAcum."Tipo Transfer"::Entrada THEN
          BEGIN
            rAcum.CALCFIELDS("Personas entrada");
            IF rAcum."Personas entrada" = 0 THEN
            BEGIN
              rAcum2 := rAcum;
              rAcum2.DELETE;
            END
            ELSE
            BEGIN
              rAcum.CalcDateTimeVuelo;
              rAcum.MODIFY;
            END;
          END
          ELSE
          BEGIN
            rAcum.CALCFIELDS("Personas salida");
            IF rAcum."Personas salida" = 0 THEN
            BEGIN
              rAcum2 := rAcum;
              rAcum2.DELETE;
            END
            ELSE
            BEGIN
              rAcum.CalcDateTimeVuelo;
              rAcum.MODIFY;
            END;
          END;
        UNTIL rAcum.NEXT = 0;
      END;
    END;

    PROCEDURE NuevoCodigoHotel@1000000004();
    VAR
      lrHotel@1000000001 : Record 7009724;
      lrHotel2@1000000005 : Record 7009724;
      lrZona@1000000000 : Record 7009713;
      lrParametros@1000000007 : Record 7009700;
      lrDelegacion@1000000008 : Record 7009718;
      lwNumero@1000000002 : Integer;
      lwNumeroTexto@1000000003 : Code[10];
      lwCeros@1000000004 : Code[10];
      lwCodigo@1000000006 : Code[20];
    BEGIN
      // NuevoCodigoHotel

      lrHotel.RESET;
      lrHotel.SETRANGE(Procesado, FALSE);
      IF lrHotel.FINDSET THEN
      BEGIN
        REPEAT
          lrHotel.TESTFIELD("Zona Fisica");
          lrZona.GET(lrHotel."Zona Fisica");
          lrZona.TESTFIELD("ID zona para hoteles");

          lrParametros.FINDFIRST;
          lrDelegacion.GET(lrParametros.Delegacion);
          lwNumero := lrDelegacion."Ultimo ID hotel";
          lwNumero += 1;
          lrDelegacion."Ultimo ID hotel" := lwNumero;
          lrDelegacion.MODIFY;

          lwNumeroTexto := FORMAT(lwNumero);
          lwNumeroTexto := PADSTR(lwCeros, 5 - STRLEN(lwNumeroTexto), '0') + lwNumeroTexto;

          lwCodigo := lrDelegacion.Codigo + lrZona."ID zona para hoteles" + lwNumeroTexto;

          lrHotel2 := lrHotel;
          lrHotel2."Codigo anterior" := lrHotel2.Hotel;
          lrHotel2.Procesado := TRUE;
          lrHotel2.RENAME(lwCodigo);
        UNTIL lrHotel.NEXT = 0;
      END;
    END;

    PROCEDURE NuevoCodigoExcursion@1000000005();
    VAR
      lrPar@1000000005 : Record 7009700;
      lrOficina@1000000000 : Record 7009720;
      lrDelegacion@1000000001 : Record 7009718;
      lrProducto@1000000006 : Record 7009710;
      lrProducto2@1000000007 : Record 7009710;
      lwNumero@1000000002 : Integer;
      lwNumeroTexto@1000000003 : Code[10];
      lwCeros@1000000004 : Code[10];
      lwCodigo@1000000008 : Code[20];
    BEGIN
      // NuevoCodigoExcursion

      lrPar.FINDFIRST;

      lrProducto.RESET;
      lrProducto.SETRANGE("Tipo Producto", lrProducto."Tipo Producto"::Excursion);
      lrProducto.SETRANGE(Procesado      , FALSE);
      IF lrProducto.FINDSET THEN
      BEGIN
        REPEAT
          IF lrPar."Oficina Excursion Obligatoria" THEN
            lrProducto.TESTFIELD(Oficina);

          lrDelegacion.GET(lrPar.Delegacion);
          lwNumero := lrDelegacion."Ultimo ID excursion";
          lwNumero += 1;
          lrDelegacion."Ultimo ID excursion" := lwNumero;
          lrDelegacion.MODIFY;

          lwNumeroTexto := FORMAT(lwNumero);

          IF lrPar."Oficina Excursion Obligatoria" THEN
          BEGIN
            lwNumeroTexto := PADSTR(lwCeros, 4 - STRLEN(lwNumeroTexto), '0') + lwNumeroTexto;
            lwCodigo  := lrDelegacion.Codigo + lrProducto.Oficina + lwNumeroTexto;

            lrProducto2 := lrProducto;
            lrProducto2."Codigo anterior" := lrProducto2.Codigo;
            lrProducto2.Procesado := TRUE;
            lrProducto2.RENAME(lwCodigo);
          END
          ELSE
          BEGIN
            lwNumeroTexto := PADSTR(lwCeros, 7 - STRLEN(lwNumeroTexto), '0') + lwNumeroTexto;
            lwCodigo := lrDelegacion.Codigo + lwNumeroTexto;

            lrProducto2 := lrProducto;
            lrProducto2."Codigo anterior" := lrProducto2.Codigo;
            lrProducto2.Procesado := TRUE;
            lrProducto2.RENAME(lwCodigo);
          END;
        UNTIL lrProducto.NEXT = 0;
      END;
    END;

    PROCEDURE DelegacionZonasTransfer@1000000006();
    VAR
      lrZonasTransfer@1000000000 : Record 7009791;
      lrPar@1000000001 : Record 7009700;
      lrContrato@1000000002 : Record 7010142;
    BEGIN
      IF lrZonasTransfer.FINDSET(TRUE) THEN
      BEGIN
        IF NOT lrPar.FINDFIRST THEN
          EXIT;
        lrZonasTransfer.MODIFYALL(Delegacion, lrPar.Delegacion);
      END;

      //. Aprovecho esta macro para cambiar el sentido de un campo en contrato compra excursiones

      lrContrato.RESET;
      lrContrato.SETRANGE("Tipo Contrato", lrContrato."Tipo Contrato"::TourOperador);
      IF lrContrato.FINDSET THEN
      BEGIN
        REPEAT
          lrContrato."Aplica comision en factura" := NOT lrContrato."Aplica comision en factura";
          lrContrato.MODIFY;
        UNTIL lrContrato.NEXT = 0;
      END;
    END;

    PROCEDURE FusionaContratosGuiaVenta@1000000007();
    VAR
      rCont@1000000000 : Record 7010142;
      rCont2@1000000003 : Record 7010142;
      rContFusTMP@1000000004 : TEMPORARY Record 7010142;
      rPre@1000000001 : Record 7010152;
      rPre2@1000000005 : Record 7010152;
      rRep@1000000002 : Record 7010241;
    BEGIN
      // $008

      // Primero pasamos el touroperador al detalle de precios
      rCont.RESET;
      rCont.SETRANGE(rCont."Tipo Contrato", rCont."Tipo Contrato"::"Guia Venta");
      IF rCont.FINDSET THEN BEGIN
        REPEAT
          rPre.RESET;
          rPre.SETRANGE(rPre.Delegacion, rCont.Delegacion);
          rPre.SETRANGE(rPre."N§ Contrato", rCont."N§ Contrato compra");
          IF rPre.FINDFIRST THEN
            rPre.MODIFYALL(rPre.TourOperador, rCont.TourOperador);
        UNTIL rCont.NEXT = 0;
      END;
      COMMIT;

      // Ahora fusionamos los contratos en 1 por guia
      CLEAR(rContFusTMP);
      rContFusTMP.DELETEALL;
      rRep.RESET;
      IF rRep.FINDSET THEN BEGIN
        REPEAT
          rCont.RESET;
          rCont.SETRANGE(rCont."Tipo Contrato", rCont."Tipo Contrato"::"Guia Venta");
          rCont.SETRANGE(rCont."Guia Venta", rRep.Codigo);
          IF rCont.FINDSET THEN BEGIN
            REPEAT
              rContFusTMP.RESET;
              IF NOT rContFusTMP.GET(rCont.Delegacion,rCont."N§ Contrato compra",rCont."Tipo Contrato") THEN BEGIN
                rCont2.RESET;
                rCont2.SETRANGE(rCont2."Tipo Contrato", rCont2."Tipo Contrato"::"Guia Venta");
                rCont2.SETRANGE(rCont2."Guia Venta", rCont."Guia Venta");
                rCont2.SETRANGE(rCont2."Fecha firma contrato", rCont."Fecha firma contrato");
                rCont2.SETRANGE(rCont2."Fecha inicio contrato", rCont."Fecha inicio contrato");
                rCont2.SETRANGE(rCont2."Fecha final contrato", rCont."Fecha final contrato");
                rCont2.SETRANGE(rCont2."Impuestos incluidos", rCont."Impuestos incluidos");
                rCont2.SETRANGE(rCont2.Delegacion, rCont.Delegacion);
                rCont2.SETFILTER(rCont2."N§ Contrato compra", '<>%1',rCont."N§ Contrato compra");
                IF rCont2.FINDSET THEN BEGIN
                  REPEAT
                    rContFusTMP.RESET;
                    IF NOT rContFusTMP.GET(rCont2.Delegacion,rCont2."N§ Contrato compra",rCont2."Tipo Contrato") THEN BEGIN
                      rPre.RESET;
                      rPre.SETRANGE(rPre.Delegacion, rCont2.Delegacion);
                      rPre.SETRANGE(rPre."N§ Contrato", rCont2."N§ Contrato compra");
                      IF rPre.FINDFIRST THEN BEGIN
                        REPEAT
                          rPre2.RESET;
                          rPre2.INIT;
                          rPre2 := rPre;
                          rPre2."N§ Contrato" := rCont."N§ Contrato compra";
                          rPre2.INSERT(TRUE);
                        UNTIL rPre.NEXT = 0;
                        rPre.DELETEALL;
                      END;
                      // Guardamos el registro en el temporal de fusionados
                      rContFusTMP.INIT;
                      rContFusTMP := rCont2;
                      rContFusTMP.INSERT;
                    END;
                  UNTIL rCont2.NEXT = 0;
                  rCont2.DELETEALL;
                END;

                // Guardamos el registro en el temporal de fusionados
                rContFusTMP.INIT;
                rContFusTMP := rCont;
                rContFusTMP.INSERT;
              END;
            UNTIL rCont.NEXT = 0;
          END;
        UNTIL rRep.NEXT = 0;
      END;
    END;

    PROCEDURE RellenarCtaCorporativa@1000000008();
    VAR
      lrCta@1000000000 : Record 15;
      lrMovCon@1000000001 : Record 17;
      lrMovPto@1000000002 : Record 96;
    BEGIN
      // $009
      // rellenamos la cuenta corporativa

      // Mov contabilidad
      lrMovCon.RESET;
      IF lrMovCon.FINDFIRST THEN BEGIN
        REPEAT
          lrCta.RESET;
          lrCta.GET(lrMovCon."G/L Account No.");
          lrCta.TESTFIELD(lrCta."Group account");
          lrMovCon."Group account" := lrCta."Group account";
          lrMovCon.MODIFY;
        UNTIL lrMovCon.NEXT = 0;
      END;

      // Mov presupuesto
      lrMovPto.RESET;
      IF lrMovPto.FINDFIRST THEN BEGIN
        REPEAT
          lrCta.RESET;
          lrCta.GET(lrMovPto."G/L Account No.");
          lrCta.TESTFIELD(lrCta."Group account");
          lrMovPto."Group account" := lrCta."Group account";
          lrMovPto.MODIFY;
        UNTIL lrMovPto.NEXT = 0;
      END;
    END;

    PROCEDURE RellenaVueloAcumulados@1000000009();
    VAR
      rAcumVuelo@1000000000 : Record 7009795;
    BEGIN
      rAcumVuelo.RESET;
      IF rAcumVuelo.FINDSET(TRUE) THEN
      BEGIN
        REPEAT
          rAcumVuelo.Vuelo := DELCHR(rAcumVuelo.Compa¤ia, '<>') + ' ' + DELCHR(rAcumVuelo."Num. Vuelo", '<>');
          rAcumVuelo.MODIFY;
        UNTIL rAcumVuelo.NEXT = 0;
      END;
    END;

    PROCEDURE DepurarAcumulados@1000000010();
    VAR
      lwFecha@1000000004 : Date;
      lrAcumZona@1000000003 : Record 7009793;
      lrAcumVuelo@1000000002 : Record 7009794;
      lrAcumHotel@1000000001 : Record 7009811;
      lrAcumVueHotel@1000000000 : Record 7009795;
    BEGIN
      lwFecha := CALCDATE('<-12M>', TODAY);

      lrAcumZona.RESET;
      lrAcumZona.SETFILTER(Fecha, '<=%1', lwFecha);
      IF lrAcumZona.FINDSET(TRUE) THEN
      BEGIN
        REPEAT
          lrAcumVuelo.SETRANGE(Fecha          , lrAcumZona.Fecha);
          lrAcumVuelo.SETRANGE(Zona           , lrAcumZona.Zona);
          lrAcumVuelo.SETRANGE(TourOperador   , lrAcumZona.TourOperador);
          lrAcumVuelo.SETRANGE("Tipo Transfer", lrAcumZona."Tipo Transfer");
          IF lrAcumVuelo.FINDSET(TRUE) THEN
            lrAcumVuelo.DELETEALL;

          lrAcumHotel.SETRANGE(Fecha          , lrAcumZona.Fecha);
          lrAcumHotel.SETRANGE(Zona           , lrAcumZona.Zona);
          lrAcumHotel.SETRANGE(TourOperador   , lrAcumZona.TourOperador);
          lrAcumHotel.SETRANGE("Tipo Transfer", lrAcumZona."Tipo Transfer");
          IF lrAcumHotel.FINDSET(TRUE) THEN
            lrAcumHotel.DELETEALL;

          lrAcumVueHotel.SETRANGE(Fecha          , lrAcumZona.Fecha);
          lrAcumVueHotel.SETRANGE(Zona           , lrAcumZona.Zona);
          lrAcumVueHotel.SETRANGE(TourOperador   , lrAcumZona.TourOperador);
          lrAcumVueHotel.SETRANGE("Tipo Transfer", lrAcumZona."Tipo Transfer");
          IF lrAcumVueHotel.FINDSET(TRUE) THEN
            lrAcumVueHotel.DELETEALL;
        UNTIL lrAcumZona.NEXT = 0;

        lrAcumZona.DELETEALL(TRUE);
      END;
    END;

    BEGIN
    {
      $001 AJS 24022014 Nueva funcion RellenarTransferPrivadoCoste

      $002 AJS 26052014 Modificamos la funcion DepurarInterfaseReservas para trabajar tambien con lo que llega por WS

      $003 ARM 30092014 CNT-CAR-14063 Nueva func¢n ActualizaTipoServicioTransefr

      $004 AJS 25112014 Modifico la funcion Iniciar_empresa para crear un producto hotel y transfer que siempre ser n necesarios

      $005 AJS 09032015 CNT-OC-15130, Nueva funcion NuevoCodigoHotel

      $006 AJS 09032015 CNT-OC-15130, Nueva funcion NuevoCodigoExcursion

      $007 AJS CNT-CAR-14096, Nueva macro para rellenar la delegacion en Zonas transfer

      $008 ARM CNT-CAR-14053, Macro para fusionar contratos de guia venta

      $009 ARM 10042015 CNT-OC-15129 Rellenar la cuenta corporativa en mov contabilidad y presupuesto

      $010 AJS 16052015 Rellenar el nuevo campo Vuelo en acumulado x hotel x vuelo
    }
    END.
  }
}

OBJECT Codeunit 7010417 Facturacion electronica v2 XML
{
  OBJECT-PROPERTIES
  {
    Date=06/07/15;
    Time=[ 9:29:07];
    Modified=Yes;
    Version List=TRANSFER,FE;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      wArchivoXML@1103350001 : Text[250];
      wArchivoXSD@1103350004 : Text[250];
      wDocUnico@1103350002 : Boolean;
      txt01@1103350005 : TextConst 'ENU=Document correctly generated;ESP=Documento generado correctamente.;ITA=Documento generato correttamente.';
      txt02@1103350006 : TextConst 'ENU=Has been errors when generating the document.;ESP=Se han producido errores al generar el documento.;ITA=Si sono verificati errori durante la generazione del documento.';
      wFechaGen@1103350007 : Date;
      wHoraGen@1103350008 : Time;
      txt03@1103350009 : TextConst 'ENU=There is no document to generate;ESP=No hay ning£n documento a generar.;ITA=Non vi ä alcun documento da generare.';
      wProveedor@1103355003 : Code[20];
      wNivelXML@1103350010 : Integer;
      txtPagoDefecto@1103355001 : TextConst 'ENU=1;ESP=1;FRA=1;ITA=1;PTG=1';
      txt04@1103355002 : TextConst 'ENU=%1 pax x 2% days;ESP=%1 pax x %2 dias;ITA=%1 pax x %2 giorni';
      autXML@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{F6D90F11-9C73-11D3-B32E-00C04F990BB4}:'Microsoft XML, v6.0'.Unknown Class";
      lNodo@1000000001 : ARRAY [10] OF Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      wNivelBase@1000000002 : Integer;
      wNameFile@1100000 : Text[50];
      wDto@1100253000 : Decimal;

    PROCEDURE PasaParam@1103350001(pFecha@1103350000 : Date;pHora@1103350001 : Time;pProveedor@1103355000 : Code[20]);
    BEGIN
      wFechaGen := pFecha;
      wHoraGen := pHora;
      wProveedor := pProveedor;
    END;

    PROCEDURE ExportarMultiplesDocumentos@1103350002(VAR pArchivoXML@1103350006 : Text[250]) : Boolean;
    VAR
      rlCabFactVta@1103350001 : Record 36;
      rlLinFactVta@1103350002 : Record 37;
      rlTempDocs@1103350000 : Record 7035415;
      rlProvFE@1103355001 : Record 7035410;
      wlLogDll@1100253000 : Text[30];
      locContador@1103355002 : Text[3];
      flocFile@1103355003 : File;
      lTipoDocumento@1103355000 : 'Factura,Abono,Factura Registrada,Abono Registrado';
    BEGIN
      //ExportarMultiplesDocumentos

      locContador := '000';

      rlProvFE.GET(wProveedor);
      wDocUnico := NOT rlProvFE."Archivo x Documento";

      rlTempDocs.RESET;
      rlTempDocs.SETRANGE(rlTempDocs.Usuario, USERID);
      rlTempDocs.SETRANGE(rlTempDocs.Fecha, wFechaGen);
      rlTempDocs.SETRANGE(rlTempDocs.Hora, wHoraGen);
      IF rlTempDocs.FIND('-') THEN BEGIN
        REPEAT
          locContador := INCSTR(locContador);

          IF rlProvFE."Archivo x Documento" OR
             ( (NOT rlProvFE."Archivo x Documento") AND (locContador = '001') ) THEN
          BEGIN
            ConfigXML(rlTempDocs."Num documento", pArchivoXML,locContador,rlProvFE.Proveedor);
            pArchivoXML := wArchivoXML;
          END;

          rlTempDocs.Fichero :=  wNameFile;
          rlTempDocs.MODIFY;

          IF rlTempDocs."Tipo documento" = rlTempDocs."Tipo documento"::Factura THEN BEGIN
            IF rlTempDocs."Tipo Remesa" = rlTempDocs."Tipo Remesa"::Borrador THEN
              lTipoDocumento := lTipoDocumento::Factura
            ELSE
              lTipoDocumento := lTipoDocumento::"Factura Registrada";
          END
          ELSE BEGIN
            IF rlTempDocs."Tipo Remesa" = rlTempDocs."Tipo Remesa"::Borrador THEN
              lTipoDocumento := lTipoDocumento::Abono
            ELSE
              lTipoDocumento := lTipoDocumento::"Abono Registrado";
          END;

          InsertarValoresXML(rlTempDocs."Num documento", lTipoDocumento);

          //    MNC
          autXML.save(wArchivoXML);
          pArchivoXML :='';




        UNTIL rlTempDocs.NEXT = 0;

        wlLogDll := 'OK';   // TODO ...... no puedo ir a la dll

        CASE rlProvFE."Mostrar mensaje generacion" OF
          rlProvFE."Mostrar mensaje generacion"::Siempre:
            BEGIN
             IF wlLogDll = 'OK' THEN
               MESSAGE(txt01)
             ELSE
               MESSAGE(txt02);
            END;
          rlProvFE."Mostrar mensaje generacion"::Correcto:
            BEGIN
             IF wlLogDll = 'OK' THEN
               MESSAGE(txt01)
            END;
          rlProvFE."Mostrar mensaje generacion"::Incorrecto:
            BEGIN
             IF wlLogDll <> 'OK' THEN
               MESSAGE(txt02);
            END;
          rlProvFE."Mostrar mensaje generacion"::Nunca:
            BEGIN
            END;
        END;
      END ELSE
        ERROR(txt03);

      EXIT(wlLogDll = 'OK');
    END;

    PROCEDURE ConfigXML@1103350013(pDoc@1103350001 : Code[20];pArchivo@1103350000 : Text[250];pContador@1103355002 : Text[3];pProveedor@1103355004 : Code[20]);
    VAR
      Text10001@1103355003 : TextConst 'ENU=Invoice;ESP=Factura;FRA=Facture;ITA=Bill;PTG=factura';
      rLocProvFE@1103355000 : Record 7035410;
    BEGIN

      rLocProvFE.GET(pProveedor);

      IF rLocProvFE."Validar XSD" THEN
        rLocProvFE.TESTFIELD(rLocProvFE."Archivo XSD");

      IF rLocProvFE."Incluir XMLNS" THEN
        rLocProvFE.TESTFIELD(rLocProvFE.XMLNS);

      IF rLocProvFE."Incluir XMLNS:XSI" THEN
        rLocProvFE.TESTFIELD(rLocProvFE."XMLNS:XSI");

      IF rLocProvFE."Incluir XMLNS:CUR" THEN
        rLocProvFE.TESTFIELD(rLocProvFE."XMLNS:CUR");

      IF rLocProvFE."Incluir XMLNS:CBC" THEN
        rLocProvFE.TESTFIELD(rLocProvFE."XMLNS:CBC");

      IF rLocProvFE."Incluir XMLNS:CAC" THEN
        rLocProvFE.TESTFIELD(rLocProvFE."XMLNS:CAC");

      IF rLocProvFE."Incluir XMLNS:INV" THEN
        rLocProvFE.TESTFIELD(rLocProvFE."XMLNS:INV");

      IF pArchivo = '' THEN
      BEGIN
        CASE rLocProvFE."Formato Nombre Archivo" OF
           rLocProvFE."Formato Nombre Archivo"::Voxel:
              wArchivoXML := Text10001 + '_' +
                            FORMAT(wFechaGen,0,'<year4><month,2><day,2>') + '_' +
                            FORMAT(wHoraGen,0,'<hours24,2><minutes,2><seconds,2>') + '_' +
                            pContador + '.xml';

           rLocProvFE."Formato Nombre Archivo"::General:
              IF wDocUnico THEN
                wArchivoXML := FORMAT(pDoc) + '.xml' // wArchivoXML := Text10001 + '-' + FORMAT(pDoc) + '.xml'
              ELSE
                wArchivoXML := 'FE' + '-' + FORMAT(WORKDATE,0,'<Day,2><Month,2><Year>') +
                             '-' + FORMAT(TIME,0,'<Hours24,2><Minutes,2><Seconds,2><Second dec.><Comma,->')+'.xml';
        END;
      END ELSE
        wArchivoXML := pArchivo;

      //+025
      wNameFile := wArchivoXML;
      //-025

      //+026
      rLocProvFE.TESTFIELD(rLocProvFE."Ruta XML");
      rLocProvFE.TESTFIELD(rLocProvFE."Ruta XML enviados");
      //-026

      wArchivoXML := rLocProvFE."Ruta XML"+ wArchivoXML;

      CLEAR(autXML);
      CLEAR(lNodo);

      CREATE(autXML);

      autXML.loadXML := '<?xml version="1.0" encoding="utf-8"?>';

      lNodo[1] := autXML.createNode('Element', rLocProvFE."Texto NS2", '');
      autXML.appendChild(lNodo[1]);

      IF rLocProvFE."Incluir XMLNS:XSI" THEN
        _AddAttribute(lNodo[1], 'xmlns:xsi', rLocProvFE."XMLNS:XSI");

      IF rLocProvFE."Incluir XMLNS" THEN
        _AddAttribute(lNodo[1], 'xmlns:xsd', rLocProvFE.XMLNS);

      wArchivoXSD := rLocProvFE."Archivo XSD";
    END;

    PROCEDURE InsertarValoresXML@1000000001(pNumDoc@1103350000 : Code[20];pTipoDocumento@1103355004 : 'Factura,Abono,Factura Registrada,Abono Registrado');
    VAR
      rlConfigEl@1103350002 : Record 7035411;
      rlCabFra@1103350004 : Record 36;
      rlLinFra@1103350009 : Record 37;
      rlCliente@1100253000 : Record 18;
      rPreFactura@1000000004 : Record 7010415;
      rlTabRef@1103350006 : RecordRef;
      wlValor@1103350003 : Text[250];
      wlCampo@1103350007 : Text[50];
      wlValorAtt@1103355002 : Text[60];
      wlCampoAtt@1103355001 : Text[50];
      wlNivelXML@1103350008 : Integer;
      wI@1103350010 : Integer;
      wlNivelStop@1103355000 : Integer;
      wTipoDocumento@1000000000 : Integer;
      locAmount@1103355005 : Decimal;
      locAmountInclVAT@1000000001 : Decimal;
      locAmountVAT@1000000002 : Decimal;
      wAuxiliar@1000000003 : Decimal;
      lcFEDynamics@1103355007 : Codeunit 7010416;
    BEGIN
      // deberemos recorrer la tabla de configuraci¢n para todos aquellos campos que son tipo cabecera, del tipo de documento
      // pasado por par†metro y que se debe "usar"

      CLEAR(wlNivelStop);

      CLEAR(wTipoDocumento);
      CASE pTipoDocumento OF
        pTipoDocumento::Factura              : wTipoDocumento:=2;
        pTipoDocumento::Abono                : wTipoDocumento:=3;
        pTipoDocumento::"Factura Registrada" : wTipoDocumento:=0;
        pTipoDocumento::"Abono Registrado"   : wTipoDocumento:=1;
      END;

      // Primero exportamos elementos de Cabecera
      CASE pTipoDocumento OF
        pTipoDocumento::Factura:
        BEGIN
           rlCabFra.GET(wTipoDocumento, pNumDoc);
           rlTabRef.GETTABLE(rlCabFra);
           rlTabRef.SETPOSITION(rlCabFra.GETPOSITION);
        END;
        pTipoDocumento::Abono:
        BEGIN
           rlCabFra.GET(wTipoDocumento, pNumDoc);
           rlTabRef.GETTABLE(rlCabFra);
           rlTabRef.SETPOSITION(rlCabFra.GETPOSITION);
        END;
        pTipoDocumento::"Factura Registrada":
          lcFEDynamics.EstableceReferencia(pNumDoc,0,pTipoDocumento,rlTabRef);
        pTipoDocumento::"Abono Registrado":
          lcFEDynamics.EstableceReferencia(pNumDoc,0,pTipoDocumento,rlTabRef);
      END;
      rlConfigEl.RESET;
      rlConfigEl.SETCURRENTKEY("Proveedor FE","Tipo documento",Orden);
      rlConfigEl.SETRANGE("Proveedor FE",wProveedor);
      rlConfigEl.SETRANGE("Tipo documento",pTipoDocumento);
      rlConfigEl.SETRANGE("Tipo valor", rlConfigEl."Tipo valor"::Cabecera);
      rlConfigEl.SETRANGE(Usar, TRUE);
      IF rlConfigEl.FIND('-') THEN BEGIN
        REPEAT
          wNivelBase := rlConfigEl.Nivel+1;
          wlCampo := rlConfigEl."Nodo XML";
          IF NOT rlConfigEl."Nodo valor" THEN BEGIN   //es etiqueta
            _AddElement(lNodo[wNivelBase], rlConfigEl."Nodo XML", '', '', lNodo[wNivelBase+1]);
          END ELSE BEGIN  //es valor
            wlValor := DevuelveValorCampo(rlConfigEl.Orden,rlTabRef, pNumDoc,0,pTipoDocumento);
            IF ( (wlValor <> '') AND (wlValor <> '0') ) OR
              rlConfigEl."Permitir valor nulo" THEN BEGIN
              IF rlConfigEl."Es Atributo" THEN
                _AddAttribute(lNodo[wNivelBase], wlCampo, wlValor)
              ELSE BEGIN
                IF NOT rlConfigEl.Atributo THEN BEGIN
                  _AddElement(lNodo[wNivelBase],rlConfigEl."Nodo XML", '', '', lNodo[wNivelBase+1]);
                END ELSE BEGIN
                  wlValorAtt := DevuelveValorCampoAtt(rlConfigEl."Cod atributo", rlTabRef, pNumDoc, 0, wlCampoAtt,
                                 rlConfigEl."Tipo documento");
                  _AddAttribute(lNodo[wNivelBase], wlCampo, wlValor);
                END;
              END;
            END;
          END;
        UNTIL rlConfigEl.NEXT = 0;
      END;

      // En segundo lugar las l°neas
      CASE pTipoDocumento OF
        pTipoDocumento::Factura:
        BEGIN
           rlLinFra.RESET;
           rlLinFra.SETRANGE("Document Type", wTipoDocumento);
           rlLinFra.SETRANGE("Document No.", pNumDoc);
           rlLinFra.SETFILTER(Type, '<>%1', 0);
           //     el GET se hace dentro del bucle
        END;
        pTipoDocumento::Abono:
        BEGIN
           rlLinFra.RESET;
           rlLinFra.SETRANGE("Document Type", wTipoDocumento);
           rlLinFra.SETRANGE("Document No.", pNumDoc);
           rlLinFra.SETFILTER(Type, '<>%1', 0);
           //     el GET se hace dentro del bucle
        END;
        // TODO
        {
        pTipoDocumento::"Factura Registrada":
          lcFEDynamics.EstableceReferencia(pNumDoc,0,pTipoDocumento,rlTabRef);
        pTipoDocumento::"Abono Registrado":
          lcFEDynamics.EstableceReferencia(pNumDoc,0,pTipoDocumento,rlTabRef);
        }

      END;
      IF rlLinFra.FINDSET() THEN REPEAT
        rlTabRef.GETTABLE(rlLinFra);
        rlTabRef.SETPOSITION(rlLinFra.GETPOSITION);

        rlConfigEl.RESET;
        rlConfigEl.SETCURRENTKEY("Proveedor FE","Tipo documento",Orden);
        rlConfigEl.SETRANGE("Proveedor FE",wProveedor);
        rlConfigEl.SETRANGE("Tipo documento",pTipoDocumento);
        rlConfigEl.SETRANGE("Tipo valor", rlConfigEl."Tipo valor"::Linea);
        rlConfigEl.SETRANGE(Usar, TRUE);
        IF rlConfigEl.FIND('-') THEN BEGIN
          REPEAT
            wNivelBase := rlConfigEl.Nivel+1;
            wlCampo := rlConfigEl."Nodo XML";
            IF NOT rlConfigEl."Nodo valor" THEN BEGIN   //es etiqueta
              _AddElement(lNodo[wNivelBase], rlConfigEl."Nodo XML", '', '', lNodo[wNivelBase+1]);
            END ELSE BEGIN  //es valor
              wlValor := DevuelveValorCampo(rlConfigEl.Orden,rlTabRef, pNumDoc, rlLinFra."Line No.", pTipoDocumento);
              IF ( (wlValor <> '') AND (wlValor <> '0') ) OR
                rlConfigEl."Permitir valor nulo" THEN BEGIN
                IF rlConfigEl."Es Atributo" THEN BEGIN
                  IF (wlCampo = 'Amount') THEN BEGIN //$053 Excepcion para Amount en lineas
                    wAuxiliar := rlLinFra."Amount Including VAT" - rlLinFra.Amount;
                    wlValor := FORMAT(wAuxiliar,0,'<Sign><Integer><Decimals><1000Character,,>');
                    wlValor := CONVERTSTR(wlValor, ',','.');
                  END;
                  IF (wlCampo = 'Item') THEN BEGIN //$053 Excepcion para Item en lineas
                    CLEAR(rPreFactura);
                    rPreFactura.SETCURRENTKEY("Nß Factura","Tipo Documento");
                    rPreFactura.SETRANGE("Nß Factura", pNumDoc);
                    rPreFactura.SETRANGE("Tipo Documento", wTipoDocumento);
                    IF rPreFactura.FINDFIRST() THEN BEGIN
                      IF (rPreFactura."Tipo factura" = rPreFactura."Tipo factura"::"Texto alternativo") THEN BEGIN
                        wlValor := rPreFactura."Texto alternativo";
                      END;
                    END;
                  END;

                  _AddAttribute(lNodo[wNivelBase], wlCampo, wlValor)
                END ELSE BEGIN
                  IF NOT rlConfigEl.Atributo THEN BEGIN
                    _AddElement(lNodo[wNivelBase],rlConfigEl."Nodo XML", '', '', lNodo[wNivelBase+1]);
                  END ELSE BEGIN
                    wlValorAtt := DevuelveValorCampoAtt(rlConfigEl."Cod atributo", rlTabRef, pNumDoc, 0, wlCampoAtt,
                                   rlConfigEl."Tipo documento");
                    _AddAttribute(lNodo[wNivelBase], wlCampo, wlValor);
                  END;
                END;
              END;
            END;
          UNTIL rlConfigEl.NEXT = 0;
        END;
      UNTIL rlLinFra.NEXT = 0;

      // Finalmente el pie
      CASE pTipoDocumento OF
        pTipoDocumento::Factura:
        BEGIN
           rlCabFra.GET(wTipoDocumento, pNumDoc);
           rlCabFra.CALCFIELDS(Amount, "Amount Including VAT");
           rlTabRef.GETTABLE(rlCabFra);
           rlTabRef.SETPOSITION(rlCabFra.GETPOSITION);
        END;
        pTipoDocumento::Abono:
        BEGIN
           rlCabFra.GET(wTipoDocumento, pNumDoc);
           rlCabFra.CALCFIELDS(Amount, "Amount Including VAT");
           rlTabRef.GETTABLE(rlCabFra);
           rlTabRef.SETPOSITION(rlCabFra.GETPOSITION);
        END;
        pTipoDocumento::"Factura Registrada":
          lcFEDynamics.EstableceReferencia(pNumDoc,0,pTipoDocumento,rlTabRef);
        pTipoDocumento::"Abono Registrado":
          lcFEDynamics.EstableceReferencia(pNumDoc,0,pTipoDocumento,rlTabRef);
      END;
      rlConfigEl.RESET;
      rlConfigEl.SETCURRENTKEY("Proveedor FE","Tipo documento",Orden);
      rlConfigEl.SETRANGE("Proveedor FE",wProveedor);
      rlConfigEl.SETRANGE("Tipo documento",pTipoDocumento);
      rlConfigEl.SETRANGE("Tipo valor", rlConfigEl."Tipo valor"::Pie);
      rlConfigEl.SETRANGE(Usar, TRUE);
      IF rlConfigEl.FIND('-') THEN BEGIN
        REPEAT
          wNivelBase := rlConfigEl.Nivel+1;
          wlCampo := rlConfigEl."Nodo XML";
          IF NOT rlConfigEl."Nodo valor" THEN BEGIN   //es etiqueta
            _AddElement(lNodo[wNivelBase], rlConfigEl."Nodo XML", '', '', lNodo[wNivelBase+1]);
          END ELSE BEGIN  //es valor
            wlValor := DevuelveValorCampo(rlConfigEl.Orden,rlTabRef, pNumDoc,0,pTipoDocumento);
            IF ( (wlValor <> '') AND (wlValor <> '0') ) OR
              rlConfigEl."Permitir valor nulo" THEN BEGIN
              IF rlConfigEl."Es Atributo" THEN BEGIN
                  IF ((wlCampo = 'Tax') OR (wlCampo = 'Amount'))       //$053 Excepcion para Tax y Amount, en el pie
                     THEN BEGIN
                    wAuxiliar := rlCabFra."Amount Including VAT" - rlCabFra.Amount;
                    wlValor := FORMAT(wAuxiliar,0,'<Sign><Integer><Decimals><1000Character,,>');
                    wlValor := CONVERTSTR(wlValor, ',','.');
                  END;
                _AddAttribute(lNodo[wNivelBase], wlCampo, wlValor);
              END ELSE BEGIN
                IF NOT rlConfigEl.Atributo THEN BEGIN
                  _AddElement(lNodo[wNivelBase],rlConfigEl."Nodo XML", '', '', lNodo[wNivelBase+1]);
                END ELSE BEGIN
                  wlValorAtt := DevuelveValorCampoAtt(rlConfigEl."Cod atributo", rlTabRef, pNumDoc, 0, wlCampoAtt,
                                 rlConfigEl."Tipo documento");
                  _AddAttribute(lNodo[wNivelBase], wlCampo, wlValor);
                END;
              END;
            END;
          END;
        UNTIL rlConfigEl.NEXT = 0;
      END;
    END;

    PROCEDURE DevuelveValorCampo@1103355019(pOrden@1103355005 : Integer;pRefTabla@1103355004 : RecordRef;pNumdoc@1103355003 : Code[20];pLinea@1103355001 : Integer;pTipoDoc@1103355000 : 'Factura,Abono') wValor : Text[250];
    VAR
      rlConfigEl@1103355006 : Record 7035411;
    BEGIN
      //+033
      wValor := DevuelveValorNodo(pOrden,pRefTabla, pNumdoc,pLinea,pTipoDoc);
      IF wValor = '' THEN
        IF rlConfigEl.GET(wProveedor,pTipoDoc,pOrden) AND (rlConfigEl."Valor predeterminado" <> '') THEN
          wValor := ASCII_ANSI(fTrata_Char(rlConfigEl."Valor predeterminado"));
      //-033
    END;

    PROCEDURE DevuelveValorNodo@1100244010(pOrden@1103355000 : Integer;pRefTabla@1103355002 : RecordRef;pNumdoc@1103355006 : Code[20];pLinea@1103350016 : Integer;pTipoDoc@1103355008 : 'Factura,Abono') wValor : Text[250];
    VAR
      rlConfigEl@1103350002 : Record 7035411;
      rlCabFraVta@1103350017 : Record 36;
      rlLinFraVta@1103350011 : Record 37;
      rlTermPago@1103350020 : Record 3;
      rlCliente@1103355005 : Record 18;
      rlProvFE@1103355007 : Record 7035410;
      rlRefCampo@1103350001 : FieldRef;
      rlRefCampo2@1103350005 : FieldRef;
      rlRefTabla@1103350006 : RecordRef;
      wlCode@1103350018 : Code[20];
      wlAux@1103350009 : Decimal;
      rlOption@1103350012 : '0,1,2';
      wlDate@1103350013 : Date;
      wlDecimal@1103350014 : Decimal;
      decImpLineas@1103355003 : Decimal;
      pXMLCampo@1103355001 : Text[50];
      txtlTrue@1103355010 : TextConst 'ENU=true;ESP=true';
      txtlFalse@1103355009 : TextConst 'ENU=false;ESP=false;ITA=FALSO';
      txtDate@1100217000 : TextConst 'ESP=Date';
      txtInteger@1100217001 : TextConst 'ESP=Integer';
      txtDecimal@1100217002 : TextConst 'ESP=Decimal';
      txtBoolean@1100217003 : TextConst 'ESP=Boolean';
    BEGIN
      { pasamos como par†metro:
      - Tipo documento
      - Orden dentro de la configuraci¢n de los elementos
      - Tabla referenciada, dependiendo del tipo dev documento
      - NumDoc -> num de la fra o el abono

      Devolveremos, el valor del campo de Navision correspondiente a la correspondencia con el campo xml
      }

      rlProvFE.GET(wProveedor);

      rlConfigEl.RESET;
      IF rlConfigEl.GET(wProveedor,pTipoDoc,pOrden) THEN BEGIN

        pXMLCampo := rlConfigEl."Nodo XML";

        wValor := '';
        wlDecimal := 0;
        wlDate := 0D;

        CASE rlConfigEl."Tipo campo" OF
          rlConfigEl."Tipo campo"::Normal:
          BEGIN
            IF rlConfigEl."Tabla navision" = pRefTabla.NUMBER THEN
            BEGIN
              rlRefCampo := pRefTabla.FIELD(rlConfigEl."Campo navision");

              CASE FORMAT(rlRefCampo.TYPE) OF
                'Date':
                  BEGIN
                      EVALUATE(wlDate,FORMAT(rlRefCampo.VALUE));

                      IF ( (rlConfigEl."Nodo XML" = 'BeginDate') OR (rlConfigEl."Nodo XML" = 'EndDate') )
                           AND (wlDate = 0D) THEN  BEGIN
                        rlCabFraVta.RESET;
                        rlCabFraVta.SETRANGE("No.", pNumdoc);
                        IF rlCabFraVta.FIND('-') THEN
                          wlDate := rlCabFraVta."Posting Date";
                      END;

                      wValor := FORMAT(wlDate,0,'<Year4>-<Month,2>-<Day,2>');
                  END;

                'Integer','Decimal':
                  BEGIN
                      IF EVALUATE(wlDecimal,FORMAT(rlRefCampo.VALUE)) THEN BEGIN
                        IF rlConfigEl."Nodo XML" <> 'UP' THEN
                          wlDecimal := ROUND(wlDecimal);
                        IF rlConfigEl."Cambiar signo" THEN
                          wlDecimal := -wlDecimal;

                        wValor := FORMAT(wlDecimal,0,'<Sign><Integer><Decimals><1000Character,,>');
                        wValor := CONVERTSTR(wValor, ',','.');
                       END;
                 END;
                'Boolean':
                  BEGIN
                    wValor := txtlFalse;
                    IF UPPERCASE(FORMAT(rlRefCampo.VALUE))<>'NO' THEN
                      wValor := txtlTrue;
                 END
              ELSE
                wValor := FORMAT(rlRefCampo.VALUE);
              END;
              EXIT(ASCII_ANSI(fTrata_Char(wValor)));

            END ELSE BEGIN
              pRefTabla.CLOSE;
              pRefTabla.OPEN(rlConfigEl."Tabla navision");
              IF pRefTabla.FIND('-') THEN
              BEGIN
                rlRefCampo := pRefTabla.FIELD(rlConfigEl."Campo navision");
                IF FORMAT(rlRefCampo.TYPE) = 'Date' THEN BEGIN
                  EVALUATE(wlDate,FORMAT(rlRefCampo.VALUE));
                  wValor := FORMAT(wlDate,0,'<Year4>-<Month,2>-<Day,2>');
                END ELSE BEGIN
                  IF EVALUATE(wlDecimal,FORMAT(rlRefCampo.VALUE)) THEN BEGIN
                    IF rlConfigEl."Cambiar signo" THEN
                      wlDecimal := -wlDecimal;

                    wValor := FORMAT(wlDecimal,0,'<Sign><Integer><Decimals><1000Character,,>');
                    wValor := CONVERTSTR(wValor, ',','.');
                  END ELSE
                    wValor := FORMAT(rlRefCampo.VALUE);
                 END;

                 EXIT(ASCII_ANSI(fTrata_Char(wValor)));
              END;
            END;
          END;

          rlConfigEl."Tipo campo"::Lookup:
          BEGIN
            rlRefTabla.OPEN(rlConfigEl."Tabla relacionada");
            IF rlRefTabla.FIND('-') THEN BEGIN
              rlRefCampo := rlRefTabla.FIELD(rlConfigEl."Campo clave");
              IF rlConfigEl."Campo navision" <> 0 THEN BEGIN
                rlRefCampo2 := pRefTabla.FIELD(rlConfigEl."Campo navision");
                rlRefCampo.SETFILTER('%1', rlRefCampo2.VALUE);
              END;
              IF rlRefTabla.FIND('-') THEN
              BEGIN
                rlRefCampo := rlRefTabla.FIELD(rlConfigEl."Campo lookup");
                EXIT(ASCII_ANSI(fTrata_Char(FORMAT(rlRefCampo.VALUE))));
              END;
            END;
          END;

          rlConfigEl."Tipo campo"::Constante:
          EXIT(ASCII_ANSI(fTrata_Char(rlConfigEl."Valor predeterminado")));



        END;
      END;
    END;

    PROCEDURE DevuelveValorCampoAtt@1103355003(pOrden@1103355000 : Integer;pRefTabla@1103355002 : RecordRef;pNumDoc@1103350000 : Code[20];pLinea@1103350016 : Integer;VAR pNameAtt@1103355004 : Text[60];pTipoDoc@1103355006 : 'Factura,Abono') wValor : Text[250];
    VAR
      rlConfigEl@1103350002 : Record 7035411;
      rlConfigElAtt@1103355003 : Record 7035414;
      rlTermPago@1103350020 : Record 3;
      rlRefCampo@1103350001 : FieldRef;
      rlRefCampo2@1103350005 : FieldRef;
      rlRefTabla@1103350006 : RecordRef;
      wlCode@1103350018 : Code[20];
      wlAux@1103350009 : Decimal;
      rlOption@1103350012 : '0,1,2';
      wlDate@1103350013 : Date;
      wlDecimal@1103350014 : Decimal;
      pXMLCampo@1103355001 : Text[50];
    BEGIN
      { pasamos como par†metro:
      - Tipo documento
      - Orden dentro de la configuraci¢n de los elementos
      - Tabla referenciada, dependiendo del tipo dev documento
      - NumDoc -> num de la fra o el abono
      - NameAtt -> nombre del atributo del nodo

      Devolveremos, el valor del campo de Navision correspondiente a la correspondencia con el campo xml
      }

      rlConfigElAtt.RESET;
      IF rlConfigElAtt.GET(wProveedor,pTipoDoc,pOrden) THEN BEGIN

        pXMLCampo := rlConfigElAtt."Nodo XML";
        pNameAtt := rlConfigElAtt."Nodo XML";
        wValor := '';
        wlDecimal := 0;
        wlDate := 0D;

        CASE rlConfigElAtt."Tipo campo" OF

          rlConfigElAtt."Tipo campo"::Normal:
          BEGIN
            IF rlConfigElAtt."Tabla navision" = pRefTabla.NUMBER THEN
            BEGIN
              rlRefCampo := pRefTabla.FIELD(rlConfigElAtt."Campo navision");
              IF FORMAT(rlRefCampo.TYPE) = 'Date' THEN BEGIN
                EVALUATE(wlDate,FORMAT(rlRefCampo.VALUE));
                wValor := FORMAT(wlDate,0,'<Year4>-<Month,2>-<Day,2>');
              END ELSE BEGIN
                IF EVALUATE(wlDecimal,FORMAT(rlRefCampo.VALUE)) THEN BEGIN
                  wValor := FORMAT(wlDecimal,0,'<Sign><Integer><Decimals><1000Character,,>');
                  wValor := CONVERTSTR(wValor, ',','.');
               END ELSE
                  wValor := FORMAT(rlRefCampo.VALUE);
               END;

              // +016
              // EXIT(wValor);
              EXIT(ASCII_ANSI(fTrata_Char(wValor)));
              // -016


            END ELSE BEGIN

              pRefTabla.OPEN(rlConfigElAtt."Tabla navision");
              IF pRefTabla.FIND('-') THEN
              BEGIN

                rlRefCampo := pRefTabla.FIELD(rlConfigElAtt."Campo navision");
                IF FORMAT(rlRefCampo.TYPE) = 'Date' THEN BEGIN
                  EVALUATE(wlDate,FORMAT(rlRefCampo.VALUE));
                  wValor := FORMAT(wlDate,0,'<Year4>-<Month,2>-<Day,2>');
                END ELSE BEGIN
                  IF EVALUATE(wlDecimal,FORMAT(rlRefCampo.VALUE)) THEN BEGIN
                    wValor := FORMAT(wlDecimal,0,'<Sign><Integer><Decimals><1000Character,,>');
                    wValor := CONVERTSTR(wValor, ',','.');
                  END ELSE
                    wValor := FORMAT(rlRefCampo.VALUE);
                 END;

                 // +016
                 // EXIT(wValor);
                 EXIT(ASCII_ANSI((fTrata_Char(wValor))));
                 // -016
              END;
            END;
          END;

          rlConfigElAtt."Tipo campo"::Lookup:
          BEGIN
            rlRefTabla.OPEN(rlConfigElAtt."Tabla relacionada");
            IF rlRefTabla.FIND('-') THEN BEGIN
              rlRefCampo := rlRefTabla.FIELD(rlConfigElAtt."Campo clave");
              rlRefCampo2 := pRefTabla.FIELD(rlConfigElAtt."Campo navision");
              rlRefCampo.SETFILTER('%1', rlRefCampo2.VALUE);
              IF rlRefTabla.FIND('-') THEN
              BEGIN
                rlRefCampo := rlRefTabla.FIELD(rlConfigElAtt."Campo lookup");
                // +016
                // EXIT(FORMAT(rlRefCampo.VALUE));
                EXIT(ASCII_ANSI(fTrata_Char(FORMAT(rlRefCampo.VALUE))));
                // -016
              END;
            END;
          END;

          rlConfigElAtt."Tipo campo"::Calculado:
          BEGIN
            CASE pXMLCampo OF
            END; //fin CASE
            // +016
            // EXIT(wValor);
            EXIT(ASCII_ANSI(fTrata_Char(wValor)));
            // -016

          END;

          rlConfigElAtt."Tipo campo"::Directo:
            BEGIN
              wValor := rlConfigElAtt."Valor directo";
              // +016
              // EXIT(wValor);
              EXIT(ASCII_ANSI(fTrata_Char(wValor)));
              // -016
            END;

        END; //end case
      END;  //end IF
    END;

    PROCEDURE InsertaDtosCab@1103355001(pHotel@1103355000 : Code[10];pNumDoc@1103355001 : Code[20]);
    VAR
      recHistCabFraVta@1103355002 : Record 112;
      recHistLinFraVta@1103355003 : Record 113;
      txtAllowance@1103355004 : TextConst 'ENU=cac:AllowanceCharge;ESP=cac:AllowanceCharge;ITA=CAC: IndennitÖdiCosto';
      txtCharge@1103355005 : TextConst 'ENU=cbc:ChargeIndicator;ESP=cbc:ChargeIndicator;ITA=CBC: IndicatorediCosto';
      txtMulti@1103355006 : TextConst 'ENU=cbc:MultiplierFactorNumeric;ESP=cbc:MultiplierFactorNumeric;ITA=CBC: FattorediMoltiplicazioneNumerica';
      txtAmountcbc@1103355015 : TextConst 'ENU=cbc:Amount;ESP=cbc:Amount;ITA=CBC: Importo';
      txtAmount@1103355007 : TextConst 'ENU=amountCurrencyID;ESP=amountCurrencyID;ITA=importoValutaID';
      txtFalse@1103355008 : TextConst 'ENU=false;ESP=false;ITA=FALSO';
      recHistCabAboVta@1103355011 : Record 114;
      recHistLinAboVta@1103355012 : Record 115;
      txtEUR@1103355010 : TextConst 'ENU=EURO;ESP=EUR;FRA=EUR;ITA=EUR';
      wlImporte@1103355019 : Decimal;
      wlTotalAmount@1103355018 : Decimal;
      wlDto@1103355009 : Decimal;
      wlImpDto@1103355013 : Decimal;
      wlImporteTxt@1103355014 : Text[30];
    BEGIN

       { //+010
       cac:AllowanceCharge
       cbc:ChargeIndicator --> Valor
       cbc:MultiplierFactorNumeric --> Valor
       cbc:Amount  (amountCurrencyID --> Valor) --> Valor
       }

      {   // LIS: LO DESACTIVO
        IF pTipo = pTipo::Factura THEN BEGIN
          IF recHistCabFraVta.GET(pNumDoc) THEN BEGIN
            wlDto := recHistCabFraVta."Payment Discount %";
            //ahora obtenemos el importe de DtoPP
            CLEAR(wlImpDto);
            recHistLinFraVta.RESET;
            recHistLinFraVta.SETRANGE(recHistLinFraVta."Document No.", pNumDoc);
            IF recHistLinFraVta.FIND('-') THEN
              REPEAT
                wlImpDto += recHistLinFraVta."Pmt. Disc. Given Amount";
              UNTIL recHistLinFraVta.NEXT=0;
            //
          END;
        END ELSE BEGIN
          IF recHistCabAboVta.GET(pNumDoc) THEN
            wlDto := recHistCabAboVta."Payment Discount %";
            //ahora obtenemos el importe de DtoPP
            CLEAR(wlImpDto);
            recHistLinAboVta.RESET;
            recHistLinAboVta.SETRANGE(recHistLinAboVta."Document No.", pNumDoc);
            IF recHistLinAboVta.FIND('-') THEN
              REPEAT
                wlImpDto += recHistLinAboVta."Pmt. Disc. Given Amount";
              UNTIL recHistLinAboVta.NEXT=0;
            //
        END;

        IF wlDto <> 0 THEN BEGIN //solo ponemos los nodos si hay dto
          wDllXML.WriteStartElement(txtAllowance);
          wDllXML.WriteNode(txtCharge, txtFalse);

          //insertamos el % dto
          wlImporteTxt := FORMAT(wlDto,0,'<Sign><Integer><Decimals><1000Character,,>');
          wlImporteTxt := CONVERTSTR(wlImporteTxt, ',','.');
          wlDto := 0;
          wDllXML.WriteNode(txtMulti, wlImporteTxt);

          //insertamos el importe del dto
          wlImporteTxt := FORMAT(wlImpDto,0,'<Sign><Integer><Decimals><1000Character,,>');
          wlImporteTxt := CONVERTSTR(wlImporteTxt, ',','.');
          wlImpDto := 0;
          wDllXML.WriteNodeAttribute(txtAmountcbc, wlImporteTxt, txtAmount, txtEUR);

          wDllXML.WriteEndElement;
       END;

      }
    END;

    PROCEDURE InsertaDtosLin@1103355007(pHotel@1103355002 : Code[10];pNumDoc@1103355001 : Code[20];pNumLin@1103355016 : Integer);
    VAR
      recHistLinFraVta@1103355003 : Record 113;
      txtAllowance@1103355004 : TextConst 'ENU=cac:AllowanceCharge;ESP=cac:AllowanceCharge;ITA=CAC: IndennitÖdiCosto';
      txtCharge@1103355005 : TextConst 'ENU=cbc:ChargeIndicator;ESP=cbc:ChargeIndicator;ITA=CBC: IndicatorediCosto';
      txtMulti@1103355006 : TextConst 'ENU=cbc:MultiplierFactorNumeric;ESP=cbc:MultiplierFactorNumeric;ITA=CBC: FattorediMoltiplicazioneNumerica';
      txtFalse@1103355008 : TextConst 'ENU=false;ESP=false;ITA=FALSO';
      recHistLinAboVta@1103355012 : Record 115;
      wlImporte@1103355019 : Decimal;
      wlTotalAmount@1103355018 : Decimal;
      wlDto@1103355009 : Decimal;
      wlImporteTxt@1103355014 : Text[30];
    BEGIN
      //+011

       {
       cac:AllowanceCharge
       cbc:ChargeIndicator --> Valor
       cbc:MultiplierFactorNumeric --> Valor
       }

      {   // LIS: DESACTIVO
        IF pTipo = pTipo::Factura THEN BEGIN
          IF recHistLinFraVta.GET(pNumDoc,pNumLin) THEN
            wlDto := recHistLinFraVta."Line Discount %";
        END ELSE BEGIN
          IF recHistLinAboVta.GET(pNumDoc,pNumLin) THEN
            wlDto := recHistLinAboVta."Line Discount %";
        END;

        IF wlDto <> 0 THEN BEGIN //solo ponemos los nodos si hay dto
          wDllXML.WriteStartElement(txtAllowance);
          wDllXML.WriteNode(txtCharge, txtFalse);

          //insertamos el % dto
          wlImporteTxt := FORMAT(wlDto,0,'<Sign><Integer><Decimals><1000Character,,>');
          wlImporteTxt := CONVERTSTR(wlImporteTxt, ',','.');
          wlDto := 0;
          wDllXML.WriteNode(txtMulti, wlImporteTxt);

          wDllXML.WriteEndElement;
        END;
      }
    END;

    PROCEDURE GetPaymentMeanCode@1103355017(pTipo@1103355000 : 'Factura,Abono';pNumDoc@1103355001 : Code[10]) pFormaPago : Code[10];
    VAR
      rlHistFraVta@1103355002 : Record 112;
      rlHistAboVta@1103355003 : Record 114;
    BEGIN
       //Devolvemos la forma de pago del documento

       CLEAR(pFormaPago);
       IF (pTipo = pTipo::Factura) THEN BEGIN
         IF rlHistFraVta.GET(pNumDoc) THEN
           pFormaPago := rlHistFraVta."Payment Method Code";
       END ELSE BEGIN
         IF rlHistAboVta.GET(pNumDoc) THEN
           pFormaPago := rlHistAboVta."Payment Method Code";
       END;

       EXIT(pFormaPago);
    END;

    PROCEDURE ASCII_ANSI@1(pTexto@1103350003 : Text[250]) wRetorno : Text[250];
    VAR
      wAscii@1103350002 : Text[250];
      wAnsi@1103350001 : Text[250];
      wChar@1103350000 : ARRAY [32] OF Char;
    BEGIN

      //ASCII_ANSI
      //Para salvar el problema que al exportar los textos no se saquen los car†cteres especiales (p.ej: •, ö, etc...),
      //transformamos los car†cteres ASCII en ANSI para que los exporte al TXT correctamente.

      wAscii := 'ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ›››››µ∂∑∏››++Ωæ++--+-+∆«++--›-+';
      wAscii := wAscii +'œ–—“”‘i÷◊ÿ++›_›ﬁÓ‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒ=ÛÙıˆ˜¯˘˙˚¸˝›ˇ';

      wChar[1] := 196;
      wChar[2] := 197;
      wChar[3] := 201;
      wChar[4] := 242;
      wChar[5] := 220;
      wChar[6] := 186;
      wChar[7] := 191;
      wChar[8] := 188;
      wChar[9] := 187;
      wChar[10] := 193;
      wChar[11] := 194;
      wChar[12] := 192;
      wChar[13] := 195;
      wChar[14] := 202;
      wChar[15] := 203;
      wChar[16] := 200;
      wChar[17] := 205;
      wChar[18] := 206;
      wChar[19] := 204;
      wChar[20] := 175;
      wChar[21] := 223;
      wChar[22] := 213;
      wChar[23] := 254;
      wChar[24] := 218;
      wChar[25] := 219;
      wChar[26] := 217;
      wChar[27] := 180;
      wChar[28] := 177;
      wChar[29] := 176;
      wChar[30] := 185;
      wChar[31] := 179;
      wChar[32] := 178;

      wAnsi  := '«¸È‚‰‡ÂÁÍÎËÔÓÏ'+FORMAT(wChar[1])+FORMAT(wChar[2])+FORMAT(wChar[3])+ 'Ê∆Ùˆ'+FORMAT(wChar[4]);
      wAnsi := wAnsi + '˚˘ˇ÷'+FORMAT(wChar[5])+'¯£ÿ◊É·ÌÛ˙Ò—™'+FORMAT(wChar[6])+FORMAT(wChar[7]);
      wAnsi := wAnsi + 'Æ¨Ω'+FORMAT(wChar[8])+'°´'+FORMAT(wChar[9])+'___¶¶' + FORMAT(wChar[10])+FORMAT(wChar[11]);
      wAnsi := wAnsi + FORMAT(wChar[12]) + '©¶¶++¢•++--+-+„' + FORMAT(wChar[13]) + '++--¶-+§–';
      wAnsi  :=  wAnsi +FORMAT(wChar[14])+FORMAT(wChar[15])+FORMAT(wChar[16])+'i'+FORMAT(wChar[17])+FORMAT(wChar[18]);
      wAnsi  :=  wAnsi + 'œ++__¶' + FORMAT(wChar[19])+FORMAT(wChar[20])+'”'+FORMAT(wChar[21])+'‘“ı';
      wAnsi  :=  wAnsi + FORMAT(wChar[22]) + 'µ' + FORMAT(wChar[23]) + 'ﬁ' + FORMAT(wChar[24])+ FORMAT(wChar[25]);
      wAnsi  :=  wAnsi + FORMAT(wChar[26]) + '˝›Ø' + FORMAT(wChar[27]) + '≠' + FORMAT(wChar[28]) +'=æ∂ß˜∏'+ FORMAT(wChar[29]);
      wAnsi  :=  wAnsi + '®∑' + FORMAT(wChar[30]) +FORMAT(wChar[31]) +FORMAT(wChar[32]) +'_ ';

      wRetorno := CONVERTSTR(pTexto, wAscii, wAnsi);
    END;

    PROCEDURE fTrata_Char@1000000000(wTextoIni@1000000000 : Text[250]) wTextoFin : Text[250];
    VAR
      wMal@1000000001 : Text[50];
      wBien@1000000002 : Text[50];
    BEGIN
      //BRM - 100809: A§adimos •, ¶, ß

      wMal:='µ∑é†ÖÑê‘”Çäâ÷ﬁÿ°çã‡„ô¢ïîÈÎö£óÅ•§¶ß';
      wBien:='AAAaaaEEEeeeIIIiiiOOOoooUUUuuuNnao';
      wTextoFin := CONVERTSTR(wTextoIni, wMal, wBien);
    END;

    PROCEDURE RetornaSupplierClientID@1100000(pSupplierClientID@1100000 : Code[20];pCliente@1100001 : Code[20]) rtn : Code[20];
    BEGIN

      IF pSupplierClientID <> '' THEN rtn := pSupplierClientID ELSE rtn := pCliente;
    END;

    PROCEDURE RetornaTextoImporte@1103355013(pImporte@1103355000 : Decimal) wTexto : Text[250];
    VAR
      rCheque@1103355001 : Report 1401;
      wText@1103355002 : ARRAY [2] OF Text[80];
      wParteEntera@1103355003 : Decimal;
    BEGIN
      //+027
      pImporte := ABS(pImporte);
      wParteEntera := ROUND(pImporte, 1, '<');
      rCheque.FormatNoText(wText,wParteEntera,'');
      wTexto := wText[1];
      IF wText[2] <> '' THEN
        wTexto += ' ' + wText[2];
      IF (pImporte - wParteEntera) <> 0 THEN
        wTexto += STRSUBSTNO(' %1/100',ROUND((pImporte - wParteEntera) * 100,1));
      //-027
    END;

    PROCEDURE GetImporteTxt@1103355015(pImporte@1103355000 : Decimal) wlImporteTxt : Text[30];
    BEGIN
      //+027
      // Convierte el decimal a Texto con el formato necesario

      wlImporteTxt := FORMAT(pImporte,0,'<Sign><Integer><Decimals><1000Character,,>');
      wlImporteTxt := CONVERTSTR(wlImporteTxt, ',','.');
      //-027
    END;

    LOCAL PROCEDURE _AddElement@1000000005(VAR DOMNode@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";Name@1000000001 : Text[250];Value@1000000002 : Text[250];NameSpace@1000000003 : Text[250];VAR CreatedDOMNode@1000000004 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode") Status : Integer;
    VAR
      TempElement@1000000005 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      // _AddElement

      TempElement := autXML.createNode('Element', Name, NameSpace);

      IF TempElement.nodeName='' THEN BEGIN
        Status := 50;
        EXIT(Status)
      END;
      IF Value <> '' THEN BEGIN
        TempElement.text := Value;
      END;
      DOMNode.appendChild(TempElement);
      CreatedDOMNode := TempElement;
      CLEAR(TempElement);
      Status := 0;
    END;

    LOCAL PROCEDURE _AddAttribute@1000000006(VAR DOMNode@1000000000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";Name@1000000001 : Text[250];Value@1000000002 : Text[250]) Status : Integer;
    VAR
      TempAttribute@1000000003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      // _AddAttribute

      TempAttribute := DOMNode.ownerDocument.createAttribute(Name);
      IF TempAttribute.nodeName='' THEN BEGIN
        Status := 60;
        EXIT(Status)
      END;

      IF Value <> '' THEN BEGIN
        TempAttribute.nodeValue := Value;
      END;
      DOMNode.attributes.setNamedItem(TempAttribute);
      CLEAR(TempAttribute);
    END;

    EVENT autXML@1000000000::ondataavailable@198();
    BEGIN
    END;

    EVENT autXML@1000000000::onreadystatechange@-609();
    BEGIN
    END;

    BEGIN
    {
      //funciones para generar archivos XML para exportaci¢n electr¢nica

      $052 MNC 12-01-15 Basado en anteriores de Hotel y EBS, pero usando XMLDOMDOC

      De momento solo Tablas 36 y 37, fra y abono venta borrador. Pendiente poder seleccionar fra y abono registrados
      Pendiente marcado con TODO

      $053 MNC 06-07-2015 exceciones en campos de pie y de lineas
    }
    END.
  }
}

OBJECT Report 7009775 Resumen saldo proveedor
{
  OBJECT-PROPERTIES
  {
    Date=02/10/12;
    Time=12:00:00;
    Modified=Yes;
    Version List=AIC2009;
  }
  PROPERTIES
  {
    CaptionML=[ENU=Summary supplier balance;
               ESP=Resumen Saldo proveedor];
    OnInitReport=BEGIN
                   SetFechas(WORKDATE);
                 END;

  }
  DATAITEMS
  {
    { PROPERTIES
      {
        DataItemTable=Table23;
        DataItemTableView=SORTING(No.);
        NewPagePerRecord=Yes;
        PrintOnlyIfDetail=Yes;
        OnPreDataItem=BEGIN
                        CLEAR(wSaltaPag);
                      END;

        OnAfterGetRecord=BEGIN
                           // Cuando el usuario pida que en el informe no muestre el detalle de las facturas pendientes
                           // no hacemos el salto de pagina

                           Vendor.SETFILTER("Date Filter", '..%1', wFechaFinal);
                           Vendor.CALCFIELDS(Balance);

                           IF wSinValidar THEN BEGIN
                             IF wSaltaPag THEN
                               CurrReport.NEWPAGE;
                             wSaltaPag := FALSE;
                           END;

                           CLEAR(wSaldoCont);

                           // Buscamos la ultima fecha de pago

                           rVendEntry.RESET;
                           rVendEntry.SETCURRENTKEY("Document Type",
                                                    "Vendor No.",
                                                    "Posting Date",
                                                    "Currency Code");
                           rVendEntry.SETRANGE("Vendor No."   , "No.");
                           rVendEntry.SETRANGE("Document Type", rVendEntry."Document Type"::Payment);
                           IF NOT rVendEntry.FINDLAST THEN
                             CLEAR(rVendEntry);
                         END;

        ReqFilterFields=No.;
      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=18150;
            SectionHeight=1269;
          }
          CONTROLS
          {
            { 1103355001;Label  ;10650;0    ;7500 ;423  ;HorzAlign=Right;
                                                         FontSize=10;
                                                         FontBold=Yes;
                                                         CaptionML=[ENU=Summary supplier balance;
                                                                    ESP=Resumen Saldo proveedor] }
            { 1103355003;TextBox;0    ;0    ;7500 ;423  ;FontSize=10;
                                                         SourceExpr=COMPANYNAME }
            { 1103355045;Shape  ;0    ;423  ;18150;423  ;ShapeStyle=HorzLine }
            { 1103355047;TextBox;16800;846  ;1350 ;423  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         CaptionML=[ENU=Date control:;
                                                                    ESP=Fecha Control:];
                                                         SourceExpr=wFechaFinal }
            { 1103355085;Label  ;14100;846  ;2550 ;423  ;ParentControl=1103355047;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=1269;
          }
          CONTROLS
          {
            { 1103355011;TextBox;7050 ;423  ;9750 ;423  ;FontSize=9;
                                                         SourceExpr=Name }
            { 1103355007;TextBox;2400 ;423  ;4500 ;423  ;HorzAlign=Left;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Supplier;
                                                                    ESP=Proveedor];
                                                         SourceExpr="No." }
            { 1103355008;Label  ;150  ;423  ;2100 ;423  ;ParentControl=1103355007;
                                                         VertAlign=Bottom;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes }
            { 1103355096;Shape  ;0    ;0    ;18150;1269  }
          }
           }
        { PROPERTIES
          {
            SectionType=Footer;
            PrintOnEveryPage=Yes;
            PlaceInBottom=Yes;
            SectionWidth=18150;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1103355000;Shape  ;0    ;0    ;18150;423  ;ShapeStyle=HorzLine }
            { 1103355006;TextBox;9000 ;423  ;2250 ;423  ;HorzAlign=Right;
                                                         SourceExpr=USERID }
            { 1103355002;TextBox;5850 ;423  ;3150 ;423  ;HorzAlign=Right;
                                                         SourceExpr=FORMAT(TODAY,0,4) }
            { 1103355004;TextBox;17700;423  ;450  ;423  ;CaptionML=[ENU=page;
                                                                    ESP=P gina];
                                                         SourceExpr=CurrReport.PAGENO }
            { 1103355005;Label  ;16800;423  ;900  ;423  ;ParentControl=1103355004 }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table2000000026;
        DataItemTableView=SORTING(Number)
                          WHERE(Number=FILTER(1..2));
        DataItemVarName=Tempd;
        PrintOnlyIfDetail=Yes;
        OnPreDataItem=BEGIN
                        // Tempd  es un entero filtrado a 2.  1= Temporada A (Anterior), 2= Temporada B (Antual)
                      END;

        OnAfterGetRecord=BEGIN
                           wTempd := Number;

                           CalcImportes2; // Calcula los importes de la temporada

                           wBonosSin := GetBonosSinValidar;

                           wSaldoFinal[wTempd] += wBonosSin;
                         END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=1269;
            OnPreSection=BEGIN
                           CurrReport.SHOWOUTPUT((wTempd=2) AND (wSaldoFinal[1]<>0));
                         END;

          }
          CONTROLS
          {
            { 1103355075;Shape  ;0    ;423  ;18150;423  ;ShapeStyle=HorzLine }
            { 1103355076;Shape  ;0    ;530  ;18150;423  ;ShapeStyle=HorzLine }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=3807;
          }
          CONTROLS
          {
            { 1103355044;Shape  ;0    ;846  ;8100 ;2538  }
            { 1103355077;TextBox;0    ;423  ;8100 ;423  ;FontSize=9;
                                                         FontBold=Yes;
                                                         SourceExpr=STRSUBSTNO(Text002,wTempd,wFechas[wTempd][1],wFechas[wTempd][2]) }
            { 1103355009;TextBox;4350 ;1269 ;2400 ;423  ;HorzAlign=Right;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Balance in invoices;
                                                                    ESP=Saldo en Facturas];
                                                         SourceExpr=wImporteFacturas[wTempd] }
            { 1103355010;Label  ;450  ;1269 ;3750 ;423  ;ParentControl=1103355009;
                                                         HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes }
            { 1103355013;TextBox;4350 ;1692 ;2400 ;423  ;HorzAlign=Right;
                                                         FontSize=9;
                                                         CaptionML=[ENU=balance in Credit memos;
                                                                    ESP=Saldo en Abonos];
                                                         SourceExpr=wImporteAbonos[wTempd] }
            { 1103355012;Label  ;450  ;1692 ;3750 ;423  ;ParentControl=1103355013;
                                                         HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes }
            { 1103355039;Shape  ;4350 ;2115 ;2400 ;423  ;ShapeStyle=HorzLine }
            { 1103355040;TextBox;4350 ;2538 ;2400 ;423  ;HorzAlign=Right;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Balance in invoices;
                                                                    ESP=Saldo en Facturas];
                                                         SourceExpr=wImporteFacturas[wTempd]  + wImporteAbonos[wTempd] }
            { 1103355070;TextBox;6900 ;2538 ;900  ;423  ;HorzAlign=Left;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Supplier;
                                                                    ESP=Proveedor];
                                                         SourceExpr=Vendor."Currency Code" }
            { 1103355043;Label  ;450  ;2538 ;3750 ;423  ;HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes;
                                                         CaptionML=[ENU=Balance Invoicing;
                                                                    ESP=Saldo facturacion] }
          }
           }
        { PROPERTIES
          {
            SectionType=Footer;
            SectionWidth=18150;
            SectionHeight=1692;
            OnPostSection=BEGIN
                            IF (wSaldoFinal[1]<>0) OR (wSaldoFinal[2] <> 0) THEN
                              wSaltaPag:= TRUE;
                          END;

          }
          CONTROLS
          {
            { 1103355094;Shape  ;0    ;423  ;5400 ;423   }
            { 1103355095;Shape  ;10350;423  ;6600 ;423   }
            { 1103355086;TextBox;3150 ;423  ;2100 ;423  ;FontSize=9;
                                                         CaptionML=[ENU=ACCOUNT BALANCE;
                                                                    ESP=SALDO CONTABLE];
                                                         SourceExpr=Vendor.Balance }
            { 1103355089;Label  ;150  ;423  ;2850 ;423  ;ParentControl=1103355086;
                                                         VertAlign=Center;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes }
            { 1103355090;TextBox;13500;423  ;2250 ;423  ;FontSize=9;
                                                         CaptionML=[ENU=FINAL BALANCE;
                                                                    ESP=SALDO FINAL];
                                                         SourceExpr=wSaldoFinal[1] + wSaldoFinal[2] }
            { 1103355091;Label  ;10500;423  ;2850 ;423  ;ParentControl=1103355090;
                                                         VertAlign=Center;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes }
            { 1103355093;TextBox;15900;423  ;900  ;423  ;HorzAlign=Left;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Supplier;
                                                                    ESP=Proveedor];
                                                         SourceExpr=Vendor."Currency Code" }
            { 1103355092;Shape  ;0    ;1269 ;5400 ;423   }
            { 1103355098;TextBox;3150 ;1269 ;2100 ;423  ;FontSize=9;
                                                         CaptionML=[ENU=LAST PAYMENT;
                                                                    ESP=ULTIMO PAGO];
                                                         SourceExpr=rVendEntry."Posting Date" }
            { 1103355099;Label  ;150  ;1269 ;2850 ;423  ;ParentControl=1103355098;
                                                         VertAlign=Center;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=2;
        DataItemTable=Table25;
        DataItemTableView=SORTING(Document No.,Document Type,Vendor No.)
                          WHERE(Open=CONST(Yes));
        DataItemVarName=Movimientos;
        OnPreDataItem=BEGIN
                        SETFILTER("Document Type", '<>%1&<>%2', "Document Type"::Invoice, "Document Type"::"Credit Memo");

                        SETRANGE("Posting Date" , wFechas[wTempd][1], wFechas[wTempd][2]);

                        CurrReport.CREATETOTALS("Remaining Amount", Amount);
                      END;

        OnAfterGetRecord=BEGIN
                           wSaldoFinal[wTempd] += - "Remaining Amount";

                           wSaldoCont[wTempd] += - "Remaining Amount";
                         END;

        CalcFields=Remaining Amount,Amount;
        DataItemLinkReference=Vendor;
        DataItemLink=Vendor No.=FIELD(No.);
      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            SectionWidth=18150;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1103355024;Label  ;0    ;0    ;1350 ;846  ;ParentControl=1103355025;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355027;Label  ;1500 ;0    ;1800 ;846  ;ParentControl=1103355026;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355029;Label  ;3450 ;0    ;2700 ;846  ;ParentControl=1103355028;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355031;Label  ;6300 ;0    ;7050 ;846  ;ParentControl=1103355030;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355033;Label  ;13500;0    ;2250 ;846  ;ParentControl=1103355032;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355068;Label  ;15900;0    ;2250 ;846  ;ParentControl=1103355069;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
          }
           }
        { PROPERTIES
          {
            SectionType=TransHeader;
            SectionWidth=18150;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1103355014;Label  ;0    ;0    ;1350 ;846  ;ParentControl=1103355025;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355015;Label  ;1500 ;0    ;1800 ;846  ;ParentControl=1103355026;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355016;Label  ;3450 ;0    ;2700 ;846  ;ParentControl=1103355028;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355017;Label  ;6300 ;0    ;7050 ;846  ;ParentControl=1103355030;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355018;Label  ;13500;0    ;2250 ;846  ;ParentControl=1103355032;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355067;Label  ;15900;0    ;2250 ;846  ;ParentControl=1103355069;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1103355025;TextBox;0    ;0    ;1350 ;423  ;FontSize=8;
                                                         SourceExpr="Posting Date" }
            { 1103355026;TextBox;1500 ;0    ;1800 ;423  ;FontSize=8;
                                                         SourceExpr="Document Type" }
            { 1103355028;TextBox;3450 ;0    ;2700 ;423  ;HorzAlign=Left;
                                                         FontSize=8;
                                                         SourceExpr="External Document No." }
            { 1103355030;TextBox;6300 ;0    ;7050 ;423  ;FontSize=8;
                                                         SourceExpr=Description }
            { 1103355032;TextBox;13500;0    ;2250 ;423  ;FontSize=8;
                                                         CaptionML=[ENU=Remaining Amount;
                                                                    ESP=Importe Pendiente];
                                                         SourceExpr=-"Remaining Amount" }
            { 1103355069;TextBox;15900;0    ;2250 ;423  ;FontSize=8;
                                                         CaptionML=[ENU=Amount;
                                                                    ESP=Importe];
                                                         SourceExpr=- Amount }
          }
           }
        { PROPERTIES
          {
            SectionType=Footer;
            SectionWidth=18150;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1103355019;TextBox;13500;0    ;2250 ;423  ;HorzAlign=Right;
                                                         FontSize=8;
                                                         CaptionML=[ENU=balance in Credit memos;
                                                                    ESP=Saldo en Abonos];
                                                         SourceExpr=-"Remaining Amount" }
            { 1103355020;Label  ;7650 ;0    ;5700 ;423  ;ParentControl=1103355019;
                                                         HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes;
                                                         CaptionML=[ENU=Summary remaining movements;
                                                                    ESP=Resumen movimientos pendientes] }
            { 1103355072;TextBox;15900;0    ;900  ;423  ;HorzAlign=Left;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Supplier;
                                                                    ESP=Proveedor];
                                                         SourceExpr=Vendor."Currency Code" }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=2;
        DataItemTable=Table2000000026;
        DataItemTableView=SORTING(Number);
        MaxIteration=1;
        DataItemVarName=SubTotalContable;
      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1103355080;Shape  ;0    ;423  ;9300 ;423   }
            { 1103355078;TextBox;6000 ;423  ;2250 ;423  ;HorzAlign=Right;
                                                         FontSize=8;
                                                         CaptionML=[ENU=Sub-total season acounting;
                                                                    ESP=Sub-total contable temporada];
                                                         SourceExpr=wSaldoCont[wTempd] }
            { 1103355079;Label  ;150  ;423  ;5700 ;423  ;ParentControl=1103355078;
                                                         HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes }
            { 1103355081;TextBox;8400 ;423  ;900  ;423  ;HorzAlign=Left;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Supplier;
                                                                    ESP=Proveedor];
                                                         SourceExpr=Vendor."Currency Code" }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=2;
        DataItemTable=Table7010014;
        DataItemTableView=SORTING(Proveedor,Num. Factura,Fecha factura);
        DataItemVarName=SinValidar;
        OnPreDataItem=VAR
                        lwFecha2@1103355000 : Date;
                      BEGIN
                        SETRANGE (Contabilizada  , FALSE);

                        lwFecha2 := wFechas[wTempd][2];
                        IF (wFechaFinal <> 0D) AND (wFechaFinal < lwFecha2) THEN
                          lwFecha2 := wFechaFinal;

                        CASE wTempd OF
                          1 : SETFILTER("Fecha factura", '<=%1', lwFecha2);
                          2 : SETRANGE("Fecha factura" , wFechas[2][1], lwFecha2);
                        END;
                        // CurrReport.CREATETOTALS("Importe Hotel Validacion");
                        CurrReport.CREATETOTALS(wImporteHotel);
                      END;

        OnAfterGetRecord=VAR
                           lrLinHotel@1103355000 : Record 7009861;
                           lwImp@1103355001 : Decimal;
                         BEGIN

                           CLEAR(wImporteHotel);
                           CLEAR(lrLinHotel);
                           lrLinHotel.SETRANGE(No, ID);
                           IF lrLinHotel.FINDSET THEN BEGIN
                             REPEAT
                               lwImp := lrLinHotel."Importe Calculado" - lrLinHotel."Importe validado";
                               IF lrLinHotel."Importe Hotel" < lwImp THEN
                                 lwImp := lrLinHotel."Importe Hotel";
                               wImporteHotel += lwImp;
                             UNTIL lrLinHotel.NEXT=0;
                           END;

                           // JPT 02/04/09 Si lo descontamos de los Bonos no se lo podemos volver a a¤adir a saldo
                           // wSaldoFinal[wTempd] += wImporteHotel;
                           wBonosSin -= wImporteHotel;

                           {
                           wSaldoFinal[wTempd] += "Importe Hotel Validacion";

                           wBonosSin -= "Importe Hotel Validacion";
                           }
                         END;

        CalcFields=Importe Hotel Validacion;
        DataItemLinkReference=Vendor;
        DataItemLink=Proveedor=FIELD(No.);
      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            SectionWidth=18150;
            SectionHeight=1692;
            OnPreSection=BEGIN
                           CurrReport.SHOWOUTPUT(wSinValidar);
                         END;

          }
          CONTROLS
          {
            { 1103355034;Label  ;1650 ;846  ;1500 ;846  ;ParentControl=1103355023;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355022;Label  ;3300 ;846  ;2550 ;846  ;ParentControl=1103355021;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355036;Label  ;13500;846  ;2250 ;846  ;ParentControl=1103355035;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355038;Label  ;6000 ;846  ;7350 ;846  ;ParentControl=1103355037;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355071;Label  ;0    ;846  ;1500 ;846  ;ParentControl=1103355066;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355083;Label  ;0    ;423  ;7050 ;423  ;FontSize=9;
                                                         FontBold=Yes;
                                                         CaptionML=[ENU=Remaining invoices to validate;
                                                                    ESP=Facturas Pendientes de Validar] }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=423;
            OnPreSection=BEGIN
                           CurrReport.SHOWOUTPUT(wSinValidar);
                         END;

          }
          CONTROLS
          {
            { 1103355021;TextBox;3300 ;0    ;2550 ;423  ;FontSize=8;
                                                         SourceExpr="Num. Factura" }
            { 1103355023;TextBox;1650 ;0    ;1500 ;423  ;FontSize=8;
                                                         SourceExpr="Fecha factura" }
            { 1103355035;TextBox;13500;0    ;2250 ;423  ;FontSize=8;
                                                         CaptionML=[ENU=Invoice amount;
                                                                    ESP=Importe factura];
                                                         SourceExpr=wImporteHotel }
            { 1103355037;TextBox;6000 ;0    ;7350 ;423  ;FontSize=8;
                                                         SourceExpr="Texto registro" }
            { 1103355066;TextBox;0    ;0    ;1500 ;423  ;FontSize=8;
                                                         SourceExpr="Fecha creacion" }
          }
           }
        { PROPERTIES
          {
            SectionType=Footer;
            SectionWidth=18150;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1103355087;Shape  ;0    ;0    ;16950;423   }
            { 1103355041;TextBox;13500;0    ;2250 ;423  ;FontSize=8;
                                                         CaptionML=[ENU=Invoice amount;
                                                                    ESP=Importe factura];
                                                         SourceExpr=wImporteHotel }
            { 1103355042;Label  ;150  ;0    ;13200;423  ;HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes;
                                                         CaptionML=[ENU=All remaining invoices to be posted;
                                                                    ESP=Total facturas pendientes de contabilizar] }
            { 1103355074;TextBox;15900;0    ;900  ;423  ;HorzAlign=Left;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Supplier;
                                                                    ESP=Proveedor];
                                                         SourceExpr=Vendor."Currency Code" }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=2;
        DataItemTable=Table2000000026;
        DataItemTableView=SORTING(Number);
        MaxIteration=1;
        DataItemVarName=Resumen;
        OnAfterGetRecord=BEGIN
                           { JPT 24/01/08 desean que los importes aparezcan a 0
                           IF wSaldoFinal[wTempd] = 0 THEN
                             CurrReport.BREAK;
                           }
                         END;

        DataItemLinkReference=Vendor;
      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=423;
            OnPreSection=BEGIN
                           // Quieren que salga aunque sea 0
                           // CurrReport.SHOWOUTPUT := wBonosSin <> 0;
                         END;

          }
          CONTROLS
          {
            { 1103355088;Shape  ;0    ;0    ;16950;423   }
            { 1103355084;TextBox;13500;0    ;2250 ;423  ;FontSize=8;
                                                         CaptionML=[ENU=Invoice amount;
                                                                    ESP=Importe factura];
                                                         SourceExpr=wBonosSin }
            { 1103355082;Label  ;150  ;0    ;13200;423  ;HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes;
                                                         CaptionML=[ENU=Season vouchers remaining to validate;
                                                                    ESP=Bonos de la temporada pendientes de validar] }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1103355049;Shape  ;0    ;0    ;16950;423   }
            { 1103355048;TextBox;150  ;0    ;13200;423  ;FontSize=9;
                                                         FontBold=Yes;
                                                         LeaderDots=Yes;
                                                         SourceExpr=STRSUBSTNO(Text004,wTempd) }
            { 1103355046;TextBox;13500;0    ;2250 ;423  ;HorzAlign=Right;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Balance in invoices;
                                                                    ESP=Saldo en Facturas];
                                                         SourceExpr=wSaldoFinal[wTempd] }
            { 1103355073;TextBox;15900;0    ;900  ;423  ;HorzAlign=Left;
                                                         FontSize=9;
                                                         CaptionML=[ENU=Supplier;
                                                                    ESP=Proveedor];
                                                         SourceExpr=Vendor."Currency Code" }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemTable=Table2000000026;
        DataItemTableView=SORTING(Number)
                          WHERE(Number=FILTER(1..2));
        DataItemVarName=Tempd2;
        PrintOnlyIfDetail=Yes;
        OnPreDataItem=BEGIN
                        IF NOT wSinProveedor THEN
                          CurrReport.BREAK;
                      END;

        OnAfterGetRecord=BEGIN
                           wTempd := Number;
                         END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=18150;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1103355051;TextBox;0    ;0    ;7500 ;423  ;FontSize=10;
                                                         SourceExpr=COMPANYNAME }
            { 1103355050;Label  ;10650;0    ;7500 ;423  ;HorzAlign=Right;
                                                         FontSize=10;
                                                         FontBold=Yes;
                                                         CaptionML=[ENU=Invoices without supplier;
                                                                    ESP=Facturas sin proveedor] }
            { 1103355052;Shape  ;0    ;423  ;18150;423  ;ShapeStyle=HorzLine }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1103355097;TextBox;0    ;423  ;8100 ;423  ;FontSize=9;
                                                         FontBold=Yes;
                                                         SourceExpr=STRSUBSTNO(Text002,wTempd,wFechas[wTempd][1],wFechas[wTempd][2]) }
          }
           }
        { PROPERTIES
          {
            SectionType=Footer;
            PrintOnEveryPage=Yes;
            PlaceInBottom=Yes;
            SectionWidth=18150;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1103355053;Shape  ;0    ;0    ;18150;423  ;ShapeStyle=HorzLine }
            { 1103355054;TextBox;9000 ;423  ;2250 ;423  ;HorzAlign=Right;
                                                         SourceExpr=USERID }
            { 1103355055;TextBox;5850 ;423  ;3150 ;423  ;HorzAlign=Right;
                                                         SourceExpr=FORMAT(TODAY,0,4) }
            { 1103355056;TextBox;17700;423  ;450  ;423  ;CaptionML=[ENU=page;
                                                                    ESP=P gina];
                                                         SourceExpr=CurrReport.PAGENO }
            { 1103355057;Label  ;16800;423  ;900  ;423  ;ParentControl=1103355056 }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table7010014;
        DataItemTableView=SORTING(Proveedor,Num. Factura,Fecha factura);
        DataItemVarName=SinProveedor;
        OnPreDataItem=VAR
                        lwFecha2@1103355000 : Date;
                      BEGIN
                        SETRANGE (Contabilizada  , FALSE);

                        lwFecha2 := wFechas[wTempd][2];
                        IF (wFechaFinal <> 0D) AND (wFechaFinal < lwFecha2) THEN
                          lwFecha2 := wFechaFinal;

                        CASE wTempd OF
                          1 : SETFILTER("Fecha factura", '<=%1', lwFecha2);
                          2 : SETRANGE("Fecha factura" , wFechas[2][1], lwFecha2);
                        END;

                        SETRANGE (Proveedor      , '');
                        SETFILTER(Hotel          , '<>%1', '');
                      END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=18150;
            SectionHeight=1692;
          }
          CONTROLS
          {
            { 1103355062;Label  ;3300 ;846  ;1500 ;846  ;ParentControl=1103355058;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355063;Label  ;4950 ;846  ;2550 ;846  ;ParentControl=1103355060;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355064;Label  ;7650 ;846  ;7350 ;846  ;ParentControl=1103355059;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1103355065;Label  ;15150;846  ;1800 ;846  ;ParentControl=1103355061;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1103355058;TextBox;3300 ;0    ;1500 ;423  ;FontSize=8;
                                                         SourceExpr="Fecha factura" }
            { 1103355059;TextBox;7650 ;0    ;7350 ;423  ;FontSize=8;
                                                         SourceExpr="Texto registro" }
            { 1103355060;TextBox;4950 ;0    ;2550 ;423  ;FontSize=8;
                                                         SourceExpr="Num. Factura" }
            { 1103355061;TextBox;15150;0    ;1800 ;423  ;FontSize=8;
                                                         CaptionML=[ENU=Invoice amount;
                                                                    ESP=Importe factura];
                                                         SourceExpr="Importe Hotel Validacion" }
          }
           }
      }
       }
  }
  REQUESTFORM
  {
    PROPERTIES
    {
      Width=7920;
      Height=3850;
      CaptionML=[ENU=Summary supplier balance;
                 ESP=Resumen Saldo proveedor];
      SaveValues=Yes;
    }
    CONTROLS
    {
      { 1103355000;TextBox;4510 ;1540 ;1700 ;440  ;CaptionML=[ENU=Final date of control;
                                                              ESP=Fecha final de control];
                                                   SourceExpr=wFechaFinal }
      { 1103355001;Label  ;220  ;1540 ;4180 ;440  ;ParentControl=1103355000 }
      { 1103355002;CheckBox;4510;2090 ;440  ;440  ;ShowCaption=No;
                                                   CaptionML=[ENU=Show invoices without supplier;
                                                              ESP=Mostrar facturas sin proveedor];
                                                   SourceExpr=wSinProveedor }
      { 1103355003;Label  ;220  ;2090 ;4180 ;440  ;ParentControl=1103355002 }
      { 1103355004;CheckBox;4510;2640 ;440  ;440  ;ShowCaption=No;
                                                   CaptionML=[ENU=Shouw invoices without validation;
                                                              ESP=Mostrar facturas sin validar];
                                                   SourceExpr=wSinValidar }
      { 1103355005;Label  ;220  ;2640 ;4180 ;440  ;ParentControl=1103355004 }
      { 1103355006;TextBox;4290 ;220  ;3080 ;440  ;Focusable=No;
                                                   HorzAlign=Center;
                                                   BorderStyle=Normal;
                                                   CaptionML=[ENU=Season A;
                                                              ESP=Temporada A];
                                                   SourceExpr=STRSUBSTNO('%1..%2',wFechas[1][1],wFechas[1][2]) }
      { 1103355007;Label  ;220  ;220  ;3960 ;440  ;ParentControl=1103355006 }
      { 1103355008;TextBox;4290 ;770  ;3080 ;440  ;Focusable=No;
                                                   HorzAlign=Center;
                                                   BorderStyle=Normal;
                                                   CaptionML=[ENU=Season B;
                                                              ESP=Temporada B];
                                                   SourceExpr=STRSUBSTNO('%1..%2',wFechas[2][1],wFechas[2][2]) }
      { 1103355009;Label  ;220  ;770  ;3960 ;440  ;ParentControl=1103355008 }
    }
  }
  REQUESTPAGE
  {
    PROPERTIES
    {
    }
    CONTROLS
    {
    }
  }
  CODE
  {
    VAR
      rMov@1103355000 : Record 380;
      rVendEntry@1103355017 : Record 25;
      wImporteFacturas@1103355001 : ARRAY [2] OF Decimal;
      wImporteAbonos@1103355002 : ARRAY [2] OF Decimal;
      wSaldoFinal@1103355004 : ARRAY [2] OF Decimal;
      wBonosSin@1103355012 : Decimal;
      wSaldoCont@1103355016 : ARRAY [2] OF Decimal;
      wFechaFinal@1103355003 : Date;
      wSinProveedor@1103355005 : Boolean;
      wSinValidar@1103355006 : Boolean;
      wSaltaPag@1103355007 : Boolean;
      wFechas@1103355008 : ARRAY [2,2] OF Date;
      Text001@1103355009 : TextConst 'ENU=Must indicate a date;ESP=Debe de indicarse una fecha';
      wTempd@1103355010 : ',A,B';
      Text002@1103355011 : TextConst 'ENU=Season %1      %2..%3;ESP=Temporada %1      %2..%3';
      Text003@1103355013 : TextConst 'ENU=Supplier #1#########\@2@@@@@@@@@@@@@@@@@;ESP=Proveedor #1#########\@2@@@@@@@@@@@@@@@@@';
      Text004@1103355014 : TextConst 'ENU="Real balance season %1 ";ESP=Saldo real temporada %1';
      wVentana@1103355015 : Dialog;
      wImporteHotel@1103355018 : Decimal;

    PROCEDURE SetFechas@1103355001(pwFecha@1103355000 : Date);
    VAR
      lwMes@1103355002 : Integer;
      lwFechaIni@1103355001 : Date;
    BEGIN
      // SetFechas
      // Dada una fecha dada se delimitan 2 Temporadas
      // Sabemos que la temporadas van  del 01.11 al 30.04  y  del 01.05 al 31.10
      // As¡ wFechas es una matriz de 2+2  dimensiones organizada de la siguiente manera:
      // wFechas[1][1] Inicio Temporada A , wFechas[1][2] Fin Temporada A
      // wFechas[2][1] Inicio Temporada B , wFechas[2][2] Fin Temporada B

      IF pwFecha = 0D THEN
        ERROR(Text001);

      CLEAR(wFechas);
      lwMes := DATE2DMY(pwFecha,2); // Buscamos el Mes Actal.

      // Buscamos el incio de la temporada A
      CASE lwMes OF
        1..4  : lwFechaIni:= DMY2DATE(1,5,DATE2DMY(pwFecha,3)-1); // 01/05 a¤o Ant
        5..10 : lwFechaIni:= DMY2DATE(1,11,DATE2DMY(pwFecha,3)-1); // 01/10 a¤o Ant
        11..12: lwFechaIni:= DMY2DATE(1,5,DATE2DMY(pwFecha,3)); // 01/05 a¤o Act
      END;

      wFechas[1][1] := lwFechaIni;
      wFechas[1][2] := CALCDATE('<+6M-1D>', wFechas[1][1]);
      wFechas[2][1] := CALCDATE('<+1D>',wFechas[1][2]);
      wFechas[2][2] := CALCDATE('<+6M-1D>',wFechas[2][1]);
    END;

    PROCEDURE CalcImportes@1103355000();
    BEGIN
      // CalcImportes
      // *************************** NO SE UTILIZA ******************************
      // Ya que solo interesan los movimientos que siguen pendientes

      wImporteFacturas[wTempd] := 0;
      wImporteAbonos[wTempd]   := 0;

      CLEAR(rMov);
      rMov.SETCURRENTKEY("Initial Document Type",
                         "Vendor No.",
                         "Posting Date",
                         "Currency Code",
                         "Entry Type");
      rMov.SETRANGE("Vendor No."           , Vendor."No.");
      rMov.SETRANGE("Posting Date", wFechas[wTempd][1], wFechas[wTempd][2]);

      rMov.SETRANGE("Initial Document Type", rMov."Initial Document Type"::Invoice);
      IF rMov.FINDSET THEN BEGIN
        rMov.CALCSUMS(Amount);
        wImporteFacturas[wTempd] := - rMov.Amount;
      END;

      rMov.SETRANGE("Initial Document Type", rMov."Initial Document Type"::"Credit Memo");
      IF rMov.FINDSET THEN BEGIN
        rMov.CALCSUMS(Amount);
        wImporteAbonos[wTempd] := - rMov.Amount;
      END;

      wSaldoFinal[wTempd] := wImporteFacturas[wTempd] + wImporteAbonos[wTempd];
      wSaldoCont[wTempd]  := wImporteFacturas[wTempd] + wImporteAbonos[wTempd]; // Guardamos el saldo contable
    END;

    PROCEDURE CalcImportes2@1103355002();
    VAR
      lrMovPro@1103355000 : Record 25;
    BEGIN
      // CalcImportes2

      wImporteFacturas[wTempd] := 0;
      wImporteAbonos[wTempd]   := 0;

      CLEAR(lrMovPro);
      lrMovPro.SETCURRENTKEY("Document Type","Vendor No.","Posting Date","Currency Code");
      lrMovPro.SETRANGE("Vendor No.", Vendor."No.");
      lrMovPro.SETRANGE("Posting Date", wFechas[wTempd][1], wFechas[wTempd][2]);
      lrMovPro.SETRANGE(Open, TRUE);

      lrMovPro.SETRANGE("Document Type" , lrMovPro."Document Type"::Invoice);
      IF lrMovPro.FINDSET THEN BEGIN
        REPEAT
          lrMovPro.CALCFIELDS("Remaining Amount");
          wImporteFacturas[wTempd] += - lrMovPro."Remaining Amount"
        UNTIL lrMovPro.NEXT=0;
      END;

      lrMovPro.SETRANGE("Document Type" , lrMovPro."Document Type"::"Credit Memo");
      IF lrMovPro.FINDSET THEN BEGIN
        REPEAT
          lrMovPro.CALCFIELDS("Remaining Amount");
          wImporteAbonos[wTempd] += - lrMovPro."Remaining Amount"
        UNTIL lrMovPro.NEXT=0;
      END;

      wSaldoFinal[wTempd] := wImporteFacturas[wTempd] + wImporteAbonos[wTempd];
      wSaldoCont[wTempd]  := wImporteFacturas[wTempd] + wImporteAbonos[wTempd]; // Guardamos el saldo contable
    END;

    PROCEDURE GetBonosSinValidar@1() : Decimal;
    VAR
      lrHotel@1103355000 : Record 7009724;
      lrBono@1103355001 : Record 7010013;
      lwImporteSin@1103355002 : Decimal;
      lwTotalImporte@1103355003 : Decimal;
      lwCont@1103355004 : Integer;
      lwTot@1103355005 : Integer;
      lwFecha2@1103355006 : Date;
    BEGIN
      // GetBonosSinValidar
      // JPT 04/07/05 Buscas el total de importe de bonos de hotel sin validar de ese proveedor

      CLEAR(lrHotel);
      CLEAR(lwTotalImporte);
      lrHotel.SETCURRENTKEY(NoName,"Proveedor Intermediacion","Proveedor Cuenta Propia");
      lrHotel.SETRANGE("Proveedor Intermediacion", Vendor."No.");
      IF lrHotel.FIND('-') THEN BEGIN
        wVentana.OPEN(Text003);
        REPEAT
          CLEAR(lrBono);
          lrBono.SETCURRENTKEY(Delegacion,Hotel,"Fecha llegada");

          lwFecha2 := wFechas[wTempd][2];
          IF (wFechaFinal <> 0D) AND (wFechaFinal < lwFecha2) THEN
            lwFecha2 := wFechaFinal;

          CASE wTempd OF
            1 : lrBono.SETFILTER("Fecha llegada", '<=%1', lwFecha2);
            2 : lrBono.SETRANGE("Fecha llegada" , wFechas[2][1], lwFecha2);
          END;

          lrBono.SETRANGE(Hotel, lrHotel.Hotel);
          lwTot := lrBono.COUNT;
          wVentana.UPDATE(1,Vendor."No.");
          CLEAR(lwCont);
          IF lrBono.FIND('-') THEN BEGIN
            REPEAT
              lrBono.CALCFIELDS("Importe coste","Importe ya validado");
              lwImporteSin := lrBono."Importe coste" - lrBono."Importe ya validado";
              lwTotalImporte += lwImporteSin;

              lwCont +=1;
              wVentana.UPDATE(2,ROUND(lwCont/lwTot * 10000,1));
            UNTIL lrBono.NEXT=0;
          END;
        UNTIL lrHotel.NEXT=0;
        wVentana.CLOSE;
      END;

      EXIT(lwTotalImporte);
    END;

    BEGIN
    END.
  }
  RDLDATA
  {
  }
}

OBJECT Report 7010140 Liquidacion ventas por Guia
{
  OBJECT-PROPERTIES
  {
    Date=17/02/15;
    Time=[ 9:44:43];
    Modified=Yes;
    Version List=AIC2009,GOC;
  }
  PROPERTIES
  {
    CaptionML=[ENU=Settlement sales per guide;
               ESP=Liquidacion ventas por Guia];
    LeftMargin=1000;
    OnInitReport=BEGIN
                   rPar.FINDFIRST;
                 END;

  }
  DATAITEMS
  {
    { PROPERTIES
      {
        DataItemTable=Table7010162;
        DataItemTableView=SORTING(Guia Venta,N§ Ticket,Liquidado GV,N§ liquidacion GV,N§ liquidacion GV reembolso);
        MaxIteration=1;
        DataItemVarName=Filtros;
        OnPreDataItem=BEGIN
                        CLEAR(wTxtCab1);
                        IF wReimpresion THEN
                          wTxtCab1 := Text0002;

                        CLEAR(wTxtCab2);
                        IF wDefinitiva THEN
                          wTxtCab2 := Text0004;

                        SETRANGE(Anulada, FALSE);

                        //+$012 <
                        IF NOT FINDFIRST THEN
                        BEGIN
                          COPYFILTER("N§ liquidacion GV", Filtros."N§ liquidacion GV reembolso");
                          SETRANGE("N§ liquidacion GV");
                        END;
                        //+$012 >

                        CLEAR(rRep);
                        IF FINDFIRST THEN
                          rRep.GET("Guia Venta");
                      END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            SectionWidth=19650;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1100253011;Shape  ;0    ;423  ;19200;423  ;ShapeStyle=HorzLine }
            { 1100253012;Label  ;12900;0    ;6300 ;423  ;HorzAlign=Right;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         CaptionML=[ENU=Sale guide settlement;
                                                                    ESP=Liquidaci¢n Gu¡a Venta] }
            { 1100253013;TextBox;0    ;0    ;5400 ;423  ;FontSize=8;
                                                         FontBold=Yes;
                                                         SourceExpr=COMPANYNAME }
          }
           }
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=19650;
            SectionHeight=2961;
          }
          CONTROLS
          {
            { 1100253042;Label  ;450  ;0    ;2550 ;423  ;ParentControl=1100253046;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes;
                                                         CaptionML=[ENU=Sale guide;
                                                                    ESP=Guia venta] }
            { 1100253044;Label  ;1950 ;1692 ;1200 ;846  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=Excursion date;
                                                                    ESP=Fecha Excursion] }
            { 1100253045;Label  ;3300 ;1692 ;3600 ;846  ;VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=Excursion;
                                                                    ESP=Excursion] }
            { 1100253046;TextBox;3150 ;0    ;5100 ;423  ;SourceExpr=rRep.Codigo + ' - ' + rRep.Nombre }
            { 1100253049;Label  ;7050 ;1692 ;1200 ;846  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=AD / CH;
                                                                    ESP=AD / NI] }
            { 1100253050;Label  ;8400 ;1692 ;1800 ;846  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=Price AD / CH;
                                                                    ESP=Precio AD / NI] }
            { 1100253053;Label  ;11850;1692 ;1350 ;846  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=Payment;
                                                                    ESP=Cobro] }
            { 1100253054;Label  ;16350;1692 ;2850 ;846  ;VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=Discounts;
                                                                    ESP=Descuentos] }
            { 1100253055;Label  ;0    ;1692 ;1800 ;846  ;HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=Ticket No.;
                                                                    ESP=N§ Ticket] }
            { 1100253056;Label  ;14100;1692 ;750  ;846  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=% purc.;
                                                                    ESP=% com.] }
            { 1100253057;TextBox;3150 ;423  ;5100 ;423  ;HorzAlign=Left;
                                                         FontSize=9;
                                                         FontBold=Yes;
                                                         CaptionML=[ENU=Settlement No.;
                                                                    ESP=N§ liquidaci¢n];
                                                         SourceExpr=wNumLiquidacion }
            { 1100253058;Label  ;450  ;423  ;2550 ;423  ;ParentControl=1100253057;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         LeaderDots=Yes;
                                                         CaptionML=[ENU=Settlement No.;
                                                                    ESP=N§ liquidaci¢n] }
            { 1100253059;Label  ;15000;1692 ;1200 ;846  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=Sale date;
                                                                    ESP=Fecha venta] }
            { 1100253060;Shape  ;0    ;2538 ;19200;423  ;ShapeStyle=HorzLine }
            { 1100253032;TextBox;8700 ;0    ;4350 ;423  ;HorzAlign=Center;
                                                         FontSize=10;
                                                         FontBold=Yes;
                                                         SourceExpr=wTxtCab1 }
            { 1100253021;TextBox;13200;0    ;4350 ;423  ;HorzAlign=Center;
                                                         FontSize=10;
                                                         FontBold=Yes;
                                                         SourceExpr=wTxtCab2 }
            { 1100253004;Label  ;10350;1692 ;1350 ;846  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=Amount;
                                                                    ESP=Importe] }
          }
           }
        { PROPERTIES
          {
            SectionType=Footer;
            PrintOnEveryPage=Yes;
            PlaceInBottom=Yes;
            SectionWidth=19650;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1100253014;TextBox;0    ;423  ;3600 ;423  ;SourceExpr=cNom.nom_delegacion(rPar.Delegacion) }
            { 1100253015;Shape  ;0    ;0    ;19200;423  ;ShapeStyle=HorzLine }
            { 1100253016;TextBox;5850 ;423  ;7050 ;423  ;HorzAlign=Center;
                                                         SourceExpr=FORMAT(TODAY,0,4) + ' / ' + FORMAT(TIME,0,0) + ' / ' + USERID }
            { 1100253017;TextBox;14850;423  ;4350 ;423  ;HorzAlign=Right;
                                                         SourceExpr=Text0008 + FORMAT(CurrReport.PAGENO) }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table7010162;
        DataItemTableView=SORTING(Guia Venta,N§ Ticket,Liquidado GV,N§ liquidacion GV,N§ liquidacion GV reembolso);
        DataItemVarName=ResvExc;
        OnPreDataItem=VAR
                        lrRes@1100253000 : Record 7010162;
                      BEGIN
                        ResvExc.COPYFILTERS(Filtros);

                        // wNoTicketAnt := rRep."Ultimo Ticket Liquidado";
                        CLEAR(wNoTicketAnt);

                        // Limpiamos los temporales
                        CLEAR(rTmpNoDecl);
                        rTmpNoDecl.DELETEALL;
                        CLEAR(rTmpAcum);
                        rTmpAcum.DELETEALL;

                        // Llamamos a la funci¢n Facturar para obtener los Totales
                        // en la tabla 50439

                        CLEAR(rLiqGV);
                        lrRes.COPY(Filtros);

                        cLiqGV.VerificarSetupContable(lrRes); //$005

                        cLiqGV.Facturar(lrRes,2); // Modo Consultar

                        rLiqGV.GET(rRep.Codigo);

                        CLEAR(wFechaCamb);

                        ResvExc.SETRANGE(Anulada, FALSE);
                        ResvExc.SETRANGE("Cobros con problemas", FALSE); //$009

                        // Si es una reimpresion mantendremos la reeembolsadas a posteriori
                        IF wReimpresion THEN
                          ResvExc.SETRANGE(Reembolsada)
                        ELSE
                          ResvExc.SETRANGE(Reembolsada, FALSE);

                        //+$001
                        rRsvAux.RESET;
                        rRsvAux.SETCURRENTKEY("N§ Ticket");
                        //+$001


                        //+$014 < La comision se guarda en negativo en la reserva
                        wComisionTO   += 0;
                        wComisionTODL += 0;
                        //+$014 >
                      END;

        OnAfterGetRecord=BEGIN

                           IF "Guia Venta" <> rRep.Codigo THEN
                             ERROR(Text0001);

                           //+$007
                           IF (Adultos = 0) AND (Ni¤os = 0) THEN
                             ERROR(Text0012, "N§ Ticket");

                           //. Si estamos imprimiendo una liquidacion que solo tenga tickets reembolsados
                           //. saltamos el dataitem de ventas normales
                           IF (GETFILTER("N§ liquidacion GV") = '') AND (wReimpresion) THEN
                             CurrReport.SKIP;

                           // Se supone que todas la reservas que estan en la misma liquidaci¢n
                           // tienen que tener la misma fecha de cambio.
                           TESTFIELD("Fecha cambio");
                           IF wFechaCamb = 0D THEN
                             wFechaCamb := "Fecha cambio";

                           IF wFechaCamb <> "Fecha cambio" THEN
                             ERROR(Text0003);

                           // Si hay un salto de numeraci¢n de Ticket
                           IF wNoTicketAnt <> '' THEN BEGIN
                             IF (INCSTR(wNoTicketAnt) <> "N§ Ticket") THEN BEGIN

                               //+$001
                               rRsvAux.SETRANGE("N§ Ticket", INCSTR(wNoTicketAnt));
                               IF NOT rRsvAux.FINDFIRST THEN BEGIN

                                 //+$006
                                 rTalonario.RESET;
                                 rTalonario.SETRANGE ("Guia Venta"       , ResvExc."Guia Venta");
                                 rTalonario.SETFILTER("N§ Ticket inicial", '<=%1', INCSTR(wNoTicketAnt));
                                 rTalonario.SETFILTER("N§ Ticket final"  , '>=%1', INCSTR(wNoTicketAnt));
                                 IF rTalonario.FINDFIRST THEN BEGIN
                                   rTmpNoDecl := ResvExc;
                                   rTmpNoDecl."N§ Ticket"     := INCSTR(wNoTicketAnt);
                                   rTmpNoDecl."N§ Habitacion" := "N§ Ticket";
                                   rTmpNoDecl.INSERT;
                                 END;
                                 //+$006

                               END;
                               //+$001

                             END;
                           END;

                           // Acumulamos en el temporal de Resumen cobros
                           TempCobros(Delegacion, "N§ Reserva", FALSE);

                           wAdultos := Adultos - "Venta - Invitados Adultos";
                           wNi¤os   := Ni¤os   - "Venta - Invitados ni¤os";

                           //+$014 < La comision se guarda en negativo en la reserva
                           wComisionTO   += (-1) * ResvExc."Comision Touroperador";
                           wComisionTODL += (-1) * ResvExc."Tipo cambio" * ResvExc."Comision Touroperador";
                           //+$014 >

                           wNoTicketAnt := "N§ Ticket";
                         END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=19650;
            SectionHeight=1269;
          }
          CONTROLS
          {
            { 1100253018;Label  ;0    ;423  ;3900 ;423  ;VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=[ENU=Sales;
                                                                    ESP=Ventas] }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=19650;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1100253000;TextBox;0    ;0    ;1800 ;423  ;HorzAlign=Left;
                                                         SourceExpr="N§ Ticket" }
            { 1100253001;TextBox;1950 ;0    ;1200 ;423  ;SourceExpr="Fecha Excursion" }
            { 1100253002;TextBox;3300 ;0    ;3600 ;423  ;SourceExpr=Producto + ' - ' + cNom.nom_producto(Producto) }
            { 1100253003;TextBox;7050 ;0    ;1200 ;423  ;HorzAlign=Right;
                                                         SourceExpr=STRSUBSTNO('%1 / %2', wAdultos, wNi¤os) }
            { 1100253005;TextBox;8400 ;0    ;1800 ;423  ;HorzAlign=Right;
                                                         SourceExpr=STRSUBSTNO('%1 / %2', "Precio Adulto", "Precio Ni¤o") }
            { 1100253007;TextBox;11850;0    ;1350 ;423  ;SourceExpr=CobroExcursion }
            { 1100253008;TextBox;14100;0    ;750  ;423  ;DecimalPlaces=0:2;
                                                         SourceExpr="Precio Comision Guia Venta" }
            { 1100253009;TextBox;16350;0    ;2850 ;423  ;SourceExpr=_DescuentosReserva(ResvExc) }
            { 1100253010;TextBox;15000;0    ;1200 ;423  ;SourceExpr="Fecha cambio" }
            { 1100253006;TextBox;10350;0    ;1350 ;423  ;SourceExpr="Ingreso reserva" }
            { 1100217011;TextBox;13350;0    ;600  ;423  ;SourceExpr=Divisa }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=2;
        DataItemTable=Table7010240;
        DataItemTableView=SORTING(Delegacion,Num Reserva,ID Cobro);
        DataItemVarName=Cobros;
        DataItemLink=Delegacion=FIELD(Delegacion),
                     Num Reserva=FIELD(N§ Reserva);
      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            SectionWidth=19650;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1100217001;Label  ;11400;0    ;1500 ;423  ;ParentControl=1100217000;
                                                         HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1100217003;Label  ;15000;0    ;1500 ;423  ;ParentControl=1100217002;
                                                         HorzAlign=Center;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1100217008;Label  ;13050;0    ;1800 ;423  ;ParentControl=1100217006;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=19650;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1100217000;TextBox;11400;0    ;1500 ;423  ;HorzAlign=Left;
                                                         CaptionML=[ENU=Payment Method;
                                                                    ESP=Forma Pago];
                                                         SourceExpr="Forma de Pago" }
            { 1100217002;TextBox;15000;0    ;1500 ;423  ;HorzAlign=Center;
                                                         SourceExpr="Cod. Divisa" }
            { 1100217006;TextBox;13050;0    ;1800 ;423  ;CaptionML=ESP=Recibido;
                                                         SourceExpr="Importe Recibido" }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table7010162;
        DataItemTableView=SORTING(Guia Venta,N§ Ticket,Liquidado GV,N§ liquidacion GV,N§ liquidacion GV reembolso);
        DataItemVarName=RsvAnulada;
        OnPreDataItem=BEGIN
                        RsvAnulada.COPYFILTERS(Filtros);

                        SETRANGE(Anulada    , TRUE);
                        SETRANGE(Reembolsada, FALSE);
                      END;

        OnAfterGetRecord=BEGIN
                           //. Las reservas anuladas no deben figurar como reservas no declaradas

                           rTmpNoDecl.SETRANGE("N§ Ticket", "N§ Ticket");
                           IF rTmpNoDecl.FINDFIRST THEN
                             rTmpNoDecl.DELETE;

                           wAdultos := Adultos - "Venta - Invitados Adultos";
                           wNi¤os   := Ni¤os   - "Venta - Invitados ni¤os";
                         END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            SectionWidth=19650;
            SectionHeight=1269;
          }
          CONTROLS
          {
            { 1100253022;Label  ;0    ;423  ;3900 ;423  ;VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Anuladas }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=19650;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1100253023;TextBox;0    ;0    ;1800 ;423  ;HorzAlign=Left;
                                                         SourceExpr="N§ Ticket" }
            { 1100253024;TextBox;1950 ;0    ;1200 ;423  ;SourceExpr="Fecha Excursion" }
            { 1100253025;TextBox;3300 ;0    ;3600 ;423  ;SourceExpr=Producto + ' - ' + cNom.nom_producto(Producto) }
            { 1100253026;TextBox;7050 ;0    ;1200 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Adultos;
                                                         SourceExpr=STRSUBSTNO('%1 / %2', wAdultos, wNi¤os) }
            { 1100253029;TextBox;9150 ;0    ;5550 ;423  ;SourceExpr="Comentarios Reembolso" }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table7010266;
        DataItemTableView=SORTING(Guia Venta,Liquidado GV,N§ liquidacion GV);
        OnPreDataItem=BEGIN
                        "Reserva ex - Reembolso".COPYFILTERS(Filtros);
                      END;

        OnAfterGetRecord=BEGIN
                           //. Las reservas reembolsadas no deben figurar como reservas no declaradas
                           rRsvAux.RESET;
                           rRsvAux.GET("Reserva ex - Reembolso".Delegacion,"Reserva ex - Reembolso"."Num Reserva");

                           rTmpNoDecl.SETRANGE("N§ Ticket", rRsvAux."N§ Ticket");
                           IF rTmpNoDecl.FINDFIRST THEN
                             rTmpNoDecl.DELETE;

                           // Acumulamos en el temporal de Resumen cobros
                           TempCobros(Delegacion, "Num Reserva", TRUE);

                           wAdultos := "Adultos Reembolsados";
                           wNi¤os   := "Ni¤os Reembolsados";

                           //+$014 < La comision se guarda en negativo en la reserva
                           wComisionTO   += ResvExc."Comision Touroperador";
                           wComisionTODL += ResvExc."Tipo cambio" * ResvExc."Comision Touroperador";
                           //+$014 >
                         END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            SectionWidth=19650;
            SectionHeight=1269;
          }
          CONTROLS
          {
            { 1100253030;Label  ;0    ;423  ;3900 ;423  ;VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Reembolsos }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=19650;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1000000000;TextBox;14850;0    ;4350 ;423  ;SourceExpr=Comentario }
            { 1000000001;TextBox;13800;0    ;900  ;423  ;SourceExpr=wTxtReemb }
            { 1000000002;TextBox;10350;0    ;1350 ;423  ;SourceExpr="Reserva ex - Reembolso"."Importe Reembolsado" }
            { 1000000003;TextBox;8400 ;0    ;1800 ;423  ;HorzAlign=Right;
                                                         SourceExpr=STRSUBSTNO('%1 / %2', rRsvAux."Precio Adulto", rRsvAux."Precio Ni¤o") }
            { 1000000004;TextBox;3300 ;0    ;3600 ;423  ;SourceExpr=rRsvAux.Producto + ' - ' + cNom.nom_producto(rRsvAux.Producto) }
            { 1000000005;TextBox;7050 ;0    ;1200 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Adultos;
                                                         SourceExpr=STRSUBSTNO('%1 / %2', wAdultos, wNi¤os) }
            { 1000000006;TextBox;0    ;0    ;1800 ;423  ;HorzAlign=Left;
                                                         SourceExpr=rRsvAux."N§ Ticket" }
            { 1000000007;TextBox;1950 ;0    ;1200 ;423  ;SourceExpr=rRsvAux."Fecha Excursion" }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=2;
        DataItemTable=Table7010267;
        DataItemTableView=SORTING(Delegacion,Num Reserva,Id Reembolso,ID Cobro);
        DataItemLink=Delegacion=FIELD(Delegacion),
                     Num Reserva=FIELD(Num Reserva),
                     Id Reembolso=FIELD(ID Reembolso);
      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            SectionWidth=19650;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1100217004;Label  ;11550;0    ;1500 ;423  ;ParentControl=1100217012;
                                                         HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1100217005;Label  ;13200;0    ;1800 ;423  ;ParentControl=1100217010;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1100217007;Label  ;15150;0    ;1500 ;423  ;ParentControl=1100217009;
                                                         HorzAlign=Center;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=19650;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1100217012;TextBox;11550;0    ;1500 ;423  ;HorzAlign=Left;
                                                         CaptionML=[ENU=Payment Method;
                                                                    ESP=Forma Pago];
                                                         SourceExpr="Forma de Pago" }
            { 1100217010;TextBox;13200;0    ;1800 ;423  ;CaptionML=ESP=Recibido;
                                                         SourceExpr=Importe }
            { 1100217009;TextBox;15150;0    ;1500 ;423  ;HorzAlign=Center;
                                                         SourceExpr="Cod. Divisa" }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table2000000026;
        DataItemTableView=SORTING(Number)
                          WHERE(Number=FILTER(>=1));
        DataItemVarName=NoDeclara;
        OnPreDataItem=BEGIN
                        CLEAR(rTmpNoDecl);
                        rTmpNoDecl.SETCURRENTKEY("Guia Venta", "N§ Ticket", "Liquidado GV", "N§ liquidacion GV", "N§ liquidacion GV reembolso");
                        wSig := rTmpNoDecl.FINDSET;
                      END;

        OnAfterGetRecord=BEGIN
                           IF NoDeclara.Number > 1 THEN // Si no es el primero
                             wSig := rTmpNoDecl.NEXT<>0;

                           IF NOT wSig THEN
                             CurrReport.BREAK;

                           wAdultos := rTmpNoDecl.Adultos - rTmpNoDecl."Venta - Invitados Adultos";
                           wNi¤os   := rTmpNoDecl.Ni¤os   - rTmpNoDecl."Venta - Invitados ni¤os";


                           CLEAR(wTxtNoDecla);
                           IF INCSTR(rTmpNoDecl."N§ Ticket") = rTmpNoDecl."N§ Habitacion" THEN
                             wTxtNoDecla := rTmpNoDecl."N§ Ticket"
                           ELSE
                             wTxtNoDecla := STRSUBSTNO('%1..%2', rTmpNoDecl."N§ Ticket", rTmpNoDecl."N§ Habitacion");
                         END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=19650;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1100253019;Label  ;0    ;423  ;3900 ;423  ;VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Tickets no declarados }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=19650;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1100253020;TextBox;0    ;0    ;4050 ;423  ;HorzAlign=Left;
                                                         SourceExpr=wTxtNoDecla }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table2000000026;
        DataItemTableView=SORTING(Number)
                          WHERE(Number=FILTER(>=1));
        DataItemVarName=ResCobro;
        OnPreDataItem=BEGIN
                        CLEAR(rTmpAcum);
                        wSig := rTmpAcum.FINDSET;
                      END;

        OnAfterGetRecord=BEGIN
                           IF ResCobro.Number > 1 THEN // Si no es el primero
                             wSig := rTmpAcum.NEXT<>0;

                           IF NOT wSig THEN
                             CurrReport.BREAK;
                         END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=19650;
            SectionHeight=1692;
          }
          CONTROLS
          {
            { 1100253031;Label  ;0    ;423  ;3900 ;423  ;VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Resumen Cobro }
            { 1100253035;Label  ;7050 ;423  ;1650 ;846  ;ParentControl=1100253034;
                                                         HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Forma de Pago }
            { 1100253037;Label  ;9000 ;423  ;1500 ;846  ;ParentControl=1100253036;
                                                         HorzAlign=Left;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Divisa }
            { 1100253039;Label  ;10800;423  ;1500 ;846  ;ParentControl=1100253038;
                                                         HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Importe }
            { 1100253040;Shape  ;7050 ;1269 ;5250 ;423  ;ShapeStyle=HorzLine }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=19650;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 1100253034;TextBox;7050 ;0    ;1650 ;423  ;HorzAlign=Left;
                                                         SourceExpr=rTmpAcum."Forma de Pago" }
            { 1100253036;TextBox;9000 ;0    ;1500 ;423  ;HorzAlign=Left;
                                                         SourceExpr=rTmpAcum."Cod. Divisa" }
            { 1100253038;TextBox;10800;0    ;1500 ;423  ;HorzAlign=Right;
                                                         SourceExpr=rTmpAcum.Importe }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table2000000026;
        DataItemTableView=SORTING(Number);
        MaxIteration=1;
        DataItemVarName=Totales;
        OnAfterGetRecord=BEGIN
                           // Totales en Divisa Local
                           // 1 - Total de ventas a fecha de cambio reserva
                           // 2 - Importe Total Comisi¢n GV
                           // 3 - Impuestos Aplicados a la Comisi¢n GV
                           // 4 - Retenciones ITPF sobre comsi¢n GV
                           // 5 - Total Ventas descontando importe total comisi¢n

                           // Giramos los signos
                           wFechaCamb := rLiqGV."Fecha cambio divisa";
                           wVentaExcursion := - rLiqGV."Ingreso Excursion";
                           wImportes[1] := - TipoCambio(wFechaCamb, rLiqGV.Divisa, '', rLiqGV."Ingreso Excursion");
                           wImportes[2] := - TipoCambio(wFechaCamb, rLiqGV.Divisa, '', rLiqGV."Comision GV");
                           wImportes[3] := - TipoCambio(wFechaCamb, rLiqGV.Divisa, '', rLiqGV."IVA Guia Venta");
                           wImportes[4] := - TipoCambio(wFechaCamb, rLiqGV.Divisa, '', rLiqGV."IRPF Guia Venta");
                           wImportes[5] := wImportes[1] - wImportes[2];
                           wComisionGV  := - rLiqGV."Comision GV"; //+$015
                         END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=19650;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 1100253033;Label  ;0    ;423  ;3900 ;423  ;VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Totales }
          }
           }
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=19650;
            SectionHeight=2538;
          }
          CONTROLS
          {
            { 1100253061;TextBox;7800 ;0    ;1800 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Total Ventas;
                                                         SourceExpr=wImportes[1] }
            { 1100253062;Label  ;3900 ;0    ;3750 ;423  ;ParentControl=1100253061;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1100253063;TextBox;7800 ;846  ;1800 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Comision Guia Venta;
                                                         SourceExpr=wImportes[2] }
            { 1100253064;Label  ;3900 ;846  ;3750 ;423  ;ParentControl=1100253063;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1100253067;TextBox;7800 ;1692 ;1800 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Retenci¢n IRPF;
                                                         SourceExpr=wImportes[4] }
            { 1100253068;Label  ;3900 ;1692 ;3750 ;423  ;ParentControl=1100253067;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1100253069;TextBox;7800 ;2115 ;1800 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Total Sin Comisi¢n;
                                                         SourceExpr=wImportes[5] }
            { 1100253070;Label  ;3900 ;2115 ;3750 ;423  ;ParentControl=1100253069;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1100253071;TextBox;7800 ;1269 ;1800 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Impuestos;
                                                         SourceExpr=wImportes[3] }
            { 1100253072;Label  ;3900 ;1269 ;3750 ;423  ;ParentControl=1100253071;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1100217013;TextBox;9750 ;0    ;1800 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Total Ventas;
                                                         SourceExpr='(' + FORMAT(wVentaExcursion) + ')' }
            { 1000000008;TextBox;9750 ;423  ;1800 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Total Ventas;
                                                         SourceExpr='(' + FORMAT(wComisionTO) + ')' }
            { 1000000009;TextBox;7800 ;423  ;1800 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Comision Touroperador;
                                                         SourceExpr=wComisionTODL }
            { 1000000010;Label  ;3900 ;423  ;3750 ;423  ;ParentControl=1000000009;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes }
            { 1000000011;TextBox;9750 ;846  ;1800 ;423  ;HorzAlign=Right;
                                                         CaptionML=ESP=Total Ventas;
                                                         SourceExpr='(' + FORMAT(wComisionGV) + ')' }
          }
           }
      }
       }
  }
  REQUESTFORM
  {
    PROPERTIES
    {
      Width=9020;
      Height=3410;
      CaptionML=[ENU=Settlement sales per guide;
                 ESP=Liquidacion ventas por Guia];
    }
    CONTROLS
    {
    }
  }
  REQUESTPAGE
  {
    PROPERTIES
    {
    }
    CONTROLS
    {
    }
  }
  CODE
  {
    VAR
      rTmpNoDecl@1100253002 : TEMPORARY Record 7010162;
      rRsvAux@1100253027 : Record 7010162;
      rTmpAcum@1100253003 : TEMPORARY Record 7010240;
      rPar@1100253012 : Record 7009700;
      rRep@1100253004 : Record 7010241;
      rLiqGV@1100253015 : Record 7010179;
      rTipCam@1100253016 : Record 330;
      rTalonario@1100253029 : Record 7010146;
      cNom@1100253007 : Codeunit 7009702;
      cLiqGV@1100253011 : Codeunit 7010144;
      wNoTicketAnt@1100253001 : Code[10];
      wReimpresion@1100253000 : Boolean;
      Text0001@1100253005 : TextConst 'ENU=Must filter by only one excursions sale representative;ESP=Debe de filtrarse por un solo Representante de Excursiones';
      wDefinitiva@1100253021 : Boolean;
      wSig@1100253006 : Boolean;
      Text0002@1100253014 : TextConst 'ENU=(REPRINT);ESP=(REIMPRESION)';
      Text0003@1100253020 : TextConst 'ENU=All bookings must have the same date of change;ESP=Todas las reservas deben de tener la misma fecha de cambio.';
      Text0004@1100253023 : TextConst 'ENU=Final;ESP=Definitiva';
      Text0008@1100253008 : TextConst 'ENU=page;ESP=P gina';
      wAdultos@1100253009 : Integer;
      wNi¤os@1100253010 : Integer;
      wNumLiquidacion@1100253028 : Integer;
      wImportes@1100253018 : ARRAY [5] OF Decimal;
      wVentaExcursion@1100217001 : Decimal;
      wTxtCab1@1100253013 : Text[250];
      wTxtCab2@1100253022 : Text[250];
      wTxtNoDecla@1100253017 : Text[250];
      wTxtReemb@1100253026 : Text[100];
      wFechaCamb@1100253019 : Date;
      Text0010@1100253024 : TextConst 'ENU=Partial;ESP=Parcial';
      Text0011@1100253025 : TextConst 'ENU=Total;ESP=Total';
      Text0012@1100217000 : TextConst 'ENU=The ticket %1 has an error. You must indicate adults and/or childs.;ESP=El ticket %1 tiene un error. Debe indicar adultos y/o ni¤os.';
      wComisionTO@1000000000 : Decimal;
      wComisionTODL@1000000001 : Decimal;
      wComisionGV@1000000002 : Decimal;

    PROCEDURE EsReimpresion@1100253000(pwReimp@1100253000 : Boolean;pwNumLiquidacion@1100253001 : Integer);
    BEGIN
      // EsReimpresion

      wReimpresion := pwReimp;
      wNumLiquidacion := pwNumLiquidacion;
    END;

    PROCEDURE EsDefinitiva@1100253001(pwDefinitiva@1100253000 : Boolean);
    BEGIN
      // EsDefinitiva

      wDefinitiva := pwDefinitiva;
    END;

    PROCEDURE TipoCambio@1100253010(pwFecha@1100253000 : Date;pwDivOrigen@1100253001 : Code[10];pwDivDest@1100253002 : Code[10];pwImporte@1100253003 : Decimal) : Decimal;
    BEGIN
      // TipoCambio

      EXIT(rTipCam.ExchangeAmtFCYToFCY(pwFecha,pwDivOrigen,pwDivDest,pwImporte));
    END;

    PROCEDURE TempCobros@1100253005(pwDelegacion@1100253001 : Code[10];pwNoRes@1100253002 : Integer;pwReembolso@1100253003 : Boolean);
    VAR
      lrCobr@1100253000 : Record 7010240;
      lwImp@1100253004 : Decimal;
    BEGIN
      // TempCobros
      // Si buscamos los Reembolsos descontamos el importe Reembolsado

      CLEAR(lwImp);
      CLEAR(lrCobr);
      lrCobr.SETRANGE(Delegacion   , pwDelegacion);
      lrCobr.SETRANGE("Num Reserva", pwNoRes);
      IF lrCobr.FINDSET THEN BEGIN
        REPEAT
          lrCobr.TESTFIELD("Forma de Pago");
          CLEAR(rTmpAcum);
          rTmpAcum.SETRANGE("Forma de Pago", lrCobr."Forma de Pago");
          rTmpAcum.SETRANGE("Cod. Divisa"  , lrCobr."Cod. Divisa");
          IF rTmpAcum.FINDFIRST  THEN BEGIN
            IF pwReembolso THEN
              rTmpAcum.Importe -= lrCobr."Importe Recibido"
            ELSE
              rTmpAcum.Importe += lrCobr."Importe Recibido"; //+003
               //-003rTmpAcum.Importe += lrCobr.Importe;
            rTmpAcum.MODIFY;
          END
          ELSE BEGIN
            rTmpAcum := lrCobr;
            IF pwReembolso THEN
              rTmpAcum.Importe := -lrCobr."Importe Recibido"
            ELSE
              rTmpAcum.Importe := lrCobr."Importe Recibido"; //+003
            rTmpAcum.INSERT;
          END;

        UNTIL lrCobr.NEXT=0;
      END;

      wTxtReemb := Text0011
    END;

    PROCEDURE CobroExcursion@1100253002() : Decimal;
    VAR
      lrCobro@1100253000 : Record 7010240;
      lwImpt@1100217000 : Decimal;
    BEGIN
      // CobroExcursion

      // $008 Ahora devolvemos el importe recibido en la divisa de la reserva el total ya que puede haber varias lineas de cobro
      CLEAR(lwImpt);
      lrCobro.RESET;
      lrCobro.SETRANGE(Delegacion   , ResvExc.Delegacion);
      lrCobro.SETRANGE("Num Reserva", ResvExc."N§ Reserva");
      IF lrCobro.FINDSET THEN BEGIN
        REPEAT
          lwImpt += lrCobro.CambioDivisa(lrCobro."Cod. Divisa", ResvExc.Divisa, lrCobro."Importe Recibido");
        UNTIL lrCobro.NEXT=0;
      END;
      EXIT(lwImpt);
    END;

    PROCEDURE DivisaCobro@1100253003() : Code[10];
    VAR
      lrCobro@1100253000 : Record 7010240;
    BEGIN
      // DivisaCobro

      // $008 FUNCION OBSOLETA - YA No se utiliza
      lrCobro.RESET;
      lrCobro.SETRANGE(Delegacion   , ResvExc.Delegacion);
      lrCobro.SETRANGE("Num Reserva", ResvExc."N§ Reserva");
      IF lrCobro.FINDSET THEN
        EXIT(lrCobro."Cod. Divisa");
    END;

    LOCAL PROCEDURE _DescuentosReserva@1100217000(prRsv@1100217000 : Record 7010162) lwSuplementos : Text[250];
    VAR
      lrSuplRsv@1100217001 : Record 7010165;
    BEGIN
      // DescuentosReserva

      lwSuplementos := '';

      lrSuplRsv.RESET;
      lrSuplRsv.SETRANGE (Delegacion  , prRsv.Delegacion);
      lrSuplRsv.SETRANGE ("N§ Reserva", prRsv."N§ Reserva");
      lrSuplRsv.SETFILTER(Importe     , '<%1', 0);
      IF lrSuplRsv.FINDSET THEN
      BEGIN
        REPEAT
          IF lwSuplementos = '' THEN
            lwSuplementos := lrSuplRsv."Codigo Suplemento"
          ELSE
            lwSuplementos := lwSuplementos + ',' + lrSuplRsv."Codigo Suplemento";
        UNTIL lrSuplRsv.NEXT = 0;
      END;

      EXIT(lwSuplementos);
    END;

    BEGIN
    {
      $001 AJS 04052011 Cuando hay que marcar un ticket como faltante comprobamos que no este introducido en el sistema
                        podria darse el caso de que tenga una fecha de cambio diferente

      $002 AJS 09052011 Modifico la funcion EsReimpresion para que se le pase el numero de liquidacion por parametros
                        y as¡ poderlo mostrar

      $003 AJF 30062011 (GOC-OC-11019) Se usa el importe recibido en lugar del importe del c lculo al acumular los importes.

      $004 AJS 28072011 Incluyo una columna para mostrar el cobro

      $005 AJS 05092011 Incluyo una llamada a la funcion que comprueba que el setup contable esta completo

      $006 AJS 13092011 Al comprobar ticket no liquidado hago una comprobacion de que sea un numero de ticket que este
                        dentro de algun talonario del guia de venta

      $007 AJS 16082012 Hay que hacer una comprobacion para no dejar liquidar reservas que no tienen adultos o ni¤os

      $008 JPT 06/09/12 CNT 12002 Permitir mas de un cobro por reserva de excursi¢n. Se a¤adio detalle de cobros x reserva

      $009 AJS 24092012 No incluir las reservas con problemas de cobros

      $010 AJS 26102012 Incluyo el detalle de cobro en los tickets reembolsados para mayor claridad

      $011 AJS 05042013 Cambio la columna Zona fisica por Descuentos

      $012 AJS 08012014 Corregir un error para liquidaciones que solo tienen tickets reembolsados

      $013 ARM Reembolsos CNT-OC-14047

      $014 AJS 09022015 Mostrar el total de comision touroperador bajo el total de ventas

      $015 AJS 17022015 Mostrar tambien la comision del guia venta en dolares
    }
    END.
  }
  RDLDATA
  {
  }
}

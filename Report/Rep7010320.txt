OBJECT Report 7010320 Viajes x Pax Transportados
{
  OBJECT-PROPERTIES
  {
    Date=16/10/09;
    Time=12:34:25;
    Version List=TRANSFER;
  }
  PROPERTIES
  {
    CaptionML=ESP=Viajes x Pax Transportados;
    TopMargin=1000;
    BottomMargin=0;
    VertGrid=420;
  }
  DATAITEMS
  {
    { PROPERTIES
      {
        DataItemTable=Table7010346;
        DataItemTableView=SORTING(Garaje,Plazas,Numero);
        NewPagePerGroup=No;
        DataItemVarName=Vehiculo;
        OnPreDataItem=VAR
                        rTemp@1100244000 : Record 7010351;
                        rPar@1100244001 : Record 7010311;
                        ERROR1@1100244002 : TextConst 'ESP=Hay que introducir las fechas';
                        ERROR2@1100244003 : TextConst 'ESP=La fecha de inicio no puede ser mayor que la final';
                        cFunVeh@1100244004 : Codeunit 7010317;
                        lrGAr@1100253000 : Record 7010310;
                      BEGIN
                        //Revisamos que las fechas introducidas sean correctas.
                        IF (vFecha1=0D) OR (vFecha2=0D) THEN
                          ERROR(ERROR1);
                        IF (vFecha1 > vFecha2) THEN
                          ERROR(ERROR2);

                        IF vGarajeResult = '' THEN
                          vFltGarajeResult := Text000
                        ELSE
                          vFltGarajeResult := vGarajeResult;

                        //Borramos el temporal.
                        rTemp.RESET;
                        rTemp.SETCURRENTKEY(Usuario);
                        rTemp.SETRANGE(Usuario,USERID);
                        rTemp.DELETEALL;

                        vTotal:=Text001;
                        vGrupo:=Text002;

                        IF vAgrupacionporGrupo AND (vTipoAgrupacion = vTipoAgrupacion::"Agrupaci¢n Plazas") THEN
                          cFunVeh.CrearAgrupacionRangos(aRangos,aRGaraje,vNumRangos);

                        rPar.FINDFIRST;
                        Vehiculo.RESET;
                        IF (vGaraje<>'') AND (vGaraje <> rPar."Todos los garajes") THEN
                          Vehiculo.SETRANGE(Garaje,vGaraje);

                        //Y si estamos utilizando la opci¢n vehiculos propios.
                        IF vPropiedad<>vPropiedad::Todos THEN BEGIN
                          IF vPropiedad = vPropiedad::"S¢lo Propios" THEN
                            Vehiculo.SETRANGE("Vehiculo propio",TRUE)
                          ELSE
                            Vehiculo.SETRANGE("Vehiculo propio",FALSE)
                        END;

                        IF NOT vVerBloqueados THEN
                          Vehiculo.SETRANGE(Bloqueado,FALSE);

                        IF NOT vAgrupacionporGrupo THEN
                          vMostrarAgrupacion := Text003
                        ELSE
                          vMostrarAgrupacion := FORMAT(vTipoAgrupacion);
                      END;

        OnAfterGetRecord=VAR
                           rParte@1100244000 : Record 7010360;
                           rSel@1100244001 : Record 7010352;
                           PrimerParte@1100244002 : Boolean;
                         BEGIN
                           //Miramos si el vehiculo encontrado est  en la tabla de Selecci¢n
                           //(SI HEMOS ESPECIFICADO LA OPCION DE SELECCION);
                           IF vVehiculo=vVehiculo::"Seg£n Selecci¢n" THEN BEGIN
                             rSel.RESET;
                             IF NOT (rSel.GET(USERID,Matricula) AND rSel.Seleccion) THEN
                               CurrReport.SKIP;
                           END;


                           //Recorreremos los partes del vehiculo, para el ambito de fechas marcado.
                           PrimerParte := TRUE;

                           rParte.RESET;
                           rParte.SETCURRENTKEY(Confirmado,Vehiculo,"Fecha facturacion","Tipo Servicio","Codigo Servicio",Garaje);
                           rParte.SETRANGE(Confirmado,TRUE);
                           rParte.SETRANGE(Vehiculo,Vehiculo.Matricula);
                           rParte.SETRANGE("Fecha facturacion",vFecha1,vFecha2);
                           IF vGarajeResult <> '' THEN
                             rParte.SETRANGE(Garaje,vGarajeResult);

                           IF rParte.FINDSET THEN REPEAT

                             //Aunque no lo mostremos, lo calculamos siempre por el tema del c lculo del n£mero de
                             //vehiculos por garaje y de plazas por garaje.
                             //Acumulamos para el vehiculo.
                             GrabarDatos(rParte,Vehiculo.Garaje,Vehiculo.Numero,Vehiculo.Plazas,
                                         PrimerParte,Vehiculo."Tipo vehiculo");

                             IF vAgrupacionporGrupo THEN BEGIN
                               //Acumulamos para el grupo.
                               GrabarDatos(rParte,Vehiculo.Garaje,vGrupo,Vehiculo.Plazas,FALSE,Vehiculo."Tipo vehiculo");
                               //JPT 02702/06 Se lanza una agrupaci¢n de garajes
                               GrabarDatos(rParte,TextGARAJETOTAL,vGrupo,Vehiculo.Plazas,FALSE,Vehiculo."Tipo vehiculo");
                             END;

                             //Y Para el total. Lo debemos calcular siempre.
                             //Una cosa es que no se muestre. Pero las columnas de totales de los listados de
                             //cualquier agrupacion deben calcularse con respecto a algo.
                             GrabarDatos(rParte,Vehiculo.Garaje,vTotal,Vehiculo.Plazas,FALSE,Vehiculo."Tipo vehiculo");
                             //JPT 02702/06 Se lanza una agrupaci¢n de garajes
                             GrabarDatos(rParte,TextGARAJETOTAL,vTotal,Vehiculo.Plazas,FALSE,Vehiculo."Tipo vehiculo");

                             IF PrimerParte = TRUE THEN
                               PrimerParte:=FALSE;

                           UNTIL rParte.NEXT=0;
                         END;

        OnPostDataItem=VAR
                         rTemp@1100244000 : Record 7010351;
                         lwVariosGarajes@1100253000 : Boolean;
                         lwGarajeAnt@1100253001 : Code[10];
                       BEGIN
                         //Calculamos todos los valores.
                         rTemp.RESET;
                         rTemp.SETCURRENTKEY(Usuario,Garaje,Numero,"Pax Transportados");
                         rTemp.SETRANGE(Usuario,USERID);
                         IF rTemp.FINDSET(TRUE) THEN BEGIN
                           lwGarajeAnt    := rTemp.Garaje;
                           lwVariosGarajes:= FALSE;
                           REPEAT
                             rTemp.SETRANGE("Rango Pax",0,rTemp."Pax Transportados");
                             rTemp.CALCFIELDS("Total Viajes Vehiculo","Total Viajes Rango Vehiculo","Total Viajes Garaje");

                             rTemp."%SVeh"     := (rTemp."N§ Viajes" * 100) / rTemp."Total Viajes Vehiculo";
                             rTemp."%AcumSVeh" := (rTemp."Total Viajes Rango Vehiculo" * 100) / rTemp."Total Viajes Vehiculo";
                             rTemp."%STotal"   := (rTemp."N§ Viajes" * 100) / rTemp."Total Viajes Garaje";
                             rTemp."%AcumSTotal":= (rTemp."Total Viajes Rango Vehiculo" * 100) / rTemp."Total Viajes Garaje";
                             rTemp.MODIFY;

                             IF (lwGarajeAnt <> rTemp.Garaje) AND (rTemp.Garaje <> TextGARAJETOTAL) THEN
                               lwVariosGarajes := TRUE;
                           UNTIL rTemp.NEXT=0;
                         END;

                         // JPT 02/02/06 Si resulta que solo se imprime un solo garaje no tiene ning£n objeto el hacer un total por
                         // garaje y un total general, por lo que se borrar¡a todos los registros de este £ltimo
                         IF NOT lwVariosGarajes THEN BEGIN
                           rTemp.SETRANGE(Numero , vTotal);
                           rTemp.SETRANGE(Garaje , TextGARAJETOTAL);
                           IF rTemp.FINDFIRST THEN
                             rTemp.DELETEALL;
                         END;
                       END;

      }
      SECTIONS
      {
      }
       }
    { PROPERTIES
      {
        DataItemTable=Table2000000026;
        DataItemTableView=SORTING(Number)
                          ORDER(Ascending);
        NewPagePerGroup=Yes;
        MaxIteration=1;
        DataItemVarName=Cabecera;
        OnPreDataItem=VAR
                        rPar@1100244000 : Record 7010311;
                      BEGIN
                      END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=18150;
            SectionHeight=3360;
            OnPreSection=BEGIN
                           vPrimero := TRUE;
                         END;

          }
          CONTROLS
          {
            { 37  ;Label        ;12150;0    ;6000 ;423  ;HorzAlign=Right;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         CaptionML=ESP=Viajes x Pax Transportados }
            { 38  ;TextBox      ;0    ;0    ;7500 ;423  ;SourceExpr=COMPANYNAME }
            { 1   ;TextBox      ;5250 ;1680 ;2850 ;420  ;SourceExpr=vFltGarajeResult }
            { 2   ;Label        ;0    ;1680 ;5100 ;420  ;VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Garaje a considerar en resultados }
            { 4   ;TextBox      ;12450;1680 ;2250 ;420  ;SourceExpr=FORMAT(vFecha1)+'..'+FORMAT(vFecha2) }
            { 5   ;Label        ;8400 ;1680 ;3900 ;420  ;FontSize=8;
                                                         FontBold=Yes;
                                                         CaptionML=ESP=Filtro Fechas }
            { 6   ;Label        ;0    ;2100 ;5100 ;440  ;FontSize=8;
                                                         FontBold=Yes;
                                                         CaptionML=ESP=Selecci¢n Vehiculos }
            { 20  ;TextBox      ;5250 ;2100 ;2850 ;420  ;SourceExpr=vVehiculo }
            { 48  ;Label        ;8400 ;2100 ;3900 ;440  ;FontSize=8;
                                                         FontBold=Yes;
                                                         CaptionML=ESP=Tipo de Agrupacion }
            { 49  ;TextBox      ;12450;2100 ;2250 ;420  ;SourceExpr=vMostrarAgrupacion }
            { 8   ;Label        ;0    ;1260 ;5100 ;420  ;VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Filtro Garaje }
            { 24  ;TextBox      ;5250 ;1260 ;2850 ;420  ;SourceExpr=vGaraje }
            { 50  ;Label        ;8400 ;1260 ;3900 ;420  ;FontSize=8;
                                                         FontBold=Yes;
                                                         CaptionML=ESP=Filtro Propiedad Vehiculo }
            { 51  ;TextBox      ;12450;1260 ;2250 ;420  ;SourceExpr=vPropiedad }
            { 47  ;TextBox      ;5250 ;2520 ;1350 ;420  ;SourceExpr=vVerBloqueados }
            { 52  ;Label        ;0    ;2520 ;5100 ;440  ;FontSize=8;
                                                         FontBold=Yes;
                                                         CaptionML=ESP=Ver Bloqueados }
            { 56  ;Shape        ;0    ;420  ;18150;420  ;ShapeStyle=HorzLine }
          }
           }
        { PROPERTIES
          {
            SectionType=Header;
            PrintOnEveryPage=Yes;
            SectionWidth=18150;
            SectionHeight=1260;
          }
          CONTROLS
          {
            { 9   ;Label        ;2400 ;0    ;1500 ;840  ;HorzAlign=Center;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=N§ Vehiculo }
            { 12  ;Label        ;4050 ;0    ;2700 ;840  ;HorzAlign=Center;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Plazas }
            { 32  ;Label        ;7650 ;0    ;2250 ;840  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Pax Transportados }
            { 33  ;Label        ;10050;0    ;1350 ;840  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Viajes }
            { 34  ;Label        ;11550;0    ;1500 ;840  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=% S. Veh }
            { 35  ;Label        ;13200;0    ;1500 ;840  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=% Acum. S. Veh }
            { 36  ;Label        ;16500;0    ;1650 ;840  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=% Acum. S. Total }
            { 30  ;Label        ;14850;0    ;1500 ;840  ;HorzAlign=Right;
                                                         VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=% S. Total }
            { 14  ;Label        ;450  ;0    ;1800 ;840  ;VertAlign=Bottom;
                                                         FontSize=8;
                                                         FontBold=Yes;
                                                         MultiLine=Yes;
                                                         CaptionML=ESP=Garaje }
            { 53  ;Shape        ;0    ;840  ;18150;420  ;ShapeStyle=HorzLine }
          }
           }
        { PROPERTIES
          {
            SectionType=Footer;
            PrintOnEveryPage=Yes;
            PlaceInBottom=Yes;
            SectionWidth=18150;
            SectionHeight=846;
          }
          CONTROLS
          {
            { 41  ;TextBox      ;5700 ;420  ;3150 ;423  ;HorzAlign=Right;
                                                         SourceExpr=FORMAT(TODAY,0,4) }
            { 46  ;TextBox      ;9150 ;420  ;2250 ;423  ;HorzAlign=Right;
                                                         SourceExpr=USERID }
            { 45  ;TextBox      ;17700;420  ;450  ;423  ;CaptionML=ESP=P gina;
                                                         SourceExpr=CurrReport.PAGENO }
            { 44  ;Label        ;16950;420  ;750  ;423  ;ParentControl=45 }
            { 54  ;Shape        ;0    ;0    ;18150;420  ;ShapeStyle=HorzLine }
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table7010351;
        DataItemTableView=SORTING(Usuario,Garaje,Numero,Pax Transportados)
                          ORDER(Ascending);
        NewPagePerGroup=No;
        DataItemVarName=Temporal Vehiculos;
        OnPreDataItem=VAR
                        rTemp@1100244000 : Record 7010351;
                      BEGIN
                        RESET;
                        SETRANGE(Usuario,USERID);
                        SETFILTER(Numero,'<> %1',vTotal);
                        SETRANGE("Id. Agrupacion",'');

                        //C lculo del primer garaje.
                        IF FINDFIRST THEN
                          vOldGaraje := Garaje;

                        vPrimero  := TRUE;
                      END;

        OnAfterGetRecord=BEGIN

                           IF NOT vDetalle THEN
                             CurrReport.SKIP;

                           //Si cambiamos de garaje, provocamos el salto de p gina.
                           IF vOldGaraje<>Garaje THEN BEGIN
                             vOldGaraje:=Garaje;
                             CurrReport.NEWPAGE;
                           END;

                           //Controlamos que sea el primero del grupo por el tema del titulo.
                           IF vPrimero THEN BEGIN
                             vActGaraje:= Garaje;
                             vNumero   := Numero;
                             vPlazas   := FORMAT(Plazas);
                             vTotPax   := '('+FORMAT("Total Pax x Numero")+Text004;
                             vPrimero  := FALSE;
                           END
                           ELSE BEGIN
                             vActGaraje := '';
                             vNumero := '';
                             vPlazas := '';
                             vTotPax := '';
                           END;
                         END;

        OnPostDataItem=BEGIN
                         IF vDetalle AND (COUNT > 0) AND (vAgrupacionporGrupo OR vAgrupacionTotal) THEN
                           CurrReport.NEWPAGE;
                       END;

        GroupTotalFields=Usuario,Garaje,Numero;
        CalcFields=Total Pax x Numero;
        DataItemLinkReference=Cabecera;
      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=420;
          }
          CONTROLS
          {
            { 7   ;TextBox      ;7650 ;0    ;2250 ;420  ;SourceExpr="Pax Transportados" }
            { 13  ;TextBox      ;10050;0    ;1350 ;420  ;SourceExpr="N§ Viajes" }
            { 15  ;TextBox      ;11550;0    ;1500 ;420  ;SourceExpr="%SVeh" }
            { 19  ;TextBox      ;13200;0    ;1500 ;420  ;SourceExpr="%AcumSVeh" }
            { 21  ;TextBox      ;14850;0    ;1500 ;420  ;SourceExpr="%STotal" }
            { 23  ;TextBox      ;16500;0    ;1650 ;420  ;SourceExpr="%AcumSTotal" }
            { 18  ;TextBox      ;2400 ;0    ;1500 ;420  ;HorzAlign=Right;
                                                         SourceExpr=vNumero }
            { 25  ;TextBox      ;4050 ;0    ;1050 ;420  ;HorzGlue=Right;
                                                         HorzAlign=Right;
                                                         SourceExpr=vPlazas }
            { 16  ;TextBox      ;450  ;0    ;1800 ;420  ;SourceExpr=vActGaraje }
            { 55  ;TextBox      ;5250 ;0    ;1500 ;420  ;HorzGlue=Right;
                                                         HorzAlign=Right;
                                                         SourceExpr=vTotPax }
          }
           }
        { PROPERTIES
          {
            SectionType=GroupFooter;
            SectionWidth=18150;
            SectionHeight=0;
            OnPostSection=BEGIN
                            vPrimero:= TRUE;
                          END;

          }
          CONTROLS
          {
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table7010351;
        DataItemTableView=SORTING(Usuario,Garaje,Id. Agrupacion,Pax Transportados)
                          ORDER(Ascending);
        NewPagePerGroup=No;
        NewPagePerRecord=No;
        DataItemVarName=Temporal Vehiculos Grupo;
        OnPreDataItem=BEGIN
                        RESET;
                        SETCURRENTKEY(Usuario,Garaje,"Id. Agrupacion","Pax Transportados");
                        SETRANGE(Usuario,USERID);
                        SETFILTER("Id. Agrupacion",'<> %1','');

                        //C lculo del primer garaje.
                        IF FINDFIRST THEN
                          vOldGaraje := Garaje;

                        vPrimero  := TRUE;
                      END;

        OnAfterGetRecord=VAR
                           lwGaraje@1100253000 : Code[10];
                         BEGIN
                           IF NOT vAgrupacionporGrupo THEN
                             CurrReport.SKIP;


                           //Si cambiamos de garaje, provocamos el salto de p gina.
                           IF vOldGaraje<>Garaje THEN BEGIN
                             vOldGaraje:=Garaje;
                             CurrReport.NEWPAGE;
                           END;

                           IF vPrimero THEN BEGIN
                             lwGaraje := Garaje;
                             IF lwGaraje = TextGARAJETOTAL THEN // JPT 02/02/06 Agrupaci¢n de garajes
                                lwGaraje := Text008;
                             vTexto := STRSUBSTNO(Text005, lwGaraje);
                             IF vTipoAgrupacion=vTipoAgrupacion::"Agrupaci¢n Plazas" THEN
                               vTexto:= vTexto + '>='+"Id. Agrupacion"+Text006
                             ELSE
                               vTexto:= vTexto + "Id. Agrupacion";
                             CALCFIELDS("Total Pax x Numero");
                             vTexto += ' ('+FORMAT("Total Pax x Numero")+Text004;
                             vPrimero:=FALSE;
                           END
                           ELSE
                             vTexto := '';
                         END;

        OnPostDataItem=BEGIN
                         IF vAgrupacionporGrupo AND vAgrupacionTotal AND (COUNT > 0) THEN
                           CurrReport.NEWPAGE;
                       END;

        GroupTotalFields=Usuario,Garaje,Id. Agrupacion;
      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=420;
          }
          CONTROLS
          {
            { 28  ;TextBox      ;450  ;0    ;7050 ;420  ;SourceExpr=vTexto }
            { 29  ;TextBox      ;7650 ;0    ;2250 ;420  ;SourceExpr="Pax Transportados" }
            { 31  ;TextBox      ;10050;0    ;1350 ;420  ;SourceExpr="N§ Viajes" }
            { 39  ;TextBox      ;11550;0    ;1500 ;420  ;SourceExpr="%SVeh" }
            { 40  ;TextBox      ;13200;0    ;1500 ;420  ;SourceExpr="%AcumSVeh" }
            { 42  ;TextBox      ;14850;0    ;1500 ;420  ;SourceExpr="%STotal" }
            { 43  ;TextBox      ;16500;0    ;1650 ;420  ;SourceExpr="%AcumSTotal" }
          }
           }
        { PROPERTIES
          {
            SectionType=GroupFooter;
            SectionWidth=18150;
            SectionHeight=0;
            OnPreSection=BEGIN
                           vPrimero := TRUE;
                         END;

          }
          CONTROLS
          {
          }
           }
      }
       }
    { PROPERTIES
      {
        DataItemIndent=1;
        DataItemTable=Table7010351;
        DataItemTableView=SORTING(Usuario,Garaje,Numero,Pax Transportados)
                          ORDER(Ascending);
        NewPagePerRecord=No;
        DataItemVarName=Temporal Vehiculos Total;
        OnPreDataItem=BEGIN
                        RESET;
                        SETCURRENTKEY(Usuario,Garaje,Numero,"Pax Transportados");
                        SETRANGE(Usuario,USERID);
                        SETRANGE(Numero,vTotal);

                        //C lculo del primer garaje.
                        IF FINDFIRST THEN
                          vOldGaraje := Garaje;

                        vPrimero  := TRUE;
                      END;

        OnAfterGetRecord=VAR
                           lwGaraje@1100253000 : Code[10];
                         BEGIN
                           IF NOT vAgrupacionTotal THEN
                             CurrReport.SKIP;

                           //Si cambiamos de garaje, provocamos el salto de p gina.
                           IF vOldGaraje<>Garaje THEN BEGIN
                             vOldGaraje:=Garaje;
                             CurrReport.NEWPAGE;
                           END;


                           IF vPrimero THEN BEGIN
                             lwGaraje := Garaje;
                             CALCFIELDS("Total Vehiculos Garaje","Total Plazas Garaje");
                             IF lwGaraje = TextGARAJETOTAL THEN // JPT 02/02/06 Agrupaci¢n de garajes
                                lwGaraje := Text008;

                             vTexto := STRSUBSTNO(Text007, lwGaraje);

                             CALCFIELDS("Total Pax x Numero");
                             vTexto += ' ('+FORMAT("Total Pax x Numero")+Text004;

                             vPrimero:=FALSE;
                           END
                           ELSE
                             vTexto := '';
                         END;

      }
      SECTIONS
      {
        { PROPERTIES
          {
            SectionType=Body;
            SectionWidth=18150;
            SectionHeight=423;
          }
          CONTROLS
          {
            { 10  ;TextBox      ;7650 ;0    ;2250 ;420  ;SourceExpr="Pax Transportados" }
            { 11  ;TextBox      ;10050;0    ;1350 ;420  ;SourceExpr="N§ Viajes" }
            { 17  ;TextBox      ;11550;0    ;1500 ;420  ;SourceExpr="%SVeh" }
            { 26  ;TextBox      ;13200;0    ;1500 ;420  ;SourceExpr="%AcumSVeh" }
            { 27  ;TextBox      ;14850;0    ;1500 ;420  ;SourceExpr="%STotal" }
            { 22  ;TextBox      ;16500;0    ;1650 ;420  ;SourceExpr="%AcumSTotal" }
            { 3   ;TextBox      ;450  ;0    ;7050 ;420  ;SourceExpr=vTexto }
          }
           }
        { PROPERTIES
          {
            SectionType=GroupFooter;
            SectionWidth=18150;
            SectionHeight=0;
            OnPreSection=BEGIN
                           vPrimero  := TRUE;
                         END;

          }
          CONTROLS
          {
          }
           }
      }
       }
  }
  REQUESTFORM
  {
    PROPERTIES
    {
      Width=10120;
      Height=5940;
      OnOpenForm=VAR
                   cFunBas@1100244000 : Codeunit 7010310;
                   cVeh@1100244001 : Codeunit 7010317;
                 BEGIN
                   vGaraje            := cFunBas.ObtenerGaraje();
                   IF vGaraje<>'' THEN
                     RequestOptionsForm.FltGaraje.EDITABLE := FALSE;

                   vFecha1             := cFunBas.fdom(TODAY,-1);
                   vFecha2             := cFunBas.ldom(TODAY,-1);
                   vDetalle            := TRUE;
                   vAgrupacionTotal    := TRUE;
                   vAgrupacionporGrupo := TRUE;
                   vPropiedad          := vPropiedad::Todos;
                   //............
                   vVehiculo:= vVehiculo::"Todos los Veh¡culos";
                   RequestOptionsForm.Seleccion.VISIBLE:=FALSE;

                   //............
                   vTipoAgrupacion:=vTipoAgrupacion::"Grupo Veh¡culos";
                   RequestOptionsForm.Agrupar.VISIBLE:= FALSE;
                   //............
                   vVerBloqueados := FALSE;

                   //Actualizamos la selecci¢n de Vehiculos.
                   cVeh.ActualizarSeleccionVehiculos();
                 END;

    }
    CONTROLS
    {
      { 1   ;TextBox      ;6050 ;220  ;3300 ;440  ;Name=FltGaraje;
                                                   InPage=-1;
                                                   SourceExpr=vGaraje;
                                                   TableRelation=Garaje.Garaje;
                                                   OnValidate=VAR
                                                                cfunbas@1100244001 : Codeunit 7010310;
                                                              BEGIN
                                                                cfunbas.TestRestringido(vGaraje);
                                                              END;
                                                               }
      { 2   ;Label        ;220  ;220  ;5720 ;440  ;InPage=-1;
                                                   CaptionML=ESP=Garaje }
      { 3   ;TextBox      ;6050 ;770  ;3300 ;440  ;Enabled=Yes;
                                                   Editable=Yes;
                                                   InPage=-1;
                                                   AssistEdit=No;
                                                   SourceExpr=vVehiculo;
                                                   OnValidate=BEGIN
                                                                IF vVehiculo=vVehiculo::"Todos los Veh¡culos" THEN
                                                                  RequestOptionsForm.Seleccion.VISIBLE:=FALSE
                                                                ELSE
                                                                  RequestOptionsForm.Seleccion.VISIBLE:=TRUE;
                                                              END;
                                                               }
      { 4   ;Label        ;220  ;770  ;5720 ;440  ;InPage=-1;
                                                   CaptionML=ESP=Selecci¢n Vehiculos }
      { 6   ;TextBox      ;6050 ;1870 ;1540 ;440  ;InPage=-1;
                                                   NotBlank=Yes;
                                                   NextControl=7;
                                                   SourceExpr=vFecha1 }
      { 7   ;TextBox      ;7700 ;1870 ;1540 ;440  ;InPage=-1;
                                                   NotBlank=Yes;
                                                   NextControl=20;
                                                   SourceExpr=vFecha2 }
      { 8   ;Label        ;220  ;1870 ;5720 ;440  ;InPage=-1;
                                                   CaptionML=ESP=Filtro Fechas }
      { 5   ;Label        ;220  ;3630 ;5720 ;440  ;InPage=-1;
                                                   CaptionML=ESP=Mostrar Detalle }
      { 9   ;CheckBox     ;6050 ;3630 ;440  ;440  ;InPage=-1;
                                                   ShowCaption=No;
                                                   SourceExpr=vDetalle }
      { 11  ;Label        ;220  ;4180 ;5720 ;440  ;InPage=-1;
                                                   CaptionML=ESP=Mostrar Agrupaci¢n por Tipo de Agrupacion }
      { 12  ;CheckBox     ;6050 ;4180 ;440  ;440  ;InPage=-1;
                                                   ShowCaption=No;
                                                   SourceExpr=vAgrupacionporGrupo }
      { 10  ;CommandButton;9350 ;770  ;440  ;440  ;Name=Seleccion;
                                                   InPage=-1;
                                                   ShowCaption=Yes;
                                                   CaptionML=ESP=...;
                                                   ToolTipML=ESP=Seleccionar Veh¡culos;
                                                   OnPush=VAR
                                                            rSel@1100244001 : Record 7010352;
                                                            fSel@1100244002 : Form 7010386;
                                                            rPar@1100244003 : Record 7010311;
                                                          BEGIN
                                                            rPar.FINDFIRST;

                                                            rSel.RESET;
                                                            rSel.INIT;
                                                            rSel.SETCURRENTKEY(Usuario,Garaje, Numero);
                                                            rSel.FILTERGROUP(2);
                                                            rSel.SETRANGE(Usuario,USERID);

                                                            IF (vGaraje<>'') AND (vGaraje<>rPar."Todos los garajes") THEN
                                                              rSel.SETRANGE(Garaje, vGaraje);

                                                            rSel.FILTERGROUP(0);

                                                            CLEAR(fSel);
                                                            fSel.SETTABLEVIEW(rSel);
                                                            fSel.RUN;
                                                            CLEAR(fSel);
                                                            rSel.RESET;
                                                          END;
                                                           }
      { 16  ;CommandButton;9350 ;1320 ;440  ;440  ;Name=Agrupar;
                                                   InPage=-1;
                                                   ForeColor=0;
                                                   BackColor=12632256;
                                                   Border=Yes;
                                                   CaptionML=ESP=...;
                                                   ToolTipML=ESP=Agrupaci¢n de plazas;
                                                   OnPush=VAR
                                                            rPar@1100244001 : Record 7010311;
                                                            rSel@1100244002 : Record 7010354;
                                                            fSel@1100244003 : Form 7010389;
                                                            cVeh@1100244004 : Codeunit 7010317;
                                                            rUsr@1100244005 : Record 7010420;
                                                          BEGIN
                                                            rSel.RESET;
                                                            rSel.SETCURRENTKEY("Id. Usuario");
                                                            rSel.SETRANGE("Id. Usuario",USERID);

                                                            IF rSel.COUNT=0 THEN
                                                              //Actualizamos la selecci¢n de Vehiculos.
                                                              cVeh.ActualizarRangos();

                                                            rSel.RESET;
                                                            rSel.SETCURRENTKEY("Id. Usuario",Garaje);
                                                            rSel.FILTERGROUP(2);
                                                            rPar.FINDFIRST;

                                                            rSel.SETRANGE("Id. Usuario",USERID);
                                                            IF rUsr.GET(USERID) AND (rUsr."Garaje de trabajo"<>rPar."Todos los garajes") THEN
                                                              rSel.SETRANGE(Garaje,rUsr."Garaje de trabajo");

                                                            rSel.FILTERGROUP(0);

                                                            CLEAR(fSel);
                                                            fSel.SETTABLEVIEW(rSel);
                                                            fSel.RUN;
                                                            CLEAR(fSel);
                                                            rSel.RESET;
                                                          END;
                                                           }
      { 17  ;TextBox      ;6050 ;1320 ;3300 ;440  ;Name=TipoAgrupacion;
                                                   InPage=-1;
                                                   SourceExpr=vTipoAgrupacion;
                                                   OnValidate=BEGIN
                                                                IF vTipoAgrupacion=vTipoAgrupacion::"Agrupaci¢n Plazas" THEN
                                                                  RequestOptionsForm.Agrupar.VISIBLE:= TRUE
                                                                ELSE
                                                                  RequestOptionsForm.Agrupar.VISIBLE:= FALSE;
                                                              END;
                                                               }
      { 18  ;Label        ;220  ;1320 ;5720 ;440  ;InPage=-1;
                                                   CaptionML=ESP=Tipo de Agrupaci¢n }
      { 13  ;CheckBox     ;6050 ;4730 ;440  ;440  ;InPage=-1;
                                                   ShowCaption=No;
                                                   NextControl=1;
                                                   SourceExpr=vAgrupacionTotal }
      { 14  ;Label        ;220  ;4730 ;5720 ;440  ;InPage=-1;
                                                   CaptionML=ESP=Mostrar Agrupaci¢n Total }
      { 15  ;TextBox      ;6050 ;2970 ;3300 ;440  ;Name=FltGaraje;
                                                   InPage=-1;
                                                   SourceExpr=vGarajeResult;
                                                   TableRelation=Garaje.Garaje;
                                                   OnValidate=VAR
                                                                cfunbas@1100244001 : Codeunit 7010310;
                                                              BEGIN
                                                                cfunbas.TestRestringido(vGaraje);
                                                              END;
                                                               }
      { 19  ;Label        ;220  ;2970 ;5720 ;440  ;InPage=-1;
                                                   CaptionML=ESP=Garaje a considerar en resultados }
      { 20  ;TextBox      ;6050 ;2420 ;2200 ;440  ;InPage=-1;
                                                   SourceExpr=vPropiedad }
      { 21  ;Label        ;220  ;2420 ;5720 ;440  ;ParentControl=20;
                                                   InPage=-1;
                                                   MultiLine=Yes;
                                                   CaptionML=ESP=Selecci¢n seg£n la propiedad del Vehiculo;
                                                   ToolTipML=ESP=Si se marca s¢lo se considerar n los vehiculos que han tenido actividad }
      { 22  ;CheckBox     ;6050 ;5280 ;440  ;440  ;InPage=-1;
                                                   ShowCaption=No;
                                                   NextControl=3;
                                                   SourceExpr=vVerBloqueados }
      { 23  ;Label        ;220  ;5280 ;5720 ;440  ;InPage=-1;
                                                   MultiLine=Yes;
                                                   CaptionML=ESP=Mostrar vehiculos bloqueados;
                                                   ToolTipML=ESP=Si se marca s¢lo se considerar n los vehiculos que han tenido actividad }
    }
  }
  REQUESTPAGE
  {
    PROPERTIES
    {
    }
    CONTROLS
    {
    }
  }
  CODE
  {
    VAR
      TextGARAJETOTAL@1100253001 : TextConst 'ESP=ZZZZZZZZZZ';
      Text000@1100244027 : TextConst 'ESP=TODOS';
      Text001@1100244028 : TextConst 'ESP=TOTAL';
      Text002@1100244029 : TextConst 'ESP=GR';
      Text003@1100244030 : TextConst 'ESP=Ninguna';
      Text004@1100244031 : TextConst 'ESP=" pax)"';
      Text005@1100244032 : TextConst 'ESP="%1 Agr. por: "';
      Text006@1100244033 : TextConst 'ESP=" plazas"';
      Text007@1100244034 : TextConst 'ESP="Total %1 ,  "';
      LastFieldNo@1100244000 : Integer;
      FooterPrinted@1100244001 : Boolean;
      vFecha1@1100244002 : Date;
      vFecha2@1100244003 : Date;
      vGrupo@1100244004 : Text[10];
      vTotal@1100244005 : Text[10];
      vGaraje@1100244006 : Code[10];
      vVehiculo@1100244007 : 'Todos los Veh¡culos,Seg£n Selecci¢n';
      vDetalle@1100244008 : Boolean;
      vAgrupacionporGrupo@1100244009 : Boolean;
      vAgrupacionTotal@1100244010 : Boolean;
      vNumero@1100244011 : Text[10];
      vPlazas@1100244012 : Text[5];
      vPrimero@1100244013 : Boolean;
      vTexto@1100244014 : Text[45];
      vOldGaraje@1100244015 : Code[10];
      vActGaraje@1100244016 : Code[10];
      vTipoAgrupacion@1100244017 : 'Grupo Veh¡culos,Agrupaci¢n Plazas';
      aRGaraje@1100244018 : ARRAY [100] OF Code[10];
      aRangos@1100244019 : ARRAY [100,3] OF Integer;
      vNumRangos@1100244020 : Integer;
      vMostrarAgrupacion@1100244021 : Text[30];
      vGarajeResult@1100244022 : Code[10];
      vFltGarajeResult@1100244023 : Code[10];
      vPropiedad@1100244024 : 'Todos,S¢lo Propios,S¢lo Ajenos';
      vVerBloqueados@1100244025 : Boolean;
      vTotPax@1100244026 : Text[30];
      wTotalGral@1100253000 : Boolean;
      Text008@1100253002 : TextConst 'ESP=GENERAL';

    PROCEDURE GrabarDatos@1(rParte@1100244000 : Record 7010360;pGaraje@1100244001 : Code[10];pNumero@1100244002 : Text[10];pPlazas@1100244003 : Integer;pPrimerParte@1100244004 : Boolean;pGrupoVehiculo@1100244005 : Code[10]);
    VAR
      rTemp@1100244006 : Record 7010351;
      vAuxGrupo@1100244007 : Code[10];
      vTransportados@1100244008 : Decimal;
      vAuxNumero@1100244009 : Code[10];
    BEGIN
      //GrabarDatos(rParte,pNumero,pPlazas);

      //Miramos si estamos grabando el grupo.
      //Si no lo tenemos que agrupar no grabamos nada.
      vAuxGrupo := '';
      IF pNumero = vGrupo THEN BEGIN
        vAuxGrupo:=CalcularAgrupacion(pGaraje,pPlazas,pGrupoVehiculo);
        IF vAuxGrupo='' THEN
          EXIT
        ELSE
          vAuxNumero := COPYSTR(pNumero + vAuxGrupo, 1, MAXSTRLEN(vAuxNumero));
      END
      ELSE
        vAuxNumero:=pNumero;

      vTransportados:=rParte."Adultos trans. soporte"+rParte."Ni¤os trans. soporte";

      IF NOT rTemp.GET(USERID,pGaraje,vAuxNumero,vTransportados) THEN BEGIN
        rTemp.INIT;
        rTemp.Usuario                   := USERID;
        rTemp.Garaje                    := pGaraje;
        rTemp.Numero                    := vAuxNumero;
        rTemp."Pax Transportados"       := vTransportados;
        rTemp."N§ Viajes"               := rParte."N§ viajes";
        rTemp.Plazas                    := pPlazas;
        rTemp."Id. Agrupacion"          := vAuxGrupo;
        rTemp."Primer Registro Vehiculo":= pPrimerParte;
        rTemp. "Total Pax"              := vTransportados * rParte."N§ viajes";
        rTemp.INSERT;
      END
      ELSE BEGIN
        rTemp."N§ Viajes" := rTemp."N§ Viajes" + rParte."N§ viajes";
        rTemp.Plazas      := rTemp.Plazas + pPlazas;
        rTemp."Total Pax"  := rTemp."N§ Viajes" * rTemp."Pax Transportados";
        rTemp.MODIFY;
      END
    END;

    PROCEDURE CalcularAgrupacion@2(pGaraje@1100244000 : Code[10];pPlazas@1100244001 : Integer;pGrupoVehiculo@1100244002 : Code[10]) : Code[10];
    VAR
      cFunVeh@1100244003 : Codeunit 7010317;
      Result@1100244004 : Code[10];
    BEGIN
      //CalcularAgrupacion()
      IF vTipoAgrupacion = vTipoAgrupacion::"Grupo Veh¡culos" THEN
        Result := pGrupoVehiculo
      ELSE
        Result := cFunVeh.ObtenerAgrupacionRango(pGaraje,aRangos,aRGaraje,vNumRangos,pPlazas);
      EXIT(Result)
    END;

    BEGIN
    {
      //Se tiene en cuenta la pertenencia del vehiculo a un garaje y no que el vehiculo haya trabajado
      //para un determinado garaje.
      //As¡ el parte puede estar vinculado a Garaje2, el vehiculo a Garaje1, y contar  para
      //el Garaje1.

      //NOTA:
      //La variable PRIMERO se utiliza para determinar cuando hay que imprimir el n§vehiculo asi como
      //el garaje y el n§plazas.
      //Hay que tener en cuenta que esta informacion se imprimira al cambiar de vehiculo, de garaje o
      //de PAGINA (p  que quede bonito, no?).
    }
    END.
  }
  RDLDATA
  {
  }
}

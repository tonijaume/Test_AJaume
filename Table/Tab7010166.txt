OBJECT Table 7010166 Coste Excursiones
{
  OBJECT-PROPERTIES
  {
    Date=10/06/15;
    Time=16:42:39;
    Modified=Yes;
    Version List=AIC2009;
  }
  PROPERTIES
  {
    OnInsert=VAR
               lrCoste@1100217000 : Record 7010166;
             BEGIN
               lrCoste.RESET;
               lrCoste.SETRANGE(Delegacion   , Delegacion);
               lrCoste.SETRANGE("N§ Servicio", "N§ Servicio");
               IF lrCoste.FINDLAST THEN
                 "Orden Linea" := lrCoste."Orden Linea" + 10
               ELSE
                 "Orden Linea" := 10;

               "Fecha creacion" := TODAY;
               "Hora creacion"  := TIME;
             END;

    OnDelete=BEGIN
               // Borramos si existe el detalle de calculo

               _CancelarDetalle;
             END;

    CaptionML=[ENU=Excursions Cost;
               ESP=Coste Excursiones];
    DrillDownFormID=Form7010203;
  }
  FIELDS
  {
    { 1   ;   ;Delegacion          ;Code10        ;TableRelation=Delegacion.Codigo;
                                                   CaptionML=[ENU=Local Office;
                                                              ESP=Delegacion];
                                                   Description=PK, FK Delegacion;
                                                   Editable=No }
    { 3   ;   ;N§ Servicio         ;Integer       ;TableRelation="Servicio Excursion"."N§ Servicio";
                                                   CaptionML=[ENU=Service No.;
                                                              ESP=N§ Servicio];
                                                   Description=PK, FK Servicio Excursion }
    { 5   ;   ;Concepto            ;Code10        ;TableRelation="Concepto C/I".Concepto;
                                                   CaptionML=[ENU=concept;
                                                              ESP=Concepto];
                                                   Description=PK, FK Concepto C/I }
    { 7   ;   ;TourOperador        ;Code10        ;TableRelation=TourOperador.TourOperador;
                                                   CaptionML=[ENU=TourOperator;
                                                              ESP=TourOperador];
                                                   NotBlank=Yes;
                                                   Description=FK TourOperador }
    { 8   ;   ;Origen Concepto     ;Code10        ;Description=$002 }
    { 9   ;   ;O_N§ Pax            ;Integer       ;CaptionML=[ENU=Pax No.;
                                                              ESP=N§ Pax];
                                                   Description=$005 }
    { 11  ;   ;O_Precio Base       ;Decimal       ;CaptionML=[ENU=Base rate;
                                                              ESP=Precio Base];
                                                   Description=$005;
                                                   AutoFormatType=2;
                                                   AutoFormatExpr="Cod. divisa" }
    { 17  ;   ;Fecha               ;Date          ;CaptionML=[ENU=Date;
                                                              ESP=Fecha] }
    { 19  ;   ;Zona                ;Code10        ;TableRelation="Zona fisica"."Zona Fisica";
                                                   CaptionML=[ENU=Location;
                                                              ESP=Zona];
                                                   Description=FK Zona Fisica }
    { 21  ;   ;N§ Vehiculos        ;Integer       ;CaptionML=[ENU=Vehicles No.;
                                                              ESP=N§ vehiculos];
                                                   Editable=No }
    { 23  ;   ;Tipo Vehiculo       ;Code10        ;CaptionML=[ENU=Vehicle type;
                                                              ESP=Tipo Vehiculo];
                                                   Editable=No }
    { 25  ;   ;Precio Pax          ;Decimal       ;CaptionML=[ENU=Pax Rate;
                                                              ESP=Precio Pax];
                                                   Editable=No;
                                                   AutoFormatType=2;
                                                   AutoFormatExpr="Cod. divisa" }
    { 27  ;   ;Importe             ;Decimal       ;OnValidate=BEGIN
                                                                DesglosarIVA(TRUE);
                                                              END;

                                                   CaptionML=[ENU=Amount;
                                                              ESP=Importe];
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 31  ;   ;Cod. divisa         ;Code10        ;TableRelation=Currency.Code;
                                                   OnValidate=BEGIN
                                                                IF "Cod. divisa" <> '' THEN
                                                                BEGIN
                                                                  "Importe sin impuestos (DL)" := ROUND(rTipoCam.ExchangeAmtFCYToFCY("Fecha cambio divisa",
                                                                                                                                     "Cod. divisa",
                                                                                                                                     '',
                                                                                                                                     "Importe sin Impuesto")
                                                                                                       );
                                                                  "Importe con impuestos (DL)" := ROUND(rTipoCam.ExchangeAmtFCYToFCY("Fecha cambio divisa",
                                                                                                                                     "Cod. divisa",
                                                                                                                                     '',
                                                                                                                                     "Importe con Impuesto")
                                                                                                       );
                                                                END
                                                                ELSE
                                                                BEGIN
                                                                  "Importe sin impuestos (DL)" := "Importe sin Impuesto";
                                                                  "Importe con impuestos (DL)" := "Importe con Impuesto";
                                                                END;
                                                              END;

                                                   CaptionML=[ENU=Currency code;
                                                              ESP=C¢d. divisa];
                                                   Description=FK Divisa }
    { 33  ;   ;Suplemento          ;Code10        ;CaptionML=[ENU=Supplement;
                                                              ESP=Suplemento] }
    { 37  ;   ;Tipo Elemento       ;Option        ;CaptionML=[ENU=Element Type;
                                                              ESP=Tipo elemento];
                                                   OptionCaptionML=[ENU=Paxes,Supplement,,Service,Manual;
                                                                    ESP=Paxes,Suplemento,,Servicio,Manual];
                                                   OptionString=Paxes,Suplemento,,Servicio,Manual }
    { 39  ;   ;Tipo Pax            ;Code10        ;CaptionML=[ENU=Pax type;
                                                              ESP=Tipo Pax];
                                                   Editable=No }
    { 41  ;   ;Cantidad Aplicada   ;Decimal       ;CaptionML=[ENU=Applied quantity;
                                                              ESP=Cantidad aplicada] }
    { 43  ;   ;Precio x Vehiculo   ;Decimal       ;CaptionML=[ENU=Price x Vehicle;
                                                              ESP=Precio x Vehiculo];
                                                   Editable=No;
                                                   AutoFormatType=2;
                                                   AutoFormatExpr="Cod. divisa" }
    { 45  ;   ;N§ Contrato Excursion;Code10       ;TableRelation="Contrato Compra Excursiones"."N§ Contrato compra" WHERE (Delegacion=FIELD(Delegacion));
                                                   CaptionML=[ENU=Excursion contract No.;
                                                              ESP=N§ Contrato Excursion];
                                                   Description=FK Contrato Compra Excursion }
    { 47  ;   ;Tipo Precio         ;Code10        ;CaptionML=[ENU=Price type;
                                                              ESP=Tipo Precio];
                                                   Editable=No }
    { 48  ;   ;Personas servicio   ;Decimal       ;CaptionML=[ENU=Service persons;
                                                              ESP=Personas servicio] }
    { 49  ;   ;N§ Prefactura       ;Code10        ;CaptionML=[ENU=Pro-forma invoice No.;
                                                              ESP=N§ Prefactura];
                                                   Editable=No }
    { 51  ;   ;N§ Factura          ;Code20        ;CaptionML=[ENU=Invoice No.;
                                                              ESP=N§ Factura] }
    { 53  ;   ;Automatico/Manual   ;Option        ;CaptionML=[ENU=Automatic/Manual;
                                                              ESP=Automatico/Manual];
                                                   OptionCaptionML=[ENU=Automatic,Manual,Cancellation;
                                                                    ESP=Automatico,Manual,Anulaci¢n];
                                                   OptionString=Automatico,Manual,Anulaci¢n;
                                                   Editable=No }
    { 55  ;   ;Comentarios         ;Boolean       ;FieldClass=FlowField;
                                                   CalcFormula=Exist("Comentarios Excursiones" WHERE (Delegacion=FIELD(Delegacion),
                                                                                                      N§ servicio=FIELD(N§ Servicio),
                                                                                                      Orden Linea=FIELD(Orden Linea)));
                                                   CaptionML=[ENU=Comments;
                                                              ESP=Comentarios];
                                                   Description=Campo Calculado }
    { 57  ;   ;Orden Linea         ;Integer       ;InitValue=0;
                                                   CaptionML=[ENU=Line order;
                                                              ESP=Orden Linea];
                                                   Editable=No }
    { 63  ;   ;Importe Original SIN;Decimal       ;CaptionML=[ENU=Original amount WITHOUT;
                                                              ESP=Importe Original SIN];
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 65  ;   ;Importe Original CON;Decimal       ;CaptionML=[ENU=Original amount WITH;
                                                              ESP=Importe Original CON];
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 67  ;   ;% Reparto TourOperador;Decimal     ;CaptionML=[ENU=% Touroperator delivery;
                                                              ESP=% Reparto TourOperador] }
    { 69  ;   ;Cantidad Real       ;Decimal       ;CaptionML=[ENU=Real Quantity;
                                                              ESP=Cantidad Real] }
    { 71  ;   ;old_Minimo          ;Boolean       ;CaptionML=[ENU=Minimum;
                                                              ESP=Minimo];
                                                   Description=$022 }
    { 73  ;   ;Excursion           ;Code10        ;TableRelation="Producto agencia".Codigo WHERE (Tipo Producto=CONST(Excursion));
                                                   CaptionML=[ENU=Excursion;
                                                              ESP=Excursion];
                                                   Editable=No }
    { 74  ;   ;Oficina             ;Code20        ;TableRelation="Oficina ventas".Codigo;
                                                   Description=$003 }
    { 75  ;   ;Importe sin Impuesto;Decimal       ;OnValidate=BEGIN
                                                                DesglosarIVA(FALSE);
                                                              END;

                                                   CaptionML=[ENU=Amount without tax;
                                                              ESP=Importe sin impuesto];
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 77  ;   ;Importe con Impuesto;Decimal       ;OnValidate=BEGIN
                                                                DesglosarIVA(FALSE);
                                                              END;

                                                   CaptionML=[ENU=Amount with tax;
                                                              ESP=Importe con impuesto];
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 80  ;   ;Id Soporte          ;Integer       ;Description=$002 }
    { 83  ;   ;Pax Validados Trans ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Validacion Transportista"."Pax Validacion" WHERE (Delegacion=FIELD(Delegacion),
                                                                                                                      N§ Servicio=FIELD(N§ Servicio),
                                                                                                                      Orden Linea=FIELD(Orden Linea)));
                                                   CaptionML=[ENU=Trans Validated Pax;
                                                              ESP=Pax Validados Trans];
                                                   Description=Campo Calculado }
    { 85  ;   ;Importe Validados Trans;Decimal    ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Validacion Transportista"."Importe Validacion" WHERE (Delegacion=FIELD(Delegacion),
                                                                                                                          N§ Servicio=FIELD(N§ Servicio),
                                                                                                                          Orden Linea=FIELD(Orden Linea)));
                                                   CaptionML=[ENU=Trans Validated Amount;
                                                              ESP=Importe Validados Trans];
                                                   Description=Campo Calculado;
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 87  ;   ;Pax Validacion      ;Decimal       ;OnValidate=BEGIN
                                                                _CheckPaxValidacion;
                                                              END;

                                                   CaptionML=[ENU=Validation Pax;
                                                              ESP=Pax Validacion] }
    { 89  ;   ;Importe Validacion  ;Decimal       ;OnValidate=BEGIN
                                                                _CheckImporteValidacion;
                                                              END;

                                                   CaptionML=[ENU=Validation amount;
                                                              ESP=Importe validacion];
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 91  ;   ;Pax Validados Excursion;Decimal    ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Validacion Excursion"."Pax Validacion" WHERE (Delegacion=FIELD(Delegacion),
                                                                                                                  N§ Servicio=FIELD(N§ Servicio),
                                                                                                                  Orden Linea=FIELD(Orden Linea)));
                                                   CaptionML=[ENU=Excursion Validated Pax;
                                                              ESP=Pax Validados Excursion];
                                                   Description=Campo Calculado }
    { 93  ;   ;Importe Validados Excursion;Decimal;FieldClass=FlowField;
                                                   CalcFormula=Sum("Validacion Excursion"."Importe Validacion" WHERE (Delegacion=FIELD(Delegacion),
                                                                                                                      N§ Servicio=FIELD(N§ Servicio),
                                                                                                                      Orden Linea=FIELD(Orden Linea)));
                                                   CaptionML=[ENU=Excursion Validated Pax;
                                                              ESP=Importe Validados Excursion];
                                                   Description=Campo Calculado;
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 95  ;   ;Pax Validados GO    ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Validacion Guia Oficial"."Pax Validacion" WHERE (Delegacion=FIELD(Delegacion),
                                                                                                                     N§ Servicio=FIELD(N§ Servicio),
                                                                                                                     Orden Linea=FIELD(Orden Linea)));
                                                   CaptionML=[ENU=GO Validated Pax;
                                                              ESP=Pax Validados GO];
                                                   Description=Campo Calculado }
    { 97  ;   ;Importe Validados GO;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Validacion Guia Oficial"."Importe Validacion" WHERE (Delegacion=FIELD(Delegacion),
                                                                                                                         N§ Servicio=FIELD(N§ Servicio),
                                                                                                                         Orden Linea=FIELD(Orden Linea)));
                                                   CaptionML=[ENU=GO Validated Amount;
                                                              ESP=Importe Validados GO];
                                                   Description=Campo Calculado;
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 99  ;   ;Pendiente FPR       ;Boolean       ;InitValue=Yes;
                                                   CaptionML=[ENU=Pending ITR;
                                                              ESP=Pendiente FPR] }
    { 100 ;   ;Factura FPR         ;Code20        ;CaptionML=[ENU=Invoice ITR;
                                                              ESP=Factura FPR] }
    { 103 ;   ;Usuario             ;Code20        ;TableRelation=User."User ID";
                                                   CaptionML=[ENU=User;
                                                              ESP=Usuario] }
    { 105 ;   ;Linea Traspaso      ;Integer       ;CaptionML=[ENU=Transfer line;
                                                              ESP=Linea Traspaso] }
    { 107 ;   ;O_Reservado Touroperador;Boolean   ;CaptionML=[ENU=Touroperator Booked;
                                                              ESP=Reservado TourOperador];
                                                   Description=$013;
                                                   Editable=No }
    { 108 ;   ;O_Guia Venta        ;Code20        ;TableRelation="Representante excursiones".Codigo;
                                                   CaptionML=[ENU=Sale guide;
                                                              ESP=Guia venta];
                                                   Description=$013;
                                                   Editable=No }
    { 110 ;   ;Proveedor           ;Code20        ;TableRelation=Vendor.No.;
                                                   CaptionML=[ENU=Supplier;
                                                              ESP=Proveedor];
                                                   Description=FK Proveedor;
                                                   Editable=No }
    { 112 ;   ;Fecha creacion      ;Date          ;CaptionML=[ENU=Creation Date;
                                                              ESP=Fecha creacion];
                                                   Editable=No }
    { 114 ;   ;Hora creacion       ;Time          ;CaptionML=[ENU=Creation Time;
                                                              ESP=Hora creacion];
                                                   Editable=No }
    { 115 ;   ;Fecha cambio divisa ;Date          ;CaptionML=[ENU=Currency exchange date;
                                                              ESP=Fecha cambio divisa] }
    { 117 ;   ;Tipo cambio divisa  ;Decimal       ;CaptionML=[ENU=Currency exchange rate;
                                                              ESP=Tipo cambio divisa] }
    { 118 ;   ;Importe sin impuestos (DL);Decimal ;CaptionML=[ENU=Amount without taxes (LCY);
                                                              ESP=Importe sin impuestos (DL)];
                                                   AutoFormatType=1 }
    { 119 ;   ;Importe con impuestos (DL);Decimal ;CaptionML=[ENU=Amount with taxes (LCY);
                                                              ESP=Importe con impuestos (DL)];
                                                   AutoFormatType=1 }
    { 120 ;   ;Prestacion          ;Integer       ;CaptionML=[ENU=Feature;
                                                              ESP=Prestacion] }
    { 121 ;   ;Tipo cambio FPR     ;Decimal       ;CaptionML=[ENU=ITR Exchange Rate;
                                                              ESP=Tipo cambio FPR];
                                                   Description=$006;
                                                   AutoFormatType=2 }
    { 122 ;   ;Tipo cambio Factura ;Decimal       ;CaptionML=[ENU=Invoice Exchange Rate;
                                                              ESP=Tipo cambio Factura];
                                                   Description=$006;
                                                   AutoFormatType=2 }
    { 123 ;   ;Num. Ticket         ;Code10        ;CaptionML=[ENU=Ticket No.;
                                                              ESP=Num. Ticket];
                                                   Description=$009 }
    { 124 ;   ;Confirmacion proveedor;Code20      ;CaptionML=[ENU=Provider confirmation;
                                                              ESP=Confirmacion proveedor];
                                                   Description=$009 }
    { 125 ;   ;Coste x Ticket      ;Boolean       ;CaptionML=[ENU=Cost x Ticket;
                                                              ESP=Coste x Ticket];
                                                   Description=$010 }
    { 126 ;   ;Booking Touroperador;Code20        ;CaptionML=[ENU=Touroperator booking;
                                                              ESP=Booking Touroperador];
                                                   Description=$024 }
    { 200 ;   ;VAT %               ;Decimal       ;CaptionML=[ENU=VAT %;
                                                              ESP=% IVA];
                                                   DecimalPlaces=0:6;
                                                   Description=$015;
                                                   Editable=No }
    { 205 ;   ;VAT Bus. Posting Group;Code10      ;TableRelation="VAT Business Posting Group";
                                                   CaptionML=[ENU=VAT Bus. Posting Group;
                                                              ESP=Grupo registro IVA neg.];
                                                   Description=$015 }
    { 210 ;   ;VAT Prod. Posting Group;Code10     ;TableRelation="VAT Product Posting Group";
                                                   CaptionML=[ENU=VAT Prod. Posting Group;
                                                              ESP=Grupo registro IVA prod.];
                                                   Description=$015 }
    { 215 ;   ;Importe base impuesto;Decimal      ;CaptionML=[ENU=Tax base amount;
                                                              ESP=Importe base impuesto];
                                                   Description=$023;
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
    { 220 ;   ;Importe exento      ;Decimal       ;CaptionML=[ENU=Exempted amount;
                                                              ESP=Importe exento];
                                                   Description=$023;
                                                   AutoFormatType=1;
                                                   AutoFormatExpr="Cod. divisa" }
  }
  KEYS
  {
    {    ;Delegacion,N§ Servicio,Orden Linea      ;Clustered=Yes }
    {    ;Delegacion,N§ Servicio,TourOperador,Zona,Concepto,Tipo Vehiculo,Tipo Elemento,Tipo Pax,N§ Contrato Excursion,Tipo Precio,Orden Linea;
                                                   SumIndexFields=Importe,Importe sin Impuesto,Importe con Impuesto;
                                                   KeyGroups=RENUMERING }
    {    ;Delegacion,N§ Servicio,TourOperador,Zona,Concepto,Tipo Vehiculo,Tipo Elemento,Tipo Pax,N§ Contrato Excursion,Orden Linea;
                                                   KeyGroups=RENUMERING }
    {    ;Concepto,Fecha,TourOperador,N§ Contrato Excursion,Zona;
                                                   KeyGroups=RENUMERING }
    {    ;Concepto,N§ Prefactura                  ;KeyGroups=RENUMERING }
    {    ;Delegacion,N§ Servicio,Concepto         ;SumIndexFields=Importe con Impuesto,Importe sin Impuesto,Importe sin impuestos (DL),Importe con impuestos (DL);
                                                   KeyGroups=RENUMERING }
    {    ;Delegacion,Concepto,Proveedor,N§ Factura,Fecha;
                                                   SumIndexFields=Importe con Impuesto,Importe sin Impuesto;
                                                   KeyGroups=RENUMERING }
    {    ;Delegacion,TourOperador,Fecha           ;KeyGroups=RENUMERING }
    {    ;Delegacion,N§ Servicio,Prestacion,Num. Ticket,N§ Factura;
                                                   SumIndexFields=Importe con Impuesto,Importe sin Impuesto }
    {    ;Excursion,TourOperador,Proveedor,N§ Factura,Automatico/Manual,Fecha;
                                                   SumIndexFields=Importe sin Impuesto }
  }
  FIELDGROUPS
  {
  }
  CODE
  {
    VAR
      Text000@1103355007 : TextConst 'ENU=EXCI;ESP=EXCI';
      Text004@1103355011 : TextConst 'ENU=G/L Accounts folder does not exist for\;ESP=No existe el fichero de cuentas para la\';
      Text005@1103355012 : TextConst 'ENU=Local Office %1 and T.O. %2.;ESP=Delegacion %1 y T.O. %2.';
      Text006@1103355013 : TextConst 'ENU=Purchase contract %1 does not exist for excursions supplier;ESP=No existe el contrato de compra %1 para proveedor excursiones';
      Text007@1103355014 : TextConst 'ENU=Contract %1-%2 is not confirmed;ESP=El contrato %1-%2 no esta confirmado.';
      Text008@1103355015 : TextConst 'ENU=Supplier %1 does not exist;ESP=No existe el proveedor %1';
      Text009@1103355016 : TextConst 'ENU=Purchase VAT %1 %2 does not exist;ESP=No existe el IVA de compra %1 %2';
      rIVA@1103355000 : Record 325;
      rContrato@1103355001 : Record 7010142;
      rPro@1103355002 : Record 23;
      rTipoCam@1103355003 : Record 330;
      Text010@1100217003 : TextConst 'ENU=Unable to validate more paxes than the really carried.;ESP=No puede validar m s paxes que los realmente transportados.';
      Text011@1100217001 : TextConst 'ENU=Unable to validate an amount higher than the really applied.;ESP=No puede validar un importe mayor que el realmente aplicado.';

    PROCEDURE busca_contrato@1();
    BEGIN
      // busca_contrato

      CASE Concepto OF
        'EXAC':
        BEGIN
          rContrato.SETRANGE("Tipo Contrato"     , rContrato."Tipo Contrato"::Transportista);
          rContrato.SETRANGE("N§ Contrato compra", "N§ Contrato Excursion");
        END;
        'EXCC':
        BEGIN
          rContrato.SETRANGE("Tipo Contrato"     , rContrato."Tipo Contrato"::Excursion);
          rContrato.SETRANGE("N§ Contrato compra", "N§ Contrato Excursion");
        END;
        'EXGO':
        BEGIN
          rContrato.SETRANGE("Tipo Contrato"     , rContrato."Tipo Contrato"::"Guia Oficial");
          rContrato.SETRANGE("N§ Contrato compra", "N§ Contrato Excursion");
        END;
      END;

      IF NOT rContrato.FINDFIRST THEN
        ERROR(Text006, "N§ Contrato Excursion");
      IF NOT rContrato.Confirmado THEN
        ERROR(Text007, rContrato."Tipo Contrato", rContrato."N§ Contrato compra");
      IF NOT rPro.GET(rContrato.Proveedor) THEN
        ERROR(Text008, rContrato.Proveedor);

      IF NOT rIVA.GET(rPro."VAT Bus. Posting Group", rContrato."Grupo registro iva prod.") THEN
        ERROR(Text009, rPro."VAT Bus. Posting Group", rContrato."Grupo registro iva prod.");
    END;

    PROCEDURE DesglosarIVA@1100217000(pwInicial@1100217004 : Boolean);
    VAR
      lwIVA@1100217003 : Decimal;
      lwExencion@1000000000 : Decimal;
      lrContrato@1100217000 : Record 7010142;
    BEGIN
      //. Buscamos el contrato de compra

      lwIVA := GetIVA(lrContrato);

      //. Rellenamos los campos de importe en funcion del contrato
      IF lrContrato."Impuestos incluidos" THEN
      BEGIN
        //-$020IF pwInicial THEN
        //-$020BEGIN
          "Importe con Impuesto" := Importe;
          "Importe sin Impuesto" := ROUND(Importe / lwIVA);
        "Importe base impuesto" := "Importe sin Impuesto";
        //-$020END
        //-$020ELSE
        //-$020  "Importe sin Impuesto" := ROUND("Importe con Impuesto"/ lwIVA)
      END
      ELSE
      BEGIN
        //-$020IF pwInicial THEN
        //-$020BEGIN
          "Importe sin Impuesto" := Importe;

          //-$023"Importe con Impuesto" := ROUND(Importe * lwIVA);

        //+$023 <
        IF lrContrato."% Exento" <> 0 THEN
        BEGIN
          lwExencion := lrContrato."% Exento" / 100;
          "Importe exento" := ROUND("Importe sin Impuesto" * lwExencion);
        END;

        "Importe base impuesto" := "Importe sin Impuesto" - "Importe exento";
        "Importe con Impuesto"  := ROUND(("Importe base impuesto" * lwIVA)) + "Importe exento";
        //+$023 >

        //-$020END
        //-$020ELSE
        //-$020  "Importe con Impuesto" := ROUND("Importe sin Impuesto" * lwIVA);
      END;

      VALIDATE("Cod. divisa");
    END;

    PROCEDURE GetIVA@1100217007(VAR prContrato@1100217002 : Record 7010142) : Decimal;
    VAR
      lrVendor@1100217001 : Record 23;
      lrVATSetup@1100217000 : Record 325;
      lwIVA@1100217003 : Decimal;
    BEGIN
      // GetIVA

      prContrato.RESET;
      prContrato.SETRANGE(Delegacion          , Delegacion);
      prContrato.SETRANGE("N§ Contrato compra", "N§ Contrato Excursion");
      CASE Concepto OF
        'EXAC': prContrato.SETRANGE("Tipo Contrato", prContrato."Tipo Contrato"::Transportista);
        'EXCC': prContrato.SETRANGE("Tipo Contrato", prContrato."Tipo Contrato"::Excursion);
        'EXGO': prContrato.SETRANGE("Tipo Contrato", prContrato."Tipo Contrato"::"Guia Oficial");
      END;
      prContrato.SETRANGE(Confirmado, TRUE);
      prContrato.FINDFIRST;

      //. Buscamos el proveedor
      lrVendor.GET(prContrato.Proveedor);

      //. Buscamos la configuracion de IVA
      lrVATSetup.GET(lrVendor."VAT Bus. Posting Group", prContrato."Grupo registro iva prod.");
      lwIVA := 1 + lrVATSetup."VAT+EC %" / 100;

      //+$015 <
      "VAT %"                   := lrVATSetup."VAT+EC %";
      "VAT Bus. Posting Group"  := lrVendor."VAT Bus. Posting Group";
      "VAT Prod. Posting Group" := prContrato."Grupo registro iva prod.";
      //+$015 >

      EXIT(lwIVA);
    END;

    PROCEDURE ShowDetail@1100217001();
    VAR
      lrDet@1100217000 : Record 7010256;
      lfDetalle@1100217001 : Form 7010292;
    BEGIN
      lrDet.RESET;
      lrDet.FILTERGROUP(2);
      lrDet.SETRANGE(Delegacion     , Delegacion);
      lrDet.SETRANGE("Num. Servicio", "N§ Servicio");
      lrDet.SETRANGE("ID linea"     , "Orden Linea");
      lrDet.FILTERGROUP(0);

      CLEAR(lfDetalle);
      lfDetalle.SETTABLEVIEW(lrDet);
      lfDetalle.RUNMODAL;
    END;

    PROCEDURE NombreProveedor@1100217002() : Text[250];
    VAR
      lrVendor@1100217000 : Record 23;
    BEGIN
      IF lrVendor.GET(Proveedor) THEN
        EXIT(lrVendor.Name);
    END;

    LOCAL PROCEDURE _CheckPaxValidacion@1100217003();
    BEGIN
      CASE Concepto OF
        'EXAC':
        BEGIN
          CALCFIELDS("Pax Validados Trans");
          IF ("Pax Validados Trans" + "Pax Validacion") > "Cantidad Real" THEN
            ERROR(Text010);
        END;
        'EXCC':
        BEGIN
          CALCFIELDS("Pax Validados Excursion");
          IF ("Pax Validados Excursion" + "Pax Validacion") > "Cantidad Real" THEN
            ERROR(Text010);
        END;
        'EXGO':
        BEGIN
          CALCFIELDS("Pax Validados GO");
          IF ("Pax Validados GO" + "Pax Validacion") > "Cantidad Real" THEN
            ERROR(Text010);
        END;
      END;
    END;

    LOCAL PROCEDURE _CheckImporteValidacion@1100217004();
    BEGIN
      CASE Concepto OF
        'EXAC':
        BEGIN
          CALCFIELDS("Importe Validados Trans");
          IF "Importe con Impuesto" > 0 THEN BEGIN
            IF ("Importe Validados Trans" + "Importe Validacion") > "Importe con Impuesto" THEN
              ERROR(Text011);
          END
          ELSE BEGIN
            IF ("Importe Validados Trans" + "Importe Validacion") > -"Importe con Impuesto" THEN
              ERROR(Text011);
          END;
        END;
        'EXCC':
        BEGIN
          CALCFIELDS("Importe Validados Excursion");
          IF "Importe con Impuesto" > 0 THEN BEGIN
            IF ("Importe Validados Excursion" + "Importe Validacion") > "Importe con Impuesto" THEN
              ERROR(Text011);
          END
          ELSE BEGIN
            IF ("Importe Validados Excursion" + "Importe Validacion") > -"Importe con Impuesto" THEN
              ERROR(Text011);
          END;
        END;
        'EXGO':
        BEGIN
          CALCFIELDS("Importe Validados GO");
          IF "Importe con Impuesto" > 0 THEN BEGIN
            IF ("Importe Validados GO" + "Importe Validacion") > "Importe con Impuesto" THEN
              ERROR(Text011);
          END
          ELSE BEGIN
            IF ("Importe Validados GO" + "Importe Validacion") > -"Importe con Impuesto" THEN
              ERROR(Text011);
          END;
        END;
      END;
    END;

    PROCEDURE GetColor@1100217005() : Decimal;
    BEGIN
      IF "N§ Factura" <> '' THEN
        EXIT(16711680) //. Azul
      ELSE
      BEGIN
        IF Usuario = UPPERCASE(USERID) THEN
          EXIT(255); //. Rojo
      END;
    END;

    LOCAL PROCEDURE _CancelarDetalle@1000000000();
    VAR
      lrDet@1000000000 : Record 7010256;
    BEGIN
      // _CancelarDetalle

      lrDet.RESET;
      lrDet.SETRANGE(Delegacion     , Delegacion);
      lrDet.SETRANGE("Num. Servicio", "N§ Servicio");
      lrDet.SETRANGE("ID linea"     , "Orden Linea");
      IF lrDet.FINDSET(TRUE) THEN
        lrDet.DELETEALL;
    END;

    BEGIN
    {
      $001 JPT 29/05/12  CNT-CAR-12004/EXC-15 - Providers confirmations - Mostramos las lineas de confirmacion

      $002 JPT 29/06/12 A¤ado nuevo campo "Origen Concepto". Es una forma de subconcepto. CNT-CAR-12004/EXC-08 Transport Suport Service
                        A¤ado tambien Id Soporte

      $003 JPT 08/08/12 CNT-OC-12004 Incluir filtro por oficina en las excursiones. Nuevo campo Oficina

      $004 AJS 26032013 Cambio el nombre de la tabla a Coste excursiones

      $005 AJS 26032013 Marco como obsoletos los campos 9 y 11

      $006 AJS 20052013 Nuevos campos "Tipo cambio FPR" y "Tipo cambio Factura" para que se puedan conocer las diferencias de cambio
                        entre la prevision de coste y el momento de facturar

      $007 AJS 21052013 Redondeamos los importes cuando se hace la conversion a Divisa Local

      $008 AJS 15062013 Buscar el siguiente numero de orden en el OnInsert

      $009 AJS 15062013 Nuevos campos necesarios para el calculo de coste por ticket

      $010 AJS 16062013 Nuevo campo "Coste x Ticket" para reconocer las lineas creadas en la nueva rutina de calculo por ticket

      $011 AJS 17062013 Elimino la funcion ShowConfirmacionProv

      $012 AJS 17062013 Modifico los campos "Pax Validacion" e "Importe Validacion" para controlar que no se valide mas
                        de lo permitido

      $013 AJS 25062013 Marcamos campos Reservado Touroperador y Guia venta como obsoletos

      $014 AJS 09082013 Modifico las opciones del campo Tipo Elemento porque habia opciones obsoletas

      $015 AJS 14082013 Agrego la informacion de IVA en las lineas de coste

      $016 AJS 28082013 Relleno la propiedad DrillDownFormID con el valor 7010203

      $017 AJS 23092013 Nueva funcion GetColor para las ventanas de validacion de coste

      $018 AJS 24092013 Cambio el nombre del campo 23 para que sea Tipo Vehiculo en singular

      $019 AJS 28102013 Nueva clave para tener un campo calculado de coste por prestacion

      $020 AJS 19012014 El campo Importe no era editable, modifico el desglose de impuesto

      $021 AJS 29012014 Nueva funcion GetIVA para poderla llamar desde el reparto de coste por touroperador

      $022 AJS 11052014 Marco el campo Minimo como obsoleto

      $023 AJS 20082014 CNT-OC-14077, Nuevos campos para el calculo de costes exentos parcialmente de impuestos

      $024 AJS 24092014 Nuevo campo "Booking touroperador"

      $025 AJS 28012015 Amplio la clave Delegacion,N§ Servicio,Prestacion con el campo Num. Ticket y N§ Factura
                        y pongo Importe sin impuestos

      $026 AJS 28052015 Cuando se borra un registro borramos el detalle asociado

      $027 AJS 10062015 Elimino funci¢n ModificaValidacion porque es obsoleta
    }
    END.
  }
}

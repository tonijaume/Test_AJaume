OBJECT Table 7010360 Parte
{
  OBJECT-PROPERTIES
  {
    Date=05/06/15;
    Time=14:18:22;
    Modified=Yes;
    Version List=TRANSFER;
  }
  PROPERTIES
  {
    OnInsert=BEGIN
               rPar.FINDFIRST;
               rPar.TESTFIELD("Serie Partes");
               IF "N§ Parte" = '' THEN
                 "N§ Parte" := GestNoSerie.GetNextNo(rPar."Serie Partes", TODAY, TRUE);
               VALIDATE(Fecha      , TODAY);

               // Establece el campo "Precios por" por defecto

               "Ingreso Precios por" := rPar."Partes (Ingreso) Precios Por";
               "Coste Precios por"   := rPar."Partes (Coste) Precios Por";

               // Insertar creacion en el historico
               rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, text2,'',
                                      Text50000 + FORMAT(Fecha));

               VALIDATE("N§ viajes", 1);

               IF "Tipo Servicio" <> '' THEN
               BEGIN
                 IF rTipoSer.GET("Tipo Servicio") THEN
                   VALIDATE("Origen/Destino", rTipoSer."Pto Origen x Defecto");
               END;

               Version := 1;

               //. Rellenamos la fecha de creacion
               "Fecha creacion" := WORKDATE;
             END;

    OnModify=BEGIN
               // AJS --> Hay que comprobar que el parte no este confirmado

               IF Confirmado THEN
                 ERROR(err1, "N§ Parte");

               rPar.FINDFIRST;

               MantenVersion(TRUE); // Mantiene la versi¢n de impresion
               MantenNoExp(TRUE);  // Mantiene el campo "No Exportacion Prov"

               // Mantiene la tabla de Cambios Parte Impresi¢n
               IF (rPar."Empresa Real" IN [rPar."Empresa Real"::TRN, rPar."Empresa Real"::CNT]) THEN
                 cFunAdic.MantenCambiosImpresion(Rec);

               // Mantiene el campo de recogida
               ModificaRecogida;
             END;

    OnDelete=VAR
               lrVueloxParte@1100244000 : Record 7035335;
               lrCI@1100244002 : Record 7010414;
               lrAnota@1100253000 : Record 7010435;
               lrParteRecogida@1103355000 : Record 7010360;
               lrParte@1103355001 : Record 7010360;
             BEGIN
               // AJS --> Hay que comprobar que el parte no este confirmado

               IF Confirmado THEN
                 ERROR(err2);

               // ----  AJS 4.03.2002  ----
               // ----  Hay que comprobar que no haya lineas de coste ingreso asociadas a este parte, eso significaria que se facturo al
               // ----  menos una vez el parte y por lo tanto ahora no se puede borrar porque generaria una inconsistencia al
               // ----  hacer la factura de complementaria

               lrCI.RESET;
               lrCI.SETRANGE("N§ Parte", "N§ Parte");
               IF lrCI.FINDFIRST THEN
                 ERROR(err13);

               // JPT 29/12/08 Movemos los registros a la tabla Backup
               // En algunos casos puede no interesarnos hacer el backup
               IF NOT wBol[3] THEN
                 cFunAdic.MakePKParte(Rec);

               // AJF 07/10/08
               // Borramos Tambi‚n el parte de recogida si este tiene

               rPar.FINDFIRST;

               IF "Recogida Generada" <> '' THEN BEGIN
                 IF lrParteRecogida.GET("Recogida Generada") THEN BEGIN
                   IF NOT CONFIRM(Text031, TRUE) THEN
                     ERROR('');

                   // modifico la recogida para que no intente actualizar el campo al borrar la
                   // recogida y de un fallo recursivo.

                   "Recogida Generada" := '';
                   MODIFY;

                   lrParteRecogida.DELETE(TRUE);
                 END;
               END;

               // AJF 28/05/08
               // Si se elimina un parte de recogida hay que actualizar el campo de v¡nculo del parte origen.

               IF "Origen creacion" = "Origen creacion"::"Recogida Automatica" THEN BEGIN
                 lrParte.RESET;
                 lrParte.SETCURRENTKEY(Fecha, Cliente, "Touroperador principal");
                 lrParte.SETRANGE(Fecha                   , Fecha);
                 lrParte.SETRANGE(Cliente                 , Cliente);
                 lrParte.SETRANGE("Touroperador principal", "Touroperador principal");
                 lrParte.SETRANGE("Recogida Generada"     , "N§ Parte");

                 IF lrParte.FINDFIRST THEN BEGIN
                    lrParte.VALIDATE("Recogida Generada", '');
                    lrParte.MODIFY;


                    rHist.inserta_registro(rHist."Tipo Fichero"::Parte, lrParte."N§ Parte", 0, Text50001,
                                           Text50002 + lrParte."N§ Parte" + Text50003, '');

                 END;
               END;

               // AJS --> Hay que dejar las lineas de desglose libres para poder asociarlas a otro parte

               rHotSer.RESET;
               rHotSer.SETCURRENTKEY("N§ Parte");
               rHotSer.SETRANGE("N§ Parte", "N§ Parte");
               IF rHotSer.FINDSET(TRUE) THEN
                 rHotSer.MODIFYALL("N§ Parte", '');

               // AJS --> Hay que borrar los extras asociados al parte, las zonas de precios, los
               //         touroperadores x Parte y las zonas fisicas

               rExtPar.RESET;
               rExtPar.SETRANGE("N§ Parte", "N§ Parte");
               IF rExtPar.FINDSET(TRUE) THEN
                 rExtPar.DELETEALL;

               rZonPar.RESET;
               rZonPar.SETRANGE("N§ Parte", "N§ Parte");
               IF rZonPar.FINDSET(TRUE) THEN
                 rZonPar.DELETEALL;

               rToPar.RESET;
               rToPar.SETRANGE("N§ Parte", "N§ Parte");
               IF rToPar.FINDSET(TRUE) THEN
                 rToPar.DELETEALL;

               rZonFisPar.RESET;
               rZonFisPar.SETRANGE("N§ Parte", "N§ Parte");
               IF rZonFisPar.FINDSET(TRUE) THEN
                 rZonFisPar.DELETEALL;

               // Borra todas las lineas Vuelos X Parte asignadas

               lrVueloxParte.RESET;
               lrVueloxParte.SETRANGE("N§Parte" ,"N§ Parte");
               IF lrVueloxParte.FINDSET(TRUE) THEN
                 lrVueloxParte.DELETEALL;

               // Borramos tambien las lineas de anotaciones de Parte

               CLEAR(lrAnota);
               lrAnota.SETRANGE("N§ Parte","N§ Parte");
               IF lrAnota.FINDSET(TRUE) THEN
                 lrAnota.DELETEALL;

               // Borramos los subtrayectos

               rSubTrParte.RESET;
               rSubTrParte.SETRANGE("N§ Parte", "N§ Parte");
               IF rSubTrParte.FINDSET(TRUE) THEN
                 rSubTrParte.DELETEALL;

               // Actualizar los campos de viajes en los vehiculos y conductores.

               actualiza_vehiculo(Vehiculo, xRec.Vehiculo, Fecha);
               actualiza_conductor("Cod Conductor", xRec."Cod Conductor", Fecha);
               Coherencia_Actividad_Conductor("Fecha conductor", "Cod Conductor", xRec."Cod Conductor", Fecha);

               // Insertar borrado en el historico

               rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, text1, Text50000 + FORMAT(Fecha),
                                      DELCHR(Cliente, '<>') + ' - ' + DELCHR("Codigo Servicio", '<>'));
             END;

    OnRename=BEGIN
               // AJS --> No se pueden renombrar partes

               ERROR(err3);
             END;

    CaptionML=ESP=Parte;
    LookupFormID=Form7010401;
    DrillDownFormID=Form7010401;
  }
  FIELDS
  {
    { 1   ;   ;N§ Parte            ;Code10        ;AltSearchField=Codigo Barras;
                                                   CaptionML=ESP=N§ Parte;
                                                   Description=PK }
    { 3   ;   ;Garaje              ;Code10        ;TableRelation=Garaje;
                                                   OnValidate=BEGIN
                                                                // El control de garaje cerrado solo tiene que hacerse si el usuario modifica el garaje
                                                                // directamente en el formulario

                                                                IF CurrFieldNo = FIELDNO(Garaje) THEN
                                                                  rGaraje.ControlCerrado(Garaje);

                                                                IF Garaje <> xRec.Garaje THEN BEGIN
                                                                  actualizar_viajes("N§ Parte");

                                                                  IF xRec.Garaje <> '' THEN BEGIN
                                                                    "Garaje cambiado" := TRUE;
                                                                    "Garaje anterior" := xRec.Garaje;
                                                                  END;

                                                                  // Registramos en el historico

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Garaje),
                                                                                         xRec.Garaje, Garaje);

                                                                  MantenVersion("N§ Parte" <> ''); // Mantenemos la versi¢n tambien desde aqui si es modificacion

                                                                END;
                                                              END;

                                                   CaptionML=ESP=Garaje;
                                                   SQL Data Type=Varchar;
                                                   NotBlank=Yes;
                                                   Description=FK Garaje }
    { 5   ;   ;Fecha               ;Date          ;OnValidate=VAR
                                                                lrTTOOParte@1103350000 : Record 7010365;
                                                              BEGIN
                                                                IF Fecha <> xRec.Fecha THEN BEGIN

                                                                  // AJS 16.06.2004
                                                                  // Compruebo que este haciendo la modificacion directamente sobre el campo para que no me salten los mensajes
                                                                  // cuando trabajo con el interfase

                                                                  IF GUIALLOWED THEN
                                                                  BEGIN
                                                                    IF Fecha < TODAY THEN
                                                                      MESSAGE(Text005);

                                                                    //BRM 16/06/04

                                                                    IF (CALCDATE(Text50004,Fecha) = xRec.Fecha) THEN BEGIN
                                                                      IF CONFIRM(Text008,FALSE) THEN
                                                                        "Dia siguiente" := TRUE;
                                                                    END;
                                                                  END;

                                                                  rPar.FINDFIRST; //+$004
                                                                  IF (NOT "Dia siguiente") OR (rPar."Empresa Real" = rPar."Empresa Real"::IBZ) THEN //+$004
                                                                    VALIDATE("Fecha facturacion", Fecha);

                                                                   // JPT 13/01/05 Rellenamos el nuevo campo en TTOOxParte

                                                                   CLEAR(lrTTOOParte);
                                                                   lrTTOOParte.SETRANGE("N§ Parte","N§ Parte");
                                                                   IF lrTTOOParte.FINDSET(TRUE) THEN
                                                                     lrTTOOParte.MODIFYALL("Fecha Servicio Parte",Fecha);

                                                                  // Registramos en el historico

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Fecha),
                                                                                         FORMAT(xRec.Fecha), FORMAT(Fecha));
                                                                  ActualizaHoraDT;
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Fecha;
                                                   NotBlank=Yes }
    { 6   ;   ;Fecha Real          ;Date          ;CaptionML=ESP=Fecha Real;
                                                   Editable=No }
    { 7   ;   ;Cliente             ;Code20        ;TableRelation=Customer;
                                                   OnValidate=VAR
                                                                lrCliente@1103355000 : Record 18;
                                                              BEGIN
                                                                IF Cliente <> xRec.Cliente THEN BEGIN

                                                                  actualizar_viajes("N§ Parte");

                                                                  // AJS 04.03.04
                                                                  // Si el cliente tiene un solo touroperador se rellena automaticamente

                                                                  rCliTo.RESET;
                                                                  rCliTo.SETRANGE(Cliente, Cliente);

                                                                  // AJS 30.06.2006
                                                                  // Hay que controlar que el touroperador no este inhabilitado

                                                                  rCliTo.SETRANGE("Operativa Deshabilitada", FALSE);

                                                                  IF rCliTo.COUNT = 1 THEN BEGIN
                                                                    rCliTo.FINDFIRST;
                                                                    VALIDATE("Touroperador principal", rCliTo.TTOO);
                                                                  END;

                                                                  // AJF 06/06/08
                                                                  // Buscamos el registro del cliente para actualizar el valor de busca precio ingreso.
                                                                  IF lrCliente.GET(Cliente) THEN
                                                                    "Busca precio ingreso" := lrCliente."Busca precio ingreso";

                                                                  // Registramos en el historico

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Cliente),
                                                                                         xRec.Cliente, Cliente);

                                                                  GetGestor;  // JPT 15/05/05 Actualiza el codigo del gestor
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Cliente;
                                                   SQL Data Type=Varchar;
                                                   Description=FK Cliente }
    { 9   ;   ;Codigo Servicio     ;Code10        ;TableRelation="Codigo servicio".Codigo WHERE (Filtro Cliente=FIELD(Cliente),
                                                                                                 Filtro Touroperador=FIELD(Touroperador principal));
                                                   OnValidate=BEGIN
                                                                IF "Codigo Servicio" <> xRec."Codigo Servicio" THEN BEGIN
                                                                  rCodSer.GET("Codigo Servicio");
                                                                  VALIDATE("Tipo Servicio", rCodSer."Tipo servicio");
                                                                  actualizar_viajes("N§ Parte");

                                                                  // Registramos en el historico

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Codigo Servicio"),
                                                                                         xRec."Codigo Servicio", "Codigo Servicio");

                                                                END;
                                                              END;

                                                   CaptionML=ESP=Codigo Servicio;
                                                   SQL Data Type=Varchar;
                                                   Description="Codigo servicio".Codigo WHERE (Filtro Cliente=FIELD(Cliente),Filtro Touroperador=FIELD(Touroperador principal),Tiene precio x cliente=CONST(S¡)) }
    { 11  ;   ;Tipo Servicio       ;Code10        ;TableRelation="Tipo Servicio".Codigo;
                                                   OnValidate=BEGIN
                                                                IF "Tipo Servicio" <> xRec."Tipo Servicio" THEN BEGIN
                                                                  rTipoSer.GET("Tipo Servicio");
                                                                  VALIDATE("Calcular maletas", rTipoSer."Calcular Maletas");
                                                                  actualizar_viajes("N§ Parte");
                                                                // ----  AGM 14.03.2001 Rellenar el Campo Origen/Destino apartir de un parametro
                                                                  VALIDATE("Origen/Destino", rTipoSer."Pto Origen x Defecto");
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Tipo Servicio;
                                                   SQL Data Type=Varchar;
                                                   Description=FK Tipo Servicio;
                                                   Editable=No }
    { 13  ;   ;Vehiculo            ;Code10        ;TableRelation=Vehiculo.Matricula;
                                                   OnValidate=VAR
                                                                rVeh@1100244000 : Record 7010346;
                                                                lrConductor@1100244001 : Record 7010327;
                                                                lfTablaConductor@1100244002 : Form 7010358;
                                                                lrTTOOPart@1100253000 : Record 7010365;
                                                                lwPaxT@1100244003 : Decimal;
                                                              BEGIN
                                                                IF Vehiculo <> xRec.Vehiculo THEN BEGIN

                                                                  // AML --> Se comprueba que el dia esta abierto.

                                                                  rPar.FINDFIRST;

                                                                  //RRT. 08.06.04 -> Aplicar a SJO la misma problematica que IBZ.
                                                                  IF (rPar."Empresa Real" <> rPar."Empresa Real"::IBZ) AND
                                                                     (rPar."Empresa Real" <> rPar."Empresa Real"::SJO) THEN
                                                                  BEGIN
                                                                    IF NOT rDiasAbiertos.GET(Fecha) AND (NOT wBol[1]) THEN
                                                                      ERROR(err14, Fecha);
                                                                  END;

                                                                  // AJS 06.02.2004
                                                                  // Contemplar que se pueda dejar el vehiculo en blanco

                                                                  IF Vehiculo <> '' THEN BEGIN
                                                                    rPar.FINDFIRST;
                                                                    rVeh.GET(Vehiculo);
                                                                    rVeh.AvisoRevision; // comprueba revisiones ptes.

                                                                    // Comprobamos que el vehiculo tenga las plazas necesarios

                                                                    CALCFIELDS("Adultos transportados","Ni¤os transportados");
                                                                    lwPaxT := "Adultos transportados" + "Ni¤os transportados";
                                                                    IF lwPaxT > rVeh.Plazas THEN
                                                                      IF NOT CONFIRM(Text003, FALSE, lwPaxT, rVeh.Plazas, "N§ Parte") THEN
                                                                        ERROR(Text004);

                                                                    IF rPar."Restringir recursos x garaje" THEN
                                                                      IF rVeh.Garaje <> Garaje THEN
                                                                        ERROR(err10);
                                                                    IF rVeh.Bloqueado THEN
                                                                      ERROR(err5, rVeh."Fecha final actividad");

                                                                    // AJS 26.06.2006
                                                                    // Control de vehiculo escolar o adaptado a minusvalidos

                                                                    IF "Vehiculo Escolar" AND (NOT rVeh."Transporte escolar") THEN
                                                                      ERROR(Text022);

                                                                    IF "Vehiculo Minusvalidos" AND (NOT rVeh."Adaptado minusvalidos") THEN
                                                                      ERROR(Text023);

                                                                    // AJF 10/04/08 - DRF IBZ 07002

                                                                    IF "Vehiculo especial" AND (NOT rVeh."Vehiculo especial") THEN
                                                                      ERROR(Text027);


                                                                    VALIDATE("Vehiculo Agregado", rVeh.Agregado);

                                                                    // AJS 06.02.2004
                                                                    // Si la asignacion se hace desde la ventana de asignacion rapida que no salgan los mensajes

                                                                    IF NOT "Asignacion rapida" THEN BEGIN

                                                                      // Miramos si el vehiculo tiene alguna incidencia abierta

                                                                      rVeh.SETFILTER ("Filtro Fecha Inicio", '<= %1', Fecha);
                                                                      rVeh.SETFILTER ("Filtro Fecha Fin", '= %1 | > %2', 0D , Fecha);
                                                                      rVeh.CALCFIELDS(rVeh."Tiene Incidencias Abiertas");
                                                                      IF rVeh."Tiene Incidencias Abiertas" THEN
                                                                        MESSAGE(msg1);

                                                                      // A partir del vehiculo se asignara el conductor *** UEX ****************
                                                                      // Si hay varios conductores asignados a ese vehiculo aparecera una tabla de seleccion

                                                                      IF NOT wBol[2] THEN BEGIN // JPT 15/05/06 Si es importacion No automatizamos el conductor
                                                                        lrConductor.RESET;
                                                                        lrConductor.SETRANGE("Vehiculo habitual", Vehiculo);
                                                                        IF lrConductor.FINDFIRST THEN BEGIN
                                                                          CLEAR(lfTablaConductor);
                                                                          IF lrConductor.COUNT > 1 THEN BEGIN
                                                                            lfTablaConductor.SETTABLEVIEW(lrConductor);
                                                                            lfTablaConductor.LOOKUPMODE(TRUE);
                                                                            lfTablaConductor.RUNMODAL;
                                                                            lfTablaConductor.GETRECORD(lrConductor);
                                                                          END;
                                                                          VALIDATE("Cod Conductor", lrConductor.Conductor);
                                                                        END;
                                                                      END;

                                                                      // ----  AJS 30.05.2003 Se ha incluido un nuevo campo en los vehiculos para indicar cual es su conductor habitual  ----

                                                                      IF "Cod Conductor" = '' THEN BEGIN
                                                                        IF rVeh."Conductor habitual" <> '' THEN
                                                                          VALIDATE("Cod Conductor", rVeh."Conductor habitual");
                                                                      END;
                                                                    END;

                                                                    // AJS 13.07.2004
                                                                    // Si existe una restriccion de imagen del vehiculo contra un touroperador

                                                                    IF rRestricImagen.GET("Touroperador principal", rVeh."Imagen Vehiculo") THEN
                                                                      ERROR(Text010, rVeh."Imagen Vehiculo", "Touroperador principal");

                                                                    "N§ Vehiculo"               := rVeh.Numero;
                                                                    "Tipo Vehiculo"             := rVeh."Tipo vehiculo";
                                                                    IF "Tipo Vehiculo facturacion" = '' THEN
                                                                      VALIDATE("Tipo Vehiculo facturacion", rVeh."Tipo vehiculo");

                                                                    // ----  Si el vehiculo es externo hay que pasarle el proveedor al parte  ----

                                                                    VALIDATE(Proveedor, rVeh."Empresa propietaria");

                                                                    // AJS 13.04.2004
                                                                    // Si el parte ya estaba asignado marcarlo para mostrar de manera especial en la ventana control operaciones

                                                                    IF xRec.Vehiculo <> '' THEN BEGIN

                                                                      // AJS 14.04.2004
                                                                      // Solo se marca si el cambio se hace para en el mismo dia del parte

                                                                      IF TODAY = Fecha THEN BEGIN
                                                                        "Vehiculo cambiado" := TRUE;
                                                                      END;
                                                                    END;

                                                                  END
                                                                  ELSE BEGIN
                                                                    "N§ Vehiculo" := '';
                                                                    "Tipo Vehiculo" := '';
                                                                    "Tipo Vehiculo facturacion" := '';
                                                                  END;
                                                                  // ----  Actualizar los campos de viajes en el vehiculo  ----

                                                                  actualiza_vehiculo(Vehiculo, xRec.Vehiculo, Fecha);

                                                                  CompVehConductor; // Avisamos si al conductor se le ha asignado otro vehiculo para el mismo d¡a

                                                                  // ----  Registramos en el historico  ----

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Vehiculo), xRec.Vehiculo, Vehiculo);
                                                                END;
                                                              END;

                                                   OnLookup=VAR
                                                              rVeh@1100244000 : Record 7010346;
                                                            BEGIN
                                                              rPar.FINDFIRST;
                                                              rVeh.RESET;
                                                              IF rPar."Restringir recursos x garaje" THEN
                                                                rVeh.SETRANGE(Garaje, Garaje);
                                                              IF FORM.RUNMODAL(0, rVeh) = ACTION::LookupOK THEN
                                                              BEGIN
                                                                VALIDATE(Vehiculo, rVeh.Matricula);
                                                              END;
                                                            END;

                                                   CaptionML=ESP=Vehiculo;
                                                   SQL Data Type=Varchar;
                                                   Description=FK Vehiculo }
    { 15  ;   ;Cod Conductor       ;Code10        ;TableRelation=Conductor.Conductor;
                                                   OnValidate=VAR
                                                                rCond@1100244000 : Record 7010327;
                                                                CONDUCTOR_BLOQUEADO@1100244001 : TextConst 'ESP=El conductor %1 est  bloqueado. No puede por tanto asignarse a un parte de trabajo';
                                                                lrInc@1103350000 : Record 7010333;
                                                              BEGIN
                                                                // AML --> Se comprueba que el dia esta abierto.

                                                                rPar.FINDFIRST;

                                                                IF (rPar."Empresa Real" <> rPar."Empresa Real"::IBZ) AND
                                                                   (rPar."Empresa Real" <> rPar."Empresa Real"::SJO) AND (NOT wBol[1]) THEN BEGIN
                                                                  IF NOT rDiasAbiertos.GET(Fecha) THEN
                                                                    ERROR(err14, Fecha);
                                                                END;

                                                                // AJS 06.02.2004
                                                                // Contemplar que se pueda dejar el conductor en blanco

                                                                IF "Cod Conductor" <> '' THEN
                                                                BEGIN

                                                                  // Comprueba que el conductor no tenga ninguna incidencia

                                                                  IF rPar."Empresa Real" IN [rPar."Empresa Real"::UEX] THEN BEGIN
                                                                    lrInc.RESET;
                                                                    lrInc.SETCURRENTKEY(Conductor,Prioridad,"Fecha Desde","Fecha Hasta");
                                                                    lrInc.SETRANGE(Conductor, "Cod Conductor");
                                                                    lrInc.SETFILTER("Fecha Desde" ,'<=%1',Fecha);
                                                                    lrInc.SETFILTER("Fecha Hasta" ,'>=%1|%2',Fecha,0D);
                                                                    IF lrInc.FINDFIRST THEN
                                                                      ERROR(Text011,lrInc.Conductor,lrInc."Cod Motivo");
                                                                  END;

                                                                  rCond.GET("Cod Conductor");
                                                                  IF rCond.Bloqueado THEN
                                                                    ERROR(CONDUCTOR_BLOQUEADO,rCond."Nombre Abreviado");
                                                                  IF rPar."Restringir recursos x garaje" THEN
                                                                    IF rCond.Garaje <> Garaje THEN
                                                                      ERROR(err11);

                                                                  Conductor := rCond."Nombre Abreviado";

                                                                  // AJS 06.02.2004
                                                                  // Si la asignacion se hace desde la ventana de asignacion rapida que no salgan los mensajes

                                                                  IF NOT "Asignacion rapida" THEN BEGIN
                                                                    comprobar_conductor("Cod Conductor", Fecha, Conductor);

                                                                    // JPT 07/09/01
                                                                    // Para UEX la asignaci¢n de conductor se realiza a partir del vehiculo
                                                                    IF NOT wBol[2] THEN BEGIN // JPT 15/05/06 Si es importacion No automatizamos el vehiculo
                                                                      IF (Vehiculo = '') AND (rCond."Vehiculo habitual" <> '') THEN
                                                                        VALIDATE(Vehiculo, rCond."Vehiculo habitual");
                                                                    END;
                                                                  END;

                                                                  // JPT No dejar asignar si no se ha rellenado el campo "Hora de Inicio"
                                                                  IF "Hora inicio" =  0T THEN
                                                                    ERROR(Text013, FIELDCAPTION("Hora inicio"));

                                                                END
                                                                ELSE
                                                                  Conductor := '';

                                                                // AJS 22.09.2005
                                                                // Si se cambia el conductor hay que dejar el campo "Fecha conductor" en blanco para que el registro de
                                                                // actividad sea coherente

                                                                IF "Cod Conductor" <> xRec."Cod Conductor" THEN
                                                                  "Fecha conductor" := 0D;

                                                                // Actualizar los campos de viajes en el conductor

                                                                actualiza_conductor("Cod Conductor", xRec."Cod Conductor", Fecha);

                                                                // Comprobar la coherencia del registro de actividad del conductor

                                                                Coherencia_Actividad_Conductor("Fecha conductor", "Cod Conductor", xRec."Cod Conductor", Fecha);

                                                                CompVehConductor; // Avisamos si al conductor se le ha asignado otro vehiculo para el mismo d¡a

                                                                // Registramos en el historico

                                                                rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Cod Conductor"),
                                                                                       xRec."Cod Conductor", "Cod Conductor");
                                                              END;

                                                   OnLookup=VAR
                                                              rCon@1100244000 : Record 7010327;
                                                            BEGIN
                                                              rPar.FINDFIRST;
                                                              rCon.RESET; rCon.INIT;
                                                              IF rPar."Restringir recursos x garaje" THEN
                                                                rCon.SETRANGE(Garaje, Garaje);

                                                              CLEAR(fConsulta);
                                                              fConsulta.RecogeFecha(Fecha);
                                                              fConsulta.SETTABLEVIEW(rCon);
                                                              fConsulta.LOOKUPMODE(TRUE);
                                                              IF fConsulta.RUNMODAL = ACTION::LookupOK THEN BEGIN
                                                                fConsulta.GETRECORD(rCon);
                                                                // JPT 24/02/10 Si no tiene N§ no validamos el campo. Suponemos que es un filtro
                                                                // Es para evitar validaciones erroneas en los reqfilterfields de los reports
                                                                IF "N§ Parte" = '' THEN
                                                                  SETRANGE("Cod Conductor", rCon.Conductor)
                                                                ELSE
                                                                  VALIDATE("Cod Conductor", rCon.Conductor);
                                                              END;
                                                            END;

                                                   CaptionML=ESP=Cod Conductor;
                                                   SQL Data Type=Varchar;
                                                   Description=FK Conductor }
    { 17  ;   ;Guia                ;Text30        ;OnValidate=BEGIN
                                                                IF Guia <> xRec.Guia THEN BEGIN

                                                                   cFunBas.ValidaGuia(Guia);
                                                                  // Registramos en el historico
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Guia), xRec.Guia, Guia);
                                                                END;
                                                              END;

                                                   OnLookup=VAR
                                                              lwGuia@1103350000 : Text[30];
                                                            BEGIN
                                                              lwGuia := Guia;
                                                              IF cFunBas.LookUpGuia(lwGuia) THEN
                                                                VALIDATE(Guia,lwGuia);
                                                            END;

                                                   CaptionML=ESP=Guia }
    { 19  ;   ;Referencia          ;Text30        ;OnValidate=BEGIN
                                                                IF Referencia <> xRec.Referencia THEN BEGIN
                                                                  // Registramos en el historico


                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Referencia), xRec.Referencia, Referencia);
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Referencia }
    { 21  ;   ;Observaciones       ;Text250       ;CaptionML=ESP=Observaciones }
    { 23  ;   ;Letreros            ;Text30        ;OnValidate=BEGIN
                                                                IF Letreros <> xRec.Letreros THEN BEGIN
                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Letreros),
                                                                                         xRec.Letreros, Letreros);

                                                                END;

                                                                IF Letreros='' THEN BEGIN
                                                                  CLEAR("Imprimir Letreros");
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Letreros }
    { 24  ;   ;Imprimir Letreros   ;Boolean       ;OnValidate=BEGIN
                                                                IF Letreros='' THEN
                                                                  ERROR(Text015,FIELDCAPTION(Letreros));
                                                              END;

                                                   CaptionML=ESP=Imprimir Letreros }
    { 25  ;   ;Origen/Destino      ;Code10        ;TableRelation="Punto de recogida".Codigo;
                                                   OnValidate=BEGIN
                                                                IF "Origen/Destino" <> xRec."Origen/Destino" THEN BEGIN

                                                                  // AJF 27/06/08
                                                                  // Si cambiamos el campo desde formulario pedir confirmaci¢n
                                                                  IF CurrFieldNo = FIELDNO("Origen/Destino") THEN BEGIN
                                                                    IF NOT CONFIRM(Text028, FALSE) THEN
                                                                      ERROR(Text004);
                                                                  END;
                                                                  // Buscamos el Origen/Destino para obtener la presentacion

                                                                  IF rPtoRec.GET("Origen/Destino") THEN
                                                                    Presentacion := COPYSTR(rPtoRec.Descripci¢n, 1, MAXSTRLEN(Presentacion));

                                                                  // Registramos en el historico

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Origen/Destino"),
                                                                                         xRec."Origen/Destino", "Origen/Destino");
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Origen/Destino;
                                                   SQL Data Type=Varchar;
                                                   Description=FK Punto de recogida }
    { 27  ;   ;Hora inicio         ;Time          ;OnValidate=VAR
                                                                vHora@1100244000 : Text[8];
                                                              BEGIN
                                                                IF "Hora inicio" <> xRec."Hora inicio" THEN BEGIN
                                                                  //IF "Hora final" <> 0T THEN
                                                                  //  IF "Hora final" < "Hora inicio" THEN
                                                                      //ERROR(err4);

                                                                  IF Fecha = TODAY THEN BEGIN
                                                                    IF "Hora inicio" < TIME THEN
                                                                      MESSAGE(Text006);
                                                                  END;

                                                                  //Desconfirmamos el registro de actividad correspondiente si ya no est  contenido en
                                                                  //ning£n periodo existente.
                                                                  rPar.FINDFIRST;
                                                                  IF rPar."Desvalidar registro actividad" THEN BEGIN
                                                                    IF ("Cod Conductor"<>'') AND ("Fecha conductor" <> 0D) THEN BEGIN
                                                                      IF NOT ContenidoEnPeriodo THEN BEGIN
                                                                        Desvalidar_Registro_Actividad("Cod Conductor","Fecha conductor");
                                                                        "Fecha conductor" := 0D;
                                                                      END;
                                                                    END;
                                                                  END;

                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION("Hora inicio"), FORMAT(xRec."Hora inicio"), FORMAT("Hora inicio"));
                                                                 ActualizaHoraDT;
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Hora inicio;
                                                   NotBlank=Yes }
    { 28  ;   ;Hora Inicio DT      ;DateTime      ;OnValidate=VAR
                                                                lrSerPar@1103355000 : Record 7010359;
                                                              BEGIN
                                                                // AJS 27.03.2008
                                                                // Pasamos este campo a las lineas de recogida

                                                                HIniDTBI; // Actualizamos campo "Hora Inicio BI"

                                                                IF (CurrFieldNo = FIELDNO("Hora inicio")) OR
                                                                   (CurrFieldNo = FIELDNO(Fecha)) THEN
                                                                BEGIN
                                                                  lrSerPar.RESET;
                                                                  lrSerPar.SETCURRENTKEY("N§ Parte");
                                                                  lrSerPar.SETRANGE("N§ Parte", "N§ Parte");
                                                                  IF lrSerPar.FINDSET(TRUE) THEN BEGIN
                                                                    // JPT 02/02/10 Datetime a Biginteger
                                                                    lrSerPar.MODIFYALL("FechaHora Parte", "Hora Inicio DT");
                                                                    lrSerPar.MODIFYALL("FechaHora Parte BI", "Hora Inicio BI");
                                                                  END;
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Hora Inicio DT }
    { 29  ;   ;Confirmado          ;Boolean       ;OnValidate=BEGIN
                                                                // Registramos en el historico

                                                                rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION(Confirmado), FORMAT(xRec.Confirmado),
                                                                                         FORMAT(Rec.Confirmado));
                                                              END;

                                                   CaptionML=ESP=Confirmado }
    { 30  ;   ;Hora Inicio BI      ;BigInteger    ;OnValidate=BEGIN
                                                                // JPT 02/02/10 Datetime a Biginteger
                                                                "Hora Inicio DT" := cFunBas.BIGINTtoDT("Hora Inicio BI");
                                                              END;
                                                               }
    { 31  ;   ;Adultos transportados;Decimal      ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Servicios - Partes"."Adultos transportados" WHERE (N§ Parte=FIELD(N§ Parte)));
                                                   CaptionML=ESP=Adultos transportados;
                                                   DecimalPlaces=0:2;
                                                   Description=Campo calculado sobre Servicios - Partes;
                                                   Editable=No }
    { 33  ;   ;Ni¤os transportados ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Servicios - Partes"."Ni¤os transportados" WHERE (N§ Parte=FIELD(N§ Parte)));
                                                   CaptionML=ESP=Ni¤os transportados;
                                                   DecimalPlaces=0:2;
                                                   Description=Campo calculado sobre Servicios - Partes;
                                                   Editable=No }
    { 51  ;   ;Proveedor           ;Code20        ;TableRelation=Vendor;
                                                   OnValidate=VAR
                                                                lrTTOOxParte@1100244000 : Record 7010365;
                                                                lrContComp@1100244001 : Record 7010408;
                                                                lwPrimero@1103355000 : Boolean;
                                                                lwEnc@1103355001 : Boolean;
                                                              BEGIN
                                                                IF Proveedor <> xRec.Proveedor THEN BEGIN
                                                                  // Actualizamos 'Contrato compra' en TTOO x parte
                                                                  lrTTOOxParte.RESET;
                                                                  lrTTOOxParte.SETRANGE("N§ Parte" , "N§ Parte");
                                                                  IF Proveedor = '' THEN BEGIN
                                                                    lrTTOOxParte.MODIFYALL("N§ Contrato compra", '',TRUE);
                                                                  END
                                                                  ELSE BEGIN
                                                                    IF lrTTOOxParte.FINDSET(TRUE) THEN BEGIN
                                                                      lwPrimero := TRUE;
                                                                      REPEAT
                                                                        // JPT 27/12/05 Cambio a la nueva codeunit de calculo
                                                                        // lcCalPar.busca_contrato_compra(lrContComp ,Proveedor, lrTTOOxParte.Touroperador,
                                                                        //                                Cliente ,  "Fecha facturacion", Garaje );
                                                                        lwEnc := cCalcR.BuscaContratoCompraReal(lrContComp ,Proveedor,
                                                                                                                lrTTOOxParte.Touroperador,Cliente , "Fecha facturacion", Garaje );
                                                                        lrTTOOxParte."N§ Contrato compra":= lrContComp."N§ Contrato";
                                                                        lrTTOOxParte.MODIFY(TRUE);

                                                                        IF lwPrimero AND lwEnc THEN BEGIN
                                                                          VALIDATE("Tipo calculo coste", lrContComp."Tipo calculo coste");
                                                                          lwPrimero := FALSE;
                                                                        END;
                                                                      UNTIL lrTTOOxParte.NEXT = 0;
                                                                    END;
                                                                  END;

                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Proveedor),
                                                                                         xRec.Proveedor, Proveedor);
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Proveedor;
                                                   Description=FK Proveedor }
    { 53  ;   ;Fecha facturacion   ;Date          ;OnValidate=BEGIN
                                                                IF "Fecha facturacion" <> xRec."Fecha facturacion" THEN BEGIN
                                                                  //Actualizamos la tabla Servicios - Partes.
                                                                  actualizar_viajes("N§ Parte");

                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Fecha facturacion"),
                                                                                         FORMAT(xRec."Fecha facturacion"), FORMAT("Fecha facturacion"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Fecha facturacion;
                                                   NotBlank=Yes }
    { 55  ;   ;Tipo Vehiculo facturacion;Code10   ;TableRelation="Tipo Vehiculo".Codigo;
                                                   OnValidate=VAR
                                                                lrTTOOxPar@1100244000 : Record 7010365;
                                                              BEGIN
                                                                IF "Tipo Vehiculo facturacion" <> xRec."Tipo Vehiculo facturacion" THEN BEGIN
                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION("Tipo Vehiculo facturacion"),
                                                                                         xRec."Tipo Vehiculo facturacion", "Tipo Vehiculo facturacion");

                                                                  // JPT- 25/01/02 Mantenemos "touroperador x parte"
                                                                  lrTTOOxPar.RESET;
                                                                  lrTTOOxPar.SETRANGE("N§ Parte", "N§ Parte");
                                                                  IF lrTTOOxPar.FINDSET(TRUE) THEN
                                                                    lrTTOOxPar.MODIFYALL("Tipo Vehiculo","Tipo Vehiculo facturacion");

                                                                END;
                                                              END;

                                                   CaptionML=ESP=Tipo Vehiculo facturacion;
                                                   NotBlank=Yes;
                                                   Description=FK Tipo Vehiculo }
    { 57  ;   ;Tipo Vehiculo       ;Code10        ;TableRelation="Tipo Vehiculo";
                                                   CaptionML=ESP=Tipo Vehiculo;
                                                   Description=FK Tipo Vehiculo;
                                                   Editable=No }
    { 58  ;   ;Vehiculo Agregado   ;Boolean       ;CaptionML=ESP=Vehiculo Agregado;
                                                   Editable=No }
    { 59  ;   ;Hora final          ;Time          ;OnValidate=BEGIN
                                                                IF "Hora final" <> xRec."Hora final" THEN
                                                                BEGIN

                                                                  //Desconfirmamos el registro de actividad correspondiente si ya no est  contenido en
                                                                  //ning£n periodo existente.
                                                                  rPar.FINDSET;
                                                                  IF rPar."Desvalidar registro actividad" THEN
                                                                  BEGIN
                                                                    IF ("Cod Conductor" <> '') AND ("Fecha conductor" <> 0D) AND ("Hora final" <> 0T) THEN
                                                                    BEGIN
                                                                      IF NOT ContenidoEnPeriodo THEN
                                                                      BEGIN
                                                                        Desvalidar_Registro_Actividad("Cod Conductor","Fecha conductor");
                                                                        "Fecha conductor" := 0D;
                                                                      END;
                                                                    END;
                                                                  END;

                                                                  // Registramos en el historico
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION("Hora final"), FORMAT(xRec."Hora final"),
                                                                                         FORMAT("Hora final"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Hora final }
    { 61  ;   ;N§ viajes           ;Decimal       ;OnValidate=BEGIN
                                                                IF "N§ viajes" <> xRec."N§ viajes" THEN BEGIN
                                                                  //Actualizamos la Tabla Servicios-Parte.
                                                                  actualizar_viajes("N§ Parte");

                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION("N§ viajes"), FORMAT(xRec."N§ viajes"),
                                                                                         FORMAT("N§ viajes"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=N§ viajes;
                                                   MinValue=0;
                                                   MaxValue=999 }
    { 63  ;   ;Tipo aplicacion ingreso;Option     ;OnValidate=BEGIN
                                                                IF "Tipo aplicacion ingreso" <> xRec."Tipo aplicacion ingreso" THEN BEGIN
                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION("Tipo aplicacion ingreso"),
                                                                                         FORMAT(xRec."Tipo aplicacion ingreso"),
                                                                                         FORMAT("Tipo aplicacion ingreso"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Tipo aplicacion ingreso;
                                                   OptionCaptionML=ESP=Independiente,Mayor importe;
                                                   OptionString=Independiente,Mayor importe }
    { 65  ;   ;Tipo Calculo        ;Option        ;CaptionML=ESP=Tipo Calculo;
                                                   OptionCaptionML=ESP=Margen,Confirmacion;
                                                   OptionString=Margen,Confirmacion;
                                                   Editable=No }
    { 67  ;   ;Errores             ;Boolean       ;FieldClass=FlowField;
                                                   CalcFormula=Exist("TRF-Error calculo" WHERE (N§ Parte=FIELD(N§ Parte),
                                                                                                Tipo=CONST(Error)));
                                                   TableRelation="TRF-Error calculo";
                                                   OnLookup=BEGIN
                                                              rErr.RESET; rErr.INIT;
                                                              rErr.SETRANGE("N§ Parte", "N§ Parte");
                                                              rErr.SETRANGE(Tipo      , rErr.Tipo::Error);
                                                              FORM.RUNMODAL(0, rErr);
                                                            END;

                                                   CaptionML=ESP=Errores;
                                                   Description=Calculado sobre Error Calculo;
                                                   Editable=No }
    { 69  ;   ;Adultos trans. soporte;Decimal     ;CaptionML=ESP=Adultos trans. soporte;
                                                   DecimalPlaces=0:2;
                                                   Description=Soporte del campo calculado para poder hacer campos calculados sobre este campo.;
                                                   Editable=No }
    { 71  ;   ;Ni¤os trans. soporte;Decimal       ;CaptionML=ESP=Ni¤os trans. soporte;
                                                   DecimalPlaces=0:2;
                                                   Description=Soporte del campo calculado para poder hacer campos calculados sobre este campo.;
                                                   Editable=No }
    { 73  ;   ;Vuelos              ;Text140       ;OnValidate=VAR
                                                                lrSerPar@1100253000 : Record 7010359;
                                                                lwPrimero@1100253001 : Boolean;
                                                              BEGIN
                                                                rPar.FINDSET;
                                                                IF Vuelos <> xRec.Vuelos THEN BEGIN
                                                                  // JPT 05/04/06 TRN pidio introducir los vuelos a nivel de cabecera
                                                                  IF rPar."Empresa Real" IN  [rPar."Empresa Real"::TRN] THEN BEGIN
                                                                    lrSerPar.formatea_lista_vuelos(Vuelos, "Hora 1er Vuelo", Fecha);
                                                                    CLEAR(lrSerPar);
                                                                    lrSerPar.SETCURRENTKEY("N§ Parte","N§ Linea");
                                                                    lrSerPar.SETRANGE("N§ Parte", "N§ Parte");
                                                                    IF lrSerPar.FINDSET(TRUE) THEN BEGIN
                                                                      lwPrimero:= TRUE;
                                                                      REPEAT
                                                                        // AJF 30.01.2008 - DRF 07004
                                                                        // En shuttle los vuelos se tratan de otra manera.
                                                                        IF ("Origen creacion" <> "Origen creacion"::Shuttle) THEN BEGIN
                                                                          IF lwPrimero THEN
                                                                            lrSerPar.Vuelo := Vuelos
                                                                          ELSE
                                                                            lrSerPar.Vuelo := '';
                                                                        END;
                                                                        // AJF fin.
                                                                        lrSerPar.MODIFY;
                                                                        lwPrimero:= FALSE;
                                                                      UNTIL lrSerPar.NEXT=0;
                                                                    END;
                                                                  END;
                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION(Vuelos), xRec.Vuelos, Vuelos);
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Vuelos }
    { 75  ;   ;Generada prevision  ;Boolean       ;CaptionML=ESP=Generada prevision }
    { 77  ;   ;Letra               ;Code20        ;OnValidate=BEGIN
                                                                IF Letra <> xRec.Letra THEN BEGIN
                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION(Letra), xRec.Letra, Letra);
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Letra;
                                                   Editable=No }
    { 79  ;   ;Paxes Previstos     ;Integer       ;OnValidate=BEGIN
                                                                IF "Paxes Previstos" <> xRec."Paxes Previstos" THEN BEGIN

                                                                  rPar.FINDFIRST;

                                                                  IF rPar."Control Paxes Previstos" THEN
                                                                    // Registramos en el historico

                                                                    rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Paxes Previstos"),
                                                                                           FORMAT(xRec."Paxes Previstos"), FORMAT("Paxes Previstos"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Paxes Previstos;
                                                   Editable=No }
    { 80  ;   ;Fecha conductor     ;Date          ;CaptionML=ESP=Fecha conductor;
                                                   Description=Campo de control para saber sobre que d¡a se imputa la actividad al conductor }
    { 81  ;   ;N§ Vehiculo         ;Code10        ;OnValidate=VAR
                                                                rVeh@1100244000 : Record 7010346;
                                                              BEGIN
                                                                // AML --> Se comprueba que el dia esta abierto.
                                                                //

                                                                rPar.FINDFIRST;

                                                                IF (rPar."Empresa Real" <> rPar."Empresa Real"::IBZ) AND
                                                                   (rPar."Empresa Real" <> rPar."Empresa Real"::SJO) THEN
                                                                  IF NOT rDiasAbiertos.GET(Fecha) AND (NOT wBol[1]) THEN
                                                                    ERROR(err14, Fecha);

                                                                rVeh.RESET; rVeh.INIT;
                                                                rVeh.SETRANGE(Numero, "N§ Vehiculo");
                                                                IF "N§ Vehiculo" <> '' THEN BEGIN
                                                                  IF rVeh.FINDFIRST THEN
                                                                    VALIDATE(Vehiculo, rVeh.Matricula)
                                                                  ELSE
                                                                    ERROR(err8, "N§ Vehiculo");
                                                                END;
                                                              END;

                                                   OnLookup=VAR
                                                              rVeh@1100244000 : Record 7010346;
                                                            BEGIN
                                                              rPar.FINDFIRST;
                                                              rVeh.RESET; rVeh.INIT;
                                                              IF rPar."Restringir recursos x garaje" THEN
                                                                rVeh.SETRANGE(Garaje, Garaje);
                                                              IF FORM.RUNMODAL(0, rVeh) = ACTION::LookupOK THEN BEGIN
                                                                //VALIDATE("N§ Vehiculo", rVeh.Numero);
                                                                VALIDATE(Vehiculo, rVeh.Matricula);
                                                              END;
                                                            END;

                                                   CaptionML=ESP=N§ Vehiculo }
    { 83  ;   ;Conductor           ;Code20        ;OnValidate=BEGIN
                                                                // AML --> Se comprueba que el dia esta abierto.
                                                                //

                                                                rPar.FINDFIRST;

                                                                IF (rPar."Empresa Real" <> rPar."Empresa Real"::IBZ) AND
                                                                   (rPar."Empresa Real" <> rPar."Empresa Real"::SJO) THEN
                                                                  IF NOT rDiasAbiertos.GET(Fecha) AND (NOT wBol[1]) THEN
                                                                    ERROR(err14, Fecha);

                                                                // AJS 06.02.2004
                                                                // Contemplar si se quiere dejar el conductor en blanco

                                                                IF Conductor <> '' THEN BEGIN
                                                                  rCond.RESET; rCond.INIT;
                                                                  rCond.SETRANGE("Nombre Abreviado", Conductor);
                                                                  IF rCond.FINDFIRST THEN
                                                                    VALIDATE("Cod Conductor", rCond.Conductor)
                                                                  ELSE BEGIN
                                                                    w_text_filtro := '@' + Conductor + '*';
                                                                    rCond.SETFILTER("Nombre Abreviado", w_text_filtro);
                                                                    IF rCond.FINDFIRST THEN
                                                                      VALIDATE("Cod Conductor", rCond.Conductor)
                                                                    ELSE
                                                                      ERROR(err9, Conductor);
                                                                  END;
                                                                END
                                                                ELSE
                                                                  VALIDATE("Cod Conductor", '');
                                                              END;

                                                   OnLookup=BEGIN
                                                              rCond.RESET;
                                                              IF FORM.RUNMODAL(0, rCond) = ACTION::LookupOK THEN
                                                                VALIDATE(Conductor, rCond."Nombre Abreviado");
                                                            END;

                                                   CaptionML=ESP=Conductor }
    { 85  ;   ;Calcular maletas    ;Boolean       ;InitValue=Yes;
                                                   OnValidate=BEGIN
                                                                IF "Calcular maletas" <> xRec."Calcular maletas" THEN BEGIN
                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION("Calcular maletas"), FORMAT(xRec."Calcular maletas"),
                                                                                         FORMAT("Calcular maletas"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Calcular maletas }
    { 87  ;   ;Facturable          ;Boolean       ;InitValue=Yes;
                                                   OnValidate=VAR
                                                                lrTTOOParte@1103350000 : Record 7010365;
                                                              BEGIN
                                                                rPar.FINDFIRST;
                                                                IF Facturable <> xRec.Facturable THEN BEGIN
                                                                  // Marca las lineas de TTOO x Parte
                                                                  CLEAR(lrTTOOParte);
                                                                  lrTTOOParte.SETRANGE("N§ Parte","N§ Parte");
                                                                  IF lrTTOOParte.FINDSET(TRUE) THEN
                                                                    lrTTOOParte.MODIFYALL(Facturable,Facturable);

                                                                  // ----  AJS 20.03.2002  ----
                                                                  // ----  Si un parte es facturable no puede ser gratuito  ----

                                                                  // JPT 30/09/04  TRN puede facturar a 0
                                                                  IF NOT (rPar."Empresa Real" IN [rPar."Empresa Real"::TRN]) THEN BEGIN
                                                                    IF Facturable THEN
                                                                      VALIDATE(Gratuito, FALSE);
                                                                  END
                                                                  ELSE
                                                                  BEGIN
                                                                    IF Facturable AND Gratuito THEN
                                                                      MESSAGE(Text012);
                                                                  END;

                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Facturable),
                                                                                         FORMAT(xRec.Facturable), FORMAT(Facturable));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Facturable }
    { 89  ;   ;Facturado           ;Boolean       ;CaptionML=ESP=Facturado;
                                                   Editable=No }
    { 90  ;   ;Ingreso Precios por ;Option        ;OnValidate=BEGIN
                                                                IF "Ingreso Precios por" <> xRec."Ingreso Precios por" THEN BEGIN
                                                                  rToPar.RESET;
                                                                  rToPar.SETRANGE("N§ Parte", "N§ Parte");
                                                                  IF rToPar.FINDSET(TRUE) THEN
                                                                    REPEAT
                                                                      rToPar.VALIDATE("Ingreso Precios Por", "Ingreso Precios por");
                                                                      rToPar.MODIFY(TRUE);
                                                                    UNTIL rToPar.NEXT = 0;

                                                                  // ----  AJS 22.07.2002  ----
                                                                  // ----  Si indicamos precios por "Zona mas alejada" desmarcamos el campo busca precio pasaje x zona  ----

                                                                  IF "Ingreso Precios por" = "Ingreso Precios por"::"Zona mas alejada" THEN
                                                                    "Busca precio pasaje x zona ing" := FALSE;

                                                                  // ----  Registramos en el historico  ----

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Ingreso Precios por"),
                                                                                         FORMAT(xRec."Ingreso Precios por"), FORMAT("Ingreso Precios por"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Ingreso Precios por;
                                                   OptionCaptionML=ESP=Cada zona,Zona mas alejada,Zonas combinadas;
                                                   OptionString=Cada zona,Zona mas alejada,Zonas combinadas }
    { 91  ;   ;Coste Precios por   ;Option        ;OnValidate=BEGIN
                                                                IF "Coste Precios por" <> xRec."Coste Precios por" THEN BEGIN

                                                                  rToPar.RESET;
                                                                  rToPar.SETRANGE("N§ Parte", "N§ Parte");
                                                                  IF rToPar.FINDSET(TRUE) THEN
                                                                    REPEAT
                                                                      rToPar.VALIDATE("Coste Precios Por", "Coste Precios por");
                                                                      rToPar.MODIFY(TRUE);
                                                                    UNTIL rToPar.NEXT = 0;

                                                                  // ----  Registramos en el historico  ----

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Coste Precios por"),
                                                                                         FORMAT(xRec."Coste Precios por"), FORMAT("Coste Precios por"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Coste Precios por;
                                                   OptionCaptionML=ESP="Cada zona,Zona mas alejada ";
                                                   OptionString=Cada zona,Zona mas alejada }
    { 93  ;   ;Busca precio pasaje x zona ing;Boolean;
                                                   OnValidate=BEGIN
                                                                IF "Busca precio pasaje x zona ing" <> xRec."Busca precio pasaje x zona ing" THEN BEGIN
                                                                  // Registramos en el historico
                                                                  //
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0,
                                                                                         FIELDCAPTION("Busca precio pasaje x zona ing"),
                                                                                         FORMAT(xRec."Busca precio pasaje x zona ing"),
                                                                                         FORMAT("Busca precio pasaje x zona ing"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Busca precio pasaje x zona ing }
    { 94  ;   ;Touroperadores      ;Text70        ;CaptionML=ESP=Touroperadores }
    { 96  ;   ;Ingreso DL Prod     ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Produccion Ingreso"."Importe sin impuesto DL" WHERE (N§ Parte=FIELD(N§ Parte)));
                                                   CaptionML=ESP=Ingreso DL Prod;
                                                   Description=Calculado;
                                                   Editable=No;
                                                   AutoFormatType=1 }
    { 97  ;   ;Ingreso DL          ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum(Coste-Ingreso."Importe sin impuesto DL" WHERE (N§ Parte=FIELD(N§ Parte)));
                                                   CaptionML=ESP=Ingreso DL;
                                                   Description=Calculado;
                                                   Editable=No;
                                                   AutoFormatType=1 }
    { 98  ;   ;Coste DL            ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Produccion Coste"."Importe sin impuesto DL" WHERE (N§ Parte=FIELD(N§ Parte)));
                                                   CaptionML=ESP=Coste DL;
                                                   Description=Calculado;
                                                   Editable=No;
                                                   AutoFormatType=1 }
    { 99  ;   ;Kms                 ;Decimal       ;OnValidate=BEGIN
                                                                IF Kms <> xRec.Kms THEN BEGIN

                                                                // ----  Registramos en el historico  ----

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Kms), FORMAT(xRec.Kms), FORMAT(Kms));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Kms;
                                                   DecimalPlaces=0:2;
                                                   MinValue=0;
                                                   MaxValue=2.000 }
    { 100 ;   ;Impreso             ;Boolean       ;OnValidate=BEGIN
                                                                IF Impreso = TRUE THEN
                                                                  ERROR(err12);

                                                                  // ----  Registramos en el historico  ----

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Impreso),
                                                                                         FORMAT(xRec.Impreso), FORMAT(Impreso));
                                                              END;

                                                   CaptionML=ESP=Impreso }
    { 101 ;   ;Hora 1er Vuelo      ;Time          ;CaptionML=ESP=Hora 1er Vuelo;
                                                   Editable=No }
    { 103 ;   ;Agrupacion          ;Code10        ;OnLookup=VAR
                                                              lrParte@1103355000 : Record 7010360;
                                                              lfForm@1103355001 : Form 7010401;
                                                            BEGIN
                                                              IF Agrupacion <> '' THEN BEGIN
                                                                CLEAR(lrParte);
                                                                lrParte.SETCURRENTKEY(Agrupacion);
                                                                lrParte.SETRANGE(Agrupacion, Agrupacion);
                                                                lfForm.SETTABLEVIEW(lrParte);
                                                                lfForm.LlamadaAsignacion(TRUE);
                                                                lfForm.RUN;
                                                              END;
                                                            END;

                                                   CaptionML=ESP=Agrupacion }
    { 105 ;   ;Zona parte          ;Code10        ;TableRelation="Zona fisica transfer".Codigo;
                                                   OnValidate=VAR
                                                                lrZonaFisica@1100244000 : Record 7010314;
                                                              BEGIN
                                                                IF "Zona parte" <> xRec."Zona parte" THEN BEGIN

                                                                  // AJF 08/04/08
                                                                  //IF ("Origen creacion" = "Origen creacion"::Shuttle) THEN BEGIN
                                                                  //   IF lrZonaFisica.GET("Zona parte") THEN BEGIN
                                                                  //     VALIDATE(Garaje, lrZonaFisica."Garaje Predeterminado");
                                                                  //   END;
                                                                  //END;

                                                                  // AJF 31/03/08 - IBZ DRF 07002
                                                                  // Pasar la zona parte a Touroperador x parte

                                                                  rToPar.RESET;
                                                                  rToPar.SETRANGE("N§ Parte", "N§ Parte");
                                                                  rToPar.MODIFYALL("Zona Parte", "Zona parte");

                                                                  // ----  Registramos en el historico  ----

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Zona parte"),
                                                                                         FORMAT(xRec."Zona parte"), FORMAT("Zona parte"));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Zona parte;
                                                   Description=FK Zona fisica, Se rellena con la zona fisica mas alejada de los puntos de recogida;
                                                   Editable=No }
    { 106 ;   ;Bono                ;Code10        ;OnValidate=VAR
                                                                lrTTOOxParte@1100244000 : Record 7010365;
                                                                lrSerPar@1100244001 : Record 7010359;
                                                              BEGIN
                                                                IF Bono <> xRec.Bono THEN BEGIN

                                                                  // JPT-26/02/02-UEX**************************
                                                                  // Mantiene el campo Bono en TTOOxParte
                                                                  lrTTOOxParte.RESET;
                                                                  lrTTOOxParte.SETRANGE("N§ Parte" , "N§ Parte");
                                                                  IF lrTTOOxParte.FINDSET(TRUE) THEN
                                                                    lrTTOOxParte.MODIFYALL(Bono , Bono);
                                                                  // Fin JPT-26/02/02-UEX ********************



                                                                  // ----  Registramos en el historico  ----

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Bono),
                                                                                         FORMAT(xRec.Bono), FORMAT(Bono));
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Bono;
                                                   Editable=Yes }
    { 107 ;   ;Gratuito            ;Boolean       ;OnValidate=BEGIN
                                                                rPar.FINDFIRST;
                                                                IF Gratuito <> xRec.Gratuito THEN
                                                                  // TRN puede facturar a 0
                                                                  IF NOT (rPar."Empresa Real" IN [rPar."Empresa Real"::TRN]) THEN BEGIN
                                                                    IF Facturable THEN
                                                                      ERROR(Text007);
                                                                  END
                                                                  ELSE BEGIN
                                                                    IF Facturable AND Gratuito THEN
                                                                      MESSAGE(Text012);
                                                                  END;

                                                                  // ----  Registramos en el historico  ----

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Gratuito),
                                                                                         FORMAT(xRec.Gratuito), FORMAT(Gratuito));
                                                              END;

                                                   CaptionML=ESP=Gratuito }
    { 109 ;   ;Tipo calculo coste  ;Option        ;CaptionML=ESP=Tipo calculo coste;
                                                   OptionCaptionML=ESP=Normal,Precio mas alto,Promedio Plazas;
                                                   OptionString=Normal,Precio mas alto,Promedio Plazas }
    { 110 ;   ;Busca precio ingreso;Option        ;CaptionML=ESP=Busca precio ingreso;
                                                   OptionCaptionML=ESP=Pasaje independiente,Pasaje conjunto;
                                                   OptionString=Pasaje independiente,Pasaje conjunto }
    { 111 ;   ;N§ Touroperadores   ;Integer       ;FieldClass=FlowField;
                                                   CalcFormula=Count("Touroperador x Parte" WHERE (N§ Parte=FIELD(N§ Parte)));
                                                   CaptionML=ESP=N§ Touroperadores;
                                                   Description=Calculado a partir de TTOO x Parte;
                                                   Editable=No }
    { 116 ;   ;Num. Bono Excursiones;Code14       ;OnValidate=BEGIN

                                                                IF "Num. Bono Excursiones" <> '' THEN BEGIN

                                                                  // Si no es una excursion hay que dar un mensaje de error

                                                                  rCodSer.GET("Codigo Servicio");
                                                                  rTipoSer.GET(rCodSer."Tipo servicio");
                                                                  IF rTipoSer."Tipo fijo" <> rTipoSer."Tipo fijo"::Excursion THEN
                                                                    ERROR(err21);

                                                                  "Num. Bono Excursiones" := FormateaBonoExc("Num. Bono Excursiones");

                                                                  // Comprobar si el bono esta repetido

                                                                  rParte.RESET;
                                                                  rParte.SETCURRENTKEY("Num. Bono Excursiones");
                                                                  rParte.SETRANGE ("Num. Bono Excursiones", "Num. Bono Excursiones");
                                                                  rParte.SETFILTER("N§ Parte"             , '<>%1', "N§ Parte");
                                                                  IF rParte.FINDFIRST THEN
                                                                    MESSAGE(err17, "Num. Bono Excursiones", rParte."N§ Parte", rParte.Fecha);
                                                                END;

                                                                IF "Num. Bono Excursiones" <> xRec."Num. Bono Excursiones" THEN
                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Num. Bono Excursiones"),
                                                                                         FORMAT(xRec."Num. Bono Excursiones"), FORMAT("Num. Bono Excursiones"));
                                                              END;

                                                   CaptionML=ESP=Num. Bono Excursiones }
    { 117 ;   ;Zona trabajo        ;Code10        ;TableRelation="Zona de trabajo".Codigo;
                                                   OnValidate=VAR
                                                                lrPI@1100244000 : Record 7035392;
                                                              BEGIN
                                                                IF "Zona trabajo" <> xRec."Zona trabajo" THEN BEGIN

                                                                  // Pasar la zona de trabajo a Touroperador x parte

                                                                  rToPar.RESET;
                                                                  rToPar.SETRANGE("N§ Parte", "N§ Parte");
                                                                  IF rToPar.FINDSET(TRUE) THEN
                                                                    rToPar.MODIFYALL("Zona trabajo", "Zona trabajo");

                                                                  // ----  Registramos en el historico  ----

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Zona trabajo"),
                                                                                         FORMAT(xRec."Zona trabajo"), FORMAT("Zona trabajo"));

                                                                  // AJS 23.06.2008, TNU08002
                                                                  // La zona de trabajo de produccion pasa a depender de la definicion de zonas de precio
                                                                  // para gestionar mejor las zonas de facturacion por Touroperador

                                                                  { {Codigo eliminado}
                                                                  IF Confirmado THEN BEGIN
                                                                    lrPI.RESET;
                                                                    lrPI.SETRANGE ("N§ Parte"       , "N§ Parte");
                                                                    lrPI.SETFILTER("N§ Prefactura"  , '%1','');
                                                                    IF lrPI.FINDSET(TRUE) THEN
                                                                      lrPI.MODIFYALL("Zona trabajo", "Zona trabajo");
                                                                  END;
                                                                  {fin codigo eliminado} }
                                                                END;
                                                              END;

                                                   CaptionML=ESP=Zona trabajo;
                                                   Description=FK Zona de trabajo;
                                                   Editable=No }
    { 118 ;   ;Touroperador principal;Code10      ;TableRelation=Cliente/TTOO.TTOO WHERE (Cliente=FIELD(Cliente),
                                                                                          Operativa Deshabilitada=CONST(No));
                                                   OnValidate=VAR
                                                                lrSerPar2@1103355000 : Record 7010359;
                                                              BEGIN
                                                                // Si el servicio tiene lineas modificamos todas las lineas que tengan el touroperador anterior por el nuevo

                                                                rHotSer.RESET;
                                                                rHotSer.SETCURRENTKEY("N§ Parte");
                                                                rHotSer.SETRANGE("N§ Parte"   , "N§ Parte");
                                                                rHotSer.SETRANGE(Touroperador , xRec."Touroperador principal");
                                                                IF rHotSer.FINDSET(TRUE) THEN BEGIN
                                                                  REPEAT
                                                                    lrSerPar2 := rHotSer;
                                                                    lrSerPar2.PasaXRec(rHotSer);
                                                                    lrSerPar2.Touroperador := "Touroperador principal";
                                                                    lrSerPar2.mantener_touroperador_parte(Rec);
                                                                    lrSerPar2.MODIFY;
                                                                  UNTIL rHotSer.NEXT = 0;

                                                                  // AJS 23.06.2008, TNU08002
                                                                  // La zona de trabajo del parte de trabajo no depende del touroperador
                                                                  //"Zona trabajo" := rZonFis.GetZonaTrabajo("Zona parte", "Touroperador principal", "Tipo Servicio");
                                                                  ProratearViajes; // AJF 02/11/10
                                                                END;

                                                                // AJS 26.02.2004
                                                                // El campo de "precios por" se rellena con el valor por defecto que tiene en cliente/TTOO

                                                                IF rCliTo.GET(Cliente, "Touroperador principal") THEN
                                                                  VALIDATE("Ingreso Precios por", rCliTo."Precios por")
                                                                ELSE
                                                                  ERROR(Text009, "Touroperador principal", Cliente);

                                                                GetGestor;  // JPT 15/05/05 Actualiza el codigo del gestor

                                                                // Registramos en el historico

                                                                rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Touroperador principal"),
                                                                                       xRec."Touroperador principal", "Touroperador principal");
                                                              END;

                                                   CaptionML=ESP=Touroperador principal;
                                                   NotBlank=Yes;
                                                   Description=Cliente/TTOO.TTOO WHERE (Cliente=FIELD(Cliente),Operativa Deshabilitada=CONST(No)) }
    { 119 ;   ;Dia siguiente       ;Boolean       ;OnValidate=BEGIN
                                                                ActualizaHoraDT;

                                                                // Registramos en el historico

                                                                rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Dia siguiente"),
                                                                                       FORMAT(xRec."Dia siguiente"), FORMAT("Dia siguiente"));
                                                              END;

                                                   CaptionML=ESP=Dia siguiente;
                                                   Description=Indica que el parte pertenece a la madrugada del dia siguiente a que indica la fecha del parte;
                                                   Editable=Yes }
    { 121 ;   ;Asignacion rapida   ;Boolean       ;CaptionML=ESP=Asignacion rapida;
                                                   Description=Indica si los campos Vehiculo y Cod conductor se estan rellenando desde la ventana de asignacion rapida }
    { 123 ;   ;Usuario             ;Code20        ;TableRelation=User."User ID";
                                                   CaptionML=ESP=Usuario;
                                                   Description=FK User;
                                                   Editable=No }
    { 125 ;   ;Presentacion        ;Text80        ;OnValidate=BEGIN
                                                                // Registramos en el historico

                                                                rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION(Presentacion),
                                                                                       xRec.Presentacion, Presentacion);
                                                              END;

                                                   CaptionML=ESP=Presentacion }
    { 126 ;   ;Finalizacion        ;Text80        ;OnLookup=BEGIN
                                                              CLEAR(rPtoRec);
                                                              IF FORM.RUNMODAL(0,rPtoRec) = ACTION::LookupOK THEN
                                                                Finalizacion := COPYSTR(rPtoRec.Descripci¢n, 1, MAXSTRLEN(Finalizacion));
                                                            END;

                                                   CaptionML=ESP=Finalizacion }
    { 127 ;   ;Codigo Barras       ;Code20        ;CaptionML=ESP=Codigo Barras }
    { 129 ;   ;Garaje cambiado     ;Boolean       ;TableRelation=Garaje.Garaje;
                                                   CaptionML=ESP=Garaje cambiado }
    { 131 ;   ;Garaje anterior     ;Code10        ;TableRelation=Garaje.Garaje;
                                                   CaptionML=ESP=Garaje anterior;
                                                   Description=Conservar cual era el garaje antes del cambio }
    { 133 ;   ;Num cambio garaje   ;Integer       ;TableRelation="Log Cambios de garaje"."Num Cambio";
                                                   CaptionML=ESP=Num cambio garaje;
                                                   Description=FK Log Cambios de garaje;
                                                   Editable=No }
    { 135 ;   ;Vehiculo cambiado   ;Boolean       ;CaptionML=ESP=Vehiculo cambiado;
                                                   Description=Marca si se ha cambiado el coche despues de haber hecho una primera asignacion;
                                                   Editable=No }
    { 150 ;   ;Num Exportacion Prov;Integer       ;CaptionML=ESP=Num Exportacion Prov;
                                                   Description=Para controlar la exportaci¢n de servicios a proveedores }
    { 151 ;   ;Cod Grupo           ;Code20        ;OnValidate=BEGIN
                                                                //BRM Control modificacion TPR

                                                                IF ("Cod Grupo" <> xRec."Cod Grupo") THEN BEGIN

                                                                  rCliTo.GET(Cliente,"Touroperador principal");

                                                                  IF ("Cod Grupo" = '') AND (rCliTo."Cliente Siempre Grupos") THEN
                                                                    ERROR(err23,Cliente,"Touroperador principal");

                                                                  IF ("Cod Grupo" <> '') THEN BEGIN
                                                                    rGrupo.RESET;
                                                                    rGrupo.SETRANGE("Codigo Grupo","Cod Grupo");
                                                                    rGrupo.SETRANGE(Cliente,Cliente);
                                                                    rGrupo.SETRANGE(TTOO,"Touroperador principal");
                                                                    rGrupo.SETFILTER("Fecha Llegada Prevista",'<=%1|%2',Fecha,0D);
                                                                    rGrupo.SETRANGE(Confirmado,TRUE);
                                                                    rGrupo.SETRANGE(Facturado,FALSE);
                                                                    IF NOT rGrupo.FINDFIRST THEN
                                                                      ERROR(err22,"N§ Parte","Cod Grupo",Fecha);

                                                                    IF rGrupo.Referencia <> '' THEN
                                                                      VALIDATE(Referencia, rGrupo.Referencia); // Actualizamos el campo Referencia
                                                                  END;

                                                                  rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Cod Grupo"),
                                                                                        xRec."Cod Grupo", "Cod Grupo");
                                                                END;

                                                                // JPT 22/06/09 DRF IBZ 09001 - Valoraci¢n de partes de recogida
                                                                ModificaCampo(FIELDNO("Cod Grupo"));
                                                              END;

                                                   OnLookup=VAR
                                                              lrGrup@1103350000 : Record 7010373;
                                                            BEGIN
                                                              CLEAR(lrGrup);
                                                              lrGrup.SETCURRENTKEY(Cliente,TTOO);
                                                              lrGrup.SETRANGE(Cliente    , Cliente);
                                                              lrGrup.SETRANGE(TTOO       , "Touroperador principal");
                                                              lrGrup.SETRANGE(Confirmado , TRUE);
                                                              lrGrup.SETRANGE(Facturado  , FALSE);
                                                              lrGrup.SETFILTER("Fecha Llegada Prevista", '<=%1', Fecha);
                                                              lrGrup.SETFILTER("Fecha Salida Prevista" , '>=%1|%2', Fecha, 0D);
                                                              IF FORM.RUNMODAL(0,lrGrup)= ACTION::LookupOK THEN
                                                                VALIDATE("Cod Grupo",lrGrup."Codigo Grupo");
                                                            END;

                                                   CaptionML=ESP=Cod Grupo;
                                                   Description=FK Grupos;
                                                   Editable=Yes }
    { 152 ;   ;No Exportar         ;Boolean       ;OnValidate=BEGIN
                                                                // Registramos en el historico

                                                                rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("No Exportar"),
                                                                                       FORMAT(xRec."No Exportar"), FORMAT("No Exportar"));
                                                              END;

                                                   CaptionML=ESP=No Exportar }
    { 153 ;   ;No Servicio Regular ;Integer       ;TableRelation="Servicios Regulares".No.;
                                                   OnValidate=VAR
                                                                lrPI@1103355000 : Record 7035392;
                                                              BEGIN
                                                                // JPT 22/06/09 Cuando se rellena un parte de recogida al ser llamado por uno de excursi¢n
                                                                IF "Origen creacion" <> -1 THEN BEGIN
                                                                  IF NOT CONFIRM (Text024) THEN BEGIN
                                                                    "No Servicio Regular" := xRec."No Servicio Regular";
                                                                    EXIT;
                                                                  END;
                                                                END;

                                                                // Modifica el campo en las linea C/I
                                                                CLEAR(lrPI);
                                                                lrPI.SETCURRENTKEY("N§ Parte",Touroperador,"Tipo linea","Linea abono","Tipo elemento");
                                                                lrPI.SETRANGE("N§ Parte"  , "N§ Parte");
                                                                IF lrPI.FINDSET(TRUE) THEN
                                                                  lrPI.MODIFYALL("Servicio Regular", "No Servicio Regular");

                                                                // JPT 22/06/09 DRF IBZ 09001 - Valoraci¢n de partes de recogida
                                                                ModificaCampo(FIELDNO("No Servicio Regular"));
                                                              END;

                                                   CaptionML=ESP=No Servicio Regular;
                                                   Description=Servicios Regulares }
    { 154 ;   ;Fecha Confirmacion  ;DateTime      ;CaptionML=ESP=Fecha Confirmacion;
                                                   Description=Indica la fecha y Hora de confirmacion. Necesario para desconfirmar }
    { 155 ;   ;Tipo Calculo Ingresos;Option       ;CaptionML=ESP=Tipo Calculo Ingresos;
                                                   OptionCaptionML=ESP=Normal,Promedio Plazas,Mayor Importe;
                                                   OptionString=Normal,Promedio Plazas,Mayor Importe }
    { 156 ;   ;Gestor              ;Code20        ;OnValidate=BEGIN
                                                                CLEAR(rToPar);
                                                                rToPar.SETRANGE("N§ Parte", "N§ Parte");
                                                                IF rToPar.FINDSET(TRUE) THEN
                                                                  rToPar.MODIFYALL(Gestor, Gestor);
                                                              END;

                                                   CaptionML=ESP=Gestor;
                                                   Description=Usuario gestor del TTOO }
    { 157 ;   ;Copias Impresas     ;Integer       ;OnValidate=BEGIN

                                                                // Registramos en el historico del parte la impresion
                                                                rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, Text019 , '',
                                                                                       STRSUBSTNO(Text020, "Copias Impresas", Version));
                                                              END;

                                                   CaptionML=ESP=Copias Impresas;
                                                   MinValue=0;
                                                   Description=Impresion partes;
                                                   Editable=No }
    { 158 ;   ;Version             ;Integer       ;InitValue=1;
                                                   CaptionML=ESP=Version;
                                                   MinValue=0;
                                                   Description=Numero de version (modificacion) de impresion;
                                                   Editable=No }
    { 165 ;   ;Peticion Servicio Cliente;Text100  ;OnValidate=VAR
                                                                lwExt@1100253000 : Code[10];
                                                              BEGIN
                                                                IF "Peticion Servicio Cliente" <> '' THEN BEGIN
                                                                  IF NOT EXISTS("Peticion Servicio Cliente") THEN
                                                                    ERROR(Text017,"Peticion Servicio Cliente");

                                                                  lwExt := COPYSTR("Peticion Servicio Cliente",STRLEN("Peticion Servicio Cliente")-2);
                                                                  IF NOT  (lwExt IN ['DOC','PDF']) THEN
                                                                    ERROR(Text018,lwExt);
                                                                END;
                                                              END;

                                                   OnLookup=BEGIN
                                                              "Peticion Servicio Cliente":= cFunBas.GetDocumento("Peticion Servicio Cliente",Text016 ,
                                                                                                                 FIELDCAPTION("Peticion Servicio Cliente"));
                                                            END;

                                                   CaptionML=ESP=Peticion Servicio Cliente;
                                                   Description=Documento de petici¢n de servicio }
    { 167 ;   ;Imprimir peticion servicio;Boolean ;CaptionML=ESP=Imprimir peticion servicio }
    { 170 ;   ;Plaza Parking       ;Code10        ;CaptionML=ESP=Plaza Parking }
    { 180 ;   ;Tiene Anotaciones   ;Boolean       ;FieldClass=FlowField;
                                                   CalcFormula=Exist("Anotaciones Parte" WHERE (N§ Parte=FIELD(N§ Parte)));
                                                   CaptionML=ESP=Tiene Anotaciones;
                                                   Description=Calculado a partir de tabla Anotaciones Parte;
                                                   Editable=No }
    { 190 ;   ;Origen creacion     ;Option        ;CaptionML=ESP=Origen creacion;
                                                   OptionCaptionML=ESP=Manual,Importacion,Grupos,Servicios Regulares,Shuttle,Recogida Automatica;
                                                   OptionString=Manual,Importacion,Grupos,Servicios Regulares,Shuttle,Recogida Automatica;
                                                   Description=Indica el Origen en la creacion del Parte;
                                                   Editable=No }
    { 191 ;   ;Fecha creacion      ;Date          ;CaptionML=ESP=Fecha creacion;
                                                   Editable=No }
    { 192 ;   ;Vehiculo Escolar    ;Boolean       ;OnValidate=BEGIN
                                                                // JPT 22/06/09 DRF IBZ 09001 - Valoraci¢n de partes de recogida
                                                                ModificaCampo(FIELDNO("Vehiculo Escolar"));

                                                                rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Vehiculo Escolar"),
                                                                                       FORMAT(xRec."Vehiculo Escolar"), FORMAT("Vehiculo Escolar"));
                                                              END;

                                                   CaptionML=ESP=Vehiculo Escolar }
    { 193 ;   ;Vehiculo Minusvalidos;Boolean      ;OnValidate=BEGIN
                                                                // JPT 22/06/09 DRF IBZ 09001 - Valoraci¢n de partes de recogida
                                                                ModificaCampo(FIELDNO("Vehiculo Minusvalidos"));

                                                                rHist.inserta_registro(rHist."Tipo Fichero"::Parte, "N§ Parte", 0, FIELDCAPTION("Vehiculo Minusvalidos"),
                                                                                       FORMAT(xRec."Vehiculo Minusvalidos"), FORMAT("Vehiculo Minusvalidos"));
                                                              END;

                                                   CaptionML=ESP=Vehiculo Minusvalidos }
    { 194 ;   ;Vehiculo Microbus   ;Boolean       ;CaptionML=ESP=Vehiculo Microbus;
                                                   Description=Utilizado solo por OPTRAT/COMPLEX }
    { 200 ;   ;Calcular Otros Gastos;Boolean      ;CaptionML=ESP=Calcular Otros Gastos;
                                                   Description=Ter. Indica que se tienen que calcular gastos de agua/Toalla }
    { 201 ;   ;Privado             ;Boolean       ;CaptionML=ESP=Privado }
    { 202 ;   ;Recogida Generada   ;Code10        ;CaptionML=ESP=Recogida Generada;
                                                   Description=FK Parte }
    { 203 ;   ;Vehiculo especial   ;Boolean       ;OnValidate=BEGIN
                                                                // JPT 22/06/09 DRF IBZ 09001 - Valoraci¢n de partes de recogida
                                                                ModificaCampo(FIELDNO("Vehiculo especial"));
                                                              END;

                                                   CaptionML=ESP=Vehiculo especial;
                                                   Description=para exportar servicios especiales para IBIZATOURS }
    { 204 ;   ;Busca precio pasaje x zona cos;Boolean;
                                                   CaptionML=ESP=Busca precio pasaje x zona cos }
    { 205 ;   ;Shuttle Time        ;Time          ;CaptionML=ESP=Shuttle Time }
  }
  KEYS
  {
    {    ;N§ Parte                                ;Clustered=Yes }
    {    ;Confirmado,Fecha,Gestor                  }
    {    ;Fecha,Vehiculo,Hora inicio               }
    {    ;Fecha,Cod Conductor,Dia siguiente,Hora inicio }
    {    ;Fecha,Dia siguiente,Hora inicio          }
    {    ;Fecha Real                               }
    {    ;Confirmado,Vehiculo,Fecha facturacion,Tipo Servicio,Codigo Servicio,Garaje;
                                                   SumIndexFields=N§ viajes,Adultos trans. soporte,Ni¤os trans. soporte;
                                                   SIFTLevelsToMaintain=[{Confirmado,Vehiculo,Fecha facturacion:Day},
                                                                         {Confirmado,Vehiculo,Fecha facturacion:Day,Tipo Servicio,Codigo Servicio,Garaje}] }
    {    ;Cod Conductor,Fecha,Tipo Vehiculo        }
    {    ;Confirmado,Cod Conductor,Fecha facturacion,Tipo Servicio,Garaje;
                                                   SumIndexFields=N§ viajes,Adultos trans. soporte,Ni¤os trans. soporte;
                                                   SIFTLevelsToMaintain=[{Confirmado,Cod Conductor,Fecha facturacion:Day},
                                                                         {Confirmado,Cod Conductor,Fecha facturacion:Day,Tipo Servicio,Garaje}] }
    {    ;Cod Conductor,Fecha,Dia siguiente,Hora inicio }
    {    ;Fecha,Tipo Servicio,Codigo Servicio      }
    {    ;Cod Conductor,Fecha conductor            }
    { No ;Confirmado,Fecha,Vehiculo,Cod Conductor,Tipo Servicio }
    {    ;Facturado,Codigo Servicio                }
    {    ;Agrupacion,Codigo Servicio,Fecha,Hora inicio }
    {    ;Tipo Servicio,Garaje,Fecha,N§ Vehiculo,Hora inicio }
    {    ;Fecha,Codigo Servicio,Vuelos,Hora 1er Vuelo,Touroperadores }
    {    ;Fecha,N§ Vehiculo,Hora inicio,Tipo Servicio }
    {    ;Proveedor,Tipo Servicio,Fecha,Hora inicio }
    {    ;Fecha,Proveedor,Codigo Servicio,Hora 1er Vuelo }
    {    ;Tipo Servicio,Proveedor,Fecha            }
    { No ;Fecha,Hora 1er Vuelo,Agrupacion,Codigo Servicio }
    {    ;Fecha,N§ Vehiculo,Dia siguiente,Hora inicio,Cod Conductor }
    {    ;Vehiculo,Fecha,Confirmado,Proveedor      }
    {    ;Fecha,Tipo Vehiculo,Vehiculo             }
    {    ;Num. Bono Excursiones                    }
    {    ;Fecha,Tipo Servicio,Codigo Servicio,Dia siguiente,Hora inicio,Zona parte }
    {    ;Num cambio garaje                        }
    {    ;Fecha,Cliente,Touroperador principal,Zona trabajo,Facturado }
    {    ;Cod Grupo                                }
    { No ;N§ Vehiculo,Fecha,Codigo Servicio        }
    { No ;Hora Inicio DT,Origen creacion           }
    {    ;Proveedor,Fecha,Codigo Servicio          }
    {    ;Zona parte,Touroperador principal,Fecha,Codigo Servicio }
    {    ;Tipo Servicio,Touroperador principal,Fecha }
    {    ;Fecha,N§ Vehiculo,Codigo Servicio        }
    {    ;Fecha,Proveedor,Num Exportacion Prov     }
    {    ;No Servicio Regular,Fecha                }
    {    ;Referencia                              ;MaintainSQLIndex=No }
    {    ;Hora Inicio BI,Origen creacion           }
  }
  FIELDGROUPS
  {
  }
  CODE
  {
    VAR
      Text50000@1103355019 : TextConst 'ESP="FECHA PARTE "';
      Text50001@1103355020 : TextConst 'ESP=RECOGIDA';
      Text50002@1103355021 : TextConst 'ESP="PARTE RECOGIDA "';
      Text50003@1103355022 : TextConst 'ESP=" BORRADO"';
      Text50004@1103355023 : TextConst 'ESP=1D';
      Text50005@1103355024 : TextConst 'ESP=Contrato compra';
      Text50008@1103355025 : TextConst 'ESP=<weekday text>';
      Text50009@1103355026 : TextConst 'ESP=Nueva Fecha #1##########';
      Text50012@1103355027 : TextConst 'ESP=Vehiculo';
      Text50013@1103355028 : TextConst 'ESP=<integer>';
      Text50014@1103355029 : TextConst 'ESP=.PDF';
      rCliTo@1100244045 : Record 7010313;
      rTipoSer@1100244000 : Record 7010319;
      rCodSer@1100244001 : Record 7010320;
      rExtPar@1100244002 : Record 7010362;
      rZonPar@1100244003 : Record 7010364;
      rToPar@1100244004 : Record 7010365;
      rHotSer@1100244005 : Record 7010359;
      rPar@1100244006 : Record 7010311;
      rTipo@1100244007 : Record 330;
      rHist@1100244008 : Record 7010361;
      rErr@1100244010 : Record 7010413;
      rCond@1100244011 : Record 7010327;
      rZonFisPar@1100244012 : Record 7010366;
      rParte@1100244013 : Record 7010360;
      rPtoRec@1100244044 : Record 7010315;
      rZonFis@1100244052 : Record 7010314;
      rRestricImagen@1100244059 : Record 7035374;
      rGaraje@1103355006 : Record 7010310;
      rSubTrParte@1103355017 : Record 7035399;
      GestNoSerie@1100244014 : Codeunit 396;
      err1@1100244015 : TextConst 'ESP=No se puede modificar un parte (%1)  una vez confirmado.';
      err2@1100244016 : TextConst 'ESP=No se puede borrar un parte una vez confirmado.';
      err3@1100244017 : TextConst 'ESP=No se puede renombrar un parte.';
      err4@1100244018 : TextConst 'ESP=La hora de final no puede ser anterior a la hora inicial.';
      err5@1100244019 : TextConst 'ESP=No se puede indicar al parte un vehiculo que esta bloqueado %1';
      err6@1100244020 : TextConst 'ESP=El conductor no tiene contrato en vigor para la fecha del parte.';
      err7@1100244021 : TextConst 'ESP=El conductor tiene una incidencia para la fecha del parte.\\¨Desea continuar?.';
      err8@1100244022 : TextConst 'ESP=No existe ningun vehiculo con n§ %1.';
      err9@1100244023 : TextConst 'ESP=No existe ningun conductor con nombre corto %1';
      err10@1100244024 : TextConst 'ESP=No se pueden utilizar vehiculos de un garaje distinto del garaje asignado al parte.';
      err11@1100244025 : TextConst 'ESP=No se pueden utilizar conductores de un garaje distinto del garaje asignado al parte.';
      text1@1100244026 : TextConst 'ESP=BORRADO';
      text2@1100244027 : TextConst 'ESP=CREACION';
      text3@1100244028 : TextConst 'ESP=El Contrato del Conductor %1 no tiene vigencia para el %2, desea continuar.';
      confirma_sin_contrato@1100244029 : TextConst 'ESP=El conductor %1 no tiene contrato para este dia, desea continuar.';
      cFunBas@1103350003 : Codeunit 7010310;
      cCalcR@1100253002 : Codeunit 7010407;
      cFunAdic@1100253007 : Codeunit 7010410;
      w_text_filtro@1100244030 : Text[30];
      err12@1100244031 : TextConst 'ESP=No es posible asignar esta propiedad manualmente';
      msg1@1100244032 : TextConst 'ESP=Este Vehiculo tiene alguna incidenica abierta';
      err13@1100244033 : TextConst 'ESP=Este parte ha sido facturado como minimo una vez, no puede ser borrado, puede emitir el abono dejando el parte como pendiente.';
      rDiasAbiertos@1100244034 : Record 7035341;
      err14@1100244035 : TextConst 'ESP=El dia %1 no ha sido abierto. \\Es neces ria su apertura si desea asignar partes.';
      fConsulta@1100244036 : Form 7010358;
      err15@1100244037 : TextConst 'ESP=Proceso cancelado a petici¢n del usuario.';
      err16@1100244038 : TextConst 'ESP=El campo %1 tiene que tener %2 caracteres';
      err17@1100244039 : TextConst 'ESP=El Bono %1 ya se encuentra el el Parte %2 de Fecha %3';
      err18@1100244040 : TextConst 'ESP=Debe introducir 11 caracteres num‚ricos';
      err19@1100244041 : TextConst 'ESP=El caracter %1 no es numerico';
      err20@1100244042 : TextConst 'ESP=El primer caracter tiene que ser una letra';
      err21@1100244043 : TextConst 'ESP=Solo se puede indicar un bono de excursiones en una excursion.';
      Text001@1100244046 : TextConst 'ESP=No se pueden cambiar los recursos en un dia cerrado.';
      Text002@1100244047 : TextConst 'ESP=¨Desea crear un contrato nuevo para el conductor %1?';
      Text003@1100244048 : TextConst 'ESP=El pax transportado (%1)  en Parte %3 es superior a la capacidad del vehiculo (%2). ¨Desea Seguir?';
      Text004@1100244049 : TextConst 'ESP=Proceso anulado';
      Text005@1100244050 : TextConst 'ESP=Ha introducido una fecha inferior al d¡a de hoy';
      Text006@1100244051 : TextConst 'ESP=Ha introducido una hora anterior a la actual en un parte para hoy';
      rGrupo@1100244053 : Record 7010373;
      err22@1100244054 : TextConst 'ESP=El Parte %1 no puede ser asociado al Grupo %2. La fecha Llegada Prevista del Grupo %2 debe ser anterior a %3';
      err23@1100244055 : TextConst 'ESP=El Cliente %1, TTOO %2 debe estar asociado obligatoriamente a un grupo.';
      Text007@1100244056 : TextConst 'ESP=Un parte facturable no puede ser gratuito.';
      Text008@1100244057 : TextConst 'ESP=¨El Parte actual se ha convertido en un parte del d¡a siguiente?';
      Text009@1100244058 : TextConst 'ESP=El Touroperador %1 no esta ligado al cliente %2.';
      Text010@1100244060 : TextConst 'ESP=No se pueden utilizar vehiculos con imagen %1 en partes del touroperador %2.';
      wBol@1103350000 : ARRAY [5] OF Boolean;
      Text011@1103350001 : TextConst 'ESP=El conductor %1 tiene una incidencia %2 para este d¡a';
      Text012@1103350002 : TextConst 'ESP=Se generar  un ingreso con importe 0';
      Text013@1100253000 : TextConst 'ESP=Debe rellenear el campo %1';
      Text014@1100253001 : TextConst 'ESP=No puede dejarse el numero de parte en blanco';
      Text015@1100253003 : TextConst 'ESP=El campo %1 est  vacio';
      Text016@1100253004 : TextConst 'ESP="Word/PDF/JPG|*.DOC;*.PDF;*.JPG"';
      Text017@1100253006 : TextConst 'ESP=No se encuentra el documento\ %1';
      Text018@1100253005 : TextConst 'ESP=No estan permitidos archivos con extensi¢n %1';
      Text019@1100253008 : TextConst 'ESP=Parte Impreso';
      Text020@1100253009 : TextConst 'ESP=Copia %1 Version  %2';
      Text021@1103355000 : TextConst 'ESP=Aviso: El conductor %1 ya tiene asignado el vehiculo %2 para el d¡a %3.\Parte N§ %4';
      Text022@1103355001 : TextConst 'ESP=Este parte debe realizarlo un vehiculo autorizado para el transporte escolar.';
      Text023@1103355002 : TextConst 'ESP=Este parte requiere de un vehiculo adaptado para minusvalidos.';
      Text024@1103355003 : TextConst 'ESP=¨Desea realmente cambiar el numero de Servicio Regular?';
      Text025@1103355004 : TextConst 'ESP=El Vehiculo %1  es propio pero el Conductor %2 No';
      Text026@1103355005 : TextConst 'ESP=El Conductor %1 es propio pero el Vehiculo %2 No';
      conf1@1103355007 : TextConst 'ESP=Seguro de que desea deasignar este punto de recogida del parte?';
      Text027@1103355008 : TextConst 'ESP=Este parte debe realizarlo un vehiculo especial.';
      err24@1103355012 : TextConst 'ESP=No se puede generar un parte de recogida a partir de otro parte de recogida.';
      err25@1103355011 : TextConst 'ESP=El tipo de servicio %1 no es una excursi¢n. Solo se pueden generar partes de recogida a partir de partes de excursi¢n.';
      err26@1103355010 : TextConst 'ESP=El parte %1 ya tiene un parte de recogida generado.';
      err27@1103355009 : TextConst 'ESP=La fecha del parte debe ser mayor o igual al %1.';
      Text028@1103355013 : TextConst 'ESP=El texto de presentaci¢n va a cambiar si modifica el campo Origen/destino. ¨Est  seguro de que desea continuar?';
      Text029@1103355014 : TextConst 'ESP=No existe el usuario %1.';
      Text030@1103355015 : TextConst 'ESP="Recogida excursion: "';
      Text031@1103355016 : TextConst 'ESP=Al borrar este parte de trabajo, tambien se va a borrar el parte de trabajo de recogida';
      Text032@1103355018 : TextConst 'ESP=El campo %1 no puede modificarse directamente al ser un parte de recogida.\Modifique el valor en el parte de excursi¢n.';

    PROCEDURE nom_codigo_servicio@2() : Text[30];
    VAR
      rCodSer@1100244000 : Record 7010320;
    BEGIN
      // nom_codigo_servicio
      //
      IF NOT rCodSer.GET("Codigo Servicio") THEN
        EXIT('')
      ELSE
        EXIT(rCodSer.Descripcion);
    END;

    PROCEDURE nom_cliente@1() : Text[50];
    VAR
      rCli@1100244000 : Record 18;
    BEGIN
      // nom_cliente
      //
      IF NOT rCli.GET(Cliente) THEN
        EXIT('')
      ELSE
        EXIT(rCli.Name);
    END;

    PROCEDURE nom_garaje@3() : Text[30];
    VAR
      rGar@1100244000 : Record 7010310;
    BEGIN
      // nom_garaje
      //
      IF NOT rGar.GET(Garaje) THEN
        EXIT('')
      ELSE
        EXIT(rGar.Nombre);
    END;

    PROCEDURE nom_conductor@5() : Text[30];
    VAR
      rCon@1100244000 : Record 7010327;
    BEGIN
      // nom_conductor
      //
      IF NOT rCon.GET("Cod Conductor") THEN
        EXIT('')
      ELSE
        EXIT(rCon.Nombre);
    END;

    PROCEDURE nom_origen@6() : Text[30];
    VAR
      rPto@1100244000 : Record 7010315;
    BEGIN
      // nom_origen
      //
      IF NOT rPto.GET("Origen/Destino") THEN
        EXIT('')
      ELSE
        EXIT(rPto.Descripci¢n);
    END;

    PROCEDURE nom_proveedor@7() : Text[30];
    VAR
      rPro@1100244000 : Record 23;
    BEGIN
      // nom_proveedor
      //
      IF NOT rPro.GET(Proveedor) THEN
        EXIT('')
      ELSE
        EXIT(rPro.Name);
    END;

    PROCEDURE AliasProveedor@1100244004() : Code[30];
    VAR
      lrPro@1100244000 : Record 23;
    BEGIN
      // AliasProveedor

      IF lrPro.GET(Proveedor) THEN
        EXIT(lrPro."Search Name");
    END;

    PROCEDURE actualiza_vehiculo@8(vehiculo_actual@1100244000 : Code[10];vehiculo_anterior@1100244001 : Code[10];fecha_parte@1100244002 : Date);
    VAR
      rVeh@1100244003 : Record 7010346;
      rParte@1100244004 : Record 7010360;
      w_primer_dia_a¤o@1100244005 : Date;
      w_ultimo_dia_a¤o@1100244006 : Date;
    BEGIN
      // actualiza_vehiculo
      //
      // AJS --> Actualizar los campos "Fecha 1er viaje anual" y "Fecha Ultimo viaje" de
      //         xRec.Vehiculo y Vehiculo.
      //
      w_primer_dia_a¤o := DMY2DATE(1, 1, DATE2DMY(TODAY, 3));
      w_ultimo_dia_a¤o := DMY2DATE(31, 12, DATE2DMY(TODAY, 3));
      rParte.RESET;
      rParte.SETCURRENTKEY(Vehiculo,
                           Fecha);
      IF vehiculo_anterior <> '' THEN BEGIN
        rVeh.GET(vehiculo_anterior);
        rParte.SETRANGE(Vehiculo, vehiculo_anterior);
        rParte.SETRANGE(Fecha   , w_primer_dia_a¤o, w_ultimo_dia_a¤o);
        IF rParte.FINDFIRST THEN
          rVeh."Fecha 1er viaje anual" := rParte.Fecha
        ELSE BEGIN
          rParte.SETRANGE(Fecha);
          IF rParte.FINDLAST THEN
            rVeh."Fecha 1er viaje anual" := rParte.Fecha
          ELSE
            rVeh."Fecha 1er viaje anual" := 0D;
        END;

        rParte.SETRANGE(Fecha);
        IF rParte.FINDLAST THEN
          rVeh."Fecha ultimo viaje" := rParte.Fecha
        ELSE
          rVeh."Fecha ultimo viaje" := 0D;
        rVeh.MODIFY(TRUE);
      END;

      IF vehiculo_actual <> '' THEN BEGIN
        rVeh.GET(vehiculo_actual);
        rParte.SETRANGE(Vehiculo, vehiculo_actual);
        rParte.SETRANGE(Fecha   , w_primer_dia_a¤o, w_ultimo_dia_a¤o);
        IF rParte.FINDFIRST THEN
          rVeh."Fecha 1er viaje anual" := rParte.Fecha
        ELSE BEGIN
          rParte.SETRANGE(Fecha);
          IF rParte.FINDLAST THEN
            rVeh."Fecha 1er viaje anual" := rParte.Fecha
          ELSE
            rVeh."Fecha 1er viaje anual" := fecha_parte;
        END;
        rParte.SETRANGE(Fecha);
        IF rParte.FINDLAST THEN
          rVeh."Fecha ultimo viaje" := rParte.Fecha
        ELSE
          rVeh."Fecha ultimo viaje" := fecha_parte;
        rVeh.MODIFY(TRUE);
      END;
    END;

    PROCEDURE actualiza_conductor@9(conductor_actual@1100244000 : Code[10];conductor_anterior@1100244001 : Code[10];fecha_parte@1100244002 : Date);
    VAR
      rCon@1100244003 : Record 7010327;
      rParte@1100244004 : Record 7010360;
      w_primer_dia_a¤o@1100244005 : Date;
      w_ultimo_dia_a¤o@1100244006 : Date;
    BEGIN
      // actualiza_conductor
      //
      // AJS --> Actualizar los campos "Fecha 1er viaje anual" y "Fecha Ultimo viaje" de
      //         xRec.Conductor y Conductor.
      //
      w_primer_dia_a¤o := DMY2DATE(1, 1, DATE2DMY(TODAY, 3));
      w_ultimo_dia_a¤o := DMY2DATE(31, 12, DATE2DMY(TODAY, 3));
      rParte.RESET; rParte.INIT;
      rParte.SETCURRENTKEY("Cod Conductor",
                           Fecha);
      IF conductor_anterior <> '' THEN BEGIN
        rCon.GET(conductor_anterior);
        rParte.SETRANGE("Cod Conductor", conductor_anterior);
        rParte.SETRANGE(Fecha    , w_primer_dia_a¤o, w_ultimo_dia_a¤o);
        IF rParte.FINDFIRST THEN
          rCon."Fecha 1er viaje anual" := rParte.Fecha
        ELSE BEGIN
          rParte.SETRANGE(Fecha);
          IF rParte.FINDLAST THEN
            rCon."Fecha 1er viaje anual" := rParte.Fecha
          ELSE
            rCon."Fecha 1er viaje anual" := 0D;
        END;
        rParte.SETRANGE(Fecha);
        IF rParte.FINDLAST THEN
          rCon."Fecha ultimo viaje" := rParte.Fecha
        ELSE
          rCon."Fecha ultimo viaje" := 0D;
        rCon.MODIFY(TRUE);
      END;
      IF conductor_actual <> '' THEN BEGIN
        rCon.GET(conductor_actual);
        rParte.ASCENDING(TRUE);
        rParte.SETRANGE("Cod Conductor", conductor_actual);
        rParte.SETRANGE(Fecha   , w_primer_dia_a¤o, w_ultimo_dia_a¤o);
        IF rParte.FINDFIRST THEN
          rCon."Fecha 1er viaje anual" := rParte.Fecha
        ELSE BEGIN
          rParte.SETRANGE(Fecha);
          IF rParte.FINDLAST THEN
            rCon."Fecha 1er viaje anual" := rParte.Fecha
          ELSE
            rCon."Fecha 1er viaje anual" := fecha_parte;
        END;
        rParte.SETRANGE(Fecha);
        IF rParte.FINDLAST THEN
          rCon."Fecha ultimo viaje" := rParte.Fecha
        ELSE
          rCon."Fecha ultimo viaje" := fecha_parte;
        rCon.MODIFY(TRUE);
      END;
    END;

    PROCEDURE comprobar_conductor@10(pw_conductor@1100244000 : Code[10];pw_dia@1100244001 : Date;pw_nombre@1100244002 : Code[20]);
    VAR
      rCont@1100244003 : Record 7010331;
      rInc@1100244004 : Record 7010333;
    BEGIN
      // comprobar_conductor
      //
      // AJS --> Hay que comprobar que el conductor tenga contrato en vigor y no tenga incidencias
      //         para la fecha de servicio
      //
      rCont.RESET; rCont.INIT;
      rCont.SETRANGE (Conductor   , pw_conductor);
      rCont.SETFILTER("Fecha Alta", '<=%1', pw_dia);
      rCont.SETRANGE ("Fecha Baja", 0D);
      IF NOT rCont.FINDFIRST THEN BEGIN
        rCont.SETFILTER("Fecha Baja", '>=%1', pw_dia);
        IF NOT rCont.FINDFIRST THEN BEGIN
          IF CONFIRM(confirma_sin_contrato, FALSE, pw_nombre) THEN BEGIN
            IF CONFIRM(Text002,TRUE) THEN
              rCont.CreaContratoAut(pw_conductor,pw_dia)
          END
          ELSE
            ERROR(err6);
        END;
      END;

      // JPT-30/07/03 Comprueba que el contrato tenga actividad para el d¡a de la semana

      IF NOT rCont.TieneContParaDia(pw_dia,FALSE) THEN
        IF NOT CONFIRM (text3,FALSE, pw_nombre,FORMAT(pw_dia,0,Text50008)) THEN
          ERROR(err15);

      // AML 131202
      // Previa confirmaci¢n del usuario se permite asignar a un parte un conductor con incid‚ncia
      // para la fecha del parte .

      rInc.RESET; rInc.INIT;
      rInc.SETRANGE(Conductor     , pw_conductor);
      rInc.SETFILTER("Fecha Desde", '<=%1', pw_dia);
      rInc.SETRANGE("Fecha Hasta" , 0D);
      rInc.SETFILTER(Motivo       ,'<>%1',0); // JPT/01/04/04 para TRN. Una incidencia sin motivo es del tipo "dia trabajado"
      IF rInc.FINDFIRST THEN
        IF NOT CONFIRM(err7,FALSE) THEN
          ERROR(err15);

      rInc.SETFILTER("Fecha Hasta", '>=%1', pw_dia);
      IF rInc.FINDFIRST THEN
        IF NOT CONFIRM(err7,FALSE) THEN
          ERROR(err15);
    END;

    PROCEDURE actualizar_viajes@4(pParte@1100244000 : Code[10]);
    VAR
      rTxP@1100244001 : Record 7010365;
    BEGIN
      // actualizar_viajes(pNumViajes)
      //
      rTxP.RESET;
      rTxP.SETCURRENTKEY("N§ Parte");
      rTxP.SETRANGE("N§ Parte", pParte);
      // rTxP.SETRANGE(Cliente   , pwCliente);
      IF rTxP.FINDSET(TRUE) THEN REPEAT

        IF (rTxP."N§ Viajes" <> 0) AND ("Origen creacion" <> "Origen creacion"::"Recogida Automatica") THEN
          ProratearViajes
        ELSE
          rTxP."N§ Viajes"  := 0;

        rTxP.Garaje              := Rec.Garaje;
        rTxP."Cliente estadistico" := GetClienteEstadistico(rTxP.Touroperador);
        rTxP."Cliente operativo"   := Rec.Cliente;
        rTxP."Tipo Servicio"    := Rec."Tipo Servicio";
        rTxP."Codigo Servicio"  := Rec."Codigo Servicio";
        rTxP."Fecha Facturacion":= Rec."Fecha facturacion";
        rTxP.Confirmado         := Rec.Confirmado;

        // AJS 10.11.2004
        // Codigo agregado por la migracion de IBZ

        rTxP."Tipo Vehiculo" := Rec."Tipo Vehiculo";
        rTxP.Vehiculo        := Rec.Vehiculo;

        rTxP.MODIFY(TRUE);

      UNTIL rTxP.NEXT = 0;

      // ---- A¤adida la actualizacion del campo fecha en Servicios x Parte para el listado de ----
      // ---- actividad diaria del touroperador                                                ----

      { ## AJS 14.06.2006
           TEST DE RENDIMIENTO

      rHotSer.RESET; rHotSer.INIT;
      rHotSer.SETCURRENTKEY("N§ Parte");
      rHotSer.SETRANGE("N§ Parte", "N§ Parte");
      IF rHotSer.FINDSET(TRUE) THEN BEGIN
        rHotSer.MODIFYALL(Fecha            , Fecha);
        rHotSer.MODIFYALL("Tipo Servicio"  , "Tipo Servicio");
        rHotSer.MODIFYALL("Codigo Servicio", "Codigo Servicio");
        // El campo zona de trabajo puede ir tambien por Tipo Servicio Fijo
        // rHotSer.ultima_zona_fisica("N§ Parte",FALSE,FALSE);
      END;
      ## }

      rHotSer.RESET;
      rHotSer.SETCURRENTKEY("N§ Parte");
      rHotSer.SETRANGE("N§ Parte", "N§ Parte");
      IF rHotSer.FINDSET(TRUE) THEN BEGIN
        REPEAT
          rHotSer.Fecha             := Fecha;
          rHotSer."Tipo Servicio"   := "Tipo Servicio";
          rHotSer."Codigo Servicio" := "Codigo Servicio";
          rHotSer.MODIFY;
        UNTIL rHotSer.NEXT = 0;
      END;
    END;

    PROCEDURE comprobar_contratos@11();
    VAR
      rConV@1100244001 : Record 7010403;
      rConC@1100244002 : Record 7010408;
    BEGIN
      // comprobar_contratos
      //
      // AJS --> A cada linea de Touroperador por parte le corresponde un unico contrato de compra y
      //         un unico contrato de venta.
      //
      {*
      rToPar.RESET;
      rToPar.SETCURRENTKEY("N§ Parte");
      rToPar.SETRANGE("N§ Parte", "N§ Parte");
      IF rToPar.FINDSET(TRUE) THEN BEGIN
        REPEAT
          IF (Cliente <> '') AND ("Fecha facturacion" <> 0D) AND (Garaje <> '') AND
             (rToPar.Touroperador <> '') THEN BEGIN
            // JPT 27/12/05 Cambio a la nueva codeunit de calculo
            // cCalculo.busca_contrato_venta(rConV, Cliente, rToPar.Touroperador, "Fecha facturacion", Garaje);
            cCalcR.BuscaContratoVentaReal(rConV, Cliente, rToPar.Touroperador, "Fecha facturacion", Garaje);

            IF Proveedor <> '' THEN
              // JPT 27/12/05 Cambio a la nueva codeunit de calculo
              // cCalculo.busca_contrato_compra(rConC, Proveedor, rToPar.Touroperador, Cliente, "Fecha facturacion", Garaje);
              cCalcR.BuscaContratoCompraReal(rConC, Proveedor, rToPar.Touroperador, Cliente, "Fecha facturacion", Garaje);
            rToPar."N§ Contrato venta"  := rConV."N§ Contrato";
            rToPar."N§ Contrato compra" := rConC."N§ Contrato";
            rToPar.MODIFY(TRUE);
          END;

          // ---- Hay que comprobar si se ha indicado por contrato que no hay que considerar ----
          // ---- las maletas                                                                ----

          IF rToPar."N§ Contrato venta" <> '' THEN
            "Considerar maletas" := rConV."Considerar maletas";
        UNTIL rToPar.NEXT = 0;
      END;
        *}
    END;

    PROCEDURE Coherencia_Actividad_Conductor@12(VAR parte_fecha_conductor@1100244000 : Date;conductor_actual@1100244001 : Code[10];conductor_anterior@1100244002 : Code[10];parte_fecha@1100244003 : Date);
    BEGIN
      //Coherencia_Actividad_Conductor.
      //Desvalidaci¢n de los registros de actividad en funci¢n de los cambios que se hagan en los
      //partes.
      //Esta funcion se invoca en el ONVALIDATE del campo CONDUCTOR y en el evento ONDELETE().

      //Revisamos si debemos SEGUIR EL PROCESO.

      rPar.FINDFIRST;
      IF NOT rPar."Desvalidar registro actividad" THEN
        EXIT;

      IF parte_fecha_conductor = 0D THEN
        EXIT;

      //Caso1. En el ONVALIDATE. Es una desasignacion del parte con respecto a un conductor.
      IF (conductor_actual <> conductor_anterior) AND (conductor_anterior <> '') THEN
        Desvalidar_Registro_Actividad(conductor_anterior, parte_fecha_conductor);

      //Caso2. En el ONVALIDATE y en el ONDELETE.
      //.... Puede ser la desasignacion y la nueva asignacion a un conductor.
      IF conductor_actual <>'' THEN BEGIN
         Desvalidar_Registro_Actividad(conductor_actual, parte_fecha);
      END;

      //.....
      parte_fecha_conductor := 0D;
    END;

    PROCEDURE Desvalidar_Registro_Actividad@13(pConductor@1100244000 : Code[10];pFecha@1100244001 : Date);
    VAR
      cCond@1100244002 : Codeunit 7010313;
    BEGIN
      //Desvalidar_Registro_Actividad(pConductor,pFecha);

      IF cCond.DesvalidarActividad(pConductor,pFecha) THEN BEGIN

        //Tambien desasignaremos los partes de esa fecha para mantener la coherencia.
        Desasignar_Partes(pConductor,pFecha,"N§ Parte");

        //Paralelamente tambien desvalidamos todo el grupo de periodos correspondientes al
        //mismo registro de actividad.
        cCond.DesvalidarPeriodos(pConductor,pFecha);

        //Aprovecharemos para indicar la necesidad de refresco en la pantalla gr fica.
        cCond.CambioRegistroActividad(TRUE);

      END;
    END;

    PROCEDURE Desasignar_Partes@14(pConductor@1100244000 : Code[10];pFecha@1100244001 : Date;pParte@1100244002 : Code[10]);
    VAR
      rParte@1100244003 : Record 7010360;
    BEGIN
      //Desasignar_Parte()
      //Borramos la marca de asignacion del parte al conductor.
      rParte.RESET;
      rParte.SETCURRENTKEY("Cod Conductor",Fecha,"Dia siguiente","Hora inicio");
      rParte.SETRANGE("Cod Conductor", pConductor);
      rParte.SETRANGE(Fecha , pFecha,pFecha+1);
      rParte.SETFILTER("Fecha conductor",'%1',pFecha);
      rParte.SETFILTER("N§ Parte",'<>%1',pParte);
      IF rParte.FINDSET(TRUE) THEN REPEAT
        rParte."Fecha conductor" := 0D;
        rParte.MODIFY;
      UNTIL rParte.NEXT=0;
    END;

    PROCEDURE ContenidoEnPeriodo@32() : Boolean;
    VAR
      rP@1100244000 : Record 7010338;
      cCond@1100244001 : Codeunit 7010313;
      vFFParte@1100244002 : Date;
      vFFPeriodo@1100244003 : Date;
      vHFParte@1100244004 : Time;
    BEGIN
      //ContenidoEnPeriodo
      //Hemos cambiado la hora de inicio o la hora final. Miraremos que el horario del parte
      //siga contenido dentro del periodo.
      //Si es as¡, no desconfirmaremos, sino DESCONFIRMAMOS.

      //Calculamos la fecha final del parte. Consideramos que la hora final puede estar en blanco.
      //(Ya s‚ que con la segunda condicion bastaria, pero es para realzar el hecho)
      IF ("Hora final" = 0T) OR ("Hora final" < "Hora inicio") THEN
        vFFParte := Fecha
      ELSE
        vFFParte := Fecha + 1;

      //Tenemos en cuenta que la hora final puede estar en blanco.
      IF "Hora final"=0T THEN
        vHFParte:= "Hora inicio"
      ELSE
        vHFParte:= "Hora final";


      //Navegacion por los periodos
      rP.RESET;
      rP.SETCURRENTKEY(Conductor,Fecha,"Fecha Real","Hora Inicio");
      rP.SETRANGE(Conductor,"Cod Conductor");
      rP.SETRANGE(Fecha,"Fecha conductor");
      rP.SETRANGE(Validado,TRUE);

      IF rP.FINDSET THEN REPEAT
        //Calculamos las fechas finales.
        IF rP."Hora Fin" > rP."Hora Inicio" THEN
          vFFPeriodo := rP."Fecha Real"
        ELSE
          vFFPeriodo := rP."Fecha Real" + 1;

        //Si la hora de inicio est  contenida en el periodo y la hora final tambien entonces
        //es que el parte esta CONTENIDO en el periodo.
        IF cCond.InterseccionHoras(rP.Fecha,vFFPeriodo,Fecha,Fecha,rP."Hora Inicio",
                                       rP."Hora Fin","Hora inicio","Hora inicio") THEN

          IF cCond.InterseccionHoras(rP.Fecha,vFFPeriodo,vFFParte,vFFParte,rP."Hora Inicio",
                                         rP."Hora Fin",vHFParte,vHFParte) THEN
            EXIT(TRUE);

      UNTIL rP.NEXT=0;

      EXIT(FALSE);
    END;

    PROCEDURE AsignaTouroperadores@15();
    VAR
      rSerPar@1100244000 : Record 7010359;
      lwTouroperadores@1100244001 : Text[90];
    BEGIN
      // AsignaTouroperadores
      // Esta funci¢n rellena el campo Touroperadores a partir de la concatenaci¢n de los
      // campos touroperador de Servicios-Partes

      // AJS 11.06.2008
      // La variable lwTouroperadores se ha ampliado a 90 caracteres

      rSerPar.RESET;
      rSerPar.SETCURRENTKEY("N§ Parte",
                            Touroperador);
      rSerPar.SETRANGE("N§ Parte" , "N§ Parte");
      IF rSerPar.FINDSET THEN
        REPEAT
          IF STRPOS(lwTouroperadores, rSerPar.Touroperador) = 0 THEN BEGIN
            IF (lwTouroperadores <> '') AND (rSerPar.Touroperador <> '') THEN
              lwTouroperadores := lwTouroperadores + '|';
            lwTouroperadores := lwTouroperadores + rSerPar.Touroperador;
          END;
        UNTIL rSerPar.NEXT = 0;
      VALIDATE(Touroperadores , lwTouroperadores);
      MODIFY;
    END;

    PROCEDURE TraeCodDivisaCoste@16() : Code[10];
    VAR
      lrToPar@1100244000 : Record 7010365;
    BEGIN
      // TraeCodDivisaCoste
      //
      lrToPar.RESET;
      lrToPar.SETRANGE("N§ Parte", "N§ Parte");
      IF lrToPar.FINDFIRST THEN
        EXIT(lrToPar."Cod. Divisa compra")
      ELSE
        EXIT('');
    END;

    PROCEDURE TraeCodDivisaIngreso@18() : Code[10];
    VAR
      lrToPar@1100244000 : Record 7010365;
    BEGIN
      // TraeCodDivisaIngreso
      //
      lrToPar.RESET;
      lrToPar.SETRANGE("N§ Parte", "N§ Parte");
      IF lrToPar.FINDFIRST THEN
        EXIT(lrToPar."Cod. Divisa venta")
      ELSE
        EXIT('');
    END;

    PROCEDURE CambiarFechaParte@19();
    VAR
      lwVentana@1100244000 : Dialog;
      lwFecha@1100244001 : Date;
      lwFechaAnt@1103350000 : Date;
      lrTTOOParte@1103350001 : Record 7010365;
    BEGIN
      // CambiaFechaParte

      lwVentana.OPEN(Text50009);
      lwVentana.INPUT(1,lwFecha);
      IF lwFecha <> 0D THEN BEGIN
        lwFechaAnt := Fecha;
        Fecha := lwFecha;

        //BRM 16/06/04
        IF (CALCDATE(Text50004, Fecha) = lwFechaAnt) THEN BEGIN
          IF CONFIRM(Text008,FALSE) THEN
            "Dia siguiente" := TRUE;
        END;

        // JPT 13/01/05 Rellenamos el nuevo campo en TTOOxParte
        CLEAR(lrTTOOParte);
        lrTTOOParte.SETRANGE("N§ Parte","N§ Parte");
        IF lrTTOOParte.FINDSET(TRUE) THEN
          lrTTOOParte.MODIFYALL("Fecha Servicio Parte",Fecha);
        ActualizaHoraDT;
        MODIFY;
      END;
    END;

    PROCEDURE BuscaHoraInicio@20() : Time;
    VAR
      lrParametros@1100244000 : Record 7010311;
      lrSerPar@1100244001 : Record 7010359;
      lwPrimeraHora@1100244002 : Time;
      lwCodSer@1100244003 : Record 7010320;
    BEGIN
      // BuscarPrimeraHora
      // Esta funci¢n devuelve la primera hora de recogida del parte
      // Se tendr  en cuenta las horas del dia siguiente
      // Si es una Entrada y no se encuentra hora se considerar  la hora del 1 Vuelo


      lwPrimeraHora := 0T;
      lrParametros.FINDFIRST;
      lwCodSer.RESET;
      IF (lwCodSer.GET("Codigo Servicio")) AND (lwCodSer."Tipo orden" = lwCodSer."Tipo orden"::Entrada) THEN
        lwPrimeraHora := "Hora 1er Vuelo"
      ELSE BEGIN
        lrSerPar.RESET;
        lrSerPar.SETCURRENTKEY("N§ Parte","Hora recogida",Letra);
        lrSerPar.SETRANGE("N§ Parte","N§ Parte");
        // Prioridad a las horas posteriores a "Partes d¡a siguiente"
        lrSerPar.SETFILTER("Hora recogida",'>%1',lrParametros."Partes d¡a siguiente");
        IF NOT lrSerPar.FINDFIRST THEN BEGIN
          lrSerPar.SETRANGE("Hora recogida");
          IF NOT lrSerPar.FINDFIRST THEN
            EXIT(0T);
        END;

        REPEAT
          lwPrimeraHora := lrSerPar."Hora recogida";
        UNTIL (lrSerPar.NEXT=0) OR (lwPrimeraHora <> 0T);

      END;

      EXIT(lwPrimeraHora);
    END;

    PROCEDURE FormateaBonoExc@21(pEntrada@1100244000 : Code[14]) : Code[14];
    VAR
      lwTexto@1100244001 : Code[20];
      lwTextoNum@1100244002 : Code[20];
      lwCont@1100244003 : Integer;
    BEGIN
      // FormateaBonoExc
      // Devuelve a "Num. Bono Excursiones" el c¢digo que el corresponde

      lwTexto := pEntrada;
      IF lwTexto = '' THEN
        EXIT;

      lwTexto := DELCHR(lwTexto,'=','/');
      lwTexto := DELCHR(lwTexto,'=','-');

      // Se pueden introducir un maximo de 14 caracteres

      IF STRLEN(lwTexto) > 12 THEN
        ERROR(err18);

      // Comprueba que el primer caracter no es numerico
      IF NOT (lwTexto[1] IN ['A'..'Z']) THEN
        ERROR(err20);

      // Comprueba que todos los dem s caracteres sean numericos
      FOR lwCont := 2 TO STRLEN(lwTexto) DO BEGIN
        IF NOT (lwTexto[lwCont] IN ['0'..'9']) THEN
          ERROR(err19, lwTexto[lwCont]);
      END;

      // Rellena de ceros por la izquierda hasta obtener la longitud deseada

      lwTextoNum := COPYSTR(lwTexto, 2, STRLEN(lwTexto));

      FOR lwCont := STRLEN(lwTexto) TO 11 DO
        lwTextoNum := '0' + lwTextoNum;

      lwTexto := COPYSTR(lwTexto, 1, 1) + '/' + COPYSTR(lwTextoNum, 1, 10) + '-' + COPYSTR(lwTextoNum, 11, 1);

      EXIT(lwTexto);
    END;

    PROCEDURE Busca1Zona@1100244000() : Code[10];
    VAR
      lrSerPar@1100244000 : Record 7010359;
      lwZona@1100244001 : Code[10];
    BEGIN
      // Busca1Zona
      // Devuelve la primera zona de este parte

      rPar.GET;
      rPar.TESTFIELD(rPar."Codigo Salidas");
      CLEAR(lwZona);
      lrSerPar.RESET;
      lrSerPar.SETCURRENTKEY("N§ Parte","N§ Linea");
      lrSerPar.ASCENDING("Codigo Servicio" = rPar."Codigo Salidas");
      lrSerPar.SETRANGE("N§ Parte","N§ Parte");
      IF lrSerPar.FINDFIRST THEN BEGIN
        lwZona := lrSerPar."Zona fisica";
      END;
      EXIT(lwZona);
    END;

    PROCEDURE VehiculoAnterior@1100244001() : Code[10];
    VAR
      lwVehAnt@1100244000 : Code[10];
      lrVeh@1100244001 : Record 7010346;
    BEGIN
      // VehiculoAnterior

      CLEAR(lwVehAnt);
      IF "Vehiculo cambiado" THEN BEGIN
        rHist.RESET;
        rHist.SETRANGE("Tipo Fichero" , rHist."Tipo Fichero"::Parte);
        rHist.SETRANGE("N§"           , "N§ Parte");
      //  rHist.SETRANGE(Fecha          , Fecha);
        rHist.SETRANGE(Campo          , Text50012);
        rHist.SETFILTER("Valor anterior", '<>%1','');
        IF rHist.FINDFIRST THEN
          lwVehAnt:= rHist."Valor anterior";
      END;

      IF lrVeh.GET(lwVehAnt) THEN
        lwVehAnt := lrVeh.Numero;
      EXIT(lwVehAnt);
    END;

    PROCEDURE Actualiza_CodTPR@1100244003(pwCliente@1100244002 : Record 7010313);
    VAR
      lrCond@1100244000 : Record 7010420;
      lfCond@1100244001 : Form 7010454;
    BEGIN
      //BRM Pedimos Cod. TPR para asignar al servicio
      IF ("Cod Grupo" <> '') THEN
        "Cod Grupo" := '';

      IF pwCliente."Cliente Siempre Grupos" THEN BEGIN

        // AJF 07/01/09
        // Evito borrar el registro, ya que ahora tiene datos permanentes.
        IF lrCond.GET(USERID) THEN
          lrCond.LimpiaRegistro
        ELSE BEGIN
          lrCond.INIT;
          lrCond.Usuario := USERID;
          lrCond.INSERT;
        END;

        lrCond.Cliente := pwCliente.Cliente;
        lrCond.Touroperador := pwCliente.TTOO;
        lrCond.MODIFY;
        COMMIT;
        lrCond.SETRECFILTER;

        CLEAR(lfCond);
        lfCond.SETTABLEVIEW(lrCond);
        lfCond.SETRECORD(lrCond);
        IF lfCond.RUNMODAL=ACTION::OK THEN BEGIN
          lfCond.GETRECORD(lrCond);
          VALIDATE("Cod Grupo", lrCond."Cod. Grupo");
        END;

        IF ("Cod Grupo" = '') AND rCliTo."Cliente Siempre Grupos" THEN
            ERROR(err23, pwCliente.Cliente, pwCliente.TTOO);

      END;
    END;

    PROCEDURE ActualizaHoraDT@1100244002();
    VAR
      lwFecha@1100244000 : Date;
    BEGIN
      // ActualizaHoraDT
      // Actualiza la Hora Inicio DT
      // Es del tipo DateTime

      CLEAR("Hora Inicio DT");
      // JPT 02/02/10 Datetime a Biginteger
      CLEAR("Hora Inicio BI");

      lwFecha:= Fecha;
      IF (lwFecha <> 0D) AND "Dia siguiente" THEN
        lwFecha := lwFecha + 1;

      "Fecha Real" := lwFecha;

      IF (lwFecha<>0D) AND ("Hora inicio"<>0T) THEN
        VALIDATE("Hora Inicio DT", CREATEDATETIME(lwFecha,"Hora inicio"));
    END;

    PROCEDURE SetBol@1103350000(wN@1103350001 : Integer;wValor@1103350000 : Boolean);
    BEGIN
      // SetBol
      // Marca el valor de la matriz wBol JPT 24/08/04.
      // wBol es una matriz de uso general para poder modificar algunos comportamientos desde fuera
      // As¡ la dimension:
      // 1 : Se utiliza para no hacer la comprobaci¢n de dias abiertos/Cerrados
      // 2 : Importacion Resultados OPTRAT Invisa. No automatiza conductor ni vehiculo
      // 3 : Backup de la tabla en borrado. Si wBol=true no se realiza el backup

      wBol[wN]:= wValor;
    END;

    PROCEDURE GetBol@1103350001(wN@1103350000 : Integer) : Boolean;
    BEGIN
      // GetBol
      // Devuelve el valor de la matriz wBol JPT 24/08/04.
      // wBol es una matriz de uso general para poder modificar algunos comportamientos desde fuera

      EXIT(wBol[wN]);
    END;

    PROCEDURE RellenaZonasFiscasParte@1103350002();
    VAR
      lrZonFisPar@1103350000 : Record 7010366;
      lrSerPar@1103350001 : Record 7010359;
      lrZonFis@1103350002 : Record 7010314;
    BEGIN
      // RellenaZonasFiscasParte
      // JPT 04/02/05 Esta funci¢n Borra todos los registros de "Zona Fisica Parte" y los crea de nuevo

      CLEAR(lrZonFisPar);
      lrZonFisPar.SETRANGE("N§ Parte", "N§ Parte");
      IF lrZonFisPar.FINDSET(TRUE) THEN
        lrZonFisPar.DELETEALL;

      CLEAR(lrSerPar);
      lrSerPar.SETCURRENTKEY("N§ Parte","N§ Linea");
      lrSerPar.SETRANGE("N§ Parte","N§ Parte");
      IF lrSerPar.FINDSET THEN BEGIN
        REPEAT
          IF NOT lrZonFisPar.GET(lrSerPar."N§ Parte", lrSerPar."Zona fisica") THEN BEGIN
            lrZonFisPar."N§ Parte"    := lrSerPar."N§ Parte";
            lrZonFisPar."Zona fisica" := lrSerPar."Zona fisica";
            IF lrZonFis.GET(lrSerPar."Zona fisica") THEN
              lrZonFisPar.Orden := lrZonFis.Orden;
            lrZonFisPar.INSERT;
          END;
          lrZonFisPar.Adultos             := lrZonFisPar.Adultos + lrSerPar."Adultos transportados";
          lrZonFisPar."Adultos invitados" := lrZonFisPar."Adultos invitados" + lrSerPar."Adultos invitados ingreso";
          lrZonFisPar.Ni¤os               := lrZonFisPar.Ni¤os + lrSerPar."Ni¤os transportados";
          lrZonFisPar."Ni¤os invitados"   := lrZonFisPar."Ni¤os invitados" + lrSerPar."Ni¤os invitados ingreso";
          lrZonFisPar.MODIFY;
        UNTIL lrSerPar.NEXT=0;
      END;
    END;

    PROCEDURE DevuelveCodigoBarra@1103350003() : Code[20];
    VAR
      lwCodigoBarras@1103350006 : Text[30];
      lwDiaText@1103350005 : Text[30];
      lwMesText@1103350004 : Text[30];
      lwDiaNum@1103350001 : Integer;
      lwMesNum@1103350000 : Integer;
      lwCodControl@1103350002 : Char;
    BEGIN
      // DevuelveCodigoBarra

      IF "Codigo Barras" <> '' THEN
        EXIT("Codigo Barras");

      lwDiaNum := DATE2DMY(Fecha, 1);
      IF lwDiaNum <= 9 THEN
        lwDiaText := '0' + FORMAT(DATE2DMY(Fecha, 1))
      ELSE
        lwDiaText := FORMAT(DATE2DMY(Fecha, 1));

      lwMesNum := DATE2DMY(Fecha, 2);
      IF lwMesNum <= 9 THEN
        lwMesText := '0' + FORMAT(DATE2DMY(Fecha, 2))
      ELSE
        lwMesText := FORMAT(DATE2DMY(Fecha, 2));

      //lwCodigoBarras := '!' + FORMAT(DATE2DMY(Fecha, 3)) + lwMesText + lwDiaText + "N§ Parte" + '!';
      lwCodigoBarras := FORMAT(DATE2DMY(Fecha, 3)) + lwMesText + lwDiaText + "N§ Parte";

      EXIT(lwCodigoBarras)
    END;

    LOCAL PROCEDURE DevuelveCodControl@1103350005(pwCodigo@1103350003 : Code[10]) : Char;
    VAR
      lwChar@1103350000 : Char;
      lwPar@1103350001 : Integer;
      lwImpar@1103350002 : Integer;
      lwN@1103350004 : Integer;
      lwNum@1103350005 : Integer;
      lwNumTot@1103350006 : Integer;
    BEGIN
      // DevuelveCodControl
      // JPT 14/03/05

      CLEAR(lwPar);
      CLEAR(lwImpar);

      FOR lwN := 1 TO STRLEN(pwCodigo)  DO BEGIN
        lwChar:= pwCodigo[lwN];
        IF EVALUATE(lwNum,FORMAT(lwChar)) THEN BEGIN
          IF lwNum MOD 2 =0 THEN
            lwPar:= lwPar + lwNum
          ELSE
            lwImpar := lwImpar + lwNum;
        END;
      END;

      lwNumTot := (lwImpar * 3) + lwPar;
      lwChar   := lwNumTot;
      EXIT(lwChar);
    END;

    PROCEDURE TraduceCodBarrasaHI25S@1103350006(pwCodigo@1103350003 : Text[30]) : Text[30];
    VAR
      lwChar@1103350000 : Char;
      lwN@1103350004 : Integer;
      lwNum@1103350005 : Integer;
      lwNumTot@1103350006 : Integer;
      lwCodigo@1103350007 : Text[20];
      lwCodigoFinal@1103350002 : Text[20];
      lwCodCar@1103350010 : Text[2];
      lwFactor@1103350008 : Integer;
      lwTotal@1103350009 : Integer;
      lwResto@1103350001 : Integer;
    BEGIN
      // TraduceCodBarrasaHI25S
      // JPT 14/03/05

      CLEAR(lwTotal);

      // Primero eliminamos los caracteres No numericos
      CLEAR(lwCodigo);
      FOR lwN := 1 TO STRLEN(pwCodigo)  DO BEGIN
       lwChar:= pwCodigo[lwN];
       IF lwChar IN ['0'..'9']  THEN
         lwCodigo := lwCodigo + FORMAT(lwChar);
      END;

      //
      // De atras a adelante va sumando los importes multiplicando por 3,1,3,1 consecutivamente
      { MENTIDA
      // Si el numero de posiciones es par empieza por 3  sino por 1
      IF STRLEN(lwCodigo) MOD 2 = 0 THEN
        lwFactor := 3
      ELSE
        lwFactor := 1;
      }
      lwFactor := 3;
      FOR lwN := STRLEN(lwCodigo) DOWNTO 1 DO BEGIN
       lwChar:= lwCodigo[lwN];
       EVALUATE(lwNum,FORMAT(lwChar));
       lwTotal := lwTotal + (lwNum * lwFactor);
       lwFactor := 4 - lwFactor;
      END;

      CLEAR(lwNumTot);
      lwResto := lwTotal MOD 10;
      IF lwResto <> 0 THEN
        lwNumTot := 10 - lwResto;

      lwCodigo := lwCodigo + FORMAT(lwNumTot);

      // Si es un numero impar el a¤ade un 0
      IF STRLEN(lwCodigo) MOD 2 <> 0 THEN
        lwCodigo := '0' + lwCodigo;

      CLEAR(lwCodigoFinal);
      // Ahora convierte el numero en codigos ASCII en grupos de a 2
      FOR lwN := 1 TO (STRLEN(lwCodigo) DIV 2) DO BEGIN
        lwCodCar := COPYSTR(lwCodigo,1,2);
        lwCodigo := COPYSTR(lwCodigo,3,STRLEN(lwCodigo));

        EVALUATE(lwNum,lwCodCar);
        IF lwNum < 94 THEN
          lwNum := lwNum + 33
        ELSE
          lwNum := lwNum + 103;

        // JPT en este ultimo caso las correspondencias ASCII no son buenas por lo que establecemos las siguientes conversiones
        CASE lwNum OF
          197: lwChar:='';
          198: lwChar:='’';
          199: lwChar:='€';
          200: lwChar:='Ô';
          201: lwChar:='';
          202: lwChar:='Ò';
          203: lwChar:='Ó';
          204: lwChar:='Þ';
          ELSE lwChar := lwNum;
        END;
        lwCodigoFinal := lwCodigoFinal + FORMAT(lwChar);
      END;

      // Se le a¤aden los caracteres de Iniciio y Final
      lwCodigoFinal := 'Ó' + lwCodigoFinal + 'Þ ';

      EXIT(lwCodigoFinal);
    END;

    PROCEDURE MantenTipoIngreso@1103350004();
    VAR
      lrTxP@1100244002 : Record 7010365;
      lwTTOO@1103350000 : ARRAY [2] OF Code[10];
      lrConfCalcIng@1103350002 : Record 7035379;
    BEGIN
      // MantenTipoIngreso
      //

      // AJS 29.04.2005
      // De momento solo para ultramar

      rPar.FINDFIRST;
      IF rPar."Empresa Real" <> rPar."Empresa Real"::UEX THEN
        EXIT;

      CLEAR(lwTTOO);
      CLEAR(lrConfCalcIng);
      lrTxP.SETRANGE("N§ Parte"   ,"N§ Parte");
      IF lrTxP.FINDSET THEN BEGIN
        REPEAT
          // JPT 07/03/05 Para insertar el tipo de Calculo Ingreso en Parte a partir de la combinaci¢n de TTOOs
          IF lwTTOO[1] = '' THEN
            lwTTOO[1] := lrTxP.Touroperador
          ELSE
            IF lwTTOO[2] = '' THEN
              lwTTOO[2] := lrTxP.Touroperador
          UNTIL lrTxP.NEXT=0;
      END;

      CLEAR("Tipo Calculo Ingresos");
      // JPT 07/03/05 Para insertar el tipo de Calculo Ingreso en Parte a partir de la combinaci¢n de TTOOs
      IF (lwTTOO[1] <> '') AND (lwTTOO[2] <> '') THEN BEGIN
        IF lrConfCalcIng.GET(lwTTOO[1],lwTTOO[2]) THEN BEGIN
          "Tipo Calculo Ingresos" := lrConfCalcIng."Tipo Calculo Ingreso";
          MODIFY;
        END;
      END

      // AJS 27.04.05
      // Cuando un TTOO va solo se aplica el precio promedio para calcular bien los minimos en ultramar

      ELSE BEGIN
        "Tipo Calculo Ingresos" := "Tipo Calculo Ingresos"::Normal;
        MODIFY;
      END;
    END;

    PROCEDURE GetGestor@1103350007();
    BEGIN
      // GetGestor
      // Se rellena el codigo de gestor a partir de la configuraci¢n indicada en Cliente/TTOO

      CLEAR(rCliTo);
      IF NOT rCliTo.GET(Cliente,"Touroperador principal") THEN
        CLEAR(rCliTo);
      VALIDATE(Gestor, rCliTo.Gestor);
    END;

    PROCEDURE VerPDF@1103350008();
    BEGIN
      // VerPDF
      // Lanza el visionado del PDF
      HYPERLINK(ArchivoPDF)
    END;

    PROCEDURE MantenVersion@1100253000(pwModificacion@1100253000 : Boolean);
    VAR
      lwNoCamps@1100253001 : ARRAY [20] OF Integer;
      lwRParte@1100253002 : RecordRef;
      lwRXrecParte@1100253003 : RecordRef;
      lwNo@1100253004 : Integer;
      lwField@1100253005 : FieldRef;
      lwXrecField@1100253006 : FieldRef;
      lwOk@1100253007 : Boolean;
      lwOk2@1100253008 : Boolean;
    BEGIN
      // MantenVersion
      // JPT 20/07/05 Mantemeos el campo Version
      //
      // Si pwModificacion= False se marca de todos modos
      // Si es una modificacion cambiamos el numero de versi¢n si dicha modificaci¢n afecta a alguno de los siguientes campos

      rPar.FINDFIRST;
      IF NOT (rPar."Empresa Real" IN [rPar."Empresa Real"::TRN, rPar."Empresa Real"::SJO,
                                      rPar."Empresa Real"::IBZ, rPar."Empresa Real"::CNT]) THEN
        EXIT;

      IF NOT Impreso THEN
        EXIT;

      lwOk:= TRUE;

      IF pwModificacion THEN BEGIN
        lwRParte.GETTABLE(Rec);
        lwRXrecParte.GETTABLE(xRec);
        lwOk2 := TRUE;
        FOR lwNo:=1 TO lwRParte.FIELDCOUNT DO BEGIN
          lwField     := lwRParte.FIELDINDEX(lwNo);
          lwXrecField := lwRXrecParte.FIELDINDEX(lwNo);
          // Campos que afectan al Parte
          IF lwField.NUMBER IN [3,5,7,9,11,17,19,21,23,25,27,59,73,81,83,105,118,125,127] THEN
            lwOk2 := lwOk2 AND (lwField.VALUE = lwXrecField.VALUE);
          IF NOT lwOk2 THEN  // Si ya hay alguna diferencia se realiza una salida prematura del bucle
            lwNo:= lwRParte.FIELDCOUNT;
        END;
        lwOk := NOT lwOk2;
      END;

      IF lwOk THEN BEGIN
        // Indica que no se ha modifica despues de la £ltima impresi¢n por lo que
        IF Impreso THEN BEGIN
          VALIDATE(Version,Version+1);
          Impreso:= FALSE;
        END;
      END;
    END;

    PROCEDURE MantenNoExp@1100253007(pwModificacion@1100253000 : Boolean);
    VAR
      lwNoCamps@1100253001 : ARRAY [20] OF Integer;
      lwRParte@1100253002 : RecordRef;
      lwRXrecParte@1100253003 : RecordRef;
      lwNo@1100253004 : Integer;
      lwField@1100253005 : FieldRef;
      lwXrecField@1100253006 : FieldRef;
      lwOk@1100253007 : Boolean;
      lwOk2@1100253008 : Boolean;
    BEGIN
      // MantenNoExp
      // JPT 29/03/06 Mantemeos el campo "Num Exportacion Prov" para volver a exportarlo si ha habido cambios

      // Si pwModificacion= False se marca de todos modos
      // Si es una modificacion borramos el numero de exportacion si dicha modificaci¢n afecta a alguno de los siguientes campos

      IF "Num Exportacion Prov"=0 THEN // Si no se ha exportado a£n , salimos
        EXIT;

      lwOk:= TRUE;

      IF pwModificacion THEN BEGIN
        lwRParte.GETTABLE(Rec);
        lwRXrecParte.GETTABLE(xRec);
        lwOk2 := TRUE;
        FOR lwNo:=1 TO lwRParte.FIELDCOUNT DO BEGIN
          lwField     := lwRParte.FIELDINDEX(lwNo);
          lwXrecField := lwRXrecParte.FIELDINDEX(lwNo);
          // Campos que afectan al Parte
          IF lwField.NUMBER IN [5,7,9,19,25,53,85,87,107,118] THEN
            lwOk2 := lwOk2 AND (lwField.VALUE = lwXrecField.VALUE);
          IF NOT lwOk2 THEN  // Si ya hay alguna diferencia se realiza una salida prematura del bucle
            lwNo:= lwRParte.FIELDCOUNT;
        END;
        lwOk := NOT lwOk2;
      END;

      IF lwOk THEN BEGIN
        VALIDATE("Num Exportacion Prov", 0);
      END;
    END;

    PROCEDURE ShowAnotaciones@1100253001();
    VAR
      lrAnotacion@1100253000 : Record 7010435;
    BEGIN
      // ShowAnotaciones

      IF "N§ Parte"='' THEN
        EXIT;

      CLEAR(lrAnotacion);
      lrAnotacion.FILTERGROUP(2);
      lrAnotacion.SETRANGE("N§ Parte", "N§ Parte");
      lrAnotacion.FILTERGROUP(0);
      FORM.RUNMODAL(0,lrAnotacion);
    END;

    PROCEDURE Renumera@1100253003();
    VAR
      lwNoParte@1100253000 : Code[10];
    BEGIN
      // Renumera

      rPar.FINDFIRST;
      rPar.TESTFIELD("Serie Partes");
      lwNoParte := GestNoSerie.GetNextNo(rPar."Serie Partes", TODAY, TRUE);
      CambiaNumParte(lwNoParte);
    END;

    PROCEDURE CambiaNumParte@1100253002(pwNumParte@1100253000 : Code[10]);
    VAR
      lrToPar2@1100253001 : Record 7010365;
      lrSerPar@1100253002 : Record 7010359;
      lrSerPar2@1103355000 : Record 7010359;
      lrElemPto@1100253003 : Record 7010363;
      lrHist@1100253004 : Record 7010361;
      lrHist2@1100253015 : Record 7010361;
      lrExtr@1100253007 : Record 7010362;
      lrExtr2@1100253008 : Record 7010362;
      lrVuelos@1100253009 : Record 7035335;
      lrVuelos2@1100253010 : Record 7035335;
      lrAnot@1100253011 : Record 7010435;
      lrAnot2@1100253012 : Record 7010435;
      lrZonF@1100253013 : Record 7010366;
      lrZonF2@1100253014 : Record 7010366;
    BEGIN
      // CambiaNumParte
      // Renumeramos el numero de parte
      // Para todos aquellos casos en que afecte a la clave primaria, se borrar  el registro y se crear  de nuevo

      IF pwNumParte='' THEN
        ERROR(Text014);

      // Touroperador x parte

      CLEAR(rToPar);

      // AJS 18.07.2006
      // Bloqueo explicito de la tabla de touroperador x parte

      lrToPar2.LOCKTABLE(TRUE, FALSE);

      rToPar.SETRANGE("N§ Parte", "N§ Parte");
      IF rToPar.FINDSET(TRUE) THEN BEGIN
        REPEAT
          lrToPar2 := rToPar;
          lrToPar2.DELETE;
          lrToPar2."N§ Parte" := pwNumParte;
          lrToPar2.INSERT;
        UNTIL rToPar.NEXT=0;
      END;

      // Servicios-Partes

      {## AJS 14.06.2006 TEST DE RENDIMIENTO

      CLEAR(rlSerPar);
      rlSerPar.SETCURRENTKEY("N§ Parte","N§ Linea");
      rlSerPar.SETRANGE("N§ Parte", "N§ Parte");
      IF rlSerPar.FINDSET(TRUE) THEN
        rlSerPar.MODIFYALL("N§ Parte", pwNumParte);

      ## }

      CLEAR(lrSerPar);
      lrSerPar.SETCURRENTKEY("N§ Parte","N§ Linea");
      lrSerPar.SETRANGE("N§ Parte", "N§ Parte");
      IF lrSerPar.FINDSET(TRUE) THEN BEGIN
        REPEAT
          lrSerPar2 := lrSerPar;
          lrSerPar2."N§ Parte" := pwNumParte;
          lrSerPar2.MODIFY;
        UNTIL lrSerPar.NEXT = 0;
      END;

      // Elementos x punto (suplementos)

      CLEAR(lrElemPto);
      lrElemPto.SETCURRENTKEY("N§ Parte","N§ Linea");
      lrElemPto.SETRANGE("N§ Parte", "N§ Parte");
      IF lrElemPto.FINDSET(TRUE) THEN
        lrElemPto.MODIFYALL("N§ Parte", pwNumParte);

      // Historico Servicios-Partes
      // Se han de tratar por separados los registros referentes a cabecera de Parte y lineas

      CLEAR(lrHist); // Cabecera
      lrHist.SETRANGE("Tipo Fichero", lrHist."Tipo Fichero"::Parte);
      lrHist.SETRANGE("N§"          , "N§ Parte");
      IF lrHist.FINDSET(TRUE) THEN BEGIN
        REPEAT
          lrHist2 := lrHist;
          lrHist2.DELETE;
          lrHist2."N§":= pwNumParte;
          lrHist2.INSERT;
        UNTIL lrHist.NEXT=0;
      END;

      CLEAR(lrHist);  // Lineas
      lrHist.SETCURRENTKEY("Tipo Fichero",NoParte);
      lrHist.SETRANGE("Tipo Fichero", lrHist."Tipo Fichero"::Linea);
      lrHist.SETRANGE(NoParte, "N§ Parte");
      IF lrHist.FINDSET(TRUE) THEN
        lrHist.MODIFYALL(NoParte, pwNumParte);

      // Extras Parte

      CLEAR(lrExtr);
      lrExtr.SETRANGE("N§ Parte", "N§ Parte");
      IF lrExtr.FINDSET(TRUE) THEN BEGIN
        REPEAT
          lrExtr2 := lrExtr;
          lrExtr2.DELETE;
          lrExtr2."N§ Parte" := pwNumParte;
          lrExtr2.INSERT;
        UNTIL lrExtr.NEXT=0;
      END;

      // Vuelos x Parte

      CLEAR(lrExtr);
      lrVuelos.SETRANGE("N§Parte", "N§ Parte");
      IF lrVuelos.FINDSET(TRUE) THEN BEGIN
        REPEAT
          lrVuelos2 := lrVuelos;
          lrVuelos2.DELETE;
          lrVuelos2."N§Parte" := pwNumParte;
          lrVuelos2.INSERT;
        UNTIL lrVuelos.NEXT=0;
      END;

      // Anotaciones Parte

      CLEAR(lrAnot);
      lrAnot.SETRANGE("N§ Parte", "N§ Parte");
      IF lrAnot.FINDSET(TRUE) THEN BEGIN
        REPEAT
          lrAnot2 := lrAnot;
          lrAnot2.DELETE;
          lrAnot2."N§ Parte" := pwNumParte;
          lrAnot2.INSERT;
        UNTIL lrAnot.NEXT=0;
      END;

      // Zonas fisicas Parte

      CLEAR(lrZonF);
      lrZonF.SETRANGE("N§ Parte", "N§ Parte");
      IF lrZonF.FINDSET(TRUE) THEN BEGIN
        REPEAT
          lrZonF2 := lrZonF;
          lrZonF2.DELETE;
          lrZonF2."N§ Parte" := pwNumParte;
          lrZonF2.INSERT;
        UNTIL lrZonF.NEXT=0;
      END;

      //  Siempre por ultimo
      //  Parte

      // AJS 26.07.2006
      // Bloqueamos explicitamente la tabla parte para evitar errores de bloqueo

      LOCKTABLE;

      DELETE;
      "N§ Parte" := pwNumParte;
      INSERT;
    END;

    PROCEDURE NumTempParte@1100253004() : Code[10];
    VAR
      lwCod@1100253000 : Code[10];
    BEGIN
      // NumTempParte
      // Devuelve un numero de parte temporal

      // En este caso proponemos los 4 primeros digitos del usuario + el numero de segundo del d¡a
      // Ha tener en cuenta que un d¡a tiene 86400 segundos
      // Le pongo el signo $ al principio para evitar codigos de usuario numericos

      CLEAR(lwCod);
      lwCod := STRSUBSTNO('$%1%2', COPYSTR(USERID,1,4) , FORMAT(ABS((000000T-TIME) DIV 1000),0,Text50013));
      EXIT(lwCod)
    END;

    PROCEDURE ImprimeLetrero@1100253005(pwSiempre@1100253000 : Boolean;pwReqWindow@1100253001 : Boolean);
    VAR
      lrParte@1100253002 : Record 7010360;
    BEGIN
      // ImprimeLetrero
      // Lanza la impresi¢n del report relacionado al campo "Letreros"
      // pwSiempre Determina si se tiene que imprimir aunque no este marcado el campo "Imprimir Leteros"

      lrParte := Rec;
      lrParte.SETRECFILTER;
      // En principio el report va "a pi¤on"
      IF "Imprimir Letreros" OR pwSiempre THEN
        REPORT.RUNMODAL(7010393, pwReqWindow, TRUE, lrParte);
    END;

    PROCEDURE TieneDocumentosAImp@1100253006() : Boolean;
    VAR
      lwTiene@1100253000 : Boolean;
      lrSerPar@1100253001 : Record 7010359;
    BEGIN
      // TieneDocumentosAImp
      // JPT 06/02/06 Devuelve true si tiene alg£n documento extra a imprimir junto con el parte

      lwTiene := FALSE;
      lwTiene := "Imprimir Letreros";
      lwTiene := lwTiene OR ("Peticion Servicio Cliente" <> '');

      IF NOT lwTiene THEN BEGIN
        CLEAR(lrSerPar);
        lrSerPar.SETCURRENTKEY("N§ Parte" , "N§ Linea");
        lrSerPar.SETRANGE("N§ Parte"      , "N§ Parte");
        IF lrSerPar.FINDSET THEN BEGIN
          REPEAT
            lwTiene := lwTiene OR lrSerPar."Imprimir Documento Descriptivo";
          UNTIL (lrSerPar.NEXT = 0) OR lwTiene;
        END;
      END;

      EXIT(lwTiene);
    END;

    PROCEDURE CompVehConductor@1103355000();
    VAR
      lrVeh@1103355000 : Record 7010346;
    BEGIN
      // CompVehConductor
      // JPT 16/05/06 Si para UEX en un mismo d¡a se asignan dos vehiculos a un mismo conductor se lanza un aviso

      rPar.FINDFIRST;

      IF ("Cod Conductor" = '') OR (Vehiculo = '') THEN
        EXIT;

      // AJS 18.07.2006
      // Solo se hace la comprobacion si el conductor es propio

      IF NOT rCond.GET("Cod Conductor") THEN
        EXIT;

      // JPT 08/11/07 Avisamos si el conductor es propio y el vehiculo no o viceversa

      CLEAR(lrVeh);
      lrVeh.GET(Vehiculo);
      IF NOT (lrVeh."Vehiculo propio" XOR rCond.Externo) THEN BEGIN
        IF lrVeh."Vehiculo propio" THEN
          MESSAGE(Text025, lrVeh.Numero, rCond.Conductor)
        ELSE
          MESSAGE(Text026, rCond.Conductor, lrVeh.Numero)
      END;

      IF NOT (rPar."Empresa Real" IN [rPar."Empresa Real"::UEX]) THEN
        EXIT;

      IF rCond.Externo THEN
        EXIT;

      CLEAR(rParte);
      rParte.SETCURRENTKEY(Fecha,
                           "Cod Conductor");

      rParte.SETRANGE(Fecha           , Fecha);
      rParte.SETRANGE("Cod Conductor" , "Cod Conductor");
      rParte.SETFILTER(Vehiculo       , '<>%1&<>%2', Vehiculo,'');
      rParte.SETFILTER("N§ Parte"     , '<>%1', "N§ Parte");
      IF rParte.FINDFIRST THEN
        MESSAGE(Text021, "Cod Conductor", rParte.Vehiculo, Fecha , rParte."N§ Parte");
    END;

    PROCEDURE ArchivoPDF@1103355001() : Text[1024];
    VAR
      lwNombreFichero@1103355000 : Text[1024];
    BEGIN
      // ArchivoPDF
      // Devuelve el nombre y direccion del archivo PDF relacionado

      TESTFIELD("Codigo Barras");
      rPar.FINDFIRST;
      rPar.TESTFIELD("Ruta ficheros PDF");

      lwNombreFichero := rPar."Ruta ficheros PDF";
      lwNombreFichero += '\' + COPYSTR("Codigo Barras", 1, 4) + '\' + COPYSTR("Codigo Barras", 5, 2) + '\' +
                        COPYSTR("Codigo Barras", 7, 2) + '\' + DELCHR(COPYSTR("Codigo Barras", 9, 10), '<>', '!') + Text50014;

      EXIT(lwNombreFichero);
    END;

    PROCEDURE TotalIngreso@1103355004() : Decimal;
    BEGIN
      // TotalIngreso
      // Calculamos el total del ingreso Facturado + Producido pendiente de facturar

      CALCFIELDS("Ingreso DL", "Ingreso DL Prod");
      EXIT("Ingreso DL" + "Ingreso DL Prod");
    END;

    PROCEDURE TotalIngresoCon@1103355006() : Decimal;
    VAR
      lrCI@1103355001 : Record 7010414;
      lrProd@1103355000 : Record 7035392;
      lwTotal@1103355002 : Decimal;
    BEGIN
      // TotalIngresoCon
      // Calculamos el total ingreso facturado + Producido Con IMPUESTOS INCLUIDOS

      CLEAR(lwTotal);
      CLEAR(lrCI);
      lrCI.SETRANGE("N§ Parte", "N§ Parte");
      IF lrCI.FINDSET THEN BEGIN
        REPEAT
          lwTotal += lrCI."Importe con impuesto DL";
        UNTIL lrCI.NEXT = 0;
        // AJS 01.07.2009
      END;

      CLEAR(lrProd);
      lrProd.SETRANGE("N§ Parte", "N§ Parte");
      IF lrProd.FINDSET THEN BEGIN
        REPEAT
          lwTotal += lrProd."Importe con impuesto DL";
        UNTIL lrProd.NEXT=0;
      END;

      EXIT(lwTotal);
    END;

    PROCEDURE TotalCosteCon@1103355009() : Decimal;
    VAR
      lrProdC@1103355000 : Record 7035393;
      lwTotal@1103355001 : Decimal;
    BEGIN
      // TotalCosteCon
      // Total coste con impuesto

      CLEAR(lwTotal);
      CLEAR(lrProdC);
      lrProdC.SETRANGE("N§ Parte", "N§ Parte");
      IF lrProdC.FINDSET THEN BEGIN
        lrProdC.CALCSUMS("Importe con impuesto DL");
        lwTotal += lrProdC."Importe con impuesto DL";
      END;

      EXIT(lwTotal);
    END;

    PROCEDURE TotalLineas@1103355002() : Integer;
    VAR
      lrSerPar@1103355000 : Record 7010359;
    BEGIN
      // TotalLineas
      // Cuenta las lineas de recogida

      CLEAR(lrSerPar);
      lrSerPar.SETCURRENTKEY("N§ Parte","N§ Linea");
      lrSerPar.SETRANGE("N§ Parte", "N§ Parte");
      EXIT(lrSerPar.COUNT);
    END;

    PROCEDURE ActualizaDatosVuelos@1103355003(VAR prLinea@1103355002 : Record 7010359;pbBaja@1103355003 : Boolean);
    VAR
      lrLinsParte@1103355000 : Record 7010359;
      lrVuelosTMP@1103355001 : TEMPORARY Record 7035335;
    BEGIN
      // ActualizaDatosVuelos

      rPar.FINDFIRST;

      // JPT 02/02/10 Datetime a Biginteger
      // lrLinsParte.SETCURRENTKEY("FechaHora Parte", "FechaHora Vuelo");
      lrLinsParte.SETCURRENTKEY("FechaHora Parte BI", "FechaHora Vuelo BI");
      lrLinsParte.SETRANGE("N§ Parte", Rec."N§ Parte");

      IF pbBaja THEN
        lrLinsParte.SETFILTER("N§ Linea", '<>%1', prLinea."N§ Linea");

      lrLinsParte.SETFILTER("Hora Vuelo", '<>%1', 0T);

      Vuelos := '';

      IF lrLinsParte.FINDSET THEN BEGIN
        // JPT 02/02/10 Aseguramos "FechaHora Vuelo"
        lrLinsParte.VALIDATE("FechaHora Vuelo BI");
        "Hora 1er Vuelo" := lrLinsParte."Hora Vuelo";
        IF "Codigo Servicio" = rPar."Codigo Entradas" THEN
        BEGIN
          "Hora inicio"    := lrLinsParte."Hora Vuelo";
          //Fecha            := DT2DATE(lrLinsParte."FechaHora Vuelo");
          // ActualizaHoraDT; JPT 09/03/10 No tiene ning£n sentido ya que el campo "Hora Inicio DT" se modifica abajo
          "Hora Inicio DT" := lrLinsParte."FechaHora Vuelo";
          // JPT 02/02/10 asignar "Hora Inicio BI
          HIniDTBI;
        END;

        REPEAT

          // Guardamos en un temporary los vuelos para no repetir.
          IF NOT lrVuelosTMP.GET('', COPYSTR(lrLinsParte.Vuelo, 1, 10), '') THEN
          BEGIN
            lrVuelosTMP.INIT;
            lrVuelosTMP."N§Parte"             := '';
            lrVuelosTMP."Referencia Vuelo"    := COPYSTR(lrLinsParte.Vuelo, 1, 10);
            lrVuelosTMP.IATA                  := COPYSTR(lrLinsParte.IATA, 1, 4);
            lrVuelosTMP."Codigo Touroperador" := '';
            lrVuelosTMP.INSERT;

            Vuelos += lrLinsParte.Vuelo + ',' + COPYSTR(lrLinsParte.IATA, 1, 4) + ',';
          END;

        UNTIL lrLinsParte.NEXT = 0;

        Vuelos := DELSTR(Vuelos, STRLEN(Vuelos));

      END;

      MODIFY;
    END;

    PROCEDURE ImprimeDesgloseRecogida@1103355005();
    VAR
      lrParte@1103355000 : Record 7010360;
    BEGIN
      lrParte := Rec;
      lrParte.SETRECFILTER;
      REPORT.RUNMODAL(7010398, FALSE, FALSE, lrParte);
    END;

    PROCEDURE GenerarParteRecogida@1103355007();
    VAR
      lrTipoServicio@1103355000 : Record 7010319;
      lrParteRecogida@1103355001 : Record 7010360;
      lrSubtrayectos@1103355002 : Record 7035399;
      lrLinsParte@1103355003 : Record 7010359;
      lrLinsParteInv@1103355008 : Record 7010359;
      lrLinsRecogida@1103355004 : Record 7010359;
      lrServicio@1103355005 : Record 7010358;
      lrTTOOxParte@1103355006 : Record 7010365;
      lrTTOOxParteRecog@1103355007 : Record 7010365;
    BEGIN
      // GenerarParteRecogida
      // AJF - DRF IBZ 07002

      rPar.FINDFIRST;

      rPar.TESTFIELD("Codigo Recogidas");

      //IF Fecha < TODAY THEN
      //  ERROR(err27, TODAY);

      // No se generar partes de recogida de partes de recogida.
      IF "Origen creacion" = "Origen creacion"::"Recogida Automatica" THEN
        ERROR(err24);

      // Solo se generan partes de recogida donde el tipo fijo sea excursion.
      lrTipoServicio.GET("Tipo Servicio");
      IF lrTipoServicio."Tipo fijo" <> lrTipoServicio."Tipo fijo"::Excursion THEN
        ERROR(err25, "Tipo Servicio");

      // Si ya hay un parte de recogida generado -> error.
      IF "Recogida Generada" <> '' THEN
        ERROR(err26, "N§ Parte");

      // JPT 23/06/10  Nos aseguramos que tenga la fecha facturaci¢n rellenada (se han dado casos)
      TESTFIELD("Fecha facturacion");

      // Creamos el nuevo parte.

      lrParteRecogida.INIT;
      lrParteRecogida.TRANSFERFIELDS(Rec,FALSE);

      lrParteRecogida.Vehiculo          := '';
      lrParteRecogida."Cod Conductor"   := '';
      lrParteRecogida.Proveedor         := '';
      lrParteRecogida."Hora inicio"     := 0T;
      lrParteRecogida."Hora final"      := 0T;
      lrParteRecogida."Origen creacion" := lrParteRecogida."Origen creacion"::"Recogida Automatica";

      IF lrSubtrayectos.GET("N§ Parte") THEN BEGIN

        IF lrSubtrayectos."Hora Hasta Subtrayecto" <> 0T THEN BEGIN
          lrParteRecogida.VALIDATE("Hora inicio",     lrSubtrayectos."Hora Hasta Subtrayecto");
        END;

      END;

      //lrParteRecogida.VALIDATE("Codigo Servicio", rPar."Codigo Recogidas");
      lrParteRecogida."Codigo Servicio" := rPar."Codigo Recogidas";

      lrParteRecogida.INSERT(TRUE);

      // AJF - Necesitamos que el origen sea distinto para el parte de recogida.
      lrParteRecogida.VALIDATE("Origen/Destino", lrSubtrayectos."Punto Hasta Subtrayecto");
      lrParteRecogida.Fecha := Fecha;
      lrParteRecogida."Fecha facturacion" := "Fecha facturacion";
      lrParteRecogida.ActualizaHoraDT;

      // AJF 07/10/08
      // Marco como no exportar el parte de recogida.
      // A¤ado esto a los letreros.
      lrParteRecogida.VALIDATE("No Exportar", TRUE);
      lrParteRecogida.Letreros := Text030 + "Codigo Servicio";

      lrParteRecogida.MODIFY;

      // Creamos el nuevo servicio al que se vincular n las l¡neas del parte de recogida.

      lrServicio.INIT;
      lrServicio.Garaje                   := lrParteRecogida.Garaje;
      lrServicio.Fecha                    := lrParteRecogida.Fecha;
      lrServicio.VALIDATE(Cliente,           lrParteRecogida.Cliente);
      lrServicio.VALIDATE("Tipo Servicio",   lrParteRecogida."Tipo Servicio");
      //lrServicio.Touroperador             := lrParteRecogida."Touroperador principal";
      lrServicio."Hora inicio"            := lrParteRecogida."Hora inicio";

      lrServicio."Vehiculo Escolar"       := lrParteRecogida."Vehiculo Escolar";
      lrServicio."Vehiculo Minusvalidos"  := lrParteRecogida."Vehiculo Minusvalidos";

      lrServicio."Vehiculo especial"      := lrParteRecogida."Vehiculo especial";

      lrServicio.INSERT(TRUE);


      // AJF 04/11/08
      // En lugar de invertir los n£meros de l¡nea los pongo en negativo, as¡ se pueden
      // enlazar con las l¡neas originales.

      lrLinsParte.SETCURRENTKEY   ("N§ Parte", "N§ Linea");
      lrLinsParte.SETRANGE   ("N§ Parte", "N§ Parte");
      IF lrLinsParte.FINDSET THEN BEGIN
        REPEAT

          lrLinsRecogida.INIT;
          lrLinsRecogida."N§ Servicio"        := lrServicio."N§ Servicio";
          lrLinsRecogida."N§ Linea"           := -lrLinsParte."N§ Linea";
          lrLinsRecogida.TRANSFERFIELDS(lrLinsParte,FALSE);
          lrLinsRecogida."Hora recogida" := 0T;

          lrLinsRecogida."N§ Parte" := lrParteRecogida."N§ Parte";

          lrLinsRecogida.INSERT(TRUE);

        UNTIL lrLinsParte.NEXT = 0;
      END;

      // Copiamos las l¡neas de TTOO x Parte del parte padre al parte de recogida.
      lrTTOOxParte.SETRANGE("N§ Parte", "N§ Parte");

      IF lrTTOOxParte.FINDSET THEN BEGIN
        REPEAT

          lrTTOOxParteRecog.INIT;
          lrTTOOxParteRecog.TRANSFERFIELDS(lrTTOOxParte,FALSE);
          lrTTOOxParteRecog."N§ Parte"          := lrParteRecogida."N§ Parte";
          lrTTOOxParteRecog.Touroperador        := lrTTOOxParte.Touroperador;
          lrTTOOxParteRecog."Fecha Facturacion" := "Fecha facturacion";
          // AJF 09/07/09
          lrParteRecogida."Codigo Servicio"     := rPar."Codigo Recogidas";
          // AJF 08/11/10
          // Debido al cambio de funcionalidad al insertar TTOOs x parte el registro ya puede existir.
          IF NOT lrTTOOxParteRecog.FIND THEN
          lrTTOOxParteRecog.INSERT(TRUE);

          // AJF 09/07/09
          // Cambiamos el c¢digo de servicio por el de recogidas.
          lrTTOOxParteRecog."Codigo Servicio"       := rPar."Codigo Recogidas";

          // AJF 22/10/10
          lrTTOOxParteRecog."N§ Viajes"             := 0;
          lrTTOOxParteRecog."Adultos transportados" := 0;
          lrTTOOxParteRecog."Ni¤os transportados"   := 0;
          lrTTOOxParteRecog."Pax Transportados"     := 0;

          lrTTOOxParteRecog."Fecha Facturacion"     := "Fecha facturacion";

          lrTTOOxParteRecog.MODIFY(TRUE);
        UNTIL lrTTOOxParte.NEXT = 0;
      END;

      // Marcamos el parte como recogida generada.

      "Recogida Generada" := lrParteRecogida."N§ Parte";

      MODIFY;
    END;

    PROCEDURE CargarSubtrayectos@1103355008() Ok : Boolean;
    VAR
      lrInfoExc@1103355001 : Record 7035371;
      lrSubtrayectos@1103355002 : Record 7035399;
    BEGIN
      // CargarSubtrayectos

      IF NOT lrSubtrayectos.GET("N§ Parte") THEN BEGIN

        lrInfoExc.SETRANGE ("Codigo Servicio"    , "Codigo Servicio");
        lrInfoExc.SETRANGE ("Zona fisica"        , "Zona parte"     );
        lrInfoExc.SETFILTER("Fecha Desde", '<=%1', Fecha            );
        lrInfoExc.SETFILTER("Fecha Hasta", '>=%1', Fecha            );

        IF lrInfoExc.FINDFIRST THEN BEGIN

          lrSubtrayectos.INIT;
          lrSubtrayectos.TRANSFERFIELDS(lrInfoExc, FALSE);
          lrSubtrayectos."N§ Parte" := "N§ Parte";

          lrSubtrayectos.INSERT;

          EXIT(TRUE);  // Info cargada a subtrayectos.

        END;

        EXIT(FALSE);  // No hay info en informacion x excursion.

      END;

      EXIT(TRUE); // Ya hay info en subtrayectos.
    END;

    PROCEDURE FiltrarGarajeUsuario@1103355010();
    VAR
      lrUsuario@1103355000 : Record 7010420;
      lrParGenerales@1103355001 : Record 7010311;
    BEGIN
      // FiltrarGarajeUsuario.
      // Filtramos los partes por garaje dependiendo de la configuraci¢n del usuario.

      lrParGenerales.FINDFIRST;

      IF NOT lrUsuario.GET(USERID) THEN
        ERROR(Text029, USERID);

      IF lrUsuario."Garaje por defecto" <> '' THEN
        SETRANGE(Garaje, lrUsuario."Garaje por defecto");

      IF (lrUsuario."Garaje de trabajo" <> '') AND (lrUsuario."Garaje de trabajo" <> lrParGenerales."Todos los garajes") THEN BEGIN
        FILTERGROUP(2);
        SETRANGE(Garaje, lrUsuario."Garaje de trabajo");
        FILTERGROUP(0);
      END;
    END;

    PROCEDURE ModificaCampo@1103355011(pwNoCampo@1103355000 : Integer);
    VAR
      lwPuede@1103355001 : Boolean;
      lrParte2@1103355002 : Record 7010360;
      lwRec1@1103355003 : RecordRef;
      lwRec2@1103355004 : RecordRef;
      lwField1@1103355005 : FieldRef;
      lwField2@1103355006 : FieldRef;
      lwOrAnt@1103355007 : Integer;
    BEGIN
      // ModificaCampo

      // ModificaCampo
      // Devuelve true si deja modificar

      PuedeModificarCampo(pwNoCampo, TRUE);

      IF "Recogida Generada" ='' THEN
        EXIT;

      lwRec1.GETTABLE(Rec);
      lwField1 := lwRec1.FIELD(pwNoCampo);
      CLEAR(lrParte2);
      lrParte2.GET("Recogida Generada");
      lwOrAnt := lrParte2."Origen creacion";
      lrParte2."Origen creacion":= -1; // Hacemos eso para evitar que salten los errores al modificar la tabla destino
      lwRec2.GETTABLE(lrParte2);
      lwField2 := lwRec2.FIELD(pwNoCampo);
      lwField2.VALIDATE(lwField1.VALUE);
      lwField2 := lwRec2.FIELD(190);
      lwField2.VALUE := lwOrAnt; // Volvemos a dejar el valor "Origen creacion" como estaba
      lwRec2.MODIFY;
    END;

    PROCEDURE PuedeModificarCampo@1103355012(pwNoCampo@1103355000 : Integer;pwError@1103355001 : Boolean) : Boolean;
    VAR
      lwPuede@1103355002 : Boolean;
      lrField@1103355003 : Record 2000000041;
    BEGIN
      // PuedeModificarCampo
      // Devuelve true si deja modificar

      CLEAR(lwPuede);
      lwPuede := "Origen creacion" <> "Origen creacion"::"Recogida Automatica";
      lwPuede := lwPuede OR (NOT (pwNoCampo IN [151,153,192,193,203]));

      IF pwError AND (NOT lwPuede) THEN BEGIN
       CLEAR(lrField);
       lrField.SETRANGE(TableNo, 7010360);
       lrField.SETRANGE("No."  , pwNoCampo);
       lrField.FINDFIRST;
       ERROR(Text032, lrField."Field Caption");
      END;

      EXIT(lwPuede);
    END;

    PROCEDURE HIniDTBI@1103355013();
    BEGIN
      // HIniDTBI

      // JPT 02/02/10  Pasa la "Hora Inicio DT" a "Hora Inicio BI"
      "Hora Inicio BI" := cFunBas.DTtoBIGINT("Hora Inicio DT");
    END;

    PROCEDURE GetClienteEstadistico@1100253008(pwTo@1100253001 : Code[10]) rvCli : Code[20];
    VAR
      lrCliTo@1100253000 : Record 7010313;
    BEGIN
      // GetClienteEstadistico.

      CLEAR(lrCliTo);
      lrCliTo.SETRANGE (Cliente, Cliente);
      lrCliTo.SETRANGE (TTOO   , pwTo);
      IF lrCliTo.FIND('-') THEN BEGIN
        CASE lrCliTo."Cliente mostrar estadisticas" OF
          lrCliTo."Cliente mostrar estadisticas"::Operativo  : EXIT(lrCliTo.Cliente);
          lrCliTo."Cliente mostrar estadisticas"::Facturacion: EXIT(lrCliTo."Cliente facturacion");
        END;
      END;
    END;

    PROCEDURE ProratearViajes@1100253009();
    VAR
      lrToPar@1100253000 : Record 7010365;
      lwTotPax@1100253001 : Decimal;
    BEGIN
      // ProratearViajes.

      CALCFIELDS("Adultos transportados", "Ni¤os transportados");
      lwTotPax := "Adultos transportados" + "Ni¤os transportados";
      CLEAR(lrToPar);
      lrToPar.SETRANGE ("N§ Parte"  , "N§ Parte");
      IF lrToPar.FIND('-') THEN BEGIN
        REPEAT
          IF (lwTotPax = 0) OR ("Origen creacion" = "Origen creacion"::"Recogida Automatica") THEN
            lrToPar."N§ Viajes" := 0
          ELSE
            lrToPar."N§ Viajes" := ROUND("N§ viajes" * (lrToPar."Pax Transportados" / lwTotPax)); //$001
          lrToPar.MODIFY;
        UNTIL lrToPar.NEXT = 0;
      END;
    END;

    PROCEDURE TestRestrImagenTo@1100253011();
    VAR
      lrSerPar@1100253000 : Record 7010359;
      lrRestr@1100253001 : Record 7035374;
      lrVeh@1100253002 : Record 7010346;
    BEGIN
      // TestRestrImagenTo.

      lrVeh.GET(Vehiculo);

      lrSerPar.SETCURRENTKEY("N§ Parte");
      lrSerPar.SETRANGE ("N§ Parte", "N§ Parte");
      IF lrSerPar.FIND('-') THEN BEGIN
        REPEAT
          IF lrRestr.GET("Touroperador principal", lrVeh."Imagen Vehiculo") THEN
            ERROR(Text010, lrVeh."Imagen Vehiculo", lrSerPar.Touroperador);
        UNTIL lrSerPar.NEXT = 0;
      END;
    END;

    PROCEDURE ModificaRecogida@1000000000();
    VAR
      lrPRecoj@1000000001 : Record 7010360;
      lwOk@1000000000 : Boolean;
    BEGIN
      // ModificaRecogida
      // Modifica algunos datos en el partde de recogia
      // JPT 09/08/10

      IF "Recogida Generada" ='' THEN
        EXIT;

      lwOk := (Cliente <> xRec.Cliente);
      lwOk := lwOk OR ("Touroperador principal" <> xRec."Touroperador principal");

      IF NOT lwOk THEN
        EXIT;

      IF NOT CONFIRM(Text029) THEN
        EXIT;

      lrPRecoj.GET("Recogida Generada");
      IF lrPRecoj.Cliente <> Cliente THEN
        lrPRecoj.VALIDATE(Cliente,  Cliente);

      IF lrPRecoj."Touroperador principal" <> "Touroperador principal" THEN
        lrPRecoj.VALIDATE("Touroperador principal",  "Touroperador principal");
      lrPRecoj.MODIFY(TRUE);
    END;

    BEGIN
    {
       ## AJS 11.06.2008

          He ampliado el campo Touroperadores a 90 caracteres para los servicios de shuttle

      ## AJS 01.07.2009

        .- En la funcion TotalIngresoCon he corregido un NEXT = 1 por NEXT = 0

      JPT 02/02/10 Datetime a Biginteger

      El campo "Hora Inicio DT" ha sido sustituido por "Hora Inicio BI".
      Se ha sustituido la clave en la que aparece este campo por una analoga

      $001 AJS 23082011 Modifico la propiedad MaxValue del campo "N§ viajes" para permitir hasta 999

      $002 AJS 23012015 Agregar el campo Touroperador en la clave Fecha, Codigo servicio, Vuelos, Hora 1er Vuelo

      $003 AJS 07052015 Cambio validate de Hora inicio DT para que solo actualice las lineas si estamos modificando directamente
                        la hora de inicio del parte o la fecha
    }
    END.
  }
}

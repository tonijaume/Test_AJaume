OBJECT Table 7009710 Producto agencia
{
  OBJECT-PROPERTIES
  {
    Date=25/06/15;
    Time=18:11:32;
    Modified=Yes;
    Version List=AIC2009;
  }
  PROPERTIES
  {
    OnInsert=BEGIN
               rPar.FINDFIRST;
               IF NOT rPar."Empresa Delegacion" THEN
                 ERROR(Text001);

               IF "Tipo Producto" = "Tipo Producto"::Excursion THEN
                 _NewExcursion;
             END;

    OnModify=BEGIN
               rPar.FINDFIRST;
               IF NOT rPar."Empresa Delegacion" THEN
                 ERROR(Text002);

               // $003
               ControlOficinaExc;
             END;

    OnDelete=VAR
               rPrestaciones@1103355000 : Record 7010140;
               rPrest_Cont@1103355001 : Record 7010141;
             BEGIN
               IF _TieneReservas THEN
                 ERROR(Text012); //+$011

               rPar.FINDFIRST;
               IF NOT rPar."Empresa Delegacion" THEN
                 ERROR(Text003);

               // Si borramos una excursion, tenemos que borrar sus prestaciones
               // y su relacion con contratos

               IF "Tipo Producto" = "Tipo Producto"::Excursion THEN BEGIN
                 rPrestaciones.SETRANGE("Codigo producto", Codigo);
                 IF rPrestaciones.FIND('-') THEN BEGIN
                   IF CONFIRM(Text004) THEN BEGIN
                     rPrestaciones.DELETEALL;
                     rPrest_Cont.SETRANGE("Codigo Producto", Codigo);
                     rPrest_Cont.DELETEALL;
                   END
                   ELSE
                     ERROR(Text005);
                 END;

                 _DeleteTurnos; //+$029
               END;
             END;

    OnRename=BEGIN
               // ERROR(Text006);
             END;

    CaptionML=[ENU=Agency service;
               ESP=Producto agencia];
    LookupFormID=Form7009710;
    DrillDownFormID=Form7009710;
  }
  FIELDS
  {
    { 1   ;   ;Codigo              ;Code10        ;AltSearchField=Descripcion;
                                                   CaptionML=[ENU=Code;
                                                              ESP=Codigo];
                                                   Description=PK }
    { 3   ;   ;Descripcion         ;Text50        ;CaptionML=[ENU=Description;
                                                              ESP=Descripcion] }
    { 5   ;   ;Tipo Producto       ;Option        ;CaptionML=[ENU=Service Type;
                                                              ESP=Tipo Producto];
                                                   OptionCaptionML=[ENU=Hotel,Transfer,Excursion,Flight,RaC,Others;
                                                                    ESP=Hotel,Transfer,Excursion,Vuelo,RaC,Otros];
                                                   OptionString=Hotel,Transfer,Excursion,Vuelo,RaC,Otros }
    { 47  ;   ;Duracion            ;Option        ;CaptionML=[ENU=Duration;
                                                              ESP=Duracion];
                                                   OptionCaptionML=[ENU=Full day,Half day,Night,Long Duration;
                                                                    ESP=Dia Entero,Medio Dia,Nocturna,Larga Duracion];
                                                   OptionString=Dia Entero,Medio Dia,Nocturna,Larga Duracion;
                                                   Description=$007 Excursiones }
    { 50  ;   ;Caducado            ;Boolean       ;OnValidate=VAR
                                                                rPubCfg@1000000000 : Record 7010268;
                                                              BEGIN
                                                                // $017
                                                                IF "Tipo Producto" = "Tipo Producto"::Excursion THEN BEGIN
                                                                  IF Caducado = TRUE THEN BEGIN
                                                                    rPubCfg.RESET;
                                                                    rPubCfg.SETRANGE(rPubCfg.Excursion,Codigo);
                                                                    IF rPubCfg.FINDFIRST THEN BEGIN
                                                                      rPubCfg.MODIFYALL(rPubCfg."Fecha hasta",TODAY - 1);
                                                                    END;
                                                                  END;
                                                                END;
                                                              END;

                                                   CaptionML=[ENU=Expired;
                                                              ESP=Caducado] }
    { 60  ;   ;Precisa confirmacion proveedor;Boolean;
                                                   CaptionML=[ENU=Provider confirmation needed;
                                                              ESP=Precisa confirmacion proveedor];
                                                   Description=$001 Excursiones }
    { 70  ;   ;Proveedor comision mercantil;Boolean;
                                                   OnValidate=BEGIN
                                                                _CheckTradingCommission(Rec); //+$002
                                                              END;

                                                   CaptionML=[ENU=Trading commission provider;
                                                              ESP=Proveedor comision mercantil];
                                                   Description=$002 Excursiones }
    { 80  ;   ;Oficina             ;Code20        ;TableRelation="Oficina ventas".Codigo;
                                                   OnValidate=BEGIN
                                                                IF Oficina <> xRec.Oficina THEN BEGIN
                                                                  CambiaOficina; // $003
                                                                END;
                                                              END;

                                                   CaptionML=[ENU=Office;
                                                              ESP=Oficina];
                                                   Description=$003 Excursiones }
    { 90  ;   ;Transporte organizado agencia;Boolean;
                                                   CaptionML=[ENU=Transport made by agency;
                                                              ESP=Transporte organizado agencia];
                                                   Description=$004 Excursiones }
    { 100 ;   ;Filtro Fecha servicio;Date         ;FieldClass=FlowFilter;
                                                   CaptionML=[ENU=Service date Filter;
                                                              ESP=Filtro Fecha servicio];
                                                   Description=$005 Excursiones }
    { 105 ;   ;Filtro Fecha venta  ;Date          ;FieldClass=FlowFilter;
                                                   CaptionML=[ENU=Sales date Filter;
                                                              ESP=Filtro Fecha venta];
                                                   Description=$005 Excursiones }
    { 110 ;   ;Filtro Touroperador ;Code10        ;FieldClass=FlowFilter;
                                                   TableRelation=TourOperador.TourOperador;
                                                   CaptionML=[ENU=Touroperator Filter;
                                                              ESP=Filtro Touroperador];
                                                   Description=$005 Excursiones }
    { 115 ;   ;Filtro Guia venta   ;Code20        ;FieldClass=FlowFilter;
                                                   TableRelation="Representante excursiones".Codigo;
                                                   CaptionML=[ENU=Sales guide Filter;
                                                              ESP=Filtro Guia venta];
                                                   Description=$005 Excursiones }
    { 120 ;   ;Filtro Oficina venta;Code10        ;FieldClass=FlowFilter;
                                                   TableRelation="Oficina ventas".Codigo;
                                                   CaptionML=[ENU=Sales office Filter;
                                                              ESP=Filtro Oficina venta];
                                                   Description=$005 Excursiones }
    { 125 ;   ;Filtro Turno        ;Integer       ;FieldClass=FlowFilter;
                                                   CaptionML=[ENU=Turn Filter;
                                                              ESP=Filtro Turno];
                                                   Description=$019 }
    { 200 ;   ;Adultos excursiones ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Reserva Excursion".Adultos WHERE (Producto=FIELD(Codigo),
                                                                                                      Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                      TourOperador=FIELD(Filtro Touroperador),
                                                                                                      Anulada=CONST(No),
                                                                                                      Reembolsada=CONST(No),
                                                                                                      Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                      Guia Venta=FIELD(Filtro Guia venta),
                                                                                                      Oficina=FIELD(Filtro Oficina venta)));
                                                   CaptionML=[ENU=Adults excursions;
                                                              ESP=Adultos excursiones];
                                                   Description=$005 Excursiones;
                                                   Editable=No }
    { 210 ;   ;Ni¤os excursiones   ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Reserva Excursion".Ni¤os WHERE (Producto=FIELD(Codigo),
                                                                                                    Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                    TourOperador=FIELD(Filtro Touroperador),
                                                                                                    Anulada=CONST(No),
                                                                                                    Reembolsada=CONST(No),
                                                                                                    Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                    Oficina=FIELD(Filtro Oficina venta),
                                                                                                    Guia Venta=FIELD(Filtro Guia venta)));
                                                   CaptionML=[ENU=Childs excursions;
                                                              ESP=Ni¤os excursiones];
                                                   Description=$005 Excursiones;
                                                   Editable=No }
    { 220 ;   ;Personas excursiones;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Reserva Excursion"."N§ Personas" WHERE (Producto=FIELD(Codigo),
                                                                                                            Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                            TourOperador=FIELD(Filtro Touroperador),
                                                                                                            Anulada=CONST(No),
                                                                                                            Reembolsada=CONST(No),
                                                                                                            Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                            Oficina=FIELD(Filtro Oficina venta),
                                                                                                            Guia Venta=FIELD(Filtro Guia venta),
                                                                                                            Turno Excursion=FIELD(Filtro Turno)));
                                                   CaptionML=[ENU=Persons excursions;
                                                              ESP=Personas excursiones];
                                                   Description=$005 Excursiones, calculado;
                                                   Editable=No }
    { 222 ;   ;Personas reembolsadas exc;Decimal  ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Reserva Excursion"."Personas Reembolsadas" WHERE (Producto=FIELD(Codigo),
                                                                                                                      Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                                      TourOperador=FIELD(Filtro Touroperador),
                                                                                                                      Anulada=CONST(No),
                                                                                                                      Reembolsada=CONST(No),
                                                                                                                      Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                                      Oficina=FIELD(Filtro Oficina venta),
                                                                                                                      Guia Venta=FIELD(Filtro Guia venta),
                                                                                                                      Turno Excursion=FIELD(Filtro Turno)));
                                                   CaptionML=[ENU=Refund Persons excursions;
                                                              ESP=Personas reembolsadas exc];
                                                   Description=$005 Excursiones, calculado;
                                                   Editable=No }
    { 230 ;   ;Ventas excursiones  ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Reserva Excursion"."Ingreso reserva" WHERE (Producto=FIELD(Codigo),
                                                                                                                Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                                TourOperador=FIELD(Filtro Touroperador),
                                                                                                                Anulada=CONST(No),
                                                                                                                Reembolsada=CONST(No),
                                                                                                                Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                                Oficina=FIELD(Filtro Oficina venta),
                                                                                                                Guia Venta=FIELD(Filtro Guia venta),
                                                                                                                Turno Excursion=FIELD(Filtro Turno)));
                                                   CaptionML=[ENU=Excursions sales;
                                                              ESP=Ventas excursiones];
                                                   Description=$005 Excursiones, calculado;
                                                   Editable=No }
    { 240 ;   ;Ventas netas excursiones;Decimal   ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Reserva Excursion"."Ingreso reserva neto" WHERE (Producto=FIELD(Codigo),
                                                                                                                     Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                                     TourOperador=FIELD(Filtro Touroperador),
                                                                                                                     Anulada=CONST(No),
                                                                                                                     Reembolsada=CONST(No),
                                                                                                                     Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                                     Oficina=FIELD(Filtro Oficina venta),
                                                                                                                     Guia Venta=FIELD(Filtro Guia venta),
                                                                                                                     Turno Excursion=FIELD(Filtro Turno)));
                                                   CaptionML=[ENU=Excursions net sales;
                                                              ESP=Ventas netas excursiones];
                                                   Description=$005 Excursiones, calculado;
                                                   Editable=No }
    { 242 ;   ;Comision Guia venta ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Reserva Excursion"."Comision Guia Venta" WHERE (Producto=FIELD(Codigo),
                                                                                                                    Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                                    TourOperador=FIELD(Filtro Touroperador),
                                                                                                                    Anulada=CONST(No),
                                                                                                                    Reembolsada=CONST(No),
                                                                                                                    Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                                    Oficina=FIELD(Filtro Oficina venta),
                                                                                                                    Guia Venta=FIELD(Filtro Guia venta),
                                                                                                                    Turno Excursion=FIELD(Filtro Turno)));
                                                   CaptionML=[ENU=Sales guide comission;
                                                              ESP=Comision Guia venta];
                                                   Description=$006 Excursiones, calculado;
                                                   Editable=No }
    { 244 ;   ;Comision Touroperador;Decimal      ;FieldClass=FlowField;
                                                   CalcFormula=-Sum("Reserva Excursion"."Comision Touroperador" WHERE (Producto=FIELD(Codigo),
                                                                                                                       Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                                       TourOperador=FIELD(Filtro Touroperador),
                                                                                                                       Anulada=CONST(No),
                                                                                                                       Reembolsada=CONST(No),
                                                                                                                       Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                                       Oficina=FIELD(Filtro Oficina venta),
                                                                                                                       Guia Venta=FIELD(Filtro Guia venta),
                                                                                                                       Turno Excursion=FIELD(Filtro Turno)));
                                                   CaptionML=[ENU=Touroperator comission;
                                                              ESP=Comision Touroperador];
                                                   Description=$006 Excursiones, calculado;
                                                   Editable=No }
    { 246 ;   ;Vehiculos excursiones;Decimal      ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Reserva Excursion"."Num. Vehiculos" WHERE (Producto=FIELD(Codigo),
                                                                                                               Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                               TourOperador=FIELD(Filtro Touroperador),
                                                                                                               Anulada=CONST(No),
                                                                                                               Reembolsada=CONST(No),
                                                                                                               Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                               Oficina=FIELD(Filtro Oficina venta),
                                                                                                               Guia Venta=FIELD(Filtro Guia venta),
                                                                                                               Turno Excursion=FIELD(Filtro Turno)));
                                                   CaptionML=[ENU=Persons excursions;
                                                              ESP=Personas excursiones];
                                                   Description=$016 Excursiones, calculado;
                                                   Editable=No }
    { 248 ;   ;Vehiculos reembolsados exc;Decimal ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Reserva Excursion"."Vehiculos Reembolsados" WHERE (Producto=FIELD(Codigo),
                                                                                                                       Fecha Excursion=FIELD(Filtro Fecha servicio),
                                                                                                                       TourOperador=FIELD(Filtro Touroperador),
                                                                                                                       Anulada=CONST(No),
                                                                                                                       Reembolsada=CONST(No),
                                                                                                                       Fecha Venta=FIELD(Filtro Fecha venta),
                                                                                                                       Oficina=FIELD(Filtro Oficina venta),
                                                                                                                       Guia Venta=FIELD(Filtro Guia venta),
                                                                                                                       Turno Excursion=FIELD(Filtro Turno)));
                                                   CaptionML=[ENU=Refund Vehicles excursions;
                                                              ESP=Veh¡culos reembolsados exc];
                                                   Editable=No }
    { 300 ;   ;Coste x ticket      ;Boolean       ;OnValidate=BEGIN
                                                                //+$014 <
                                                                IF _TieneReservas THEN
                                                                BEGIN
                                                                  IF NOT CONFIRM(Text013) THEN
                                                                    ERROR('');
                                                                END;
                                                                //+$014 >

                                                                _CheckTipoPrecio;

                                                                IF "Coste x ticket" <> xRec."Coste x ticket" THEN
                                                                  "Margen bruto" := 0;
                                                              END;

                                                   CaptionML=[ENU=Cost x Ticket;
                                                              ESP=Coste x Ticket];
                                                   Description=$008 Excursiones }
    { 302 ;   ;Margen bruto        ;Decimal       ;CaptionML=[ENU=Gross Margin;
                                                              ESP=Margen bruto];
                                                   Description=$009 Excursiones }
    { 304 ;   ;Excursion sin coste ;Boolean       ;OnValidate=BEGIN
                                                                //+$014 <
                                                                IF _TieneReservas THEN
                                                                BEGIN
                                                                  IF NOT CONFIRM(Text013) THEN
                                                                    ERROR('');
                                                                END;
                                                                //+$014 >
                                                              END;

                                                   CaptionML=[ENU=Excursion without cost;
                                                              ESP=Excursion sin coste];
                                                   Description=$010 Excursiones }
    { 306 ;   ;Venta libre         ;Boolean       ;OnValidate=BEGIN
                                                                //+$014 <
                                                                IF _TieneReservas THEN
                                                                BEGIN
                                                                  IF NOT CONFIRM(Text013) THEN
                                                                    ERROR('');
                                                                END;
                                                                //+$014 >
                                                              END;

                                                   OnLookup=BEGIN
                                                              //+$014 <
                                                              IF _TieneReservas THEN
                                                              BEGIN
                                                                IF NOT CONFIRM(Text013) THEN
                                                                  ERROR('');
                                                              END;
                                                              //+$014 >
                                                            END;

                                                   CaptionML=[ENU=Free sale;
                                                              ESP=Venta libre];
                                                   Description=$012, Marcar cuando no queremos hacer control de cupos de la excursion }
    { 308 ;   ;Venta x vehiculo    ;Boolean       ;OnValidate=BEGIN
                                                                IF "Venta x vehiculo" = FALSE THEN
                                                                  "Capacidad x defecto" := 0;
                                                              END;

                                                   CaptionML=[ENU=Sale x Vehicle;
                                                              ESP=Venta x vehiculo];
                                                   Description=$012, Marcamos para las excursiones que se venden por unidades de vehiculos en lugar de numero de personas }
    { 309 ;   ;Codigo anterior     ;Code10         }
    { 311 ;   ;Capacidad x defecto ;Integer       ;OnValidate=BEGIN
                                                                IF NOT "Venta x vehiculo" THEN
                                                                  TESTFIELD("Venta x vehiculo");
                                                              END;

                                                   CaptionML=[ENU=Default capacity;
                                                              ESP=Capacidad x defecto];
                                                   Description=$025 }
    { 500 ;   ;Edad adulto desde   ;Integer       ;CaptionML=[ENU=Adult age from;
                                                              ESP=Edad adulto desde];
                                                   MinValue=0 }
    { 501 ;   ;Edad adulto hasta   ;Integer       ;CaptionML=[ENU=Adult age to;
                                                              ESP=Edad adulto desde];
                                                   MinValue=0 }
    { 502 ;   ;Edad ni¤o desde     ;Integer       ;CaptionML=[ENU=Child age from;
                                                              ESP=Edad ni¤o desde];
                                                   MinValue=0 }
    { 503 ;   ;Edad ni¤o hasta     ;Integer       ;CaptionML=[ENU=Child age to;
                                                              ESP=Edad ni¤o hasta];
                                                   MinValue=0 }
    { 504 ;   ;Edad infant desde   ;Integer       ;CaptionML=[ENU=Infant age from;
                                                              ESP=Edad infant desde];
                                                   MinValue=0 }
    { 505 ;   ;Edad infant hasta   ;Integer       ;CaptionML=[ENU=Infant age to;
                                                              ESP=Edad infant hasta];
                                                   MinValue=0 }
    { 50000;  ;Procesado           ;Boolean       ;Description=TEMPORAL }
    { 50003;  ;Agrupacion comercial;Code10        ;TableRelation="Agrupacion comercial excursion".Codigo;
                                                   CaptionML=[ENU=Commercial group code;
                                                              ESP=Codigo agrupacion comercial] }
  }
  KEYS
  {
    {    ;Codigo                                  ;Clustered=Yes }
  }
  FIELDGROUPS
  {
  }
  CODE
  {
    VAR
      Text001@1103355002 : TextConst 'ENU=Only local offices items registration are possible;ESP=Solo se pueden dar de alta productos en las Delegaciones.';
      Text002@1103355003 : TextConst 'ENU=Only local offices items can be modified;ESP=Solo se pueden modificar productos en las Delegaciones.';
      Text003@1103355004 : TextConst 'ENU=Only local offices items can be cancelled;ESP=Solo se pueden dar de baja productos en las Delegaciones.';
      Text004@1103355005 : TextConst 'ENU=This excursion has provisions, delete them?;ESP=Esta excursion tiene prestaciones, borrar?';
      Text005@1103355006 : TextConst 'ENU=Excursion was not deleted;ESP=La excursion no se ha borrado';
      Text006@1103355007 : TextConst 'ENU=Unable to rename registers of this table;ESP=No se puede renombrar registros de esta tabla.';
      rPar@1103355000 : Record 7009700;
      Text007@1100253000 : TextConst 'ENU=Only excursion service providers can be used in the trading commission excursions.;ESP=Solo se pueden utilizar proveedores de servicio en las excursiones de comision mercantil.';
      Text008@1100253001 : TextConst 'ENU=Only one provider can be used in the trading commission excursions.;ESP=Solo puede indicar un proveedor en las excursiones de comision mercantil.';
      cFunExc@1100217002 : Codeunit 7010141;
      wDial@1100217000 : Dialog;
      Text009@1100217001 : TextConst 'ENU="Switching Office Code  in ";ESP="Cambiando Codigo Oficina en "';
      Text010@1100217003 : TextConst 'ENU=You cannot indicate cost per ticket because there are prices per service in the contract %1.;ESP=No se puede indicar coste por ticket porque hay precios por servicio en el contrato %1.';
      Text011@1100217004 : TextConst 'ENU=Several vendors;ESP=Varios proveedores';
      Text012@1100217005 : TextConst 'ENU=An excursion with reservations cannot be deleted.;ESP=No se puede borrar una excursion con reservas asociadas.';
      Text013@1100217006 : TextConst 'ENU=This excursion already have reservations, sure you want to change the value of this field.;ESP=Esta excursion ya tiene reservas, esta seguro de que desea cambiar el valor de este campo.';
      Text014@1000000000 : TextConst 'ENU=Sales office is mandatory.;ESP=La oficina de venta es obligatoria.';

    LOCAL PROCEDURE _CheckTradingCommission@1100253000(prExcursion@1100253001 : Record 7009710);
    VAR
      lrPrest@1100253000 : Record 7010140;
    BEGIN
      // _CheckTradingCommission

      IF NOT prExcursion."Proveedor comision mercantil" THEN
        EXIT;

      lrPrest.RESET;
      lrPrest.SETRANGE ("Codigo producto", Codigo);
      lrPrest.SETFILTER("Tipo Contrato"  , '<>%1', lrPrest."Tipo Contrato"::Excursion);
      IF lrPrest.FINDFIRST THEN
        ERROR(Text007);

      lrPrest.RESET;
      lrPrest.SETRANGE("Codigo producto", Codigo);
      IF lrPrest.COUNT > 1 THEN
        ERROR(Text008);
    END;

    PROCEDURE CambiaOficina@1100217000();
    VAR
      lrResExc@1100217000 : Record 7010162;
    BEGIN
      // CambiaOficina
      // $003
      // Cambiamos el codigo de oficina en las siguientes tablas

      wDial.OPEN(Text009 + ' #1#############');

      wDial.UPDATE(1, lrResExc.TABLECAPTION);

      CLEAR(lrResExc);
      lrResExc.SETCURRENTKEY("Fecha Excursion",Producto,"Zona Hotel","N§ Servicio");
      lrResExc.SETFILTER("Fecha Excursion", '>=%1' , TODAY);
      lrResExc.SETRANGE(Producto, Codigo);
      lrResExc.MODIFYALL(lrResExc.Oficina, Oficina);

      wDial.CLOSE;
    END;

    PROCEDURE ControlOficinaExc@1100217001();
    BEGIN
      // ControlOficinaExc
      // Comprueba que la excursion tenga una oficina relacionada
      // $003
      IF "Tipo Producto" <> "Tipo Producto"::Excursion THEN
        EXIT;

      cFunExc.ControlExcursionConOficinaProd(Rec, TRUE, TRUE);
    END;

    PROCEDURE FiltraOficinaUsuario@1100217002();
    VAR
      lrUser@1100217000 : Record 91;
    BEGIN
      // FiltraOficinaUsuario
      // $003 Aplicamos el filtro de oficina configurado por usuario, si es que lo tiene
      // Tengase en cuenta que esta funcion no tiene en cuenta la clave actual

      rPar.FINDFIRST;
      IF NOT rPar."Oficina Excursion Obligatoria" THEN
        EXIT;

      IF NOT lrUser.GET(USERID) THEN
        EXIT;

      IF lrUser."Oficina Excursiones" ='' THEN
        EXIT;

      // Cambiamos el grupo de filtrado, Asi no podria quitarse el filtro y podran solaparse filtros adicionales

      FILTERGROUP(2);
      SETRANGE(Oficina, lrUser."Oficina Excursiones");
      FILTERGROUP(0); // Devolvemos a su grupo de filtrado origina
    END;

    LOCAL PROCEDURE _CheckTipoPrecio@1100217003();
    VAR
      lrPrestCont@1100217004 : Record 7010141;
      lrPreGO@1100217000 : Record 7010154;
      lrPreTR@1100217001 : Record 7010150;
      lrPreEX@1100217002 : Record 7010151;
      lrCont@1100217003 : Record 7010142;
    BEGIN
      IF NOT "Coste x ticket" THEN
        EXIT;

      //. Vamos a recorrer las prestaciones

      lrPrestCont.RESET;
      lrPrestCont.SETRANGE("Codigo Producto", Codigo);
      IF lrPrestCont.FINDSET THEN
      BEGIN
        REPEAT
          CASE lrPrestCont."Tipo Contrato" OF
            lrPrestCont."Tipo Contrato"::Excursion:
            BEGIN
              //. Verificamos los precios de proveedores de servicio
              lrCont.RESET;
              lrCont.SETRANGE("Tipo Contrato"     , lrPrestCont."Tipo Contrato");
              lrCont.SETRANGE("N§ Contrato compra", lrPrestCont.Contrato);
              IF lrCont.FINDSET THEN
              BEGIN
                lrPreEX.SETRANGE(Delegacion   , lrCont.Delegacion);
                lrPreEX.SETRANGE("N§ Contrato", lrCont."N§ Contrato compra");
                lrPreEX.SETRANGE("Tipo aplicacion", lrPreEX."Tipo aplicacion"::Servicio);
                lrPreEX.SETRANGE(Activo       , TRUE);
                IF lrPreEX.FINDSET THEN
                  ERROR(Text010, lrPreEX."N§ Contrato");
              END;
            END;

            //. Verificamos los precios de transportista
            lrPrestCont."Tipo Contrato"::Transportista:
            BEGIN
              lrCont.RESET;
              lrCont.SETRANGE("Tipo Contrato"     , lrPrestCont."Tipo Contrato");
              lrCont.SETRANGE("N§ Contrato compra", lrPrestCont.Contrato);
              IF lrCont.FINDSET THEN
              BEGIN
                lrPreTR.RESET;
                lrPreTR.SETRANGE("N§ Contrato"    , lrCont."N§ Contrato compra");
                lrPreTR.SETRANGE(Producto         , Codigo);
                lrPreTR.SETRANGE("Tipo aplicacion", lrPreTR."Tipo aplicacion"::Vehiculo);
                lrPreTR.SETRANGE(Activo           , TRUE);
                IF lrPreTR.FINDSET THEN
                  ERROR(Text010, lrPreTR."N§ Contrato");
              END;
            END;

            //. Verificamos los precios de Guia Oficial
            lrPrestCont."Tipo Contrato"::"Guia Oficial":
            BEGIN
              lrCont.RESET;
              lrCont.SETRANGE("Tipo Contrato"     , lrPrestCont."Tipo Contrato");
              lrCont.SETRANGE("N§ Contrato compra", lrPrestCont.Contrato);
              IF lrCont.FINDSET THEN
              BEGIN
                lrPreGO.RESET;
                lrPreGO.SETRANGE("N§ Contrato"    , lrCont."N§ Contrato compra");
                lrPreGO.SETRANGE(Excursion        , Codigo);
                lrPreGO.SETRANGE("Tipo Aplicacion", lrPreGO."Tipo Aplicacion"::Servicio);
                lrPreGO.SETRANGE(Activo           , TRUE);
                IF lrPreGO.FINDSET THEN
                  ERROR(Text010, lrPreGO."N§ Contrato");
              END;
            END;
          END;
        UNTIL lrPrestCont.NEXT = 0;
      END;
    END;

    PROCEDURE NombreProveedorServicio@1100217004(pwCodigo@1100217000 : Code[10]) : Text[50];
    VAR
      lrPres@1100217001 : Record 7010140;
      lrPresCon@1100217002 : Record 7010141;
      lrCont@1100217004 : Record 7010142;
      lrVendor@1100217003 : Record 23;
    BEGIN
      // NombreProveedorServicio

      //. Retornar el nombre del proveedor de servicios de la excursion, en caso de ser unico

      lrPres.RESET;
      lrPres.SETRANGE("Codigo producto", pwCodigo);
      lrPres.SETRANGE("Tipo Contrato"  , lrPres."Tipo Contrato"::Excursion);
      IF NOT lrPres.FINDFIRST THEN
        EXIT;

      IF lrPres.COUNT = 1 THEN
      BEGIN
        lrPresCon.SETRANGE("Codigo Producto", lrPres."Codigo producto");
        lrPresCon.SETRANGE(Orden            , lrPres.Orden);
        lrPresCon.SETRANGE("Tipo Contrato"  , lrPres."Tipo Contrato");
        IF lrPresCon.FINDFIRST THEN
        BEGIN
          lrCont.SETRANGE("N§ Contrato compra", lrPresCon.Contrato);
          lrCont.SETRANGE("Tipo Contrato"     , lrPresCon."Tipo Contrato");
          IF lrCont.FINDFIRST THEN
          BEGIN
            IF lrVendor.GET(lrCont.Proveedor) THEN
              EXIT(lrVendor.Name);
          END;
        END;
      END
      ELSE
        EXIT(Text011);
    END;

    LOCAL PROCEDURE _TieneReservas@1100217005() : Boolean;
    VAR
      lrRsvExc@1100217000 : Record 7010162;
    BEGIN
      // _TieneReservas

      //+$013
      //. Retornar TRUE si la excursion tiene reservas

      CASE "Tipo Producto" OF
        "Tipo Producto"::Excursion:
        BEGIN
          lrRsvExc.RESET;
          lrRsvExc.SETCURRENTKEY(Producto);
          lrRsvExc.SETRANGE(Producto, Codigo);
          EXIT(NOT lrRsvExc.ISEMPTY);
        END;
      END;
    END;

    PROCEDURE VerCupos@1100217006(pwTurno@1000000000 : Integer);
    VAR
      lrCupo@1100217000 : Record 7010265;
      lfCupos@1100217001 : Form 7010239;
    BEGIN
      // VerCupos

      //. Llamar a la consulta de cupos por excursion

      IF "Venta libre" THEN
        EXIT;

      lrCupo.RESET;
      lrCupo.FILTERGROUP(2);
      lrCupo.SETRANGE(Excursion, Codigo);
      //+$018 <
      IF pwTurno <> 0 THEN
        lrCupo.SETRANGE(Turno, pwTurno);
      //+$018 >
      lrCupo.FILTERGROUP(0);

      CLEAR(lfCupos);
      lfCupos.SETTABLEVIEW(lrCupo);
      lfCupos.RUNMODAL;
    END;

    PROCEDURE CheckVentaVehiculo@1100217007(pwExcursion@1100217000 : Code[10]) : Boolean;
    VAR
      lrExc@1100217001 : Record 7009710;
    BEGIN
      // CheckVentaVehiculo

      IF NOT lrExc.GET(pwExcursion) THEN
        EXIT(FALSE);

      EXIT(lrExc."Venta x vehiculo");
    END;

    PROCEDURE CheckVentaLibre@1100217008(pwExcursion@1100217000 : Code[10]) : Boolean;
    VAR
      lrExc@1100217001 : Record 7009710;
    BEGIN
      // CheckVentaLibre

      IF NOT lrExc.GET(pwExcursion) THEN
        EXIT(FALSE);

      EXIT(lrExc."Venta libre");
    END;

    PROCEDURE GetPersonasRsvServicio@1100217009(pwExcursion@1100217000 : Code[10];pwTurno@1000000000 : Integer;pwTouroperador@1100217001 : Code[10];pwFechaInicio@1100217002 : Date;pwFechaFinal@1000000001 : Date) : Integer;
    VAR
      lrExc@1100217003 : Record 7009710;
    BEGIN
      // GetPersonasRsvServicio

      lrExc.GET(pwExcursion);
      IF pwTouroperador <> '' THEN
        lrExc.SETRANGE("Filtro Touroperador", pwTouroperador);

      lrExc.SETRANGE("Filtro Fecha servicio", pwFechaInicio, pwFechaFinal); //+$022
      lrExc.SETRANGE("Filtro Turno"         , pwTurno); //+$020

      lrExc.CALCFIELDS("Personas excursiones", "Personas reembolsadas exc");
      EXIT(lrExc."Personas excursiones" - "Personas reembolsadas exc");
    END;

    PROCEDURE GetVehiculosRsvServicio@1100217010(pwExcursion@1100217000 : Code[10];pwTurno@1000000000 : Integer;pwTouroperador@1100217001 : Code[10];pwFechaInicio@1000000002 : Date;pwFechaFinal@1000000001 : Date) : Integer;
    VAR
      lrExc@1100217003 : Record 7009710;
    BEGIN
      // GetVehiculosRsvServicio

      lrExc.GET(pwExcursion);
      IF pwTouroperador <> '' THEN
        lrExc.SETRANGE("Filtro Touroperador", pwTouroperador);

      lrExc.SETRANGE("Filtro Fecha servicio", pwFechaInicio, pwFechaFinal); //+$022
      lrExc.SETRANGE("Filtro Turno"         , pwTurno); //+$020

      lrExc.CALCFIELDS("Vehiculos excursiones","Vehiculos reembolsados exc");
      EXIT(lrExc."Vehiculos excursiones" - "Vehiculos reembolsados exc");
    END;

    PROCEDURE CrearRecogidas@1000000000(pwTurno@1000000000 : Integer);
    VAR
      lrHorasExc@1000000002 : Record 7010184;
      lfTabHorasRecogida@1000000001 : Form 7010225;
    BEGIN
      // CrearRecogidas

      lrHorasExc.horas_recogida_excursion(Rec);
      COMMIT;

      lrHorasExc.RESET;
      lrHorasExc.FILTERGROUP(2);
      lrHorasExc.SETRANGE(Excursion, Codigo);
      //-$028IF pwTurno <> 0 THEN
        lrHorasExc.SETRANGE(Turno, pwTurno);
      lrHorasExc.FILTERGROUP(0);

      CLEAR(lfTabHorasRecogida);
      lfTabHorasRecogida.SETTABLEVIEW(lrHorasExc);
      lfTabHorasRecogida.RUNMODAL;
    END;

    LOCAL PROCEDURE _NewExcursion@1000000001();
    VAR
      lrOficina@1000000000 : Record 7009720;
      lrDelegacion@1000000001 : Record 7009718;
      lwNumero@1000000002 : Integer;
      lwNumeroTexto@1000000003 : Code[10];
      lwCeros@1000000004 : Code[10];
    BEGIN
      // _NewExcursion

      rPar.FINDFIRST;
      IF rPar."Oficina Excursion Obligatoria" THEN
      BEGIN
        lrOficina.RESET;
        IF FORM.RUNMODAL(0, lrOficina) <> ACTION::LookupOK THEN
          ERROR(Text014);
      END;

      lrDelegacion.GET(rPar.Delegacion);
      lwNumero := lrDelegacion."Ultimo ID excursion";
      lwNumero += 1;
      lrDelegacion."Ultimo ID excursion" := lwNumero;
      lrDelegacion.MODIFY;

      lwNumeroTexto := FORMAT(lwNumero);

      IF rPar."Oficina Excursion Obligatoria" THEN
      BEGIN
        lwNumeroTexto := PADSTR(lwCeros, 4 - STRLEN(lwNumeroTexto), '0') + lwNumeroTexto;
        Codigo  := lrDelegacion.Codigo + lrOficina.Codigo + lwNumeroTexto;
        Oficina := lrOficina.Codigo;
      END
      ELSE
      BEGIN
        lwNumeroTexto := PADSTR(lwCeros, 7 - STRLEN(lwNumeroTexto), '0') + lwNumeroTexto;
        Codigo := lrDelegacion.Codigo + lwNumeroTexto
      END;
    END;

    LOCAL PROCEDURE _DeleteTurnos@1000000002();
    VAR
      lrCalendario@1000000000 : Record 7010254;
    BEGIN
      // _DeleteTurnos

      lrCalendario.RESET;
      lrCalendario.SETRANGE(Excursion, Codigo);
      IF lrCalendario.FINDSET(TRUE) THEN
        lrCalendario.DELETEALL(TRUE);
    END;

    BEGIN
    {
      $001 JPT 29/05/12  CNT-CAR-12004/EXC-15 - Providers confirmations
                         Nuevo campo "Precisa Confirmacion Proveedor"

      $002 AJS 30052012 CNT-CAR-12004/EXC-11 - Trading commission providers

      $003 JPT 08/08/12 CNT-OC-12004 Incluir filtro por oficina en las excursiones. Nuevo Campo Oficina
                        Nueva funcion CambiaOficina
                        Control de oficna en Excursion - Funcion ControlOficinaExc

      $004 AJS 21092012 Nuevo campo para indicar en las excursiones que tienen transporte propio, afecta a la funcion
                        de preparar el servicio

      $005 AJS 15012013 Nuevos campos para estudio estadistico de las excursiones

      $006 AJS 02022013 Agrego campos para las comisiones de guia venta y touroperador

      $007 AJS 11062013 Nuevo campo Duracion para predeterminar la duracion por codigo de excursion

      $008 AJS 11062013 Nuevo campo "Coste x ticket" y nueva funcion _CheckTipoPrecio para controlar que no haya precios
                        por servicio en las excursiones que se marquen como coste x ticket

      $009 AJS 06022014 Nuevo campo "Margen bruto" para calcular una prevision de coste de las excursiones in house

      $010 AJS 24022014 Nuevo campo "Excursion sin coste" parar aquellas excursiones que se facturan y no tienen costes

      $011 AJS 30052014 Establecer un control para que no puedan borrar una excursion que tiene reservas asociadas

      $012 AJS 20062014 CNT-CAR-14073, Nuevos campos para el control de cupos de venta

      $013 AJS 20062014 CNT-CAR-14073, Cambio la funcion _TieneReservas para que no muestre el error y asi poderla
                                       utilizar en m s sitios mostrando mensajes personalizados en cada caso

      $014 AJS 20062014 CNT-CAR-14073, Si la excursion tiene reservas pongo un CONFIRM sobre algunos campos

      $015 AJS 26062014 CNT-CAR-14073, Nuevas funcion CheckVentaVehiculo, CheckVentaLibre y GetPersonasRsvServicio

      $016 AJS 26062014 CNT-CAR-14073, Nuevo campo calculado Vehiculos excursiones para el control de cupos

      $017 ARM 28082014 CNT-CAR-14073 Al caducar la excursi¢n se bloquer  la publicaci¢n de la misma

      $018 AJS 24092014 Modifico la funcion VerCupo para poder filtrar por los de un turno

      $019 AJS 27092014 Modifico las funciones GetPersonasRsvServicio y GetVehiculosRsvServicio para incluir el turno

      $020 AJS 18122014 Agrego los filtros por turno en las funciones GetPersonasRsvServicio y GetVehiculosRsvServicio

      $021 AJS 18122014 Agrego el filtro por turno en los campos calculados

      $022 AJS 19122014 Modifico las funciones GetPersonasRsvServicio y GetVehiculosRsvServicio para poder pasar un periodo de fechas

      $023 AJS 09032015 CNT-OC-15130, Nueva funcion para codificar automaticamente las excursiones

      $024 AJS 09032015 Nuevo campo "Codigo anterior" que emplearemos temporalmente en aquellas empresas en que se lance
                        el proceso de recodificaci¢n

      $025 ARM 10042015 CNT-LP-15132 Nuevo campo capacidad x defecto

      $026 AJS 01052015 Incluidos nuevos campos para indicar edades por tipo de persona

      $027 AJS 22062015 Nuevo campo "Agrupacion comercial", que se va a utilizar temporalmente para la exportaci¢n a PIMS
                        hasta que se creen las modalidades de excursiones

      $028 AJS 25062015 Modificar la funcion CrearRecogida para filtrar siempre por Turno

      $029 AJS 25062015 Cuando se borra una excursion hay que borrar sus turnos
    }
    END.
  }
}
